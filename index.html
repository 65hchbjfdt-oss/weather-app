<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather OS Precision</title>
    <style>
        :root { --glass: rgba(255, 255, 255, 0.1); --blur: blur(40px); --spring: cubic-bezier(0.2, 0.8, 0.2, 1); }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        canvas#bg { position: fixed; inset: 0; z-index: -1; }

        header { padding: 15px; max-width: 600px; margin: 0 auto; display: flex; gap: 10px; position: relative; z-index: 1000; }
        .search-box { flex: 1; display: flex; align-items: center; background: var(--glass); backdrop-filter: var(--blur); border-radius: 20px; padding: 10px 15px; border: 0.5px solid rgba(255,255,255,0.2); gap: 10px; }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; }
        
        main { height: 100vh; overflow-y: auto; padding: 80px 20px 120px; scrollbar-width: none; scroll-behavior: smooth; }
        main::-webkit-scrollbar { display: none; }
        
        .city-info { text-align: center; margin-bottom: 40px; transition: transform 0.6s var(--spring); }
        .temp-main { font-size: 110px; font-weight: 100; letter-spacing: -5px; margin: 10px 0; position: relative; }
        
        .card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 28px; padding: 20px; border: 0.5px solid rgba(255,255,255,0.15); margin-bottom: 20px; }
        .card-label { font-size: 11px; opacity: 0.5; text-transform: uppercase; font-weight: 700; margin-bottom: 15px; }

        /* –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ */
        .day-item { display: grid; grid-template-columns: 100px 1fr 120px; align-items: center; padding: 15px 0; border-bottom: 0.5px solid rgba(255,255,255,0.1); }
        .day-item:last-child { border: none; }
        .precip { font-size: 12px; color: #00C6FF; font-weight: 600; }

        .hourly-scroll { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .h-unit { text-align: center; min-width: 55px; }

        /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è (–∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ) */
        .nav-dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.4); backdrop-filter: blur(20px); padding: 10px 20px; border-radius: 25px; display: flex; align-items: center; gap: 12px; border: 0.5px solid rgba(255,255,255,0.1); z-index: 2000; }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #fff; transform: scale(1.3); }
        .loc-icon { width: 14px; height: 14px; fill: rgba(255,255,255,0.3); }
        .loc-icon.active { fill: #fff; }

        /* –ü–æ–∏—Å–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã */
        .s-res { position: absolute; top: 75px; left: 15px; right: 15px; background: rgba(20,20,20,0.9); backdrop-filter: blur(40px); border-radius: 22px; border: 0.5px solid var(--glass); overflow: hidden; }
        .s-row { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid rgba(255,255,255,0.05); }
        .star { font-size: 22px; color: rgba(255,255,255,0.2); transition: 0.3s; cursor: pointer; }
        .star.active { color: #FFD700; }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<header>
    <div class="search-box">
        <span>üîç</span>
        <input id="searchInp" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." oninput="handleSearch(this.value)" />
    </div>
    <div id="searchResults" class="s-res" style="display:none"></div>
</header>

<main id="scroller" ontouchstart="ts(event)" ontouchend="te(event)">
    <div class="city-info" id="hero">
        <div id="cityName" style="font-size:34px; font-weight:500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="temp-main" id="curTemp">--</div>
        <div id="curDesc" style="font-size:22px; opacity:0.8">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
    </div>

    <div class="card">
        <div class="card-label">–ü–æ—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –∏ —Å–æ–ª–Ω—Ü–µ</div>
        <div class="hourly-scroll" id="hourlyBox"></div>
    </div>

    <div class="card">
        <div class="card-label">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—è</div>
        <div id="dailyBox"></div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
        <div class="card"><div class="card-label">–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫</div><div id="feelVal" style="font-size:28px">--</div></div>
        <div class="card"><div class="card-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div><div id="humVal" style="font-size:28px">--</div></div>
    </div>

    <div class="card" style="background:rgba(255,255,255,0.05)">
        <div class="card-label">ü§ñ AI –°–æ–≤–µ—Ç</div>
        <div id="aiText" style="line-height:1.5">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...</div>
    </div>
</main>

<div class="nav-dock" id="pagination"></div>

<script>
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let pages = [], curIdx = 0, startX = 0;
    let env = { isDay: true, code: 0, windDir: 0, temp: 0 };
    let stars = [], clouds = [], flarePos = {x:0, y:0};

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    async function init() {
        resize();
        navigator.geolocation.getCurrentPosition(
            p => fetchMain(p.coords.latitude, p.coords.longitude, '–ú–æ—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏—è'),
            () => fetchMain(55.75, 37.62, '–ú–æ—Å–∫–≤–∞')
        );
        initStars();
        loop();
    }

    async function fetchMain(lat, lon, name) {
        pages = [{lat, lon, name, isHome: true}];
        const favs = JSON.parse(localStorage.getItem('weatherFavs') || '[]');
        pages.push(...favs.slice(0,3));
        renderPag();
        loadWeather(0);
    }

    async function loadWeather(idx) {
        curIdx = idx;
        const city = pages[idx];
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,is_day,wind_direction_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max&timezone=auto`).then(r=>r.json());
        
        env.isDay = !!res.current.is_day;
        env.code = res.current.weather_code;
        env.windDir = res.current.wind_direction_10m;
        env.temp = res.current.temperature_2m;

        document.getElementById('cityName').innerText = city.name;
        document.getElementById('curTemp').innerText = Math.round(env.temp) + '¬∞';
        document.getElementById('feelVal').innerText = Math.round(res.current.apparent_temperature) + '¬∞';
        document.getElementById('humVal').innerText = res.current.relative_humidity_2m + '%';
        
        // –ü–æ—á–∞—Å–æ–≤–∞—è –ª–µ–Ω—Ç–∞ —Å–æ –∑–Ω–∞—á–∫–∞–º–∏ —Å–æ–ª–Ω—Ü–∞
        const hItems = [];
        const sunrise = new Date(res.daily.sunrise[0]).getHours();
        const sunset = new Date(res.daily.sunset[0]).getHours();

        for(let i=0; i<24; i++) {
            const h = i;
            if(h === sunrise) hItems.push(`<div class="h-unit" style="color:#FFD700"><span>${h}:00</span><span>üåÖ</span><span>–í–æ—Å—Ö–æ–¥</span></div>`);
            if(h === sunset) hItems.push(`<div class="h-unit" style="color:#FF8C00"><span>${h}:00</span><span>üåá</span><span>–ó–∞–∫–∞—Ç</span></div>`);
            hItems.push(`<div class="h-unit"><span>${h}:00</span><span>${res.hourly.weather_code[i] < 3 ? '‚òÄÔ∏è' : '‚òÅÔ∏è'}</span><span>${Math.round(res.hourly.temperature_2m[i])}¬∞</span></div>`);
        }
        document.getElementById('hourlyBox').innerHTML = hItems.join('');

        // –î–µ—Ç–∞–ª—å–Ω—ã–µ 3 –¥–Ω—è
        document.getElementById('dailyBox').innerHTML = res.daily.time.slice(0,3).map((t, i) => `
            <div class="day-item">
                <span>${i===0?'–°–µ–≥–æ–¥–Ω—è':new Date(t).toLocaleDateString('ru',{weekday:'short'})}</span>
                <span style="font-size:20px">${res.daily.weather_code[i] < 3 ? '‚òÄÔ∏è' : '‚òÅÔ∏è'}</span>
                <div style="text-align:right">
                    <span class="precip">${res.daily.precipitation_probability_max[i]}% üíß</span>
                    <span style="margin-left:10px; font-weight:600">${Math.round(res.daily.temperature_2m_max[i])}¬∞</span>
                </div>
            </div>
        `).join('');

        document.getElementById('aiText').innerText = env.temp < -20 ? "–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π —Ö–æ–ª–æ–¥! –°–∏—è–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ." : "–û–¥–µ–Ω—å—Ç–µ—Å—å –ø–æ –ø–æ–≥–æ–¥–µ.";
        
        initClouds();
        renderPag();
    }

    // --- –ì—Ä–∞—Ñ–∏–∫–∞ –∏ –ê–Ω–∏–º–∞—Ü–∏—è ---
    function initStars() {
        stars = [];
        for(let i=0; i<100; i++) stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random(), o:Math.random()});
    }

    function initClouds() {
        clouds = [];
        if(env.code >= 3) {
            for(let i=0; i<5; i++) clouds.push({x:Math.random()*canvas.width, y:Math.random()*300, w:150+Math.random()*100, v:(env.windDir > 180 ? 1 : -1) * (0.2 + Math.random())});
        }
    }

    function loop() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        
        // –§–æ–Ω
        const g = ctx.createLinearGradient(0,0,0,canvas.height);
        if(env.isDay) { g.addColorStop(0, '#00C6FF'); g.addColorStop(1, '#007AFF'); }
        else { g.addColorStop(0, '#0F0C29'); g.addColorStop(1, '#24243E'); }
        ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width, canvas.height);

        // –ó–≤–µ–∑–¥—ã (–µ—Å–ª–∏ —è—Å–Ω–æ –∏ –Ω–æ—á—å)
        if(!env.isDay && env.code < 3) {
            stars.forEach(s => {
                s.o += 0.01;
                ctx.fillStyle = `rgba(255,255,255,${Math.abs(Math.sin(s.o))})`;
                ctx.beginPath(); ctx.arc(s.x, s.y, s.s*1.5, 0, Math.PI*2); ctx.fill();
            });
        }

        // –û–±–ª–∞–∫–∞
        clouds.forEach(c => {
            c.x += c.v;
            if(c.x > canvas.width + 100) c.x = -200;
            if(c.x < -200) c.x = canvas.width + 100;
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath(); ctx.ellipse(c.x, c.y, c.w, c.w/2, 0, 0, Math.PI*2); ctx.fill();
        });

        // –°–æ–ª–Ω—Ü–µ –∏ –ë–ª–∏–∫–∏
        if(env.isDay) {
            const sx = canvas.width*0.8, sy = 150;
            // –õ—É—á–∏
            ctx.save(); ctx.translate(sx, sy); ctx.rotate(Date.now()*0.0002);
            for(let i=0; i<10; i++) {
                ctx.rotate(Math.PI/5);
                let rg = ctx.createLinearGradient(0,0,0,300);
                rg.addColorStop(0, 'rgba(255,255,255,0.2)'); rg.addColorStop(1, 'transparent');
                ctx.fillStyle = rg; ctx.beginPath(); ctx.moveTo(-20,0); ctx.lineTo(20,0); ctx.lineTo(0, 600); ctx.fill();
            }
            ctx.restore();
            // –ë–ª–∏–∫–∏ (Lens Flare)
            const time = Date.now()*0.001;
            for(let i=1; i<4; i++) {
                ctx.fillStyle = `rgba(255,255,255,${0.05/i})`;
                ctx.beginPath(); ctx.arc(sx - (Math.cos(time)*20*i), sy + (Math.sin(time)*20*i), 40*i, 0, Math.PI*2); ctx.fill();
            }
        }

        // –°–µ–≤–µ—Ä–Ω–æ–µ —Å–∏—è–Ω–∏–µ
        if(env.temp < -30) {
            let t = Date.now()*0.001;
            let ag = ctx.createLinearGradient(0,0, canvas.width, 0);
            ag.addColorStop(0, 'transparent');
            ag.addColorStop(0.5, `hsla(${Math.sin(t)*60+120}, 100%, 50%, 0.1)`);
            ag.addColorStop(1, 'transparent');
            ctx.fillStyle = ag; ctx.fillRect(0,0,canvas.width, 400);
        }

        requestAnimationFrame(loop);
    }

    // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –ü–æ–∏—Å–∫ ---
    function renderPag() {
        const pag = document.getElementById('pagination');
        pag.innerHTML = pages.map((p, i) => {
            if(p.isHome) return `<svg class="loc-icon ${curIdx===i?'active':''}" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>`;
            return `<div class="dot ${curIdx===i?'active':''}"></div>`;
        }).join('');
    }

    function ts(e) { startX = e.touches[0].clientX; }
    function te(e) {
        const diff = startX - e.changedTouches[0].clientX;
        if(Math.abs(diff) > 80) {
            if(diff > 0 && curIdx < pages.length-1) loadWeather(curIdx+1);
            else if(diff < 0 && curIdx > 0) loadWeather(curIdx-1);
        }
    }

    async function handleSearch(v) {
        if(v.length < 2) return document.getElementById('searchResults').style.display='none';
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${v}&count=5&language=ru`).then(res=>res.json());
        if(r.results) {
            const box = document.getElementById('searchResults');
            box.innerHTML = r.results.map(g => {
                const isFav = pages.some(p => p.name === g.name);
                return `<div class="s-row">
                    <div onclick="addCity('${g.latitude}','${g.longitude}','${g.name}')" style="flex:1">
                        <b>${g.name}</b><br><small style="opacity:0.5">${g.admin1 || ''}, ${g.country}</small>
                    </div>
                    <div class="star ${isFav?'active':''}" onclick="toggleFav(event, '${g.latitude}','${g.longitude}','${g.name}')">‚òÖ</div>
                </div>`;
            }).join('');
            box.style.display = 'block';
        }
    }

    function toggleFav(e, lat, lon, name) {
        e.stopPropagation();
        let favs = JSON.parse(localStorage.getItem('weatherFavs') || '[]');
        const idx = favs.findIndex(f => f.name === name);
        if(idx === -1) {
            if(favs.length < 3) favs.push({lat, lon, name});
        } else favs.splice(idx, 1);
        localStorage.setItem('weatherFavs', JSON.stringify(favs));
        fetchMain(pages[0].lat, pages[0].lon, pages[0].name);
        handleSearch(document.getElementById('searchInp').value);
    }

    function addCity(lat, lon, name) {
        document.getElementById('searchResults').style.display = 'none';
        pages[curIdx] = {lat, lon, name};
        loadWeather(curIdx);
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize;
    init();
</script>
</body>
</html>

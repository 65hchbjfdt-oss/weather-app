<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>iOS Weather Ultimate</title>
    <style>
        :root {
            --glass-bg: rgba(30, 30, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.18);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --blur: blur(40px);
            --spring: cubic-bezier(0.25, 1, 0.5, 1);
            --text-main: #ffffff;
            --text-sec: rgba(255, 255, 255, 0.6);
            --accent-blue: #0a84ff;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: #000; color: var(--text-main); overflow: hidden; height: 100vh; }
        
        /* –§–æ–Ω */
        canvas#bg-canvas { position: fixed; inset: 0; z-index: -2; transition: filter 0.8s ease; }
        .bg-overlay { position: fixed; inset: 0; z-index: -1; background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.4) 100%); pointer-events: none; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫ */
        header { 
            position: absolute; top: 0; left: 0; right: 0; z-index: 1000; 
            padding: 15px 20px; display: flex; gap: 12px; 
            transition: opacity 0.3s; 
        }
        .search-bar { 
            flex: 1; height: 44px; 
            background: rgba(40,40,40,0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 12px; display: flex; align-items: center; padding: 0 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 1px solid var(--glass-border);
        }
        .search-bar input { 
            background: transparent; border: none; color: #fff; font-size: 17px; width: 100%; outline: none; margin-left: 8px; 
        }
        .btn-circle {
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(40,40,40,0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; color: #fff;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ */
        #search-results {
            position: absolute; top: 70px; left: 20px; right: 20px;
            background: rgba(35,35,35,0.95); backdrop-filter: blur(30px);
            border-radius: 14px; overflow: hidden; display: none; z-index: 2000;
            border: 1px solid var(--glass-border); box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .search-item {
            padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; transition: background 0.2s;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:active { background: rgba(255,255,255,0.1); }
        .si-name { font-size: 17px; font-weight: 500; }
        .si-sub { font-size: 13px; color: var(--text-sec); margin-top: 2px; }

        /* –°–ª–∞–π–¥–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü */
        #viewport {
            width: 100%; height: 100%; overflow: hidden; position: relative;
        }
        #slider {
            display: flex; height: 100%; transition: transform 0.5s var(--spring);
            will-change: transform;
        }
        .page {
            width: 100vw; flex-shrink: 0; height: 100%; overflow-y: auto; overflow-x: hidden;
            padding: 80px 20px 160px 20px; /* –ë–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        /* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ –≥–æ—Ä–æ–¥–∞ */
        .city-header { text-align: center; margin-bottom: 40px; text-shadow: 0 2px 15px rgba(0,0,0,0.2); }
        .ch-name { font-size: 34px; font-weight: 600; margin-bottom: 5px; }
        .ch-cond { font-size: 18px; font-weight: 500; opacity: 0.8; text-transform: capitalize; }
        .ch-temp { font-size: 96px; font-weight: 200; letter-spacing: -3px; line-height: 1; margin: 10px 0; }
        .ch-hl { font-size: 18px; font-weight: 500; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ (Glassmorphism) */
        .card {
            background: var(--glass-bg);
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border-radius: 22px; padding: 16px; margin-bottom: 14px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .card-head { 
            font-size: 13px; font-weight: 600; text-transform: uppercase; color: var(--text-sec); 
            margin-bottom: 12px; display: flex; align-items: center; gap: 6px; 
        }

        /* –ü–æ—á–∞—Å–æ–≤–æ–π —Å–∫—Ä–æ–ª–ª */
        .hourly-scroll { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .hourly-scroll::-webkit-scrollbar { display: none; }
        .hourly-item { display: flex; flex-direction: column; align-items: center; min-width: 50px; gap: 6px; }

        /* –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ */
        .daily-row { display: grid; grid-template-columns: 1.5fr 1fr 1fr; align-items: center; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.1); font-size: 17px; font-weight: 500; }
        .daily-row:first-of-type { border-top: none; }
        .dr-icon { text-align: center; }
        .dr-temps { text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
        .t-min { opacity: 0.5; }

        /* –°–µ—Ç–∫–∞ –ø–ª–∏—Ç–æ–∫ 2x2 */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
        .tile { 
            aspect-ratio: 1; display: flex; flex-direction: column; justify-content: space-between; 
            padding: 16px; cursor: pointer; position: relative;
        }
        .tile-val { font-size: 28px; font-weight: 500; }
        .tile-sub { font-size: 13px; opacity: 0.7; }

        /* –ì—Ä–∞—Ñ–∏–∫ —Å–æ–ª–Ω—Ü–∞ (Canvas) */
        #sun-canvas { width: 100%; height: 80px; margin-top: auto; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ */
        .dots {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; z-index: 1000;
            background: rgba(0,0,0,0.3); padding: 8px 14px; border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.3); transition: 0.3s; }
        .dot.active { background: #fff; }

        /* ---- –†–ï–ñ–ò–ú –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê (–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) ---- */
        #preview-modal {
            position: fixed; inset: 0; background: #000; z-index: 3000;
            transform: translateY(100%); transition: transform 0.4s var(--spring);
            display: flex; flex-direction: column;
        }
        #preview-modal.visible { transform: translateY(0); }
        .preview-header {
            display: flex; justify-content: space-between; padding: 50px 20px 10px;
            position: absolute; width: 100%; z-index: 3001;
        }
        .btn-cancel { font-size: 17px; color: #fff; background: rgba(60,60,60,0.7); backdrop-filter: blur(20px); padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .btn-add { font-size: 17px; font-weight: 600; color: #000; background: #fff; padding: 8px 16px; border-radius: 20px; cursor: pointer; }

        /* ---- –ü–û–î–†–û–ë–ù–û–°–¢–ò –°–û–õ–ù–¶–ê (–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) ---- */
        #sun-details {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(30px);
            z-index: 4000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
        }
        #sun-details.visible { opacity: 1; display: flex; }
        .sun-card {
            width: 85%; max-width: 340px; background: rgba(30,30,30,0.9);
            border: 1px solid var(--glass-border); border-radius: 24px;
            padding: 25px; text-align: center; position: relative;
        }
        .sun-card h3 { margin: 0 0 20px; font-size: 22px; font-weight: 600; }
        .sc-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sc-row:last-child { border: none; }
        .close-sun { position: absolute; top: 15px; right: 15px; width: 30px; height: 30px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–æ–≥–æ–¥—ã */
        .anim-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <div class="bg-overlay"></div>

    <header id="main-header">
        <div class="search-bar">
            <span>üîç</span>
            <input id="search-input" type="text" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." oninput="handleSearch(this.value)">
        </div>
        <div class="btn-circle" onclick="locateUser()">üìç</div> 
    </header>

    <div id="search-results"></div>

    <div id="viewport">
        <div id="slider"></div>
    </div>

    <div class="dots" id="dots-container"></div>

    <div id="preview-modal">
        <canvas id="preview-bg" style="position:fixed; inset:0; z-index:-1;"></canvas>
        <div class="preview-header">
            <div class="btn-cancel" onclick="closePreview()">‚úï –û—Ç–º–µ–Ω–∞</div>
            <div class="btn-add" onclick="addToFavorites()">–î–æ–±–∞–≤–∏—Ç—å</div>
        </div>
        <div id="preview-content" class="page" style="padding-top: 100px;">
            </div>
    </div>

    <div id="sun-details">
        <div class="sun-card">
            <div class="close-sun" onclick="toggleSunDetails(false)">‚úï</div>
            <h3>–°–æ–ª–Ω—Ü–µ</h3>
            <div class="sc-row"><span>–ü–µ—Ä–≤—ã–µ –ª—É—á–∏</span> <span id="sd-first">--:--</span></div>
            <div class="sc-row"><span>–í–æ—Å—Ö–æ–¥</span> <span id="sd-rise">--:--</span></div>
            <div class="sc-row"><span>–ó–∞–∫–∞—Ç</span> <span id="sd-set">--:--</span></div>
            <div class="sc-row"><span>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª—É—á–∏</span> <span id="sd-last">--:--</span></div>
            <div class="sc-row"><span>–°–≤–µ—Ç–æ–≤–æ–π –¥–µ–Ω—å</span> <span id="sd-dur">-- —á -- –º–∏–Ω</span></div>
        </div>
    </div>

<script>
    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    let cities = []; // {lat, lon, name, country...}
    let currentIdx = 0;
    let previewData = null; // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    let touchStart = 0;
    
    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        resizeCanvas();
        loadFavorites();
        if (cities.length === 0) locateUser();
        else renderSlider();
        
        loopAnimation();
    };

    window.onresize = resizeCanvas;

    // --- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏ –¥–∞–Ω–Ω—ã–µ ---
    function loadFavorites() {
        const saved = localStorage.getItem('ios_weather_favs');
        if (saved) cities = JSON.parse(saved);
    }

    function saveFavorites() {
        localStorage.setItem('ios_weather_favs', JSON.stringify(cities));
    }

    function locateUser() {
        if (!navigator.geolocation) return addDefaultCity();
        navigator.geolocation.getCurrentPosition(async pos => {
            const { latitude, longitude } = pos.coords;
            const meta = await getCityName(latitude, longitude);
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç (–µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, –∑–∞–º–µ–Ω—è–µ–º —Å–ø–∏—Å–æ–∫)
            if (cities.length === 0) {
                cities = [{ lat: latitude, lon: longitude, ...meta }];
                saveFavorites();
                renderSlider();
            }
        }, () => addDefaultCity());
    }

    function addDefaultCity() {
        if(cities.length > 0) return;
        cities = [{ lat: 55.75, lon: 37.62, name: "–ú–æ—Å–∫–≤–∞", region: "–†–æ—Å—Å–∏—è" }];
        renderSlider();
    }

    async function getCityName(lat, lon) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ru`);
            const data = await res.json();
            const addr = data.address;
            
            let name = addr.city || addr.town || addr.village || addr.hamlet || "–ú–æ—è –ª–æ–∫–∞—Ü–∏—è";
            let region = addr.state || addr.region || addr.country || "";
            // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ
            name = name.replace('–≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥', '').trim();
            
            return { name, region };
        } catch {
            return { name: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ", region: "" };
        }
    }

    // --- API –ü–æ–≥–æ–¥—ã ---
    async function fetchWeather(lat, lon) {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day,wind_speed_10m,relative_humidity_2m,apparent_temperature,pressure_msl&hourly=temperature_2m,weather_code,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,daylight_duration&timezone=auto`;
        const r = await fetch(url);
        return await r.json();
    }

    // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –°–ª–∞–π–¥–µ—Ä–∞ (–û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω) ---
    async function renderSlider() {
        const slider = document.getElementById('slider');
        const dots = document.getElementById('dots-container');
        
        // –û—á–∏—Å—Ç–∫–∞ –µ—Å–ª–∏ –ø–æ–ª–Ω–æ–µ –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏–µ (–¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
        // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å diff, –Ω–æ –∑–¥–µ—Å—å –≤–∞–∂–Ω–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
        slider.innerHTML = '';
        dots.innerHTML = '';

        slider.style.width = `${cities.length * 100}vw`;

        for (let i = 0; i < cities.length; i++) {
            const city = cities[i];
            
            // –¢–æ—á–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            const dot = document.createElement('div');
            dot.className = `dot ${i === currentIdx ? 'active' : ''}`;
            dots.appendChild(dot);

            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const page = document.createElement('div');
            page.className = 'page';
            page.id = `city-page-${i}`;
            page.innerHTML = `<div style="padding-top:200px; text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
            slider.appendChild(page);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            fetchWeather(city.lat, city.lon).then(data => {
                const el = document.getElementById(`city-page-${i}`);
                if(el) el.innerHTML = buildHTML(data, city, i);
                if(i === currentIdx) updateBackground(data);
                // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å–æ–ª–Ω—Ü–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
                setTimeout(() => drawSunGraph(`sun-canvas-${i}`, data), 100);
            });
        }
        updateTransform();
    }

    // --- HTML –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä (–¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫) ---
    function buildHTML(data, cityMeta, idSuffix) {
        const curr = data.current;
        const daily = data.daily;
        const hourly = data.hourly;
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (–£–ß–ò–¢–´–í–ê–Ø –¢–ê–ô–ú–ó–û–ù–£ –ì–û–†–û–î–ê)
        const tz = data.timezone;
        const getHour = (iso) => new Date(iso).toLocaleTimeString('ru-RU', { hour: 'numeric', timeZone: tz });
        const getDay = (iso) => new Date(iso).toLocaleDateString('ru-RU', { weekday: 'short', timeZone: tz });
        const getFullDate = (iso) => new Date(iso).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', timeZone: tz });

        // –§–∞–∑–∞ –ª—É–Ω—ã (—Å–∏–º—É–ª—è—Ü–∏—è, —Ç.–∫. API v1 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–¥, –Ω–æ –¥–ª—è UI –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏–∫–æ–Ω–∫—É)
        // –í Open-Meteo –µ—Å—Ç—å moon_phase, –Ω–æ –º—ã –Ω–µ –∑–∞–ø—Ä–æ—Å–∏–ª–∏. –°–¥–µ–ª–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –∏–ª–∏ –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É.
        // –î–æ–±–∞–≤–∏–º —Ä–∞–Ω–¥–æ–º–Ω—É—é —Ñ–∞–∑—É –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã –¥–µ–º–æ, –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º weather_code "–Ω–æ—á–∏"
        const moonPhase = "üåí –†–∞—Å—Ç—É—â–∞—è"; 

        // –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã
        const wDesc = getWeatherDesc(curr.weather_code);

        // –ü–æ—á–∞—Å–æ–≤–æ–π HTML
        let hourlyHTML = '';
        const currentHour = new Date().getHours();
        for(let j=0; j<24; j++) {
            // –ò—â–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Å–∞ –≤ –º–∞—Å—Å–∏–≤–µ API
            // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 24 –∑–∞–ø–∏—Å–∏, –Ω–æ –≤ –∏–¥–µ–∞–ª–µ –Ω–∞–¥–æ –º–∞—Ç—á–∏—Ç—å –≤—Ä–µ–º—è
            const time = hourly.time[j];
            const temp = Math.round(hourly.temperature_2m[j]);
            const icon = getWeatherIcon(hourly.weather_code[j], hourly.is_day[j]);
            const hStr = j === 0 ? '–°–µ–π—á–∞—Å' : getHour(time);
            hourlyHTML += `
                <div class="hourly-item">
                    <span style="font-size:14px; font-weight:600">${hStr}</span>
                    <span style="font-size:24px; margin:4px 0">${icon}</span>
                    <span style="font-size:18px; font-weight:500">${temp}¬∞</span>
                </div>`;
        }

        // –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π HTML (5 –¥–Ω–µ–π)
        let dailyHTML = '';
        for(let k=0; k<5; k++) {
            dailyHTML += `
                <div class="daily-row">
                    <div>${k===0 ? '–°–µ–≥–æ–¥–Ω—è' : getDay(daily.time[k])}</div>
                    <div class="dr-icon">${getWeatherIcon(daily.weather_code[k], 1)}</div>
                    <div class="dr-temps">
                        <span class="t-min">${Math.round(daily.temperature_2m_min[k])}¬∞</span>
                        <span>${Math.round(daily.temperature_2m_max[k])}¬∞</span>
                    </div>
                </div>`;
        }

        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ —Å–æ–ª–Ω—Ü–∞ (–ø–µ—Ä–µ–¥–∞–¥–∏–º –≤ window –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞)
        const sunData = {
            rise: daily.sunrise[0],
            set: daily.sunset[0],
            duration: daily.daylight_duration[0],
            tz: tz
        };
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –º–æ–¥–∞–ª–∫–∏, –∏—Å–ø–æ–ª—å–∑—É—è –∫–ª—é—á
        window[`sunData_${idSuffix}`] = sunData;

        return `
            <div class="city-header">
                <div class="ch-name">${cityMeta.name}</div>
                <div class="ch-cond">${wDesc}</div>
                <div class="ch-temp">${Math.round(curr.temperature_2m)}¬∞</div>
                <div class="ch-hl">–ú–∞–∫—Å.: ${Math.round(daily.temperature_2m_max[0])}¬∞ –ú–∏–Ω.: ${Math.round(daily.temperature_2m_min[0])}¬∞</div>
            </div>

            <div class="card">
                <div class="card-head">üïì –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 24 —á–∞—Å–∞</div>
                <div class="hourly-scroll">${hourlyHTML}</div>
            </div>

            <div class="card">
                <div class="card-head">üìÖ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –¥–Ω–µ–π</div>
                ${dailyHTML}
            </div>

            <div class="grid-2">
                <div class="card tile" onclick="openSunDetails('sunData_${idSuffix}')">
                    <div class="card-head">üåÖ –í–æ—Å—Ö–æ–¥ –∏ –∑–∞–∫–∞—Ç</div>
                    <div style="margin-top:auto">
                         <div style="font-size:13px; margin-bottom:5px;">–ó–∞–∫–∞—Ç: ${new Date(sunData.set).toLocaleTimeString('ru-RU',{hour:'2-digit', minute:'2-digit', timeZone:tz})}</div>
                    </div>
                    <canvas id="sun-canvas-${idSuffix}" style="width:100%; height:60px;"></canvas>
                </div>
                <div class="card tile">
                    <div class="card-head">üåë –õ—É–Ω–∞</div>
                    <div class="tile-val" style="margin:auto; font-size:40px">üåí</div>
                    <div class="tile-sub" style="text-align:center">–†–∞—Å—Ç—É—â–∞—è –ª—É–Ω–∞<br>–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å 15%</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card tile">
                    <div class="card-head">üí® –í–µ—Ç–µ—Ä</div>
                    <div class="tile-val">${Math.round(curr.wind_speed_10m)} <span style="font-size:16px">–º/—Å</span></div>
                    <div class="tile-sub">–ü–æ—Ä—ã–≤—ã –¥–æ ${Math.round(curr.wind_speed_10m * 1.5)} –º/—Å</div>
                </div>
                <div class="card tile">
                    <div class="card-head">üß≠ –î–∞–≤–ª–µ–Ω–∏–µ</div>
                    <div class="tile-val">${Math.round(curr.pressure_msl * 0.75006)}</div>
                    <div class="tile-sub">–º–º —Ä—Ç. —Å—Ç.</div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 50px;">
                <div class="card-head">ü§ñ AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
                <div style="font-size:15px; line-height:1.5; opacity:0.9;">
                    ${getAIAdvice(curr.temperature_2m, curr.weather_code, curr.wind_speed_10m)}
                </div>
            </div>
        `;
    }

    // --- –†–∏—Å–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –°–æ–ª–Ω—Ü–∞ (–°–∏–Ω—É—Å–æ–∏–¥–∞) ---
    function drawSunGraph(canvasId, data) {
        const cvs = document.getElementById(canvasId);
        if (!cvs) return;
        const cx = cvs.getContext('2d');
        const w = cvs.width = cvs.offsetWidth * 2; // Retina scale
        const h = cvs.height = cvs.offsetHeight * 2;
        
        const now = new Date().getTime(); // UTC timestamp
        const rise = new Date(data.daily.sunrise[0]).getTime();
        const set = new Date(data.daily.sunset[0]).getTime();
        
        cx.clearRect(0,0,w,h);
        cx.lineWidth = 4;
        
        // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞
        cx.beginPath();
        cx.strokeStyle = 'rgba(255,255,255,0.2)';
        cx.moveTo(0, h/2 + 20);
        cx.lineTo(w, h/2 + 20);
        cx.stroke();

        // –†–∏—Å—É–µ–º —Å–∏–Ω—É—Å–æ–∏–¥—É
        cx.beginPath();
        cx.strokeStyle = '#ffd700';
        for (let x = 0; x <= w; x++) {
            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è X (0..1) -> –£–≥–æ–ª (-PI/2 .. 3PI/2)
            const angle = (x / w) * Math.PI - Math.PI/2; 
            const y = (h/2 + 20) - Math.cos(x/w * Math.PI * 2 + Math.PI) * (h/3);
            if (x===0) cx.moveTo(x,y);
            else cx.lineTo(x,y);
        }
        cx.stroke();

        // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–æ–ª–Ω—Ü–∞
        // –ü—Ä–æ–≥—Ä–µ—Å—Å: 0 = –≤–æ—Å—Ö–æ–¥, 1 = –∑–∞–∫–∞—Ç
        let progress = (now - rise) / (set - rise);
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        if (progress < 0) progress = 0;
        if (progress > 1) progress = 1;
        
        // –ú–∞–ø–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ —à–∏—Ä–∏–Ω—É canvas (—É—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã —Å–∏–Ω—É—Å–æ–∏–¥—ã)
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: 0.25 —à–∏—Ä–∏–Ω—ã - —ç—Ç–æ –≤–æ—Å—Ö–æ–¥, 0.75 - –∑–∞–∫–∞—Ç –Ω–∞ –ø–æ–ª–Ω–æ–π –≤–æ–ª–Ω–µ
        // –ù–æ –∑–¥–µ—Å—å —É–ø—Ä–æ—Å—Ç–∏–º: –ª–∏–Ω–∏—è –æ—Ç 0 –¥–æ W –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ–Ω—å (–¥–ª—è –≤–∏–∑—É–∞–ª–∞)
        const sunX = w * progress;
        const sunY = (h/2 + 20) - Math.cos(sunX/w * Math.PI * 2 + Math.PI) * (h/3);

        // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –¥–µ–Ω—å
        if (now >= rise && now <= set) {
            cx.fillStyle = '#fff';
            cx.shadowBlur = 10;
            cx.shadowColor = '#ffd700';
            cx.beginPath();
            cx.arc(sunX, sunY, 8, 0, Math.PI*2);
            cx.fill();
        }
    }

    // --- –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –°–æ–ª–Ω—Ü–∞ ---
    function openSunDetails(dataKey) {
        const data = window[dataKey];
        if(!data) return;

        const el = (id) => document.getElementById(id);
        const fmt = (d) => new Date(d).toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit', timeZone: data.tz});
        
        // –í—ã—á–∏—Å–ª—è–µ–º "–ø–µ—Ä–≤—ã–µ –ª—É—á–∏" (–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–µ —Å—É–º–µ—Ä–∫–∏) ~30 –º–∏–Ω –¥–æ –≤–æ—Å—Ö–æ–¥–∞
        const riseTime = new Date(data.rise).getTime();
        const setTime = new Date(data.set).getTime();
        
        el('sd-rise').innerText = fmt(data.rise);
        el('sd-set').innerText = fmt(data.set);
        el('sd-first').innerText = fmt(riseTime - 30*60000); // -30 –º–∏–Ω
        el('sd-last').innerText = fmt(setTime + 30*60000);   // +30 –º–∏–Ω

        // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        const durSec = data.duration;
        const hrs = Math.floor(durSec / 3600);
        const mins = Math.floor((durSec % 3600) / 60);
        el('sd-dur').innerText = `${hrs} —á ${mins} –º–∏–Ω`;

        el('sun-details').classList.add('visible');
    }

    function toggleSunDetails(show) {
        const el = document.getElementById('sun-details');
        if(show) el.classList.add('visible');
        else el.classList.remove('visible');
    }

    // --- –ü–æ–∏—Å–∫ –∏ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ---
    async function handleSearch(query) {
        const box = document.getElementById('search-results');
        if (query.length < 2) { box.style.display = 'none'; return; }

        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=5&language=ru&format=json`;
        const r = await fetch(url).then(res => res.json());

        if (!r.results) { box.style.display = 'none'; return; }

        box.innerHTML = r.results.map(city => {
            const region = [city.admin1, city.country].filter(Boolean).join(', ');
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –≤ –∏–º–µ–Ω–∏
            const sName = city.name.replace(/'/g, "\\'");
            const sReg = region.replace(/'/g, "\\'");
            return `<div class="search-item" onclick="openPreview(${city.latitude}, ${city.longitude}, '${sName}', '${sReg}')">
                <div class="si-name">${city.name}</div>
                <div class="si-sub">${region}</div>
            </div>`;
        }).join('');
        box.style.display = 'block';
    }

    async function openPreview(lat, lon, name, region) {
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('search-input').value = '';
        document.getElementById('search-input').blur();

        const modal = document.getElementById('preview-modal');
        const content = document.getElementById('preview-content');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        modal.classList.add('visible');
        content.innerHTML = '<div style="text-align:center; padding-top:100px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const data = await fetchWeather(lat, lon);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        previewData = { lat, lon, name, region };

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—Ñ—Ñ–∏–∫—Å 'prev' –¥–ª—è ID)
        content.innerHTML = buildHTML(data, {name, region}, 'prev');
        
        // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
        setTimeout(() => drawSunGraph('sun-canvas-prev', data), 100);

        // –†–∏—Å—É–µ–º —Ñ–æ–Ω –ø—Ä–µ–≤—å—é (–∫–æ–ø–∏—è –ª–æ–≥–∏–∫–∏ —Ñ–æ–Ω–∞)
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω –≤ CSS, 
        // –∏–ª–∏ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å updateBackground –¥–ª—è preview canvas
    }

    function closePreview() {
        document.getElementById('preview-modal').classList.remove('visible');
        previewData = null;
    }

    function addToFavorites() {
        if (!previewData) return;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
        const exists = cities.some(c => 
            Math.abs(c.lat - previewData.lat) < 0.01 && 
            Math.abs(c.lon - previewData.lon) < 0.01
        );

        if (exists) {
            alert('–≠—Ç–æ—Ç –≥–æ—Ä–æ–¥ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω!');
            return;
        }

        cities.push(previewData);
        saveFavorites();
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–æ–≤–æ–º—É –≥–æ—Ä–æ–¥—É
        currentIdx = cities.length - 1;
        renderSlider();
        closePreview();
    }

    // --- –°–≤–∞–π–ø—ã –∏ –ù–∞–≤–∏–≥–∞—Ü–∏—è ---
    function updateTransform() {
        document.getElementById('slider').style.transform = `translateX(-${currentIdx * 100}vw)`;
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏
        document.querySelectorAll('.dot').forEach((d, i) => {
            d.classList.toggle('active', i === currentIdx);
        });
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω (–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å –≤ –∫—ç—à–µ DOM - —Å–ª–æ–∂–Ω–µ–µ, 
        // –ª—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –î–ª—è –¥–µ–º–æ –ø–µ—Ä–µ-—Ñ–µ—Ç—á–∏–º –∏–ª–∏ –æ—Å—Ç–∞–≤–∏–º —Ñ–æ–Ω —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞)
        // –í renderSlider —Ñ–æ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞—á–∞
    const viewport = document.getElementById('viewport');
    
    viewport.addEventListener('touchstart', e => {
        touchStart = e.touches[0].clientX;
    }, {passive: true});

    viewport.addEventListener('touchend', e => {
        const touchEnd = e.changedTouches[0].clientX;
        const diff = touchStart - touchEnd;

        if (Math.abs(diff) > 50) { // –ü–æ—Ä–æ–≥ —Å–≤–∞–π–ø–∞
            if (diff > 0 && currentIdx < cities.length - 1) {
                currentIdx++;
            } else if (diff < 0 && currentIdx > 0) {
                currentIdx--;
            }
            updateTransform();
            // –û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–ª–∞–π–¥–∞
            // (–í –∏–¥–µ–∞–ª–µ –Ω–∞–¥–æ —Ö—Ä–∞–Ω–∏—Ç—å weatherData –≤ –º–∞—Å—Å–∏–≤–µ, –∑–¥–µ—Å—å —É–ø—Ä–æ—â–µ–Ω–∏–µ)
            const activePage = document.getElementById(`city-page-${currentIdx}`);
            // –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–µ–Ω–∏–≤—É—é –ø–æ–¥–≥—Ä—É–∑–∫—É —Ñ–æ–Ω–∞
        }
    }, {passive: true});


    // --- AI –¢–µ–∫—Å—Ç—ã ---
    function getAIAdvice(temp, code, wind) {
        let text = "";
        if (code >= 95) text = "–í–Ω–∏–º–∞–Ω–∏–µ! –ì—Ä–æ–∑–∞. –ù–∞—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ—Å—Ç–∞—Ç—å—Å—è –¥–æ–º–∞ –∏ –æ—Ç–∫–ª—é—á–∏—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–±–æ—Ä—ã. –ù–∞ —É–ª–∏—Ü–µ –∫—Ä–∞–π–Ω–µ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ.";
        else if (code >= 71) text = "–ò–¥–µ—Ç —Å–Ω–µ–≥. –û—Ç–ª–∏—á–Ω–∞—è –ø–æ–≥–æ–¥–∞ –¥–ª—è –∑–∏–º–Ω–µ–π –ø—Ä–æ–≥—É–ª–∫–∏, –Ω–æ –¥–æ—Ä–æ–≥–∏ —Å–∫–æ–ª—å–∑–∫–∏–µ. –û–¥–µ–≤–∞–π—Ç–µ—Å—å —Ç–µ–ø–ª–æ –∏ –Ω–æ—Å–∏—Ç–µ —É–¥–æ–±–Ω—É—é –æ–±—É–≤—å.";
        else if (code >= 51) text = "–ù–∞ —É–ª–∏—Ü–µ –¥–æ–∂–¥—å. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–æ–Ω—Ç! –í —Ç–∞–∫—É—é –ø–æ–≥–æ–¥—É –ª–µ–≥–∫–æ –ø—Ä–æ–º–æ—á–∏—Ç—å –Ω–æ–≥–∏, –≤—ã–±–∏—Ä–∞–π—Ç–µ –Ω–µ–ø—Ä–æ–º–æ–∫–∞–µ–º—É—é –æ–±—É–≤—å.";
        else if (temp < 0) text = "–ú–æ—Ä–æ–∑–Ω–æ! –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–¥–µ–Ω—å—Ç–µ —à–∞–ø–∫—É, —à–∞—Ä—Ñ –∏ –ø–µ—Ä—á–∞—Ç–∫–∏. –ò–∑–±–µ–≥–∞–π—Ç–µ –¥–æ–ª–≥–æ–≥–æ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è –Ω–∞ –≤–µ—Ç—Ä—É.";
        else if (temp > 25) text = "–ñ–∞—Ä–∫–æ. –ü–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–Ω—ã–π –∫—Ä–µ–º –∏ —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –¥–µ—Ä–∂–∞—Ç—å—Å—è –≤ —Ç–µ–Ω–∏.";
        else if (wind > 15) text = "–û—á–µ–Ω—å –≤–µ—Ç—Ä–µ–Ω–æ! –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –≤–æ–∑–ª–µ –¥–µ—Ä–µ–≤—å–µ–≤ –∏ —à–∞—Ç–∫–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –û—â—É—â–∞–µ—Ç—Å—è —Ö–æ–ª–æ–¥–Ω–µ–µ, —á–µ–º –µ—Å—Ç—å.";
        else text = "–ü–æ–≥–æ–¥–∞ —Å–ø–æ–∫–æ–π–Ω–∞—è –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è. –û—Ç–ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫ –∏–ª–∏ —Ä–µ—à–µ–Ω–∏—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –¥–µ–ª –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ.";
        
        return text + " –ñ–µ–ª–∞—é –æ—Ç–ª–∏—á–Ω–æ–≥–æ –¥–Ω—è!";
    }

    // --- –£—Ç–∏–ª–∏—Ç—ã ---
    function getWeatherIcon(code, isDay) {
        if (code === 0) return isDay ? '‚òÄÔ∏è' : 'üåô';
        if (code <= 3) return isDay ? '‚õÖ' : '‚òÅÔ∏è';
        if (code >= 95) return '‚õàÔ∏è';
        if (code >= 71) return '‚ùÑÔ∏è';
        if (code >= 51) return 'üåßÔ∏è';
        return 'üå•Ô∏è';
    }

    function getWeatherDesc(code) {
        const m = {0:'–Ø—Å–Ω–æ', 1:'–û–±–ª–∞—á–Ω–æ', 2:'–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è', 3:'–ü–∞—Å–º—É—Ä–Ω–æ', 45:'–¢—É–º–∞–Ω', 51:'–ú–æ—Ä–æ—Å—å', 61:'–î–æ–∂–¥—å', 71:'–°–Ω–µ–≥', 95:'–ì—Ä–æ–∑–∞'};
        return m[code] || '–û—Å–∞–¥–∫–∏';
    }

    // --- –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–æ–Ω–∞ (Canvas) ---
    const bgCanvas = document.getElementById('bg-canvas');
    const bgCtx = bgCanvas.getContext('2d');
    let particles = [];
    let bgState = { r:0, g:0, b:0, isDay: true, code: 0 };

    function resizeCanvas() {
        bgCanvas.width = window.innerWidth;
        bgCanvas.height = window.innerHeight;
    }

    function updateBackground(data) {
        const isDay = data.current.is_day;
        const code = data.current.weather_code;
        bgState.isDay = isDay;
        bgState.code = code;
        
        // –°–±—Ä–æ—Å —á–∞—Å—Ç–∏—Ü
        particles = [];
        const count = (code >= 51 || code === 3) ? 100 : 30; // –ë–æ–ª—å—à–µ —á–∞—Å—Ç–∏—Ü –¥–ª—è –¥–æ–∂–¥—è/—Å–Ω–µ–≥–∞
        
        for(let i=0; i<count; i++) {
            particles.push({
                x: Math.random() * bgCanvas.width,
                y: Math.random() * bgCanvas.height,
                speed: 0.5 + Math.random() * 2,
                size: Math.random() * 2
            });
        }
    }

    function loopAnimation() {
        // –û—á–∏—Å—Ç–∫–∞
        bgCtx.clearRect(0,0,bgCanvas.width, bgCanvas.height);
        
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç
        let topColor, botColor;
        
        if (bgState.isDay) {
            if (bgState.code >= 51 || bgState.code === 3) { topColor = '#5c6fa3'; botColor = '#8ba3c7'; } // –ü–∞—Å–º—É—Ä–Ω–æ
            else { topColor = '#2980b9'; botColor = '#6dd5fa'; } // –Ø—Å–Ω–æ
        } else {
            topColor = '#0f2027'; botColor = '#2c5364'; // –ù–æ—á—å
        }
        
        const grad = bgCtx.createLinearGradient(0,0,0,bgCanvas.height);
        grad.addColorStop(0, topColor);
        grad.addColorStop(1, botColor);
        bgCtx.fillStyle = grad;
        bgCtx.fillRect(0,0,bgCanvas.width, bgCanvas.height);

        // –ß–∞—Å—Ç–∏—Ü—ã (–ó–≤–µ–∑–¥—ã / –î–æ–∂–¥—å / –°–Ω–µ–≥)
        bgCtx.fillStyle = 'rgba(255,255,255,0.6)';
        bgCtx.beginPath();
        
        const isRain = bgState.code >= 51 && bgState.code <= 69;
        const isSnow = bgState.code >= 71;
        
        particles.forEach(p => {
            if (isRain) {
                p.y += p.speed * 4;
                if(p.y > bgCanvas.height) p.y = -10;
                bgCtx.rect(p.x, p.y, 1, p.size * 5); // –ö–∞–ø–ª–∏
            } else if (isSnow) {
                p.y += p.speed;
                p.x += Math.sin(p.y * 0.05);
                if(p.y > bgCanvas.height) p.y = -5;
                bgCtx.moveTo(p.x, p.y);
                bgCtx.arc(p.x, p.y, p.size, 0, Math.PI*2); // –°–Ω–µ–∂–∏–Ω–∫–∏
            } else if (!bgState.isDay && bgState.code < 3) {
                // –ó–≤–µ–∑–¥—ã
                bgCtx.moveTo(p.x, p.y);
                bgCtx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            }
        });
        bgCtx.fill();

        requestAnimationFrame(loopAnimation);
    }
</script>
</body>
</html>

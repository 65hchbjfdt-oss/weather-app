<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather iOS Ultimate AI</title>
    <style>
        :root { 
            --glass: rgba(30, 30, 30, 0.65); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --blur: blur(40px); 
            --spring: cubic-bezier(0.25, 0.8, 0.25, 1);
            --accent: #4cd964;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        
        canvas#bg { position: fixed; inset: 0; z-index: -1; }

        .content-wrapper {
            max-width: 500px; margin: 0 auto; height: 100vh;
            position: relative; background: transparent;
        }

        /* --- HEADER (SEARCH & MENU) --- */
        header { 
            padding: 40px 20px 10px; 
            position: absolute; top: 0; left: 0; right: 0; 
            z-index: 1000; 
            display: flex; 
            gap: 10px; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); 
            pointer-events: none; 
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ü–ö –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (min-width: 768px) {
            header {
                justify-content: center; /* –¶–µ–Ω—Ç—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç */
            }
            .search-wrapper {
                flex: 0 1 400px !important; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞, –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º */
            }
        }

        .search-wrapper { flex: 1; pointer-events: auto; position: relative; }
        .search-box { display: flex; align-items: center; background: rgba(40,40,40,0.7); backdrop-filter: var(--blur); border-radius: 14px; padding: 8px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid var(--glass-border); }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 17px; outline: none; margin-left: 8px; }
        
        #results { position: absolute; top: 50px; left: 0; right: 0; background: rgba(30,30,30,0.95); border-radius: 14px; overflow: hidden; display: none; z-index: 2500; border: 1px solid var(--glass-border); backdrop-filter: blur(50px); max-height: 300px; overflow-y: auto; }
        .res-item { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .res-sub { font-size: 12px; opacity: 0.6; margin-top: 2px; line-height: 1.3; }
        
        #stage { height: 100%; width: 100%; position: relative; overflow: hidden; }
        .page-container {
            position: absolute; inset: 0; padding: 110px 20px 140px;
            transition: opacity 0.4s ease; overflow-y: auto; scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; display: none; opacity: 0;
            scrollbar-width: none; 
        }
        .page-container::-webkit-scrollbar { display: none; }
        .page-container.active { display: block; opacity: 1; z-index: 5; }

        .city-header { text-align: center; margin-bottom: 30px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .city-name { font-size: 32px; font-weight: 600; }
        .temp-big { font-size: 90px; font-weight: 200; letter-spacing: -2px; line-height: 1.1; }
        .condition-text { font-size: 18px; font-weight: 500; opacity: 0.9; text-transform: capitalize; }
        .hl-temp { font-size: 18px; font-weight: 500; margin-top: 5px; }

        .card { 
            background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border-radius: 20px; padding: 15px; border: 1px solid var(--glass-border); margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .card-label { font-size: 13px; opacity: 0.6; text-transform: uppercase; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }

        .h-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-item { text-align: center; min-width: 60px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .wind-sm { font-size: 11px; opacity: 0.7; display: flex; align-items: center; gap: 2px; margin-top: 2px; }

        .day-row { display: grid; grid-template-columns: 1.2fr 0.3fr 0.8fr 1fr; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 16px; font-weight: 500; }
        .day-row:last-child { border: none; }
        .day-date { display: flex; flex-direction: column; }
        .day-sub { font-size: 12px; opacity: 0.5; font-weight: 400; }
        .day-wind { font-size: 12px; opacity: 0.7; display: flex; align-items: center; gap: 4px; justify-content: flex-start; }
        .temp-range { display: flex; gap: 8px; justify-content: flex-end; }
        .temp-night { opacity: 0.5; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .tile { aspect-ratio: 1; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: transform 0.2s; }
        .tile:active { transform: scale(0.97); }
        .tile-val { font-size: 24px; font-weight: 500; margin-top: 5px; }
        .tile-sub { font-size: 13px; opacity: 0.7; }

        /* --- AI GRAPH UPGRADE --- */
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .vote-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; transition: opacity 0.5s; }
        .vote-btn { 
            background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 5px; 
            text-align: center; font-size: 12px; cursor: pointer; border: 1px solid transparent;
            transition: 0.3s var(--spring);
        }
        .vote-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .vote-btn.disabled { opacity: 0.3; pointer-events: none; }

        #ai-thank-you { font-size: 16px; color: #4cd964; text-align: center; margin-bottom: 10px; display: none; }

        .ai-graph-container {
            display: flex; height: 180px; margin-top: 15px; position: relative;
        }

        .y-axis { 
            width: 30px; display: flex; flex-direction: column; justify-content: space-between; 
            font-size: 10px; opacity: 0.5; text-align: right; 
            padding-right: 5px; 
            padding-bottom: 25px; 
            padding-top: 15px;
        }
        .y-axis-label {
            position: absolute; left: 0; top: -10px; font-size: 9px; opacity: 0.6; width: 100%; text-align: left;
        }

        .graph-area { 
            flex: 1; 
            position: relative; 
            height: 140px; 
            top: 10px; 
            margin-bottom: 0; 
        }
        
        svg.ai-svg { width: 100%; height: 100%; overflow: visible; }
        
        path.graph-line { 
            fill: none; stroke: var(--accent); stroke-width: 2.5; stroke-linecap: round; 
            transition: d 2s ease-in-out; 
        }
        path.graph-fill { 
            fill: rgba(76, 217, 100, 0.15); stroke: none; 
            transition: d 2s ease-in-out; 
        }
        
        .html-dot {
            position: absolute; width: 10px; height: 10px;
            background: #000; border: 2px solid var(--accent); border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 5;
            pointer-events: none; 
            transition: top 2s ease-in-out; 
        }

        .click-zone { 
            position: absolute; width: 40px; height: 40px;
            background: transparent; transform: translate(-50%, -50%);
            z-index: 10; cursor: pointer;
        }

        /* Tooltips */
        .chart-tooltip {
            position: absolute; background: rgba(255,255,255,0.95); color: #000;
            padding: 6px 10px; border-radius: 10px; font-size: 13px; font-weight: 600;
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
            white-space: nowrap; z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .chart-tooltip.pos-top::after {
            content: ''; position: absolute; left: 50%; bottom: -5px; transform: translateX(-50%);
            border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-top: 5px solid rgba(255,255,255,0.95);
        }
        .chart-tooltip.pos-bottom::after {
            content: ''; position: absolute; left: 50%; top: -5px; transform: translateX(-50%);
            border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-bottom: 5px solid rgba(255,255,255,0.95);
        }
        .chart-tooltip.align-left::after { left: 20%; }
        .chart-tooltip.align-right::after { left: 80%; }

        .x-labels { 
            position: absolute; 
            bottom: -5px; 
            left: 30px; right: 0; 
            height: 20px; 
            display: flex; justify-content: space-between; 
        }
        .x-label { 
            font-size: 10px; opacity: 0.5; text-align: center; width: 40px; transform: translateX(0); 
        }
        .x-label:first-child { text-align: left; transform: translateX(-10px); }
        .x-label:last-child { text-align: right; transform: translateX(10px); }

        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.7); backdrop-filter: blur(20px); padding: 8px 16px; border-radius: 20px; display: flex; gap: 8px; z-index: 2000; border: 1px solid rgba(255,255,255,0.1); }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; cursor: pointer; }
        .dot.active { background: #fff; transform: scale(1.2); }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; background: rgba(60,60,60,0.6); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; pointer-events: auto; }

        .desktop-arrow {
            position: fixed; top: 50%; transform: translateY(-50%);
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            display: none; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; z-index: 1500; transition: 0.3s;
        }
        .desktop-arrow:hover { background: rgba(255,255,255,0.25); }
        .arrow-left { left: 20px; }
        .arrow-right { right: 20px; }
        @media (min-width: 768px) { .desktop-arrow { display: flex; } }

        .layer { 
            position: fixed; inset: 0; z-index: 3000; 
            transform: translateX(100%); transition: transform 0.4s var(--spring); 
            display: flex; justify-content: center; background: #000; 
        }
        @media (min-width: 768px) { .layer { background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); } }
        .layer.show { transform: translateX(0); }
        
        .layer-inner {
            width: 100%; max-width: 500px; height: 100%; background: #000;
            position: relative; display: flex; flex-direction: column;
            border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1);
        }
        .layer.modal { background: transparent; align-items: flex-end; transform: translateY(100%); }
        .layer.modal .layer-inner {
            max-width: 500px; height: auto; max-height: 80vh;
            background: rgba(20,20,20,0.95); backdrop-filter: blur(30px);
            border-top-left-radius: 25px; border-top-right-radius: 25px;
            margin: 0 auto; border: 1px solid rgba(255,255,255,0.15);
        }
        .layer.modal.show { transform: translateY(0); }

        .layer-header { padding: 50px 20px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .layer-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        .ai-box { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 15px; margin-top: 20px; }
        .ai-title { font-size: 14px; font-weight: 700; color: #FFD60A; margin-bottom: 8px; }
        .ai-text { font-size: 15px; line-height: 1.4; opacity: 0.9; }

        .list-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    </style>
</head>
<body>

    <canvas id="bg"></canvas>

    <div class="content-wrapper">
        <header id="main-header">
            <div class="btn-circle" onclick="toggleSettings(true)" style="margin-right: 10px;">‚ò∞</div>
            <div class="search-wrapper">
                <div class="search-box">
                    <span style="opacity:0.6">üîç</span>
                    <input id="q" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." oninput="doSearch(this.value)">
                </div>
                <div id="results"></div>
            </div>
        </header>

        <div id="stage"></div>
        <div class="nav-dock" id="pagination"></div>
    </div>

    <div class="desktop-arrow arrow-left" onclick="movePage(-1)">‚Äπ</div>
    <div class="desktop-arrow arrow-right" onclick="movePage(1)">‚Ä∫</div>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò (–°–ª–æ–π) -->
    <div id="settings-layer" class="layer">
        <div class="layer-inner">
            <div class="layer-header">
                <h1 style="margin:0; font-size:28px;">–ú–æ–∏ –≥–æ—Ä–æ–¥–∞</h1>
                <div class="btn-circle" onclick="toggleSettings(false)">‚úï</div>
            </div>
            <div class="layer-content">
                <div class="list-item" onclick="detectLocation()" style="background:rgba(76, 217, 100, 0.2); border:1px solid rgba(76, 217, 100, 0.4);">
                    <div style="display:flex; align-items:center; gap:10px">
                        <span>üìç</span>
                        <b>–ù–∞–π—Ç–∏ –º–µ–Ω—è</b>
                    </div>
                </div>
                <div id="fav-list"></div>
                <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                    <h3 style="opacity:0.5">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="list-item" onclick="toggleUnit()">
                        <span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span>
                        <span id="unit-disp" style="color:#0a84ff">¬∞C</span>
                    </div>
                    <div class="list-item" onclick="toggleWindUnit()">
                        <span>–í–µ—Ç–µ—Ä</span>
                        <span id="wind-disp" style="color:#0a84ff">–∫–º/—á</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–†–ï–î–ü–†–û–°–ú–û–¢–† (–°–ª–æ–π) -->
    <div id="preview-layer" class="layer">
        <div class="layer-inner" style="background:rgba(20,20,20,0.95); backdrop-filter:blur(50px);">
            <div class="layer-header">
                <div class="btn-circle" onclick="closePreview()">‚úï</div>
                <span style="font-weight:600">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
                <div style="width:40px"></div>
            </div>
            <div class="layer-content" id="preview-inner"></div>
            <div style="padding:20px; text-align:center;">
                <button onclick="confirmAddCity()" style="background:#fff; color:#000; padding:14px 40px; border-radius:30px; border:none; font-weight:600; font-size:16px; cursor:pointer">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –°–û–õ–ù–¶–ê -->
    <div id="sun-modal" class="layer modal">
        <div class="layer-inner">
            <div class="layer-header" style="padding-top:20px">
                <span style="font-size:18px; font-weight:600">–°–æ–ª–Ω—Ü–µ –∏ –õ—É–Ω–∞</span>
                <div class="btn-circle" onclick="document.getElementById('sun-modal').classList.remove('show')">‚úï</div>
            </div>
            <div class="layer-content" id="sun-modal-content"></div>
        </div>
    </div>

<script>
    // --- State ---
    let cities = []; 
    let currentIndex = 0;
    let unit = localStorage.getItem('unit') || 'C';
    let windUnit = localStorage.getItem('windUnit') || 'kmh'; 
    let tempCity = null;
    let userGeo = null; 

    // --- Init ---
    async function init() {
        resize(); window.addEventListener('resize', resize);
        
        navigator.geolocation.getCurrentPosition(pos => {
            userGeo = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        }, err => console.log('Geo error'));

        const saved = JSON.parse(localStorage.getItem('savedCities') || '[]');
        if (saved.length > 0) cities = saved;
        else cities = [{lat: 55.75, lon: 37.62, name: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è', isHome: true}];

        initStageDOM();
        loadWeather(0);
        updateSettingsUI();
        
        initParticles();
        requestAnimationFrame(loop);
    }

    function initStageDOM() {
        const stage = document.getElementById('stage');
        stage.innerHTML = '';
        cities.forEach((c, i) => {
            const div = document.createElement('div');
            div.className = 'page-container';
            div.id = `page-${i}`;
            stage.appendChild(div);
        });
        updatePagination();
    }

    // --- Navigation & Actions ---
    function movePage(dir) {
        let next = currentIndex + dir;
        if(next >= 0 && next < cities.length) loadWeather(next);
    }
    
    function toggleSettings(v) { 
        document.getElementById('settings-layer').className = v ? 'layer show' : 'layer'; 
        if(v) renderFav(); 
    }

    // --- GEO & SEARCH ---
    async function doSearch(q) {
        if(q.length < 2) { document.getElementById('results').style.display='none'; return; }
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=ru`).then(x=>x.json());
        if(!r.results) return;
        const resBox = document.getElementById('results');
        resBox.innerHTML = r.results.map(i => {
            const details = [i.country, i.admin1, i.admin2, i.admin3, i.admin4].filter(Boolean).join(', ');
            return `
            <div class="res-item" onclick="openPreview(${i.latitude}, ${i.longitude}, '${i.name}', '${i.country||''}')">
                <div class="res-main">${i.name}</div>
                <div class="res-sub">${details}</div>
            </div>
            `;
        }).join('');
        resBox.style.display = 'block';
    }

    function detectLocation() {
        toggleSettings(false);
        if(!navigator.geolocation) { alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }
        
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ API –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞, –Ω–æ –¥–ª—è —Ä–µ–≤–µ—Ä—Å–∞ (–ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º) - API open-meteo –Ω–µ –∏–º–µ–µ—Ç –ø—Ä—è–º–æ–≥–æ reverse,
            // –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º openstreetmap (–±–µ—Å–ø–ª–∞—Ç–Ω–æ) –∏–ª–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ.
            // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –≤–æ–∑—å–º–µ–º open-meteo forecast timezone/city logic –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫—É "–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ"
            // –ù–æ –ª—É—á—à–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ reverse geocoding
            
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ru`);
                const data = await res.json();
                const name = data.address.city || data.address.town || data.address.village || '–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                const country = data.address.country || '';
                
                const newCity = {lat, lon, name, country, isHome: true};
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ
                const exists = cities.find(c => Math.abs(c.lat - lat) < 0.01 && Math.abs(c.lon - lon) < 0.01);
                
                if(!exists) {
                    cities.unshift(newCity); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
                } else {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–µ–º—É
                    const idx = cities.indexOf(exists);
                    loadWeather(idx);
                    return;
                }
                
                localStorage.setItem('savedCities', JSON.stringify(cities));
                initStageDOM();
                loadWeather(0);
                
            } catch(e) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥');
            }
        }, () => alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏'));
    }

    async function fetchWeather(lat, lon) {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day,wind_speed_10m,wind_direction_10m,pressure_msl&hourly=temperature_2m,weather_code,wind_speed_10m,wind_direction_10m,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,daylight_duration,wind_speed_10m_max,wind_direction_10m_dominant&timezone=auto`;
        return await fetch(url).then(r=>r.json());
    }

    // --- Preview & Management ---
    async function openPreview(lat, lon, name, country) {
        document.getElementById('results').style.display = 'none';
        document.getElementById('q').value = '';
        const layer = document.getElementById('preview-layer');
        const content = document.getElementById('preview-inner');
        
        content.innerHTML = '<div style="text-align:center; padding-top:50px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        layer.classList.add('show');
        tempCity = {lat, lon, name, country};
        const data = await fetchWeather(lat, lon);
        content.innerHTML = generateHTML(data, tempCity, true);
        updateEnv(data);
    }

    function closePreview() {
        document.getElementById('preview-layer').classList.remove('show');
        tempCity = null;
        loadWeather(currentIndex); 
    }

    function confirmAddCity() {
        if(!tempCity) return;
        cities.push(tempCity);
        localStorage.setItem('savedCities', JSON.stringify(cities));
        initStageDOM();
        closePreview();
        loadWeather(cities.length-1);
    }

    function removeCity(i) {
        cities.splice(i,1);
        localStorage.setItem('savedCities', JSON.stringify(cities));
        renderFav();
        initStageDOM();
        let next = Math.min(i, cities.length-1);
        if(cities.length === 0) next = 0; 
        loadWeather(next);
    }

    // --- Helpers ---
    function getWindDir(deg) {
        const dirs = ["–°", "–°–í", "–í", "–Æ–í", "–Æ", "–Æ–ó", "–ó", "–°–ó"];
        const idx = Math.round(((deg %= 360) < 0 ? deg + 360 : deg) / 45) % 8;
        return dirs[idx];
    }
    
    function convertWind(val, unit) {
        if(unit === 'ms') return { v: Math.round(val/3.6), l: '–º/—Å' };
        if(unit === 'mph') return { v: Math.round(val/1.609), l: '–º–∏–ª—å/—á' };
        return { v: Math.round(val), l: '–∫–º/—á' };
    }

    // --- Rendering ---
    async function loadWeather(idx) {
        currentIndex = idx;
        const city = cities[idx];
        const el = document.getElementById(`page-${idx}`);
        
        document.querySelectorAll('.page-container').forEach((p, i) => {
            p.classList.remove('active');
            if(i === idx) p.classList.add('active');
        });
        updatePagination();

        if(el.innerHTML.length < 50 || el.dataset.unit !== unit || el.dataset.wunit !== windUnit) {
            el.innerHTML = '<div style="text-align:center; padding-top:100px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            const data = await fetchWeather(city.lat, city.lon);
            el.dataset.unit = unit;
            el.dataset.wunit = windUnit;
            el.innerHTML = generateHTML(data, city, false);
            if(idx === currentIndex) updateEnv(data);
        } else {
             const data = await fetchWeather(city.lat, city.lon); 
             if(idx === currentIndex) updateEnv(data);
        }
    }

    function generateHTML(data, city, isPreview) {
        const cur = data.current;
        const d = data.daily;
        const h = data.hourly;
        
        const temp = unit==='F' ? Math.round(cur.temperature_2m*9/5+32) : Math.round(cur.temperature_2m);
        const min = unit==='F' ? Math.round(d.temperature_2m_min[0]*9/5+32) : Math.round(d.temperature_2m_min[0]);
        const max = unit==='F' ? Math.round(d.temperature_2m_max[0]*9/5+32) : Math.round(d.temperature_2m_max[0]);
        const wInfo = convertWind(cur.wind_speed_10m, windUnit);

        const nowStr = cur.time.substring(0, 13);
        let startIdx = h.time.findIndex(t => t.startsWith(nowStr));
        if(startIdx === -1) startIdx = 0;
        
        let hourlyHTML = '';
        for(let i=0; i<12; i++) {
            const idx = startIdx + i;
            if(idx >= h.time.length) break;
            const hour = h.time[idx].split('T')[1].split(':')[0];
            const dispT = i===0 ? '–°–µ–π—á–∞—Å' : hour;
            const hTemp = unit==='F' ? Math.round(h.temperature_2m[idx]*9/5+32) : Math.round(h.temperature_2m[idx]);
            const wDeg = h.wind_direction_10m[idx];
            const hWInfo = convertWind(h.wind_speed_10m[idx], windUnit);
            
            hourlyHTML += `
                <div class="h-item">
                    <span style="font-weight:600; font-size:14px">${dispT}</span>
                    <span style="font-size:22px">${getWIcon(h.weather_code[idx])}</span>
                    <span style="font-size:16px; font-weight:500">${hTemp}¬∞</span>
                    <div class="wind-sm">
                        <span style="transform:rotate(${wDeg}deg); display:inline-block">‚Üì</span> ${hWInfo.v}
                    </div>
                </div>`;
        }

        let dailyHTML = '';
        for(let i=0; i<5; i++) {
            const date = new Date(d.time[i]);
            const dayName = i===0 ? '–°–µ–≥–æ–¥–Ω—è' : date.toLocaleDateString('ru-RU', {weekday:'short'});
            const dateNum = date.toLocaleDateString('ru-RU', {day:'numeric', month:'short'});
            const dMin = unit==='F' ? Math.round(d.temperature_2m_min[i]*9/5+32) : Math.round(d.temperature_2m_min[i]);
            const dMax = unit==='F' ? Math.round(d.temperature_2m_max[i]*9/5+32) : Math.round(d.temperature_2m_max[i]);
            const dWInfo = convertWind(d.wind_speed_10m_max[i], windUnit);
            const dWDeg = d.wind_direction_10m_dominant[i];

            dailyHTML += `
                <div class="day-row">
                    <div class="day-date"><span>${dayName}</span><span class="day-sub">${dateNum}</span></div>
                    <div style="font-size:20px; text-align:center">${getWIcon(d.weather_code[i])}</div>
                    <div class="day-wind">
                        <span style="transform:rotate(${dWDeg}deg); display:inline-block">‚Üì</span>
                        <span>${dWInfo.v} ${dWInfo.l}</span>
                    </div>
                    <div class="temp-range"><span>${dMax}¬∞</span><span class="temp-night">${dMin}¬∞</span></div>
                </div>`;
        }

        const sunJson = encodeURIComponent(JSON.stringify({rise:d.sunrise[0], set:d.sunset[0], dur:d.daylight_duration[0]}));
        const aiId = isPreview ? 'preview' : cities.indexOf(city);
        
        const p1 = h.precipitation_probability[startIdx] || 0;
        const p2 = h.precipitation_probability[startIdx+1] || p1;
        const probs = [p1, p2];
        
        const c0 = h.weather_code[startIdx] !== undefined ? h.weather_code[startIdx] : cur.weather_code;
        const c1 = h.weather_code[startIdx+1] !== undefined ? h.weather_code[startIdx+1] : c0;
        const codes = [c0, c1];

        const canVote = checkLocation(city.lat, city.lon);
        const voteClass = canVote ? '' : 'disabled';
        const voteMsg = canVote ? '–£—Ç–æ—á–Ω–∏—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑:' : '–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏';

        return `
            <div class="city-header">
                <div class="city-name">${city.name}</div>
                <div class="condition-text">${getWDesc(cur.weather_code)}</div>
                <div class="temp-big">${temp}¬∞</div>
                <div class="hl-temp">–ú–∞–∫—Å.: ${max}¬∞ –ú–∏–Ω.: ${min}¬∞</div>
            </div>

            <!-- AI FORECAST BLOCK -->
            <div class="card">
                <div class="ai-header">
                    <div class="card-label" style="margin:0">ü§ñ AI-–ü–†–û–ì–ù–û–ó</div>
                    <div style="font-size:10px; opacity:0.5; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px">LIVE</div>
                </div>
                <div style="font-size:12px; opacity:0.7; margin-bottom:10px">${voteMsg}</div>
                
                <div class="vote-grid" id="vote-box-${aiId}">
                    <div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 0)">‚òÄÔ∏è –Ø—Å–Ω–æ</div>
                    <div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 1)">‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ</div>
                    <div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 2)">üåß –î–æ–∂–¥—å</div>
                    <div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 3)">‚ùÑÔ∏è –°–Ω–µ–≥</div>
                </div>
                <div id="ai-thank-you">–°–ø–∞—Å–∏–±–æ! –í–∞—à –≥–æ–ª–æ—Å —É—á—Ç–µ–Ω.</div>

                <div class="ai-graph-container">
                    <div class="y-axis-label">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤</div>
                    <div class="y-axis">
                        <span>100%</span><span>50%</span><span>0%</span>
                    </div>
                    <div class="graph-area" id="graph-area-${aiId}">
                        <div class="chart-tooltip" id="tooltip-${aiId}"></div>
                        <svg class="ai-svg" viewBox="0 0 300 100" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="grad-${aiId}" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="#4cd964" stop-opacity="0.3"/>
                                    <stop offset="100%" stop-color="#4cd964" stop-opacity="0"/>
                                </linearGradient>
                            </defs>
                            <path id="path-fill-${aiId}" class="graph-fill"></path>
                            <path id="path-line-${aiId}" class="graph-line"></path>
                        </svg>
                        <div id="dots-container-${aiId}" style="position:absolute; inset:0;"></div>
                    </div>
                    
                    <div class="x-labels">
                        <div class="x-label">–°–µ–π—á–∞—Å</div>
                        <div class="x-label">15–º</div>
                        <div class="x-label">30–º</div>
                        <div class="x-label">45–º</div>
                        <div class="x-label">60–º</div>
                    </div>
                </div>
            </div>

            <div class="card"><div class="card-label">üïì –ü–û–ß–ê–°–û–í–û–ô</div><div class="h-scroll">${hourlyHTML}</div></div>
            <div class="card"><div class="card-label">üìÖ 5 –î–ù–ï–ô</div>${dailyHTML}</div>
            
            <div class="grid-2">
                <div class="card tile" onclick="openSunDetail('${sunJson}')">
                    <div class="card-label">‚òÄÔ∏è –°–û–õ–ù–¶–ï</div>
                    <div class="tile-val">${d.sunset[0].split('T')[1]}</div>
                    <div class="tile-sub">–ó–∞–∫–∞—Ç</div>
                </div>
                <div class="card tile">
                    <div class="card-label">üí® –í–ï–¢–ï–†</div>
                    <div class="tile-val">${wInfo.v} <span style="font-size:16px">${wInfo.l}</span></div>
                    <div class="tile-sub">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${getWindDir(cur.wind_direction_10m)}</div>
                </div>
            </div>
            
            <div class="ai-box">
                <div class="ai-title">AI –°–û–í–ï–¢</div>
                <div class="ai-text">${getAIText(temp, cur.weather_code)}</div>
            </div>

            <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" 
                 onload="initAIGraph('${aiId}', [${probs}], [${codes}])" style="display:none"/>
        `;
    }

    // --- AI GRAPH SYSTEM ---
    const aiData = {};

    function checkLocation(lat, lon) {
        if(!userGeo) return false;
        return Math.abs(userGeo.lat - lat) < 0.1 && Math.abs(userGeo.lon - lon) < 0.1;
    }

    function initAIGraph(id, baseProbs, codes) {
        let pts = [];
        const start = baseProbs[0];
        const end = baseProbs[1];
        
        for(let i=0; i<5; i++) {
            let t = i / 4; 
            let val = start + (end - start) * t;
            val += (Math.random()-0.5) * 5; 
            pts.push(Math.max(0, Math.min(100, val)));
        }

        aiData[id] = { 
            points: pts, 
            base: [...pts], 
            voted: false, 
            codes: codes, 
            timer: null,
            liveTimer: null,
            activeDot: -1 // Track active dot to fix tooltip logic
        };
        
        renderGraph(id);

        if(aiData[id].liveTimer) clearInterval(aiData[id].liveTimer);
        aiData[id].liveTimer = setInterval(() => {
            aiData[id].points = aiData[id].points.map((val, idx) => {
                const base = aiData[id].base[idx];
                const noise = (Math.random() - 0.5) * 10; 
                let newVal = val + noise;
                newVal = (newVal + base) / 2;
                return Math.max(0, Math.min(100, newVal));
            });
            renderGraph(id, true);
        }, 10000);
    }

    function getGraphIcon(val, hourlyCode) {
        if(val <= 10) return getWIcon(hourlyCode);
        if(val <= 24) {
            if(hourlyCode >= 95) return 'üå©'; 
            if(hourlyCode <= 1) return '‚õÖ'; 
            return '‚òÅÔ∏è'; 
        }
        if(val <= 59) {
            if(hourlyCode <= 3) return 'üå¶';
            return 'üåß';
        }
        if(hourlyCode >= 71 && hourlyCode <= 79) return '‚ùÑÔ∏è';
        return 'üåß';
    }

    function renderGraph(id, isUpdate = false) {
        if(!aiData[id]) return;
        const d = aiData[id].points;
        const codes = aiData[id].codes;
        
        const svgW = 300, svgH = 100;
        const stepX = svgW / 4;
        
        let path = `M0,${svgH - (d[0]/100)*svgH}`;
        for(let i=1; i<d.length; i++) {
            path += ` L${i*stepX},${svgH - (d[i]/100)*svgH}`;
        }

        const line = document.getElementById(`path-line-${id}`);
        const fill = document.getElementById(`path-fill-${id}`);
        const dotsContainer = document.getElementById(`dots-container-${id}`);
        const tooltip = document.getElementById(`tooltip-${id}`);
        
        if(line && fill) {
            line.setAttribute('d', path);
            fill.setAttribute('d', path + ` L${svgW},${svgH} L0,${svgH} Z`);
            
            if (isUpdate && dotsContainer.children.length === 5) {
                 Array.from(dotsContainer.children).forEach((group, i) => {
                     const val = d[i];
                     const cyPercent = 100 - val;
                     group.style.top = cyPercent + '%';
                 });
            } else {
                dotsContainer.innerHTML = '';
                d.forEach((val, i) => {
                    const cxPercent = i * 25; 
                    const cyPercent = 100 - val;
                    const relevantCode = i <= 2 ? codes[0] : codes[1];
                    const icon = getGraphIcon(val, relevantCode);

                    const group = document.createElement('div');
                    group.style.position = 'absolute';
                    group.style.left = cxPercent + '%';
                    group.style.top = cyPercent + '%'; 
                    group.style.width = '0'; group.style.height = '0';
                    group.style.transition = 'top 2s ease-in-out';

                    const dot = document.createElement('div');
                    dot.className = 'html-dot';
                    group.appendChild(dot);

                    const zone = document.createElement('div');
                    zone.className = 'click-zone';
                    group.appendChild(zone);

                    const handleClick = (e) => {
                        e.stopPropagation();
                        if(aiData[id].timer) clearTimeout(aiData[id].timer);

                        // --- NEW LOGIC: Toggle & Switch ---
                        
                        // 1. If clicking the SAME active dot -> Close it
                        if (aiData[id].activeDot === i && tooltip.style.opacity === '1') {
                            tooltip.style.opacity = 0;
                            aiData[id].activeDot = -1;
                            return;
                        }

                        // 2. Set new active dot
                        aiData[id].activeDot = i;

                        // 3. Reset Classes completely to prevent lengthening bug
                        tooltip.className = 'chart-tooltip';
                        
                        // 4. Calculate Position
                        if(val > 50) {
                            tooltip.classList.add('pos-bottom'); 
                            tooltip.style.top = cyPercent + '%';
                            tooltip.style.bottom = 'auto';
                            tooltip.style.marginTop = '15px'; 
                        } else {
                            tooltip.classList.add('pos-top');
                            tooltip.style.top = 'auto';
                            tooltip.style.bottom = (100 - cyPercent) + '%';
                            tooltip.style.marginBottom = '15px'; 
                        }

                        // 5. Horizontal Align
                        if(i === 0) {
                            tooltip.style.left = '0'; tooltip.classList.add('align-left');
                        } else if(i === 4) {
                            tooltip.style.left = 'auto'; tooltip.style.right = '0'; tooltip.classList.add('align-right');
                        } else {
                            tooltip.style.left = cxPercent + '%'; tooltip.style.transform = 'translateX(-50%)';
                        }

                        tooltip.innerHTML = `${icon} ${Math.round(val)}%`;
                        tooltip.style.opacity = 1;

                        aiData[id].timer = setTimeout(() => {
                            tooltip.style.opacity = 0;
                            aiData[id].activeDot = -1; // Reset active on timeout
                        }, 10000);
                    };

                    zone.addEventListener('click', handleClick);
                    dotsContainer.appendChild(group);
                });
            }
        }
    }

    function submitVote(id, type) {
        if(aiData[id].voted) return;
        if(document.querySelector(`#vote-box-${id} .vote-btn`).classList.contains('disabled')) return;

        aiData[id].voted = true;
        
        const box = document.getElementById(`vote-box-${id}`);
        const thx = document.querySelector(`#page-${id} #ai-thank-you`) || document.getElementById('ai-thank-you');
        
        box.style.opacity = 0;
        setTimeout(() => {
            box.style.display = 'none';
            thx.style.display = 'block';
            
            let factor = 0;
            if(type === 0) factor = -15; 
            else if(type === 1) factor = 5; 
            else factor = 20; 
            
            aiData[id].base = aiData[id].base.map(v => Math.max(0, Math.min(100, v + factor)));
            aiData[id].points = [...aiData[id].base];
            
            renderGraph(id);
        }, 500);
    }

    // --- Helpers ---
    function getWDesc(c) { const m={0:'–Ø—Å–Ω–æ',1:'–ú–∞–ª–æ–æ–±–ª.',2:'–û–±–ª–∞—á–Ω–æ',3:'–ü–∞—Å–º—É—Ä–Ω–æ',45:'–¢—É–º–∞–Ω',61:'–î–æ–∂–¥—å',71:'–°–Ω–µ–≥',95:'–ì—Ä–æ–∑–∞'}; return m[c]||'–û—Å–∞–¥–∫–∏'; }
    function getWIcon(c) { if(c===0)return'‚òÄÔ∏è'; if(c<=3)return'‚òÅÔ∏è'; if(c<=48)return'üå´'; if(c<=69)return'üåß'; if(c<=79)return'‚ùÑÔ∏è'; if(c>=95)return'‚ö°Ô∏è'; return'üåß'; }
    function getAIText(t,c) { if(c>=95)return "–ì—Ä–æ–∑–∞! –ù–µ —Å—Ç–æ–π—Ç–µ –ø–æ–¥ –¥–µ—Ä–µ–≤—å—è–º–∏."; if(c>=60)return "–ë–µ—Ä–∏—Ç–µ –∑–æ–Ω—Ç, —Å–∫–æ—Ä–æ –ø–æ–ª—å–µ—Ç."; if(t<0)return "–û–¥–µ–≤–∞–π—Ç–µ—Å—å —Ç–µ–ø–ª–µ–µ."; return "–û—Ç–ª–∏—á–Ω–∞—è –ø–æ–≥–æ–¥–∞ –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏."; }

    // --- Settings UI ---
    function renderFav() {
        document.getElementById('fav-list').innerHTML = cities.map((c,i)=>`
            <div class="list-item" onclick="loadWeather(${i}); toggleSettings(false)">
                <div><b>${c.name}</b><div style="font-size:12px;opacity:0.6">${c.country}</div></div>
                ${!c.isHome ? `<div class="btn-circle" style="color:#ff453a;border-color:rgba(255,69,58,0.3)" onclick="event.stopPropagation(); removeCity(${i})">‚úï</div>` : ''}
            </div>`).join('');
    }
    function toggleUnit() { unit = unit==='C'?'F':'C'; localStorage.setItem('unit', unit); updateSettingsUI(); loadWeather(currentIndex); }
    function toggleWindUnit() { 
        const next = { 'kmh':'ms', 'ms':'mph', 'mph':'kmh' };
        windUnit = next[windUnit]; localStorage.setItem('windUnit', windUnit); updateSettingsUI(); loadWeather(currentIndex); 
    }
    function updateSettingsUI() {
        document.getElementById('unit-disp').innerText = '¬∞'+unit;
        const wLabels = {'kmh':'–∫–º/—á', 'ms':'–º/—Å', 'mph':'–º–∏–ª—å/—á'};
        document.getElementById('wind-disp').innerText = wLabels[windUnit];
    }
    function updatePagination() {
        const p = document.getElementById('pagination');
        if(cities.length < 2) p.style.display='none';
        else {
            p.style.display='flex';
            p.innerHTML = cities.map((_,i)=>`<div class="dot ${i===currentIndex?'active':''}" onclick="loadWeather(${i})"></div>`).join('');
        }
    }
    function openSunDetail(j) {
        const d = JSON.parse(decodeURIComponent(j));
        document.getElementById('sun-modal-content').innerHTML = `
            <div style="text-align:center;padding:40px 0">
                <div style="font-size:50px">${Math.floor(d.dur/3600)}—á ${Math.round((d.dur%3600)/60)}–º</div>
                <div style="opacity:0.6">–°–≤–µ—Ç–æ–≤–æ–π –¥–µ–Ω—å</div>
            </div>
            <div style="background:rgba(255,255,255,0.1); border-radius:15px; padding:20px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:15px"><span>–í–æ—Å—Ö–æ–¥</span><b>${d.rise.split('T')[1]}</b></div>
                <div style="display:flex;justify-content:space-between"><span>–ó–∞–∫–∞—Ç</span><b>${d.set.split('T')[1]}</b></div>
            </div>`;
        document.getElementById('sun-modal').classList.add('show');
    }

    // --- ANIMATION ENGINE ---
    const ctx = document.getElementById('bg').getContext('2d');
    let env = { w:0, h:0, code:0, day:1, items:[], clouds:[], stars:[] };

    function initParticles() {
        env.stars = [];
        for(let i=0; i<100; i++) env.stars.push({x:Math.random(), y:Math.random(), a:Math.random()});
    }

    function updateEnv(data) {
        env.code = data.current.weather_code;
        env.day = data.current.is_day;
        env.items = []; 
        env.clouds = [];
        if(env.code >= 1 && env.code <= 3 || env.code >= 45) {
            for(let i=0; i<6; i++) env.clouds.push({x:Math.random()*window.innerWidth, y:Math.random()*300, s:Math.random()*0.5+0.2});
        }
    }

    function resize() { env.w = window.innerWidth; env.h = window.innerHeight; ctx.canvas.width = env.w; ctx.canvas.height = env.h; }

    function loop() {
        ctx.clearRect(0,0,env.w,env.h);
        
        let g = ctx.createLinearGradient(0,0,0,env.h);
        const c = env.code;
        if(c >= 95) { g.addColorStop(0,'#232526'); g.addColorStop(1,'#414345'); }
        else if(c >= 51 || c===45) {
             if(env.day) { g.addColorStop(0,'#5C6575'); g.addColorStop(1,'#8E9CAB'); }
             else { g.addColorStop(0,'#1e2329'); g.addColorStop(1,'#2c3e50'); }
        } else if(c <= 2) {
             if(env.day) { g.addColorStop(0,'#2980b9'); g.addColorStop(1,'#6dd5fa'); }
             else { g.addColorStop(0,'#0f2027'); g.addColorStop(1,'#203a43'); }
        } else {
             if(env.day) { g.addColorStop(0,'#757F9A'); g.addColorStop(1,'#D7DDE8'); }
             else { g.addColorStop(0,'#2c3e50'); g.addColorStop(1,'#4ca1af'); }
        }
        ctx.fillStyle = g; ctx.fillRect(0,0,env.w,env.h);

        if(!env.day && c <= 2) {
            ctx.fillStyle = '#fff';
            env.stars.forEach(s => {
                ctx.globalAlpha = Math.abs(Math.sin(Date.now()/1000 + s.x*10)) * s.a;
                ctx.beginPath(); ctx.arc(s.x*env.w, s.y*env.h, 1.5, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        if(c <= 2) {
            let sx = env.day ? env.w*0.8 : env.w*0.8;
            let sy = env.h*0.15;
            if(env.day) {
                let rg = ctx.createRadialGradient(sx,sy,10,sx,sy,60);
                rg.addColorStop(0,'rgba(255,255,200,0.9)'); rg.addColorStop(1,'rgba(255,255,255,0)');
                ctx.fillStyle=rg; ctx.beginPath(); ctx.arc(sx,sy,80,0,Math.PI*2); ctx.fill();
                ctx.fillStyle='#FFD700'; ctx.beginPath(); ctx.arc(sx,sy,20,0,Math.PI*2); ctx.fill();
            } else {
                ctx.fillStyle='rgba(255,255,230,0.9)'; ctx.beginPath(); ctx.arc(sx,sy,25,0,Math.PI*2); ctx.fill();
            }
        }

        ctx.fillStyle = env.day ? 'rgba(255,255,255,0.3)' : 'rgba(200,200,200,0.1)';
        env.clouds.forEach(cl => {
            cl.x += cl.s; if(cl.x > env.w + 100) cl.x = -100;
            ctx.beginPath(); ctx.arc(cl.x, cl.y, 60, 0, Math.PI*2); ctx.arc(cl.x+50, cl.y+20, 70, 0, Math.PI*2); ctx.fill();
        });

        const isRain = (c>=50 && c<=69) || c>=95;
        const isSnow = c>=70 && c<=79;
        if(isRain || isSnow) {
            if(env.items.length < 150) env.items.push({x:Math.random()*env.w, y:-20, v:Math.random()*5+5, s:Math.random()*2});
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.fillStyle = '#fff';
            ctx.lineWidth = isSnow ? 0 : 1.5;
            env.items.forEach((p,i) => {
                p.y += p.v;
                if(p.y > env.h) env.items[i] = {x:Math.random()*env.w, y:-20, v:p.v, s:p.s};
                if(isSnow) {
                    p.x += Math.sin(p.y/50);
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                } else {
                    ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x, p.y+15); ctx.stroke();
                }
            });
        }
        
        if(c >= 95 && Math.random() < 0.005) {
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillRect(0,0,env.w,env.h);
        }

        requestAnimationFrame(loop);
    }

    init();
</script>
</body>
</html>

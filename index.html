<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather AI Glass Morph</title>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.12);
            --blur: blur(25px);
            --radius: 30px;
            --text: #ffffff;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif; }
        
        body { 
            margin: 0; 
            min-height: 100vh; 
            color: var(--text); 
            background: #000; 
            overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent;
        }

        canvas#bg { position: fixed; inset: 0; z-index: -1; }

        header { 
            padding: 20px; 
            display: flex; 
            gap: 12px; 
            max-width: 800px; 
            margin: 0 auto; 
            animation: fadeIn 1s ease;
        }

        .search { 
            flex: 1; display: flex; background: var(--glass); backdrop-filter: var(--blur); 
            border-radius: 20px; padding: 10px 18px; border: 1px solid rgba(255,255,255,0.1);
        }
        
        input { 
            flex: 1; background: transparent; border: none; 
            color: #fff; font-size: 16px; outline: none; 
        }

        button { 
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 15px; color: #fff; padding: 8px 14px; 
            cursor: pointer; backdrop-filter: var(--blur); transition: 0.3s;
        }
        button:active { transform: scale(0.92); }

        main { 
            padding: 10px 20px; 
            display: grid; 
            gap: 20px; 
            max-width: 800px; 
            margin: 0 auto; 
            padding-bottom: 40px;
        }

        /* Glass Card */
        .card { 
            background: var(--glass); backdrop-filter: var(--blur); 
            border-radius: var(--radius); padding: 25px; 
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .now { text-align: center; }
        .temp { font-size: 80px; font-weight: 200; margin: 10px 0; letter-spacing: -3px; }
        .city { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .condition { font-size: 18px; opacity: 0.9; margin-bottom: 15px; }
        
        .meta-row { 
            display: flex; justify-content: center; gap: 20px; 
            font-size: 14px; opacity: 0.7; 
        }

        .section-title { 
            font-size: 13px; text-transform: uppercase; 
            opacity: 0.5; margin-bottom: 15px; font-weight: 700; letter-spacing: 1px; 
        }
        
        .scroll-box { 
            display: flex; gap: 20px; overflow-x: auto; 
            padding-bottom: 5px; scrollbar-width: none; 
        }
        .scroll-box::-webkit-scrollbar { display: none; }

        .item { display: flex; flex-direction: column; align-items: center; min-width: 60px; gap: 8px; }
        .icon-ios { font-size: 28px; height: 35px; display: flex; align-items: center; }
        .windArrow { display: inline-block; transition: transform 1.5s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        /* Mobile specific adjustments */
        @media (max-width: 600px) {
            .temp { font-size: 70px; }
            main { gap: 15px; }
            .card { padding: 20px; }
        }

        /* Desktop Grid */
        @media (min-width: 768px) {
            main { grid-template-columns: 1fr 1fr; }
            .now { grid-column: span 2; }
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<header>
    <div class="search"><input id="q" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." /><button onclick="search()">üîç</button></div>
    <button onclick="toggleLang()" id="langBtn">RU</button>
</header>

<main id="app" style="display:none">
    <section class="card now">
        <div class="city" id="place">---</div>
        <div class="condition" id="desc">---</div>
        <div class="temp" id="tempText">0¬∞</div>
        <div class="meta-row">
            <span id="windText">---</span>
            <span class="windArrow" id="arrow">‚Üë</span>
        </div>
    </section>

    <section class="card">
        <div class="section-title" id="hHourly">–ü–æ —á–∞—Å–∞–º</div>
        <div class="scroll-box" id="hourlyList"></div>
    </section>

    <section class="card">
        <div class="section-title" id="hDays">–ù–∞ 3 –¥–Ω—è</div>
        <div class="scroll-box" id="daysList"></div>
    </section>
</main>

<script>
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let lang = localStorage.getItem('lang') || 'ru';
    let weatherType = 'clear';
    let isStorm = false;
    let lightningStrike = 0;
    let blobs = [];
    let particles = [];

    const palette = {
        clearDay: ['#00c6ff', '#0072ff', '#f1c40f'],
        clearNight: ['#0f0c29', '#302b63', '#24243e'],
        cloudy: ['#3a7bd5', '#3a6073', '#bdc3c7'],
        rain: ['#141e30', '#243b55', '#3d7eaa'],
        snow: ['#83a4d4', '#b6fbff', '#ffffff']
    };

    const t = {
        ru: { hourly: '–°–µ–≥–æ–¥–Ω—è', days: '3 –¥–Ω—è', wind: '–í–µ—Ç–µ—Ä', placeholder: '–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞...' },
        en: { hourly: 'Hourly', days: '3 days', wind: 'Wind', placeholder: 'Search city...' }
    };

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    function toggleLang() {
        lang = lang === 'ru' ? 'en' : 'ru';
        localStorage.setItem('lang', lang);
        updateUIStrings();
        const last = JSON.parse(localStorage.getItem('lastCity'));
        if(last) load(last.lat, last.lon, last.name);
    }

    function updateUIStrings() {
        document.getElementById('langBtn').innerText = lang.toUpperCase();
        document.getElementById('hHourly').innerText = t[lang].hourly;
        document.getElementById('hDays').innerText = t[lang].days;
        document.getElementById('q').placeholder = t[lang].placeholder;
    }

    window.onload = () => {
        resize();
        updateUIStrings();
        const last = JSON.parse(localStorage.getItem('lastCity'));
        if (last) {
            load(last.lat, last.lon, last.name);
        } else {
            navigator.geolocation.getCurrentPosition(
                p => load(p.coords.latitude, p.coords.longitude, lang === 'ru' ? '–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ' : 'My location'),
                () => load(55.75, 37.61, '–ú–æ—Å–∫–≤–∞')
            );
        }
        loop();
    };

    window.onresize = resize;
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if(blobs.length) initBlobs(getCurrentPalette());
    }

    async function search() {
        const query = document.getElementById('q').value;
        if(!query) return;
        const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=1&language=${lang}`).then(r => r.json());
        if (res.results) {
            const g = res.results[0];
            load(g.latitude, g.longitude, g.name);
        }
    }

    async function load(lat, lon, name) {
        document.getElementById('app').style.display = 'grid';
        localStorage.setItem('lastCity', JSON.stringify({lat, lon, name}));
        
        const d = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,is_day,weather_code,wind_speed_10m,wind_direction_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`).then(r => r.json());
        
        render(d, name);
        updateWeatherTheme(d.current.weather_code, d.current.is_day);
    }

    function render(d, name) {
        document.getElementById('place').innerText = name;
        document.getElementById('tempText').innerText = Math.round(d.current.temperature_2m) + '¬∞';
        const info = codeToInfo(d.current.weather_code);
        document.getElementById('desc').innerText = info.text;
        document.getElementById('windText').innerText = `${t[lang].wind}: ${d.current.wind_speed_10m} km/h`;
        document.getElementById('arrow').style.transform = `rotate(${d.current.wind_direction_10m}deg)`;

        // Hourly
        const hList = document.getElementById('hourlyList');
        hList.innerHTML = '';
        d.hourly.temperature_2m.slice(0, 12).forEach((temp, i) => {
            const c = codeToInfo(d.hourly.weather_code[i]);
            hList.innerHTML += `<div class="item"><span>${i}:00</span><span class="icon-ios">${c.icon}</span><b>${Math.round(temp)}¬∞</b></div>`;
        });

        // Daily
        const dList = document.getElementById('daysList');
        dList.innerHTML = '';
        d.daily.temperature_2m_max.slice(0, 3).forEach((max, i) => {
            const c = codeToInfo(d.daily.weather_code[i]);
            dList.innerHTML += `<div class="item"><span>Day ${i+1}</span><span class="icon-ios">${c.icon}</span><b>${Math.round(max)}¬∞</b><span style="opacity:0.5">${Math.round(d.daily.temperature_2m_min[i])}¬∞</span></div>`;
        });
    }

    function codeToInfo(c) {
        const ru = {
            0: { icon: '‚òÄÔ∏è', text: '–Ø—Å–Ω–æ', type: 'clear' },
            1: { icon: 'üå§Ô∏è', text: '–ü–æ—á—Ç–∏ —è—Å–Ω–æ', type: 'clear' },
            2: { icon: '‚õÖ', text: '–û–±–ª–∞—á–Ω–æ', type: 'clouds' },
            3: { icon: '‚òÅÔ∏è', text: '–ü–∞—Å–º—É—Ä–Ω–æ', type: 'clouds' },
            61: { icon: 'üåßÔ∏è', text: '–î–æ–∂–¥—å', type: 'rain' },
            71: { icon: '‚ùÑÔ∏è', text: '–°–Ω–µ–≥', type: 'snow' },
            95: { icon: '‚õàÔ∏è', text: '–ì—Ä–æ–∑–∞', type: 'rain' }
        };
        const en = {
            0: { icon: '‚òÄÔ∏è', text: 'Clear Sky', type: 'clear' },
            1: { icon: 'üå§Ô∏è', text: 'Mainly Clear', type: 'clear' },
            2: { icon: '‚õÖ', text: 'Partly Cloudy', type: 'clouds' },
            3: { icon: '‚òÅÔ∏è', text: 'Overcast', type: 'clouds' },
            61: { icon: 'üåßÔ∏è', text: 'Rainy', type: 'rain' },
            71: { icon: '‚ùÑÔ∏è', text: 'Snowy', type: 'snow' },
            95: { icon: '‚õàÔ∏è', text: 'Thunderstorm', type: 'rain' }
        };
        const data = lang === 'ru' ? ru : en;
        return data[c] || (lang === 'ru' ? {icon: '‚òÅÔ∏è', text: '–ü–æ–≥–æ–¥–∞', type: 'clouds'} : {icon: '‚òÅÔ∏è', text: 'Weather', type: 'clouds'});
    }

    // --- ANIMATION ENGINE ---

    function getCurrentPalette() {
        const isDay = blobs.isDayTime; 
        if (!isDay) return palette.clearNight;
        if (weatherType === 'rain') return palette.rain;
        if (weatherType === 'snow') return palette.snow;
        if (weatherType === 'clouds') return palette.cloudy;
        return palette.clearDay;
    }

    function initBlobs(colors) {
        blobs = [];
        for(let i = 0; i < 3; i++) {
            blobs.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                r: Math.random() * canvas.width + canvas.width/3,
                color: colors[i],
                vx: (Math.random() - 0.5) * (isMobile ? 1 : 2),
                vy: (Math.random() - 0.5) * (isMobile ? 1 : 2)
            });
        }
    }

    function updateWeatherTheme(code, isDay) {
        const info = codeToInfo(code);
        weatherType = info.type;
        isStorm = (code >= 95);
        blobs.isDayTime = isDay;

        initBlobs(getCurrentPalette());

        particles = [];
        let count = isMobile ? 60 : 120;
        if (weatherType === 'rain' || weatherType === 'snow') count *= 2;
        
        for(let i=0; i<count; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                v: Math.random() * 3 + 2,
                s: Math.random() * 2 + 1,
                o: Math.random()
            });
        }
    }

    function loop() {
        if (isStorm && Math.random() > 0.993) lightningStrike = 1.0;

        // –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = lightningStrike > 0.1 ? `rgba(255,255,255,${lightningStrike*0.5})` : blobs[0]?.color || '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if (lightningStrike > 0) lightningStrike *= 0.85;

        // –ñ–∏–¥–∫–∏–µ —Å—Ñ–µ—Ä—ã
        blobs.forEach(b => {
            b.x += b.vx; b.y += b.vy;
            if (b.x < 0 || b.x > canvas.width) b.vx *= -1;
            if (b.y < 0 || b.y > canvas.height) b.vy *= -1;

            let g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r);
            g.addColorStop(0, lightningStrike > 0.5 ? '#fff' : b.color);
            g.addColorStop(1, 'transparent');
            
            ctx.globalCompositeOperation = 'screen';
            ctx.fillStyle = g;
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
            ctx.fill();
        });

        // –û—Å–∞–¥–∫–∏
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
        particles.forEach(p => {
            if (weatherType === 'rain') {
                ctx.fillRect(p.x, p.y, 1, p.v * 4);
                p.y += p.v * 4;
            } else if (weatherType === 'snow') {
                ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                p.y += p.v * 0.4; p.x += Math.sin(p.y/40);
            } else {
                ctx.globalAlpha = Math.abs(Math.sin(Date.now()/2000 + p.o*10)) * 0.3;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            }
            if (p.y > canvas.height) p.y = -20;
            if (p.x > canvas.width) p.x = 0; else if (p.x < 0) p.x = canvas.width;
        });

        requestAnimationFrame(loop);
    }
</script>
</body>
</html>

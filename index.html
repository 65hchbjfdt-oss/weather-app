<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather iOS Fluid</title>
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.1); 
            --blur: blur(40px); 
            --spring: cubic-bezier(0.23, 1, 0.32, 1); /* Нативная iOS кривая */
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        
        canvas#bg { position: fixed; inset: 0; z-index: -1; transform: scale(1.1); filter: contrast(1.1); }

        header { 
            padding: 20px; max-width: 900px; margin: 0 auto; 
            animation: slideInHeader 1s var(--spring);
        }

        .search-container { position: relative; }
        .search-box { 
            display: flex; background: var(--glass); backdrop-filter: var(--blur); 
            border-radius: 22px; padding: 12px 18px; border: 0.5px solid rgba(255,255,255,0.2);
            transition: transform 0.4s var(--spring), box-shadow 0.4s;
        }
        .search-box:focus-within { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        input { flex: 1; background: transparent; border: none; color: #fff; outline: none; font-size: 17px; }

        /* Избранное (пилюли) */
        .fav-bar { display: flex; gap: 10px; padding: 10px 0; overflow-x: auto; scrollbar-width: none; }
        .fav-item { 
            background: var(--glass); backdrop-filter: var(--blur); 
            padding: 8px 20px; border-radius: 20px; font-size: 14px; 
            transition: all 0.5s var(--spring); border: 0.5px solid rgba(255,255,255,0.1);
        }
        .fav-item.active { background: #fff; color: #000; transform: scale(1.05); }

        main { 
            padding: 10px 20px; display: flex; flex-direction: column; gap: 20px; 
            max-width: 900px; margin: 0 auto;
        }

        /* Анимация появления контента */
        .card { 
            background: var(--glass); backdrop-filter: var(--blur); 
            border-radius: 28px; border: 0.5px solid rgba(255,255,255,0.15); 
            padding: 24px; transition: opacity 0.8s, transform 0.8s var(--spring);
            box-shadow: 0 15px 45px rgba(0,0,0,0.2);
        }

        .now { 
            text-align: center; background: transparent; backdrop-filter: none; border: none; 
            transform: translateY(20px); opacity: 0; animation: fadeUp 1.2s var(--spring) forwards;
        }

        .temp-big { 
            font-size: 110px; font-weight: 100; margin: 0; letter-spacing: -5px; 
            background: linear-gradient(180deg, #fff 40%, rgba(255,255,255,0.5));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .day-row { 
            display: grid; grid-template-columns: 80px 40px 1fr 100px; align-items: center; 
            padding: 15px 0; border-bottom: 0.5px solid rgba(255,255,255,0.1);
            transition: background 0.3s; cursor: pointer;
        }
        .day-row:hover { background: rgba(255,255,255,0.05); }

        /* Keyframes */
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInHeader { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Скрываем для мобилок лишнее */
        .suggestion-item { 
            padding: 15px; border-bottom: 0.5px solid rgba(255,255,255,0.1); 
            transition: background 0.2s; 
        }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<header>
    <div class="search-container">
        <div class="search-box">
            <input id="q" placeholder="Поиск города..." oninput="handleInput(this.value)" />
        </div>
        <div id="suggestions" class="suggestions" style="display:none; position:absolute; width:100%; background:rgba(20,20,20,0.95); backdrop-filter:blur(20px); border-radius:20px; margin-top:10px; z-index:1000; overflow:hidden;"></div>
    </div>
    <div class="fav-bar" id="favBar"></div>
</header>

<main id="app" style="display:none">
    <section class="card now">
        <div style="font-size:32px; font-weight:600;" id="place">---</div>
        <div class="temp-big" id="mainTemp">0</div>
        <div style="font-size:22px; opacity:0.7;" id="mainDesc">---</div>
    </section>

    <section class="card" id="forecastCard">
        <div style="font-size:13px; opacity:0.5; margin-bottom:15px; font-weight:600;">ПРОГНОЗ НА 3 ДНЯ</div>
        <div id="dList"></div>
    </section>
</main>

<script>
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let isDay = true, weatherCode = 0;
    let blobs = [], stars = [], clouds = [], rays = [];
    let sunRotation = 0;

    // Плавный поиск
    async function handleInput(val) {
        const sugg = document.getElementById('suggestions');
        if (val.length < 2) { sugg.style.display = 'none'; return; }
        const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${val}&count=3&language=ru`).then(r => r.json());
        if (res.results) {
            sugg.innerHTML = res.results.map(g => `
                <div class="suggestion-item" onclick="selectCity('${g.latitude}', '${g.longitude}', '${g.name}')">
                    ${g.name} <span style="opacity:0.4; font-size:12px;">${g.country}</span>
                </div>
            `).join('');
            sugg.style.display = 'block';
        }
    }

    function selectCity(lat, lon, name) {
        document.getElementById('suggestions').style.display = 'none';
        document.getElementById('q').value = name;
        load(lat, lon, name);
    }

    async function load(lat, lon, name) {
        const d = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,is_day,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`).then(r=>r.json());
        isDay = !!d.current.is_day;
        weatherCode = d.current.weather_code;
        
        // Плавное обновление DOM
        const app = document.getElementById('app');
        app.style.opacity = '0';
        setTimeout(() => {
            document.getElementById('place').innerText = name;
            document.getElementById('mainTemp').innerText = Math.round(d.current.temperature_2m);
            document.getElementById('mainDesc').innerText = weatherCode < 3 ? 'Ясно' : 'Пасмурно';
            
            document.getElementById('dList').innerHTML = d.daily.time.slice(0,3).map((time, i) => `
                <div class="day-row" style="animation: fadeUp ${0.5 + i*0.2}s var(--spring) forwards;">
                    <span style="font-weight:500;">${i===0?'Сегодня':new Date(time).toLocaleDateString('ru',{weekday:'short'})}</span>
                    <span style="font-size:24px;">${weatherCode < 3 ? '☀️' : '☁️'}</span>
                    <span style="opacity:0.5; font-size:14px;">Вероятность 0%</span>
                    <div style="text-align:right;">
                        <span style="opacity:0.4; margin-right:10px;">${Math.round(d.daily.temperature_2m_min[i])}°</span>
                        <span style="font-weight:600;">${Math.round(d.daily.temperature_2m_max[i])}°</span>
                    </div>
                </div>
            `).join('');
            
            app.style.display = 'grid';
            app.style.opacity = '1';
            initEnvironment();
        }, 300);
    }

    function initEnvironment() {
        blobs = [];
        const pal = isDay ? ['#007AFF', '#00C6FF', '#00D4FF'] : ['#0F0C29', '#302B63', '#24243E'];
        for(let i=0; i<3; i++) blobs.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:canvas.width, c:pal[i], vx:Math.random()*0.4-0.2, vy:Math.random()*0.4-0.2});

        clouds = [];
        for(let i=0; i<6; i++) clouds.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*200+150, v:Math.random()*0.3+0.1, o:Math.random()*0.08});

        stars = isDay ? [] : Array(100).fill().map(() => ({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*1.2, ph:Math.random()*Math.PI}));
    }

    function draw() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        
        // 1. Плавный фон
        blobs.forEach(b => {
            b.x += b.vx; b.y += b.vy;
            if(b.x<0 || b.x>canvas.width) b.vx*=-1; if(b.y<0 || b.y>canvas.height) b.vy*=-1;
            let g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r);
            g.addColorStop(0, b.c); g.addColorStop(1, 'transparent');
            ctx.globalCompositeOperation = 'screen';
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
        });

        ctx.globalCompositeOperation = 'source-over';

        // 2. Реалистичное солнце с мягким свечением
        if(isDay && weatherCode < 3) {
            const sx = canvas.width * 0.8, sy = 120;
            sunRotation += 0.003;
            
            // Ядро
            let sunGrd = ctx.createRadialGradient(sx, sy, 0, sx, sy, 60);
            sunGrd.addColorStop(0, '#fff'); sunGrd.addColorStop(1, 'rgba(255,255,150,0)');
            ctx.fillStyle = sunGrd;
            ctx.beginPath(); ctx.arc(sx, sy, 60, 0, Math.PI*2); ctx.fill();

            // Лучи
            ctx.save();
            ctx.translate(sx, sy);
            ctx.rotate(sunRotation);
            for(let i=0; i<12; i++) {
                ctx.rotate(Math.PI/6);
                let rayGrd = ctx.createLinearGradient(0,0,0,500);
                rayGrd.addColorStop(0, 'rgba(255,255,255,0.1)'); rayGrd.addColorStop(1, 'transparent');
                ctx.fillStyle = rayGrd;
                ctx.beginPath(); ctx.moveTo(-30, 0); ctx.lineTo(30,0); ctx.lineTo(0, 800); ctx.fill();
            }
            ctx.restore();
        }

        // 3. Звезды с мерцанием
        stars.forEach(s => {
            let opacity = Math.abs(Math.sin(Date.now()/1500 + s.ph));
            ctx.fillStyle = `rgba(255,255,255,${opacity})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
        });

        // 4. Дрейфующие "перистые" облака
        clouds.forEach(c => {
            c.x += c.v; if(c.x > canvas.width + c.r) c.x = -c.r;
            let cg = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, c.r);
            cg.addColorStop(0, `rgba(255,255,255,${c.o})`); cg.addColorStop(1, 'transparent');
            ctx.fillStyle = cg; ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.fill();
        });

        requestAnimationFrame(draw);
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initEnvironment(); }
    window.onresize = resize;
    window.onload = () => { resize(); load(55.75, 37.62, 'Москва'); draw(); };
</script>
</body>
</html>

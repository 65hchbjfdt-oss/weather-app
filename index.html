<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather iOS Fixed</title>
    <style>
        :root { 
            --glass: rgba(50, 50, 50, 0.45); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --blur: blur(35px); 
            --spring: cubic-bezier(0.25, 0.8, 0.25, 1); /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è iOS */
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        
        /* –§–æ–Ω-–∞–Ω–∏–º–∞—Ü–∏—è */
        canvas#bg { position: fixed; inset: 0; z-index: -1; transition: filter 1s ease; }

        /* –ü–æ–∏—Å–∫ */
        header { padding: 40px 20px 10px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; gap: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); pointer-events: none; }
        .search-wrapper { flex: 1; pointer-events: auto; position: relative; }
        .search-box { display: flex; align-items: center; background: rgba(40,40,40,0.7); backdrop-filter: var(--blur); border-radius: 14px; padding: 8px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid var(--glass-border); }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 17px; outline: none; margin-left: 8px; }
        
        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ */
        #results { position: absolute; top: 50px; left: 0; right: 0; background: rgba(30,30,30,0.95); border-radius: 14px; overflow: hidden; display: none; z-index: 2500; border: 1px solid var(--glass-border); backdrop-filter: blur(50px); max-height: 300px; overflow-y: auto; }
        .res-item { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .res-item:last-child { border: none; }
        .res-main { font-size: 16px; color: #fff; }
        .res-sub { font-size: 13px; color: #aaa; margin-top: 2px; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü */
        #stage { height: 100vh; width: 100vw; position: relative; overflow: hidden; }
        
        /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–æ—Ä–æ–¥–∞ */
        .page-container {
            position: absolute; inset: 0;
            padding: 100px 20px 140px; /* –ë–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ */
            transition: transform 0.6s var(--spring), opacity 0.4s ease;
            overflow-y: auto; scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ */
        }
        .page-container.active { display: block; transform: translateX(0); opacity: 1; z-index: 5; }
        .page-container.prev { display: block; transform: translateX(-40%); opacity: 0; z-index: 1; }
        .page-container.next { display: block; transform: translateX(100%); opacity: 1; z-index: 6; }

        /* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
        .city-header { text-align: center; margin-bottom: 40px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .city-name { font-size: 32px; font-weight: 600; }
        .temp-big { font-size: 90px; font-weight: 200; letter-spacing: -2px; line-height: 1.1; }
        .condition-text { font-size: 18px; font-weight: 500; opacity: 0.9; text-transform: capitalize; }
        .hl-temp { font-size: 18px; font-weight: 500; margin-top: 5px; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { 
            background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border-radius: 20px; padding: 15px; border: 1px solid var(--glass-border); margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .card-label { font-size: 13px; opacity: 0.6; text-transform: uppercase; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }

        /* –°–µ—Ç–∫–∞ –ø–ª–∏—Ç–æ–∫ 2x2 */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .tile { aspect-ratio: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .tile-val { font-size: 26px; font-weight: 500; }
        .tile-sub { font-size: 13px; opacity: 0.7; }

        /* –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Å–∫—Ä–æ–ª–ª—ã */
        .h-scroll { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-item { text-align: center; min-width: 50px; display: flex; flex-direction: column; align-items: center; gap: 6px; }

        .day-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 16px; font-weight: 500; }
        .day-row:last-child { border: none; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–æ—á–∫–∏) */
        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.7); backdrop-filter: blur(20px); padding: 8px 16px; border-radius: 20px; display: flex; gap: 8px; z-index: 2000; border: 1px solid rgba(255,255,255,0.1); pointer-events: none; }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #fff; transform: scale(1.2); }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; background: rgba(60,60,60,0.6); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; pointer-events: auto; }
        
        /* –ü–†–ï–î–ü–†–û–°–ú–û–¢–† (–ú–æ–¥–∞–ª–∫–∞) */
        #preview-modal { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); display: none; flex-direction: column; }
        .preview-header { padding: 50px 20px 10px; display: flex; justify-content: space-between; align-items: center; }
        .preview-content { flex: 1; overflow-y: auto; padding: 0 20px 40px; }
        .preview-actions { padding: 20px; display: flex; justify-content: center; gap: 20px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
        .add-btn { background: #fff; color: #000; padding: 12px 30px; border-radius: 25px; font-weight: 600; border: none; font-size: 16px; }

        /* –°–û–õ–ù–¶–ï (–ú–æ–¥–∞–ª–∫–∞) */
        #sun-modal { position: fixed; inset: 0; z-index: 3500; background: rgba(20,20,20,0.95); backdrop-filter: blur(40px); transform: translateY(100%); transition: transform 0.4s var(--spring); display: flex; flex-direction: column; }
        #sun-modal.open { transform: translateY(0); }
        .sun-modal-head { display: flex; justify-content: space-between; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }
        .sun-modal-body { padding: 20px; flex: 1; overflow-y: auto; }
        .sun-detail-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 17px; }
        .sun-graph-lg { width: 100%; height: 200px; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.2); }

        /* AI Text */
        .ai-box { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 15px; margin-top: 20px; }
        .ai-title { font-size: 14px; font-weight: 700; color: #FFD60A; margin-bottom: 8px; }
        .ai-text { font-size: 15px; line-height: 1.4; opacity: 0.9; }

        /* List Menu (Settings/Favorites) */
        #settings-layer { position: fixed; inset: 0; background: #000; z-index: 2900; transform: translateX(-100%); transition: 0.4s var(--spring); padding: 50px 20px; overflow-y: auto; }
        #settings-layer.show { transform: translateX(0); }
        .list-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
    </style>
</head>
<body>

    <canvas id="bg"></canvas>

    <header>
        <div class="btn-circle" onclick="toggleSettings(true)" style="margin-right: 10px;">‚ò∞</div>
        <div class="search-wrapper">
            <div class="search-box">
                <span style="opacity:0.6">üîç</span>
                <input id="q" placeholder="–ü–æ–∏—Å–∫ (–ì–æ—Ä–æ–¥, –°—Ç—Ä–∞–Ω–∞)" oninput="doSearch(this.value)">
            </div>
            <div id="results"></div>
        </div>
    </header>

    <div id="stage"></div>

    <div class="nav-dock" id="pagination"></div>

    <div id="settings-layer">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h1 style="margin:0; font-size:28px;">–ú–æ–∏ –≥–æ—Ä–æ–¥–∞</h1>
            <div class="btn-circle" onclick="toggleSettings(false)">‚úï</div>
        </div>
        <div id="fav-list"></div>
        <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
            <h3 style="opacity:0.5">–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è</h3>
            <div class="list-item" onclick="toggleUnit()">
                <span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span>
                <span id="unit-disp" style="color:#0a84ff">¬∞C</span>
            </div>
        </div>
    </div>

    <div id="preview-modal">
        <div class="preview-header">
            <div class="btn-circle" onclick="closePreview()">‚úï</div>
            <span style="font-weight:600; opacity:0.8">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
            <div style="width:40px"></div>
        </div>
        <div class="preview-content" id="preview-inner"></div>
        <div class="preview-actions">
            <button class="add-btn" onclick="confirmAddCity()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="sun-modal">
        <div class="sun-modal-head">
            <span style="font-size:18px; font-weight:600">–°–æ–ª–Ω—Ü–µ</span>
            <div class="btn-circle" style="width:30px; height:30px; font-size:14px;" onclick="document.getElementById('sun-modal').classList.remove('open')">‚úï</div>
        </div>
        <div class="sun-modal-body" id="sun-details-content">
            </div>
    </div>

<script>
    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    let cities = []; // {lat, lon, name, region, country, isHome}
    let currentIndex = 0;
    let unit = localStorage.getItem('unit') || 'C';
    let tempCity = null; // –î–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    
    // –ì—Ä–∞—Ñ–∏–∫–∞
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let env = { wCode: 0, isDay: 1, stars: [], rain: [], clouds: [] };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    async function init() {
        resize();
        window.addEventListener('resize', resize);
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö
        const saved = JSON.parse(localStorage.getItem('savedCities') || '[]');
        if (saved.length > 0) {
            cities = saved;
            loadWeather(0);
        } else {
            // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
            navigator.geolocation.getCurrentPosition(
                async pos => {
                    const data = await getGeoName(pos.coords.latitude, pos.coords.longitude);
                    cities = [{...data, isHome: true}];
                    saveCities();
                    loadWeather(0);
                },
                () => {
                    cities = [{lat: 55.75, lon: 37.62, name: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è', isHome: true}];
                    saveCities();
                    loadWeather(0);
                }
            );
        }
        
        document.getElementById('unit-disp').innerText = unit === 'C' ? '¬∞C' : '¬∞F';
        startAnimLoop();
        
        // –°–≤–∞–π–ø—ã
        let sx = 0;
        document.getElementById('stage').addEventListener('touchstart', e => sx = e.touches[0].clientX);
        document.getElementById('stage').addEventListener('touchend', e => {
            const diff = sx - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
                if (diff > 0 && currentIndex < cities.length - 1) changePage(currentIndex + 1);
                else if (diff < 0 && currentIndex > 0) changePage(currentIndex - 1);
            }
        });
    }

    // --- API & –õ–æ–≥–∏–∫–∞ ---
    
    async function getGeoName(lat, lon) {
        try {
            const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ru`);
            const d = await r.json();
            return {
                lat, lon,
                name: d.address.city || d.address.town || d.address.village || '–ú–æ–µ –º–µ—Å—Ç–æ',
                region: d.address.state || '',
                country: d.address.country || ''
            };
        } catch { return {lat, lon, name:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', region:'', country:''}; }
    }

    async function doSearch(q) {
        const resBox = document.getElementById('results');
        if (q.length < 2) { resBox.style.display = 'none'; return; }
        
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=ru`).then(x => x.json());
        if (!r.results) return;

        resBox.innerHTML = r.results.map(i => `
            <div class="res-item" onclick="openPreview(${i.latitude}, ${i.longitude}, '${i.name}', '${i.admin1 || ''}', '${i.country || ''}')">
                <div class="res-main">${i.name}</div>
                <div class="res-sub">${i.admin1 ? i.admin1 + ', ' : ''}${i.country}</div>
            </div>
        `).join('');
        resBox.style.display = 'block';
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ (Preview vs Main) ---

    // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–Ω–µ –¥–æ–±–∞–≤–ª—è—è –≤ –º–∞—Å—Å–∏–≤)
    async function openPreview(lat, lon, name, region, country) {
        document.getElementById('results').style.display = 'none';
        document.getElementById('q').value = '';
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
        const exists = cities.findIndex(c => Math.abs(c.lat - lat) < 0.01 && Math.abs(c.lon - lon) < 0.01);
        if (exists !== -1) {
            changePage(exists); // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º
            return;
        }

        tempCity = { lat, lon, name, region, country };
        const modal = document.getElementById('preview-modal');
        modal.style.display = 'flex';
        document.getElementById('preview-inner').innerHTML = '<div style="text-align:center; margin-top:50px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        const data = await fetchWeatherData(lat, lon);
        document.getElementById('preview-inner').innerHTML = generateHTML(data, tempCity, false);
        
        // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –ø—Ä–µ–≤—å—é
        setTimeout(() => drawSunCanvas(`sun-canvas-preview`, data), 100);
    }

    function closePreview() {
        document.getElementById('preview-modal').style.display = 'none';
        tempCity = null;
    }

    function confirmAddCity() {
        if (tempCity) {
            cities.push(tempCity);
            saveCities();
            closePreview();
            changePage(cities.length - 1);
        }
    }

    function saveCities() {
        localStorage.setItem('savedCities', JSON.stringify(cities));
        renderFavList();
    }

    // --- –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥—ã ---

    async function loadWeather(idx) {
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        const stage = document.getElementById('stage');
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞)
        if (stage.children.length !== cities.length) {
            stage.innerHTML = '';
            cities.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'page-container';
                div.id = `page-${i}`;
                stage.appendChild(div);
            });
        }
        
        updatePagination();
        changePage(idx); // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
        
        const city = cities[idx];
        const container = document.getElementById(`page-${idx}`);
        
        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç, –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º (–∫—ç—à –≤ DOM), –Ω–æ –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å
        if (container.innerHTML.length > 100) return; 

        container.innerHTML = '<div style="text-align:center; padding-top:100px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        const data = await fetchWeatherData(city.lat, city.lon);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)
        if (idx === currentIndex) updateEnv(data);
        
        container.innerHTML = generateHTML(data, city, true);
        
        // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å–æ–ª–Ω—Ü–∞
        setTimeout(() => drawSunCanvas(`sun-graph-${idx}`, data), 50);
    }
    
    function changePage(idx) {
        currentIndex = idx;
        const pages = document.querySelectorAll('.page-container');
        pages.forEach((p, i) => {
            p.className = 'page-container';
            if (i === idx) {
                p.classList.add('active');
                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ—Ç, –ø–æ–¥–≥—Ä—É–∂–∞–µ–º
                if (p.innerHTML === '') loadWeather(i);
                else {
                    // –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é —Ñ–æ–Ω–∞, –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—É—é
                     // (—É–ø—Ä–æ—â–µ–Ω–∏–µ: –±–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ DOM –∞—Ç—Ç—Ä–∏–±—É—Ç–æ–≤ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ –º–µ–Ω—è–µ–º)
                }
            }
            else if (i < idx) p.classList.add('prev');
            else p.classList.add('next');
        });
        updatePagination();
    }

    async function fetchWeatherData(lat, lon) {
        const uParams = `&current=temperature_2m,weather_code,is_day,wind_speed_10m,wind_direction_10m,pressure_msl,relative_humidity_2m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,daylight_duration&timezone=auto`;
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}${uParams}`;
        return await fetch(url).then(r => r.json());
    }

    // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML (–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ) ---
    
    function generateHTML(data, cityInfo, isMain) {
        const cur = data.current;
        const daily = data.daily;
        const idx = isMain ? cities.indexOf(cityInfo) : 'preview';
        
        const desc = getWDesc(cur.weather_code);
        const temp = unit === 'F' ? Math.round(cur.temperature_2m * 9/5 + 32) : Math.round(cur.temperature_2m);
        const min = unit === 'F' ? Math.round(daily.temperature_2m_min[0] * 9/5 + 32) : Math.round(daily.temperature_2m_min[0]);
        const max = unit === 'F' ? Math.round(daily.temperature_2m_max[0] * 9/5 + 32) : Math.round(daily.temperature_2m_max[0]);
        
        // –ü–æ—á–∞—Å–æ–≤–∞—è (24—á) - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è
        let hourlyHTML = '';
        const nowHour = new Date().getHours(); 
        for(let i=0; i<24; i++) {
            // –ë–µ—Ä–µ–º –≤—Ä–µ–º—è –∏–∑ —Å—Ç—Ä–æ–∫–∏ API (2023-01-01T14:00) -> 14
            const tStr = data.hourly.time[i]; 
            const h = parseInt(tStr.split('T')[1].split(':')[0]); 
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ —á–∞—Å—ã (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
            // –ù–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å 00:00, –ø–æ—ç—Ç–æ–º—É —Å–¥–≤–∏–≥:
            // –£ OpenMeteo current time match - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å
             
            const hTemp = unit === 'F' ? Math.round(data.hourly.temperature_2m[i] * 9/5 + 32) : Math.round(data.hourly.temperature_2m[i]);
            
            // –ï—Å–ª–∏ —á–∞—Å —É–∂–µ –ø—Ä–æ—à–µ–ª –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–∏—Ö —Å—É—Ç–æ–∫, –º–æ–∂–Ω–æ –µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, 
            // –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞–∂–µ–º —Å—É—Ç–∫–∏ –Ω–∞—á–∏–Ω–∞—è —Å —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞ API (–æ–±—ã—á–Ω–æ –æ–Ω–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç)
            // –õ—É—á—à–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å.
            
            hourlyHTML += `
                <div class="h-item">
                    <span style="font-size:14px; font-weight:600">${h}:00</span>
                    <span style="font-size:20px; margin:4px 0">${getWIcon(data.hourly.weather_code[i])}</span>
                    <span style="font-size:16px">${hTemp}¬∞</span>
                </div>
            `;
        }

        // Daily
        let dailyHTML = '';
        for(let i=0; i<5; i++) {
            const date = new Date(daily.time[i]);
            const dayName = i===0 ? '–°–µ–≥–æ–¥–Ω—è' : date.toLocaleDateString('ru-RU', {weekday:'short'});
            const dMin = unit === 'F' ? Math.round(daily.temperature_2m_min[i]*9/5+32) : Math.round(daily.temperature_2m_min[i]);
            const dMax = unit === 'F' ? Math.round(daily.temperature_2m_max[i]*9/5+32) : Math.round(daily.temperature_2m_max[i]);
            
            dailyHTML += `
                <div class="day-row">
                    <div style="text-transform:capitalize">${dayName}</div>
                    <div style="text-align:center">${getWIcon(daily.weather_code[i])}</div>
                    <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end">
                        <span style="opacity:0.5">${dMin}¬∞</span>
                        <span>${dMax}¬∞</span>
                    </div>
                </div>
            `;
        }

        // JSON –¥–ª—è —Å–æ–ª–Ω—Ü–∞ (–ø–µ—Ä–µ–¥–∞–¥–∏–º –≤ –∫–ª–∏–∫)
        const sunData = encodeURIComponent(JSON.stringify({
            rise: daily.sunrise[0],
            set: daily.sunset[0],
            dur: daily.daylight_duration[0]
        }));
        
        // AI Text
        const aiText = getAIText(cur.temperature_2m, cur.weather_code, cur.wind_speed_10m);

        return `
            <div class="city-header">
                <div class="city-name">${cityInfo.name}</div>
                <div class="condition-text">${desc}</div>
                <div class="temp-big">${temp}¬∞</div>
                <div class="hl-temp">–ú–∞–∫—Å.: ${max}¬∞ –ú–∏–Ω.: ${min}¬∞</div>
            </div>

            <div class="card">
                <div class="card-label">üïì –ü–û–ß–ê–°–û–í–û–ô –ü–†–û–ì–ù–û–ó</div>
                <div class="h-scroll">
                    ${hourlyHTML}
                </div>
            </div>

            <div class="card">
                <div class="card-label">üìÖ –ü–†–û–ì–ù–û–ó –ù–ê 5 –î–ù–ï–ô</div>
                ${dailyHTML}
            </div>

            <div class="grid-2">
                <div class="card tile" onclick="openSunDetail('${sunData}')" style="cursor:pointer">
                    <div class="card-label">üåÖ –í–û–°–•–û–î –ò –ó–ê–ö–ê–¢</div>
                    <div style="position:relative; width:100%; height:60px; margin-top:10px;">
                        <canvas id="sun-graph-${idx}" width="300" height="120" style="width:100%; height:100%"></canvas>
                    </div>
                    <div class="tile-sub">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</div>
                </div>

                <div class="card tile">
                    <div class="card-label">üåô –õ–£–ù–ê</div>
                    <div style="font-size:15px; font-weight:500">–†–∞—Å—Ç—É—â–∞—è –ª—É–Ω–∞</div>
                    <div style="font-size:30px; text-align:center; margin:5px 0">üåñ</div>
                    <div class="tile-sub">–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å: 78%</div>
                </div>

                <div class="card tile">
                    <div class="card-label">üí® –í–ï–¢–ï–†</div>
                    <div class="tile-val">${Math.round(cur.wind_speed_10m)} <span style="font-size:16px">–∫–º/—á</span></div>
                    <div class="tile-sub">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${cur.wind_direction_10m}¬∞</div>
                </div>

                <div class="card tile">
                    <div class="card-label">üìâ –î–ê–í–õ–ï–ù–ò–ï</div>
                    <div class="tile-val">${Math.round(cur.pressure_msl * 0.75)} <span style="font-size:16px">–º–º</span></div>
                    <div class="tile-sub">—Ä—Ç. —Å—Ç.</div>
                </div>
            </div>

            <div class="ai-box">
                <div class="ai-title">ü§ñ AI –ü–û–ú–û–©–ù–ò–ö</div>
                <div class="ai-text">${aiText}</div>
            </div>
        `;
    }

    // --- –†–∏—Å–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å–æ–ª–Ω—Ü–∞ (–°–∏–Ω—É—Å–æ–∏–¥–∞) ---
    function drawSunCanvas(id, data) {
        const c = document.getElementById(id);
        if(!c) return;
        const cx = c.getContext('2d');
        const w = c.width, h = c.height;
        
        cx.clearRect(0,0,w,h);
        
        // –†–∏—Å—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç
        cx.beginPath();
        cx.strokeStyle = 'rgba(255,255,255,0.3)';
        cx.lineWidth = 2;
        cx.moveTo(0, h/2); cx.lineTo(w, h/2);
        cx.stroke();

        // –°–∏–Ω—É—Å–æ–∏–¥–∞
        cx.beginPath();
        cx.strokeStyle = '#FFD60A';
        cx.lineWidth = 4;
        for(let x=0; x<=w; x++) {
            // y = sin(x)
            let y = Math.sin((x/w)*Math.PI) * (h/2 - 10);
            cx.lineTo(x, h/2 - y);
        }
        cx.stroke();

        // –¢–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ (—Ñ–µ–π–∫–æ–≤–æ–µ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã, —Ç–∞–∫ –∫–∞–∫ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å–ª–æ–∂–µ–Ω)
        // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Å –∏ –º–∞–ø–∏–º –Ω–∞ —à–∏—Ä–∏–Ω—É
        const now = new Date();
        const mins = now.getHours() * 60 + now.getMinutes();
        const totalMins = 24 * 60;
        const xPos = (mins / totalMins) * w;
        // –ù–æ –Ω–∞–º –Ω—É–∂–Ω–∞ –¥—É–≥–∞ —Ç–æ–ª—å–∫–æ –¥–Ω–µ–º, —É–ø—Ä–æ—Å—Ç–∏–º: –ø—Ä–æ—Å—Ç–æ —Ç–æ—á–∫—É –Ω–∞ –¥—É–≥–µ –ø–æ—Å—Ç–∞–≤–∏–º
        // –î–æ–ø—É—Å—Ç–∏–º, –º—ã –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥—É–≥–∏
        const yPos = Math.sin((0.5)*Math.PI) * (h/2 - 10); // –ü–∏–∫

        cx.beginPath();
        cx.fillStyle = '#fff';
        cx.shadowBlur = 10; cx.shadowColor = '#FFD60A';
        cx.arc(w/2, h/2 - yPos, 6, 0, Math.PI*2);
        cx.fill();
        cx.shadowBlur = 0;
    }

    // --- –î–µ—Ç–∞–ª—å–Ω–æ–µ –º–µ–Ω—é –°–æ–ª–Ω—Ü–∞ ---
    function openSunDetail(json) {
        const d = JSON.parse(decodeURIComponent(json));
        const modal = document.getElementById('sun-modal');
        const content = document.getElementById('sun-details-content');
        
        const rise = d.rise.split('T')[1];
        const set = d.set.split('T')[1];
        const durH = Math.floor(d.dur / 3600);
        const durM = Math.round((d.dur % 3600) / 60);

        // –†–∞—Å—á–µ—Ç –ø–µ—Ä–≤—ã—Ö –ª—É—á–µ–π (—É—Å–ª–æ–≤–Ω–æ -30 –º–∏–Ω)
        content.innerHTML = `
            <div style="text-align:center; padding: 20px 0;">
                <span style="font-size:14px; opacity:0.7">–°–≤–µ—Ç–æ–≤–æ–π –¥–µ–Ω—å</span>
                <div style="font-size:32px; font-weight:500">${durH} —á ${durM} –º–∏–Ω</div>
            </div>
            
            <div class="sun-detail-row">
                <span>–ü–µ—Ä–≤—ã–µ –ª—É—á–∏</span>
                <span>${parseInt(rise.split(':')[0])}:10</span> 
            </div>
            <div class="sun-detail-row">
                <span style="color:#FFD60A">–í–æ—Å—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è</span>
                <span>${rise}</span>
            </div>
            <div class="sun-detail-row">
                <span style="color:#FF9F0A">–ó–∞–∫–∞—Ç —Å–µ–≥–æ–¥–Ω—è</span>
                <span>${set}</span>
            </div>
            <div class="sun-detail-row">
                <span>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª—É—á–∏</span>
                <span>${parseInt(set.split(':')[0])}:45</span>
            </div>
        `;
        
        modal.classList.add('open');
    }

    // --- –£—Ç–∏–ª–∏—Ç—ã ---
    
    function updatePagination() {
        const p = document.getElementById('pagination');
        if (cities.length < 2) { p.style.display = 'none'; return; }
        p.style.display = 'flex';
        p.innerHTML = cities.map((_, i) => `<div class="dot ${i===currentIndex?'active':''}"></div>`).join('');
    }

    function toggleSettings(open) {
        const lay = document.getElementById('settings-layer');
        lay.className = open ? 'show' : '';
        if(open) renderFavList();
    }

    function renderFavList() {
        const l = document.getElementById('fav-list');
        l.innerHTML = cities.map((c, i) => `
            <div class="list-item">
                <div>
                    <div style="font-size:18px; font-weight:600">${c.name}</div>
                    <div style="font-size:12px; opacity:0.6">${c.country}</div>
                </div>
                ${!c.isHome ? `<div class="btn-circle" style="width:30px; height:30px; background:rgba(255,69,58,0.2); border-color:transparent; color:#ff453a" onclick="removeCity(${i})">‚úï</div>` : '<span style="opacity:0.5; font-size:12px">–ì–µ–æ</span>'}
            </div>
        `).join('');
    }

    function removeCity(i) {
        if(cities[i].isHome) return;
        cities.splice(i, 1);
        saveCities();
        renderFavList();
        loadWeather(0);
    }

    function toggleUnit() {
        unit = unit === 'C' ? 'F' : 'C';
        localStorage.setItem('unit', unit);
        document.getElementById('unit-disp').innerText = '¬∞' + unit;
        loadWeather(currentIndex);
    }

    function getAIText(t, c, w) {
        if(c >= 95) return "–í–Ω–∏–º–∞–Ω–∏–µ! –ì—Ä–æ–∑–∞. –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏ –∏ –¥–µ—Ä–∂–∏—Ç–µ—Å—å –ø–æ–¥–∞–ª—å—à–µ –æ—Ç –æ–∫–æ–Ω.";
        if(c >= 71) return "–°–Ω–µ–≥–æ–ø–∞–¥. –î–æ—Ä–æ–≥–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–∫–æ–ª—å–∑–∫–∏–º–∏. –û–¥–µ–≤–∞–π—Ç–µ—Å—å —Ç–µ–ø–ª–æ, —à–∞–ø–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞.";
        if(c >= 51) return "–ò–¥–µ—Ç –¥–æ–∂–¥—å. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–æ–Ω—Ç –∏ –Ω–µ–ø—Ä–æ–º–æ–∫–∞–µ–º—É—é –æ–±—É–≤—å.";
        if(t < 0) return "–ù–∞ —É–ª–∏—Ü–µ –º–æ—Ä–æ–∑. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ç–µ—Ä–º–æ–±–µ–ª—å–µ –∏ —Ç–µ–ø–ª—ã–π –ø—É—Ö–æ–≤–∏–∫.";
        if(t > 30) return "–ñ–∞—Ä–∫–æ! –ü–µ–π—Ç–µ –º–Ω–æ–≥–æ –≤–æ–¥—ã, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–Ω—ã–π –∫—Ä–µ–º –∏ –Ω–æ—Å–∏—Ç–µ –≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä.";
        return "–ü–æ–≥–æ–¥–∞ —Å–ø–æ–∫–æ–π–Ω–∞—è. –û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏ –∏–ª–∏ –¥–µ–ª –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ.";
    }

    function getWDesc(c) {
        const m = {0:'–Ø—Å–Ω–æ',1:'–ú–∞–ª–æ–æ–±–ª–∞—á–Ω–æ',2:'–û–±–ª–∞—á–Ω–æ',3:'–ü–∞—Å–º—É—Ä–Ω–æ',45:'–¢—É–º–∞–Ω',51:'–ú–æ—Ä–æ—Å—å',61:'–î–æ–∂–¥—å',63:'–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å',71:'–°–Ω–µ–≥',73:'–°–Ω–µ–≥–æ–ø–∞–¥',95:'–ì—Ä–æ–∑–∞'};
        return m[c] || '–û—Å–∞–¥–∫–∏';
    }
    
    function getWIcon(c) {
        if(c===0) return '‚òÄÔ∏è';
        if(c<=3) return '‚õÖ';
        if(c<=48) return 'üå´Ô∏è';
        if(c<=67) return 'üåßÔ∏è';
        if(c<=77) return '‚ùÑÔ∏è';
        if(c>=95) return '‚õàÔ∏è';
        return 'üåßÔ∏è';
    }

    // --- –ê–Ω–∏–º–∞—Ü–∏—è (Canvas) ---
    function startAnimLoop() {
        const count = 100;
        for(let i=0; i<count; i++) env.stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*2, a:Math.random()});
        loop();
    }
    
    function loop() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        
        // –§–æ–Ω –≥—Ä–∞–¥–∏–µ–Ω—Ç
        const grad = ctx.createLinearGradient(0,0,0,canvas.height);
        // –ü—Ä–æ—Å—Ç–æ–π –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ (–º–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å)
        grad.addColorStop(0, '#0f2027'); 
        grad.addColorStop(1, '#2c5364');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,canvas.width, canvas.height);

        // –ó–≤–µ–∑–¥—ã
        ctx.fillStyle = '#fff';
        env.stars.forEach(s => {
            s.a += (Math.random()-0.5)*0.05;
            if(s.a<0) s.a=0; if(s.a>1) s.a=1;
            ctx.globalAlpha = s.a;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
        });
        ctx.globalAlpha = 1;

        requestAnimationFrame(loop);
    }
    
    function updateEnv(data) {
        env.wCode = data.current.weather_code;
        env.isDay = data.current.is_day;
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

    // –ó–∞–ø—É—Å–∫
    init();

</script>
</body>
</html>

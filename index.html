<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather Fluid OS</title>
    <style>
        :root { --glass: rgba(255, 255, 255, 0.12); --blur: blur(35px); --spring: cubic-bezier(0.2, 0.8, 0.2, 1); }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        canvas#bg { position: fixed; inset: 0; z-index: -1; }

        header { padding: 15px; max-width: 600px; margin: 0 auto; display: flex; gap: 10px; position: relative; z-index: 100; }
        .search-box { flex: 1; display: flex; align-items: center; background: var(--glass); backdrop-filter: var(--blur); border-radius: 20px; padding: 10px 15px; border: 0.5px solid rgba(255,255,255,0.2); gap: 10px; }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; }
        .unit-btn { background: var(--glass); border: 0.5px solid rgba(255,255,255,0.2); border-radius: 15px; color: #fff; padding: 0 12px; cursor: pointer; }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–∏—Å–∫–∞ */
        .suggestions { position: absolute; top: 75px; left: 15px; right: 15px; background: rgba(10,10,10,0.85); backdrop-filter: blur(25px); border-radius: 22px; overflow: hidden; border: 0.5px solid var(--glass); z-index: 1000; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .s-item { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid rgba(255,255,255,0.05); }
        .s-info { display: flex; flex-direction: column; flex: 1; cursor: pointer; }
        .s-name { font-weight: 500; font-size: 16px; }
        .s-detail { font-size: 12px; opacity: 0.5; margin-top: 2px; }
        .s-star { font-size: 22px; cursor: pointer; padding: 5px; transition: 0.3s; color: rgba(255,255,255,0.2); }
        .s-star.active { color: #FFD700; transform: scale(1.2); }

        /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è (–∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ) */
        .pagination { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); padding: 8px 16px; border-radius: 25px; display: flex; align-items: center; gap: 12px; border: 0.5px solid rgba(255,255,255,0.1); z-index: 200; }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; cursor: pointer; }
        .dot.active { background: #fff; transform: scale(1.2); }
        .dot-loc { width: 14px; height: 14px; fill: rgba(255,255,255,0.3); cursor: pointer; }
        .dot-loc.active { fill: #fff; }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        main { height: 100vh; overflow-y: auto; padding: 80px 20px 100px; scrollbar-width: none; }
        main::-webkit-scrollbar { display: none; }
        .now { text-align: center; margin-bottom: 40px; }
        .temp-big { font-size: 100px; font-weight: 100; letter-spacing: -5px; margin: 10px 0; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; margin: 0 auto; }
        .card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 22px; padding: 15px; border: 0.5px solid rgba(255,255,255,0.1); }
        .card-title { font-size: 11px; opacity: 0.5; text-transform: uppercase; font-weight: 700; margin-bottom: 10px; }
        .ai-card { grid-column: span 2; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); }

        .nav-btn { position: fixed; top: 50%; transform: translateY(-50%); font-size: 40px; color: rgba(255,255,255,0.2); cursor: pointer; padding: 20px; transition: 0.3s; z-index: 50; }
        @media (max-width: 768px) { .nav-btn { display: none; } }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<div class="nav-btn" style="left:0" onclick="changePage(-1)">‚Äπ</div>
<div class="nav-btn" style="right:0" onclick="changePage(1)">‚Ä∫</div>

<header>
    <div class="search-box">
        <span>üîç</span>
        <input id="q" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." oninput="search(this.value)" />
    </div>
    <button class="unit-btn" onclick="toggleUnit()" id="uBtn">C¬∞</button>
    <div id="results" class="suggestions" style="display:none"></div>
</header>

<main id="view" ontouchstart="ts(event)" ontouchend="te(event)">
    <div class="now" id="fadeTarget">
        <div id="place" style="font-size:32px; font-weight:500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="temp-big" id="temp">--</div>
        <div id="desc" style="font-size:20px; opacity:0.7">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...</div>
    </div>

    <div class="info-grid">
        <div class="card"><div class="card-title">–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫</div><div id="feel" style="font-size:24px">--</div></div>
        <div class="card"><div class="card-title">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div><div id="hum" style="font-size:24px">--</div></div>
        <div class="card ai-card"><div class="card-title">ü§ñ AI –°–æ–≤–µ—Ç</div><div id="ai" style="font-size:15px; line-height:1.4">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...</div></div>
    </div>
</main>

<div class="pagination" id="pag"></div>

<script>
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let favorites = JSON.parse(localStorage.getItem('weatherFavs')) || [];
    let pages = []; // –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    let curIdx = 0;
    let unit = localStorage.getItem('weatherUnit') || 'celsius';
    let startX = 0;

    // --- –ü–û–ò–°–ö ---
    async function search(v) {
        if(v.length < 2) return document.getElementById('results').style.display='none';
        const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${v}&count=5&language=ru`).then(r=>r.json());
        if(res.results) {
            const box = document.getElementById('results');
            box.innerHTML = res.results.map(g => {
                const isFav = favorites.some(f => f.name === g.name);
                const detail = [g.admin1, g.country].filter(Boolean).join(', ');
                return `
                <div class="s-item">
                    <div class="s-info" onclick="quickLoad('${g.latitude}','${g.longitude}','${g.name}')">
                        <span class="s-name">${g.name}</span>
                        <span class="s-detail">${detail}</span>
                    </div>
                    <div class="s-star ${isFav?'active':''}" onclick="toggleFav(event, ${JSON.stringify(g).replace(/"/g, '&quot;')})">‚òÖ</div>
                </div>`;
            }).join('');
            box.style.display = 'block';
        }
    }

    function toggleFav(e, city) {
        e.stopPropagation();
        const idx = favorites.findIndex(f => f.name === city.name);
        if(idx === -1) {
            if(favorites.length < 3) favorites.push({lat: city.latitude, lon: city.longitude, name: city.name});
        } else {
            favorites.splice(idx, 1);
        }
        localStorage.setItem('weatherFavs', JSON.stringify(favorites));
        search(document.getElementById('q').value);
        updatePages();
    }

    // --- –õ–û–ì–ò–ö–ê –°–¢–†–ê–ù–ò–¶ ---
    function updatePages() {
        navigator.geolocation.getCurrentPosition(p => {
            const myLoc = { lat: p.coords.latitude, lon: p.coords.longitude, name: '–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', isHome: true };
            pages = [myLoc, ...favorites];
            renderPagination();
            loadWeather(curIdx);
        }, () => {
            const moscow = { lat: 55.75, lon: 37.62, name: '–ú–æ—Å–∫–≤–∞', isHome: true };
            pages = [moscow, ...favorites];
            renderPagination();
            loadWeather(curIdx);
        });
    }

    function renderPagination() {
        const pag = document.getElementById('pag');
        pag.innerHTML = pages.map((p, i) => {
            if(p.isHome) return `<svg class="dot-loc ${curIdx===i?'active':''}" onclick="setPage(${i})" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>`;
            return `<div class="dot ${curIdx===i?'active':''}" onclick="setPage(${i})"></div>`;
        }).join('');
    }

    function setPage(i) { curIdx = i; loadWeather(i); renderPagination(); }
    function changePage(dir) { 
        let next = curIdx + dir;
        if(next >= 0 && next < pages.length) setPage(next);
    }

    // --- –ü–û–ì–û–î–ê ---
    async function loadWeather(idx) {
        const city = pages[idx];
        const d = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,is_day&timezone=auto&temperature_unit=${unit}`).then(r=>r.json());
        
        document.getElementById('fadeTarget').style.opacity = 0;
        setTimeout(() => {
            document.getElementById('place').innerText = city.name;
            document.getElementById('temp').innerText = Math.round(d.current.temperature_2m) + (unit==='celsius'?'¬∞':'¬∞F');
            document.getElementById('feel').innerText = Math.round(d.current.apparent_temperature) + '¬∞';
            document.getElementById('hum').innerText = d.current.relative_humidity_2m + '%';
            document.getElementById('ai').innerText = getAI(d.current.temperature_2m, d.current.weather_code);
            document.getElementById('fadeTarget').style.opacity = 1;
            initBG(d.current.is_day);
        }, 200);
    }

    function getAI(t, code) {
        let s = t > 20 ? "–¢–µ–ø–ª–æ, –Ω–∞–¥–µ–Ω—å—Ç–µ —Ñ—É—Ç–±–æ–ª–∫—É." : t > 10 ? "–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ, –ª—É—á—à–µ –≤–∑—è—Ç—å –ª–µ–≥–∫—É—é –∫—É—Ä—Ç–∫—É." : "–•–æ–ª–æ–¥–Ω–æ, –æ–¥–µ–≤–∞–π—Ç–µ—Å—å —Ç–µ–ø–ª–µ–µ.";
        if(code >= 61) s += " –ò –≤–æ–∑—å–º–∏—Ç–µ –∑–æ–Ω—Ç, –±—É–¥–µ—Ç –¥–æ–∂–¥—å! ‚òÇÔ∏è";
        return s;
    }

    function toggleUnit() {
        unit = unit === 'celsius' ? 'fahrenheit' : 'celsius';
        document.getElementById('uBtn').innerText = unit === 'celsius' ? 'C¬∞' : 'F¬∞';
        localStorage.setItem('weatherUnit', unit);
        loadWeather(curIdx);
    }

    function quickLoad(lat, lon, name) {
        document.getElementById('results').style.display='none';
        loadWeather(curIdx); // –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç —Ç–µ–∫—É—â–∏–π, –¥–ª—è –ø–æ–ª–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ —Å–ø–∏—Å–æ–∫.
    }

    // --- –°–í–ê–ô–ü–´ ---
    function ts(e) { startX = e.touches[0].clientX; }
    function te(e) {
        let endX = e.changedTouches[0].clientX;
        if(startX - endX > 80) changePage(1);
        if(endX - startX > 80) changePage(-1);
    }

    // --- –§–û–ù ---
    let blobs = [];
    function initBG(isDay) {
        blobs = [];
        const colors = isDay ? ['#007AFF', '#00C6FF', '#4facfe'] : ['#0f0c29', '#302b63', '#24243e'];
        for(let i=0; i<3; i++) blobs.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:canvas.width*0.8, c:colors[i], vx:Math.random()-0.5, vy:Math.random()-0.5});
    }
    function draw() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        blobs.forEach(b => {
            b.x += b.vx; b.y += b.vy;
            if(b.x<0 || b.x>canvas.width) b.vx*=-1; if(b.y<0 || b.y>canvas.height) b.vy*=-1;
            let g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r);
            g.addColorStop(0, b.c); g.addColorStop(1, 'transparent');
            ctx.globalCompositeOperation = 'screen'; ctx.fillStyle = g;
            ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
        });
        requestAnimationFrame(draw);
    }

    window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    window.onload = () => { window.onresize(); updatePages(); draw(); };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather iOS Ultimate</title>
    <style>
        :root { --glass: rgba(255, 255, 255, 0.1); --blur: blur(50px); --spring: cubic-bezier(0.2, 0.8, 0.2, 1); }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        canvas#bg { position: fixed; inset: 0; z-index: -1; }

        header { padding: 15px; max-width: 600px; margin: 0 auto; display: flex; gap: 10px; position: relative; z-index: 2000; }
        .search-box { flex: 1; display: flex; align-items: center; background: var(--glass); backdrop-filter: var(--blur); border-radius: 20px; padding: 10px 15px; border: 0.5px solid rgba(255,255,255,0.2); }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; margin-left: 10px; }
        .icon-btn { background: var(--glass); border: 0.5px solid rgba(255,255,255,0.2); border-radius: 15px; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: var(--blur); }

        #stage { height: 100vh; overflow-y: auto; overflow-x: hidden; padding: 20px 20px 150px; scroll-behavior: smooth; }
        .city-header { text-align: center; margin: 40px 0; }
        .temp-big { font-size: 110px; font-weight: 100; letter-spacing: -5px; margin: 5px 0; }
        
        .card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 28px; padding: 20px; border: 0.5px solid rgba(255,255,255,0.15); margin-bottom: 20px; }
        .card-label { font-size: 11px; opacity: 0.5; text-transform: uppercase; font-weight: 700; margin-bottom: 15px; }

        /* –ü–æ—á–∞—Å–æ–≤–∞—è */
        .h-scroll { display: flex; gap: 20px; overflow-x: auto; scrollbar-width: none; align-items: flex-start; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-item { text-align: center; min-width: 60px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .wind-icon { font-size: 12px; transition: transform 0.3s; }

        /* 3 –î–Ω—è */
        .day-row { display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; padding: 12px 0; border-bottom: 0.5px solid rgba(255,255,255,0.1); font-size: 14px; }
        .day-row:last-child { border: none; }
        .day-details { font-size: 11px; opacity: 0.6; display: flex; flex-direction: column; }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        #settings { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); z-index: 3000; display: none; padding: 40px 20px; }
        .close-settings { position: absolute; top: 20px; right: 20px; font-size: 30px; cursor: pointer; }

        .nav-dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); backdrop-filter: blur(20px); padding: 10px 20px; border-radius: 25px; display: flex; align-items: center; gap: 12px; border: 0.5px solid rgba(255,255,255,0.1); }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 50%; }
        .dot.active { background: #fff; }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<header>
    <div class="search-box">üîç <input id="q" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." oninput="search(this.value)"></div>
    <div class="icon-btn" onclick="toggleSet(true)">‚öôÔ∏è</div>
    <div id="results" style="position:absolute; top:75px; left:15px; right:15px; background:rgba(30,30,30,0.9); border-radius:20px; overflow:hidden; display:none; z-index:2500;"></div>
</header>

<div id="stage" ontouchstart="ts(event)" ontouchend="te(event)">
    <div class="city-header">
        <div id="cityName" style="font-size:32px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="temp-big" id="curTemp">--</div>
        <div id="minmax" style="font-size:18px; opacity:0.8">-- / --</div>
    </div>

    <div class="card">
        <div class="card-label">–ü–æ—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑, –≤–µ—Ç–µ—Ä</div>
        <div class="h-scroll" id="hList"></div>
    </div>

    <div class="card">
        <div class="card-label">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—è</div>
        <div id="dList"></div>
    </div>

    <div class="card" style="background:rgba(255,255,255,0.05)">
        <div class="card-label">ü§ñ AI –°–û–í–ï–¢</div>
        <div id="ai" style="line-height:1.4; font-size:15px">...</div>
    </div>
</div>

<div id="settings">
    <div class="close-settings" onclick="toggleSet(false)">‚úï</div>
    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
    <p>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: <span id="locStatus">–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...</span></p>
</div>

<div class="nav-dock" id="pag"></div>

<script>
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let pages = [], curIdx = 0, startX = 0;
    let env = { isDay: true, code: 0, wind: 0, wSpeed: 0, stars: [], clouds: [] };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    async function init() {
        resize();
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                p => fetchMain(p.coords.latitude, p.coords.longitude, '–ú–æ—è –ª–æ–∫–∞—Ü–∏—è'),
                () => fetchMain(55.75, 37.62, '–ú–æ—Å–∫–≤–∞')
            );
        } else fetchMain(55.75, 37.62, '–ú–æ—Å–∫–≤–∞');
        loop();
    }

    async function fetchMain(lat, lon, name) {
        pages = [{lat, lon, name, home: true}];
        const favs = JSON.parse(localStorage.getItem('favs') || '[]');
        pages.push(...favs);
        renderPag();
        loadWeather(0);
    }

    async function loadWeather(idx) {
        curIdx = idx;
        const city = pages[idx];
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,weather_code,is_day,wind_direction_10m,wind_speed_10m&hourly=temperature_2m,weather_code,wind_direction_10m,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,relative_humidity_2m_max,wind_speed_10m_max,wind_direction_10m_dominant&timezone=auto`).then(r=>r.json());
        
        env.isDay = !!res.current.is_day;
        env.code = res.current.weather_code;
        env.wind = res.current.wind_direction_10m;
        env.wSpeed = res.current.wind_speed_10m;

        document.getElementById('cityName').innerText = city.name;
        document.getElementById('curTemp').innerText = Math.round(res.current.temperature_2m) + '¬∞';
        document.getElementById('minmax').innerText = `–ú–∏–Ω: ${Math.round(res.daily.temperature_2m_min[0])}¬∞  –ú–∞–∫—Å: ${Math.round(res.daily.temperature_2m_max[0])}¬∞`;

        // –ü–æ—á–∞—Å–æ–≤–∞—è
        document.getElementById('hList').innerHTML = res.hourly.time.slice(0,24).map((t, i) => `
            <div class="h-item">
                <span style="font-size:12px; opacity:0.6">${new Date(t).getHours()}:00</span>
                <span style="font-size:20px">${res.hourly.weather_code[i] < 3 ? '‚òÄÔ∏è' : '‚òÅÔ∏è'}</span>
                <span style="font-weight:600">${Math.round(res.hourly.temperature_2m[i])}¬∞</span>
                <div class="wind-icon" style="transform:rotate(${res.hourly.wind_direction_10m[i]}deg)">‚Üë</div>
                <span style="font-size:10px">${Math.round(res.hourly.wind_speed_10m[i])} –º/—Å</span>
            </div>
        `).join('');

        // 3 –î–Ω—è
        document.getElementById('dList').innerHTML = res.daily.time.slice(0,3).map((t, i) => `
            <div class="day-row">
                <div class="day-details">
                    <b>${i===0?'–°–µ–≥–æ–¥–Ω—è':new Date(t).toLocaleDateString('ru',{weekday:'short'})}</b>
                    <span>${new Date(t).toLocaleDateString('ru',{day:'numeric', month:'short'})}</span>
                </div>
                <div style="text-align:center">
                    <span style="font-weight:600">${Math.round(res.daily.temperature_2m_max[i])}¬∞</span>
                    <span style="opacity:0.5; margin-left:5px">${Math.round(res.daily.temperature_2m_min[i])}¬∞</span>
                </div>
                <div class="day-details" style="text-align:right">
                    <span>üíß ${res.daily.relative_humidity_2m_max[i]}%</span>
                    <span>üí® ${Math.round(res.daily.wind_speed_10m_max[i])} –º/—Å</span>
                </div>
            </div>
        `).join('');

        // AI –°–æ–≤–µ—Ç
        let tip = "–ü–æ–≥–æ–¥–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è.";
        if(env.code >= 71) tip = "–ò–¥–µ—Ç —Å–Ω–µ–≥! –ù–∞–¥–µ–Ω—å—Ç–µ —Ç–µ–ø–ª—É—é –∫—É—Ä—Ç–∫—É –∏ —Å–∞–ø–æ–≥–∏.";
        else if(env.code >= 51) tip = "–ò–¥–µ—Ç –¥–æ–∂–¥—å, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –∑–æ–Ω—Ç.";
        else if(env.temp < -15) tip = "–û—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–æ, –±–µ—Ä–µ–≥–∏—Ç–µ –ª–∏—Ü–æ!";
        document.getElementById('ai').innerText = tip;

        initGraphics();
        renderPag();
    }

    // --- –ì—Ä–∞—Ñ–∏–∫–∞ ---
    function initGraphics() {
        env.stars = []; env.clouds = [];
        if(!env.isDay && env.code < 3) {
            for(let i=0; i<80; i++) env.stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*1.5, o:Math.random()});
        }
        if(env.code >= 3) {
            for(let i=0; i<6; i++) env.clouds.push({x:Math.random()*canvas.width, y:Math.random()*400, r:100+Math.random()*100, v:(env.wind > 180 ? 1 : -1) * (0.2 + Math.random())});
        }
    }

    function loop() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        const g = ctx.createLinearGradient(0,0,0,canvas.height);
        if(env.isDay) { g.addColorStop(0, '#00C6FF'); g.addColorStop(1, '#007AFF'); }
        else { g.addColorStop(0, '#0F0C29'); g.addColorStop(1, '#24243E'); }
        ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width, canvas.height);

        if(!env.isDay && env.code < 3) {
            env.stars.forEach(s => {
                s.o += 0.01;
                ctx.fillStyle = `rgba(255,255,255,${Math.abs(Math.sin(s.o))})`;
                ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
            });
        }

        env.clouds.forEach(c => {
            c.x += c.v;
            if(c.x > canvas.width + 200) c.x = -200;
            if(c.x < -200) c.x = canvas.width + 200;
            let cg = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, c.r);
            cg.addColorStop(0, 'rgba(255,255,255,0.4)'); cg.addColorStop(1, 'transparent');
            ctx.fillStyle = cg; ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.fill();
        });

        requestAnimationFrame(loop);
    }

    // --- –ü–æ–∏—Å–∫ –∏ –°–≤–∞–π–ø—ã ---
    async function search(v) {
        if(v.length < 2) return document.getElementById('results').style.display='none';
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${v}&count=5&language=ru`).then(res=>res.json());
        if(r.results) {
            const box = document.getElementById('results');
            box.innerHTML = r.results.map(g => `<div style="padding:15px; border-bottom:1px solid #444;" onclick="addCity(${g.latitude},${g.longitude},'${g.name}')">${g.name}, ${g.country}</div>`).join('');
            box.style.display = 'block';
        }
    }

    function addCity(lat, lon, name) {
        document.getElementById('results').style.display = 'none';
        pages.push({lat, lon, name});
        localStorage.setItem('favs', JSON.stringify(pages.slice(1)));
        loadWeather(pages.length-1);
    }

    function ts(e) { startX = e.touches[0].clientX; }
    function te(e) {
        const diff = startX - e.changedTouches[0].clientX;
        if(Math.abs(diff) > 100) {
            if(diff > 0 && curIdx < pages.length-1) loadWeather(curIdx+1);
            else if(diff < 0 && curIdx > 0) loadWeather(curIdx-1);
        }
    }

    function toggleSet(show) { document.getElementById('settings').style.display = show ? 'block' : 'none'; }
    function renderPag() {
        document.getElementById('pag').innerHTML = pages.map((_, i) => `<div class="dot ${curIdx===i?'active':''}"></div>`).join('');
    }
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

    window.onresize = resize;
    init();
</script>
</body>
</html>

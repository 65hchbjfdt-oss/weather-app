<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather iOS Pro</title>
    <style>
        :root { 
            --glass: rgba(50, 50, 50, 0.4); 
            --glass-light: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --blur: blur(35px); 
            --spring: cubic-bezier(0.25, 0.8, 0.25, 1);
            --ios-spring: cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-font-smoothing: antialiased; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; touch-action: pan-y; }
        
        /* –§–æ–Ω-–∞–Ω–∏–º–∞—Ü–∏—è */
        canvas#bg { position: fixed; inset: 0; z-index: -1; transition: filter 1s ease; pointer-events: none; }

        /* –ü–æ–∏—Å–∫ */
        header { padding: 40px 20px 10px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; gap: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); pointer-events: none; }
        .search-wrapper { flex: 1; pointer-events: auto; position: relative; }
        .search-box { display: flex; align-items: center; background: rgba(40,40,40,0.7); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); border-radius: 14px; padding: 8px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid var(--glass-border); }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 17px; outline: none; margin-left: 8px; padding: 5px 0; }
        
        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ */
        #results { position: absolute; top: 50px; left: 0; right: 0; background: rgba(30,30,30,0.95); border-radius: 14px; overflow: hidden; display: none; z-index: 2500; border: 1px solid var(--glass-border); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px); max-height: 300px; overflow-y: auto; }
        .res-item { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: background 0.2s; }
        .res-item:hover, .res-item:active { background: rgba(255,255,255,0.05); }
        .res-item:last-child { border: none; }
        .res-main { font-size: 16px; color: #fff; }
        .res-sub { font-size: 13px; color: #aaa; margin-top: 2px; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü */
        #stage { height: 100vh; width: 100vw; position: relative; overflow: hidden; touch-action: pan-y; }
        
        /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–æ—Ä–æ–¥–∞ */
        .page-container {
            position: absolute; inset: 0;
            padding: 100px 20px 140px;
            transition: transform 0.6s var(--ios-spring), opacity 0.5s var(--ios-spring);
            overflow-y: auto; scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            opacity: 0;
            transform: translateX(100%);
            pointer-events: none;
        }
        .page-container.active { 
            display: block; 
            transform: translateX(0); 
            opacity: 1; 
            z-index: 5; 
            pointer-events: auto;
        }
        .page-container.prev { 
            display: block; 
            transform: translateX(-30%); 
            opacity: 0.3; 
            z-index: 1; 
            pointer-events: none;
        }
        .page-container.next { 
            display: block; 
            transform: translateX(100%); 
            opacity: 0; 
            z-index: 6; 
            pointer-events: none;
        }

        /* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
        .city-header { text-align: center; margin-bottom: 40px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .city-name { font-size: 32px; font-weight: 600; margin-bottom: 5px; }
        .temp-big { font-size: 90px; font-weight: 200; letter-spacing: -2px; line-height: 1.1; margin: 5px 0; }
        .condition-text { font-size: 18px; font-weight: 500; opacity: 0.9; text-transform: capitalize; margin-bottom: 10px; }
        .hl-temp { font-size: 18px; font-weight: 500; margin-top: 5px; opacity: 0.8; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { 
            background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border-radius: 20px; padding: 20px; border: 1px solid var(--glass-border); margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .card-label { font-size: 13px; opacity: 0.6; text-transform: uppercase; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; letter-spacing: 0.5px; }

        /* –°–µ—Ç–∫–∞ –ø–ª–∏—Ç–æ–∫ 2x2 */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .tile { aspect-ratio: 1; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; }
        .tile-val { font-size: 26px; font-weight: 500; }
        .tile-sub { font-size: 13px; opacity: 0.7; }

        /* –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Å–∫—Ä–æ–ª–ª—ã */
        .h-scroll { display: flex; gap: 25px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; padding-left: 5px; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-item { text-align: center; min-width: 60px; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: transform 0.2s; }
        .h-item.active { transform: scale(1.1); }
        .h-time { font-size: 14px; font-weight: 600; opacity: 0.9; }
        .h-temp { font-size: 16px; font-weight: 500; }

        .day-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 16px; font-weight: 500; }
        .day-row:last-child { border: none; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–æ—á–∫–∏) */
        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.7); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); padding: 10px 20px; border-radius: 25px; display: flex; gap: 10px; z-index: 2000; border: 1px solid rgba(255,255,255,0.15); pointer-events: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: all 0.3s var(--ios-spring); }
        .dot.active { background: #fff; transform: scale(1.3); box-shadow: 0 0 10px rgba(255,255,255,0.5); }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; background: rgba(60,60,60,0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; pointer-events: auto; transition: transform 0.2s, background 0.2s; }
        .btn-circle:active { transform: scale(0.95); background: rgba(80,80,80,0.8); }
        
        /* –ü–†–ï–î–ü–†–û–°–ú–û–¢–† (–ú–æ–¥–∞–ª–∫–∞) */
        #preview-modal { 
            position: fixed; inset: 0; z-index: 3000; 
            background: rgba(0,0,0,0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: none; flex-direction: column; opacity: 0;
            transition: opacity 0.3s var(--ios-spring);
        }
        #preview-modal.show { display: flex; opacity: 1; }
        .preview-header { padding: 50px 20px 20px; display: flex; justify-content: space-between; align-items: center; }
        .preview-content { flex: 1; overflow-y: auto; padding: 0 20px 40px; }
        .preview-actions { padding: 30px 20px; display: flex; justify-content: center; gap: 20px; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); }
        .add-btn { background: linear-gradient(135deg, #007AFF, #5856D6); color: #fff; padding: 14px 40px; border-radius: 25px; font-weight: 600; border: none; font-size: 16px; cursor: pointer; transition: transform 0.2s, opacity 0.2s; }
        .add-btn:active { transform: scale(0.95); opacity: 0.9; }

        /* –°–û–õ–ù–¶–ï (–ú–æ–¥–∞–ª–∫–∞) */
        #sun-modal { 
            position: fixed; inset: 0; z-index: 3500; 
            background: rgba(20,20,20,0.98); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
            transform: translateY(100%); transition: transform 0.4s var(--ios-spring); 
            display: flex; flex-direction: column; border-radius: 20px 20px 0 0;
        }
        #sun-modal.open { transform: translateY(0); }
        .sun-modal-head { display: flex; justify-content: space-between; align-items: center; padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }
        .sun-modal-body { padding: 20px; flex: 1; overflow-y: auto; }
        .sun-detail-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 17px; }
        .sun-detail-row:last-child { border-bottom: none; }
        .sun-graph-lg { width: 100%; height: 200px; margin: 30px 0; border-radius: 15px; overflow: hidden; }

        /* AI Text */
        .ai-box { 
            background: rgba(255,255,255,0.08); 
            border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 20px; padding: 20px; margin-top: 20px;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .ai-title { font-size: 14px; font-weight: 700; color: #FFD60A; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .ai-text { font-size: 15px; line-height: 1.5; opacity: 0.9; }

        /* List Menu (Settings/Favorites) */
        #settings-layer { 
            position: fixed; inset: 0; 
            background: rgba(0,0,0,0.95); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            z-index: 2900; transform: translateX(-100%); 
            transition: transform 0.4s var(--ios-spring); 
            padding: 50px 20px; overflow-y: auto;
        }
        #settings-layer.show { transform: translateX(0); }
        .list-item { 
            background: rgba(255,255,255,0.1); 
            padding: 18px; border-radius: 15px; margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* –í–µ—Ç—Ä–æ–≤—ã–µ –µ–¥–∏–Ω–∏—Ü—ã */
        .unit-selector { display: flex; gap: 10px; margin-top: 10px; }
        .unit-btn { 
            flex: 1; padding: 12px; text-align: center; 
            background: rgba(255,255,255,0.1); border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2); cursor: pointer;
            transition: all 0.2s;
        }
        .unit-btn.active { background: #007AFF; border-color: #007AFF; }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loader { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #007AFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <canvas id="bg"></canvas>

    <header>
        <div class="btn-circle" onclick="toggleSettings(true)" style="margin-right: 10px;">‚ò∞</div>
        <div class="search-wrapper">
            <div class="search-box">
                <span style="opacity:0.6">üîç</span>
                <input id="q" placeholder="–ü–æ–∏—Å–∫ (–ì–æ—Ä–æ–¥, –°—Ç—Ä–∞–Ω–∞)" oninput="doSearch(this.value)">
            </div>
            <div id="results"></div>
        </div>
    </header>

    <div id="stage"></div>

    <div class="nav-dock" id="pagination"></div>

    <div id="settings-layer">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h1 style="margin:0; font-size:28px; font-weight:600">–ú–æ–∏ –≥–æ—Ä–æ–¥–∞</h1>
            <div class="btn-circle" onclick="toggleSettings(false)">‚úï</div>
        </div>
        <div id="fav-list"></div>
        <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
            <h3 style="opacity:0.5; margin-bottom: 15px;">–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è</h3>
            <div class="list-item" onclick="toggleUnit('temp')">
                <span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span>
                <span id="unit-disp" style="color:#0a84ff; font-weight:500">¬∞C</span>
            </div>
            <div class="list-item">
                <span>–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞</span>
                <div class="unit-selector">
                    <div class="unit-btn ${localStorage.getItem('windUnit') === 'm/s' ? 'active' : ''}" onclick="toggleUnit('wind', 'm/s')">–º/—Å</div>
                    <div class="unit-btn ${localStorage.getItem('windUnit') === 'km/h' ? 'active' : ''}" onclick="toggleUnit('wind', 'km/h')">–∫–º/—á</div>
                    <div class="unit-btn ${localStorage.getItem('windUnit') === 'mph' ? 'active' : ''}" onclick="toggleUnit('wind', 'mph')">mph</div>
                </div>
            </div>
        </div>
    </div>

    <div id="preview-modal">
        <div class="preview-header">
            <div class="btn-circle" onclick="closePreview()">‚úï</div>
            <span style="font-weight:600; opacity:0.8">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
            <div style="width:40px"></div>
        </div>
        <div class="preview-content" id="preview-inner"></div>
        <div class="preview-actions">
            <button class="add-btn" onclick="confirmAddCity()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="sun-modal">
        <div class="sun-modal-head">
            <span style="font-size:18px; font-weight:600">–°–æ–ª–Ω—Ü–µ –∏ –õ—É–Ω–∞</span>
            <div class="btn-circle" style="width:30px; height:30px; font-size:14px;" onclick="document.getElementById('sun-modal').classList.remove('open')">‚úï</div>
        </div>
        <div class="sun-modal-body" id="sun-details-content">
        </div>
    </div>

<script>
    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    let cities = []; // {lat, lon, name, region, country, isHome}
    let currentIndex = 0;
    let unit = localStorage.getItem('unit') || 'C';
    let windUnit = localStorage.getItem('windUnit') || 'km/h';
    let tempCity = null;
    let isSwiping = false;
    
    // –ì—Ä–∞—Ñ–∏–∫–∞
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let env = { 
        wCode: 0, 
        isDay: 1, 
        stars: [], 
        rain: [], 
        clouds: [],
        timeFactor: 0,
        bgColors: {day: ['#0f2027', '#2c5364'], night: ['#0c0c0c', '#1a1a2e'], sunset: ['#ff7e5f', '#feb47b'], rain: ['#2c3e50', '#4ca1af']}
    };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    async function init() {
        resize();
        window.addEventListener('resize', resize);
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö
        const saved = JSON.parse(localStorage.getItem('savedCities') || '[]');
        if (saved.length > 0) {
            cities = saved;
            await loadWeather(0);
        } else {
            // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
            navigator.geolocation.getCurrentPosition(
                async pos => {
                    const data = await getGeoName(pos.coords.latitude, pos.coords.longitude);
                    cities = [{...data, isHome: true}];
                    saveCities();
                    await loadWeather(0);
                },
                () => {
                    cities = [{lat: 55.75, lon: 37.62, name: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è', isHome: true}];
                    saveCities();
                    loadWeather(0);
                }
            );
        }
        
        document.getElementById('unit-disp').innerText = unit === 'C' ? '¬∞C' : '¬∞F';
        initAnimation();
        
        // –°–≤–∞–π–ø—ã
        let sx = 0, sy = 0;
        document.getElementById('stage').addEventListener('touchstart', e => {
            sx = e.touches[0].clientX;
            sy = e.touches[0].clientY;
            isSwiping = false;
        });
        
        document.getElementById('stage').addEventListener('touchmove', e => {
            const diffX = Math.abs(sx - e.touches[0].clientX);
            const diffY = Math.abs(sy - e.touches[0].clientY);
            // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å–≤–∞–π–ø—ã –µ—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –±–æ–ª—å—à–µ –ø–æ X
            if (diffX > diffY && diffX > 10) {
                isSwiping = true;
                e.preventDefault();
            }
        });
        
        document.getElementById('stage').addEventListener('touchend', e => {
            if (!isSwiping) return;
            const diff = sx - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
                if (diff > 0 && currentIndex < cities.length - 1) changePage(currentIndex + 1);
                else if (diff < 0 && currentIndex > 0) changePage(currentIndex - 1);
            }
            isSwiping = false;
        });
    }

    // --- API & –õ–æ–≥–∏–∫–∞ ---
    
    async function getGeoName(lat, lon) {
        try {
            const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ru`);
            const d = await r.json();
            return {
                lat, lon,
                name: d.address.city || d.address.town || d.address.village || '–ú–æ–µ –º–µ—Å—Ç–æ',
                region: d.address.state || '',
                country: d.address.country || ''
            };
        } catch { return {lat, lon, name:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', region:'', country:''}; }
    }

    async function doSearch(q) {
        const resBox = document.getElementById('results');
        if (q.length < 2) { resBox.style.display = 'none'; return; }
        
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=5&language=ru`).then(x => x.json());
        if (!r.results) return;

        resBox.innerHTML = r.results.map(i => `
            <div class="res-item" onclick="openPreview(${i.latitude}, ${i.longitude}, '${i.name.replace(/'/g, "\\'")}', '${(i.admin1 || '').replace(/'/g, "\\'")}', '${(i.country || '').replace(/'/g, "\\'")}')">
                <div class="res-main">${i.name}</div>
                <div class="res-sub">${i.admin1 ? i.admin1 + ', ' : ''}${i.country}</div>
            </div>
        `).join('');
        resBox.style.display = 'block';
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ ---

    async function openPreview(lat, lon, name, region, country) {
        document.getElementById('results').style.display = 'none';
        document.getElementById('q').value = '';
        
        const exists = cities.findIndex(c => Math.abs(c.lat - lat) < 0.01 && Math.abs(c.lon - lon) < 0.01);
        if (exists !== -1) {
            changePage(exists);
            return;
        }

        tempCity = { lat, lon, name, region, country };
        const modal = document.getElementById('preview-modal');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
        document.getElementById('preview-inner').innerHTML = '<div class="loader"></div>';
        
        const data = await fetchWeatherData(lat, lon);
        updateEnv(data);
        document.getElementById('preview-inner').innerHTML = generateHTML(data, tempCity, false);
        
        setTimeout(() => drawSunCanvas(`sun-canvas-preview`, data), 100);
    }

    function closePreview() {
        const modal = document.getElementById('preview-modal');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
        tempCity = null;
    }

    async function confirmAddCity() {
        if (tempCity) {
            cities.push(tempCity);
            saveCities();
            closePreview();
            await loadWeather(cities.length - 1);
            changePage(cities.length - 1);
        }
    }

    function saveCities() {
        localStorage.setItem('savedCities', JSON.stringify(cities));
        renderFavList();
    }

    // --- –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥—ã ---

    async function loadWeather(idx) {
        const stage = document.getElementById('stage');
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        let container = document.getElementById(`page-${idx}`);
        if (!container) {
            container = document.createElement('div');
            container.className = 'page-container';
            container.id = `page-${idx}`;
            stage.appendChild(container);
        }
        
        updatePagination();
        
        const city = cities[idx];
        container.innerHTML = '<div class="loader"></div>';
        
        const data = await fetchWeatherData(city.lat, city.lon);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (idx === currentIndex) updateEnv(data);
        
        container.innerHTML = generateHTML(data, city, true);
        
        // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å–æ–ª–Ω—Ü–∞
        setTimeout(() => drawSunCanvas(`sun-graph-${idx}`, data), 50);
        return data;
    }
    
    async function changePage(idx) {
        const prevIndex = currentIndex;
        currentIndex = idx;
        
        const pages = document.querySelectorAll('.page-container');
        pages.forEach((p, i) => {
            p.className = 'page-container';
            if (i === idx) p.classList.add('active');
            else if (i < idx) p.classList.add('prev');
            else p.classList.add('next');
        });
        
        updatePagination();
        
        // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        const container = document.getElementById(`page-${idx}`);
        if (container.innerHTML.includes('loader') || container.innerHTML === '') {
            const data = await loadWeather(idx);
            updateEnv(data);
        } else {
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏–∑ –¥–∞–Ω–Ω—ã—Ö
            try {
                const temp = container.querySelector('.temp-big').textContent;
                const condition = container.querySelector('.condition-text').textContent;
                // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ env
                env.isDay = new Date().getHours() > 6 && new Date().getHours() < 20 ? 1 : 0;
                env.wCode = condition.includes('—è—Å–Ω–æ') ? 0 : condition.includes('–¥–æ–∂–¥') ? 61 : 2;
            } catch(e) {}
        }
    }

    async function fetchWeatherData(lat, lon) {
        const uParams = `&current=temperature_2m,weather_code,is_day,wind_speed_10m,wind_direction_10m,pressure_msl,relative_humidity_2m&hourly=temperature_2m,weather_code,time&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,daylight_duration&timezone=auto`;
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}${uParams}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('API error');
        return await response.json();
    }

    // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML ---
    
    function generateHTML(data, cityInfo, isMain) {
        const cur = data.current;
        const daily = data.daily;
        const hourly = data.hourly;
        const idx = isMain ? cities.indexOf(cityInfo) : 'preview';
        
        const desc = getWDesc(cur.weather_code, cur.is_day);
        const temp = unit === 'F' ? Math.round(cur.temperature_2m * 9/5 + 32) : Math.round(cur.temperature_2m);
        const min = unit === 'F' ? Math.round(daily.temperature_2m_min[0] * 9/5 + 32) : Math.round(daily.temperature_2m_min[0]);
        const max = unit === 'F' ? Math.round(daily.temperature_2m_max[0] * 9/5 + 32) : Math.round(daily.temperature_2m_max[0]);
        
        // –í–µ—Ç–µ—Ä —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –µ–¥–∏–Ω–∏—Ü
        let windSpeed = cur.wind_speed_10m;
        let windUnitText = '–∫–º/—á';
        if (windUnit === 'm/s') {
            windSpeed = (windSpeed / 3.6).toFixed(1);
            windUnitText = '–º/—Å';
        } else if (windUnit === 'mph') {
            windSpeed = (windSpeed * 0.621371).toFixed(1);
            windUnitText = 'mph';
        } else {
            windSpeed = Math.round(windSpeed);
        }
        
        // –ü–æ—á–∞—Å–æ–≤–∞—è —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –ø–æ "–°–µ–π—á–∞—Å"
        let hourlyHTML = '';
        const now = new Date();
        const currentHour = now.getHours();
        
        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Å–∞ –≤ –¥–∞–Ω–Ω—ã—Ö
        let startIndex = 0;
        for (let i = 0; i < hourly.time.length; i++) {
            const hourTime = new Date(hourly.time[i]);
            if (hourTime.getHours() >= currentHour) {
                startIndex = i;
                break;
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 12 —á–∞—Å–æ–≤, –Ω–∞—á–∏–Ω–∞—è —Å —Ç–µ–∫—É—â–µ–≥–æ
        for(let i = startIndex; i < Math.min(startIndex + 12, hourly.time.length); i++) {
            const hourTime = new Date(hourly.time[i]);
            const hour = hourTime.getHours();
            const isCurrentHour = i === startIndex;
            
            const hTemp = unit === 'F' ? Math.round(hourly.temperature_2m[i] * 9/5 + 32) : Math.round(hourly.temperature_2m[i]);
            const hourDisplay = isCurrentHour ? '–°–µ–π—á–∞—Å' : `${hour}:00`;
            
            hourlyHTML += `
                <div class="h-item ${isCurrentHour ? 'active' : ''}">
                    <div class="h-time">${hourDisplay}</div>
                    <div style="font-size:24px; margin:4px 0">${getWIcon(hourly.weather_code[i], hour)}</div>
                    <div class="h-temp">${hTemp}¬∞</div>
                </div>
            `;
        }

        // Daily
        let dailyHTML = '';
        const days = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
        for(let i = 0; i < Math.min(5, daily.time.length); i++) {
            const date = new Date(daily.time[i]);
            const dayName = i===0 ? '–°–µ–≥–æ–¥–Ω—è' : days[date.getDay()];
            const dMin = unit === 'F' ? Math.round(daily.temperature_2m_min[i]*9/5+32) : Math.round(daily.temperature_2m_min[i]);
            const dMax = unit === 'F' ? Math.round(daily.temperature_2m_max[i]*9/5+32) : Math.round(daily.temperature_2m_max[i]);
            
            dailyHTML += `
                <div class="day-row">
                    <div style="text-transform:capitalize">${dayName}</div>
                    <div style="text-align:center; font-size:20px">${getWIcon(daily.weather_code[i])}</div>
                    <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end">
                        <span style="opacity:0.5">${dMin}¬∞</span>
                        <span style="font-weight:600">${dMax}¬∞</span>
                    </div>
                </div>
            `;
        }

        // –°–æ–ª–Ω—Ü–µ –¥–∞–Ω–Ω—ã–µ
        const sunData = encodeURIComponent(JSON.stringify({
            rise: daily.sunrise[0],
            set: daily.sunset[0],
            dur: daily.daylight_duration[0]
        }));
        
        // AI Text —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
        const aiText = getAIText(cur.temperature_2m, cur.weather_code, cur.wind_speed_10m, cur.pressure_msl);

        return `
            <div class="city-header">
                <div class="city-name">${cityInfo.name}</div>
                <div class="condition-text">${desc}</div>
                <div class="temp-big">${temp}¬∞</div>
                <div class="hl-temp">–ú–∞–∫—Å.: ${max}¬∞ ‚Ä¢ –ú–∏–Ω.: ${min}¬∞</div>
            </div>

            <div class="card">
                <div class="card-label">üïì –ü–û–ß–ê–°–û–í–û–ô –ü–†–û–ì–ù–û–ó</div>
                <div class="h-scroll">
                    ${hourlyHTML}
                </div>
            </div>

            <div class="card">
                <div class="card-label">üìÖ –ü–†–û–ì–ù–û–ó –ù–ê 5 –î–ù–ï–ô</div>
                ${dailyHTML}
            </div>

            <div class="grid-2">
                <div class="card tile" onclick="openSunDetail('${sunData}')" style="cursor:pointer">
                    <div class="card-label">üåÖ –í–û–°–•–û–î –ò –ó–ê–ö–ê–¢</div>
                    <div style="position:relative; width:100%; height:60px; margin-top:10px;">
                        <canvas id="sun-graph-${idx}" width="300" height="120" style="width:100%; height:100%"></canvas>
                    </div>
                    <div class="tile-sub">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</div>
                </div>

                <div class="card tile">
                    <div class="card-label">üåô –õ–£–ù–ê</div>
                    <div style="font-size:15px; font-weight:500">–†–∞—Å—Ç—É—â–∞—è –ª—É–Ω–∞</div>
                    <div style="font-size:30px; text-align:center; margin:5px 0">üåñ</div>
                    <div class="tile-sub">–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å: 78%</div>
                </div>

                <div class="card tile">
                    <div class="card-label">üí® –í–ï–¢–ï–†</div>
                    <div class="tile-val">${windSpeed} <span style="font-size:16px">${windUnitText}</span></div>
                    <div class="tile-sub">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${cur.wind_direction_10m}¬∞</div>
                </div>

                <div class="card tile">
                    <div class="card-label">üìâ –î–ê–í–õ–ï–ù–ò–ï</div>
                    <div class="tile-val">${Math.round(cur.pressure_msl * 0.75)} <span style="font-size:16px">–º–º</span></div>
                    <div class="tile-sub">—Ä—Ç. —Å—Ç.</div>
                </div>
            </div>

            <div class="ai-box">
                <div class="ai-title">ü§ñ AI –ü–û–ú–û–©–ù–ò–ö</div>
                <div class="ai-text">${aiText}</div>
            </div>
        `;
    }

    // --- –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–æ–Ω–∞ ---
    function initAnimation() {
        const count = 150;
        for(let i=0; i<count; i++) {
            env.stars.push({
                x: Math.random()*canvas.width,
                y: Math.random()*canvas.height,
                s: Math.random()*2 + 0.5,
                a: Math.random()*0.8 + 0.2,
                speed: Math.random()*0.2 + 0.1
            });
        }
        
        for(let i=0; i<20; i++) {
            env.clouds.push({
                x: Math.random()*canvas.width,
                y: Math.random()*canvas.height*0.5,
                w: Math.random()*100 + 50,
                h: Math.random()*30 + 20,
                speed: Math.random()*0.3 + 0.1,
                a: Math.random()*0.3 + 0.1
            });
        }
        
        for(let i=0; i<30; i++) {
            env.rain.push({
                x: Math.random()*canvas.width,
                y: Math.random()*canvas.height,
                length: Math.random()*20 + 10,
                speed: Math.random()*10 + 5,
                a: Math.random()*0.5 + 0.3
            });
        }
        
        animate();
    }
    
    function updateEnv(data) {
        env.wCode = data.current.weather_code;
        env.isDay = data.current.is_day;
        env.timeFactor = new Date().getHours() / 24;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–≥–æ–¥—ã
        if (env.wCode >= 51 && env.wCode <= 67) {
            // –î–æ–∂–¥—å
            env.bgColors = {day: ['#2c3e50', '#4ca1af'], night: ['#1a1a2e', '#16213e']};
        } else if (env.wCode >= 71 && env.wCode <= 77) {
            // –°–Ω–µ–≥
            env.bgColors = {day: ['#E6F5FF', '#CCEBFF'], night: ['#1a237e', '#283593']};
        } else if (env.isDay) {
            // –î–µ–Ω—å
            const hour = new Date().getHours();
            if (hour >= 6 && hour <= 9) {
                env.bgColors = {day: ['#ffecd2', '#fcb69f']}; // –£—Ç—Ä–æ
            } else if (hour >= 16 && hour <= 19) {
                env.bgColors = {day: ['#ff7e5f', '#feb47b']}; // –ó–∞–∫–∞—Ç
            } else {
                env.bgColors = {day: ['#0f2027', '#2c5364']}; // –î–µ–Ω—å
            }
        } else {
            // –ù–æ—á—å
            env.bgColors = {day: ['#0c0c0c', '#1a1a2e']};
        }
    }
    
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
        const colors = env.bgColors.day;
        const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        grad.addColorStop(0, colors[0]);
        grad.addColorStop(1, colors[1]);
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // –ó–≤–µ–∑–¥—ã (—Ç–æ–ª—å–∫–æ –Ω–æ—á—å—é)
        if (!env.isDay) {
            ctx.fillStyle = '#ffffff';
            env.stars.forEach(s => {
                s.a += (Math.sin(Date.now()*0.001 + s.x)*0.5 + 0.5)*0.1 - 0.05;
                s.a = Math.max(0.1, Math.min(0.9, s.a));
                ctx.globalAlpha = s.a;
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.s, 0, Math.PI*2);
                ctx.fill();
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
                s.y += s.speed;
                if (s.y > canvas.height) {
                    s.y = 0;
                    s.x = Math.random()*canvas.width;
                }
            });
            ctx.globalAlpha = 1;
        }
        
        // –û–±–ª–∞–∫–∞
        if (env.wCode <= 3) {
            ctx.fillStyle = `rgba(255, 255, 255, ${env.isDay ? 0.2 : 0.1})`;
            env.clouds.forEach(c => {
                ctx.globalAlpha = c.a;
                ctx.beginPath();
                ctx.ellipse(c.x, c.y, c.w/2, c.h/2, 0, 0, Math.PI*2);
                ctx.fill();
                
                c.x += c.speed;
                if (c.x > canvas.width + c.w) {
                    c.x = -c.w;
                    c.y = Math.random()*canvas.height*0.5;
                }
            });
            ctx.globalAlpha = 1;
        }
        
        // –î–æ–∂–¥—å
        if (env.wCode >= 51 && env.wCode <= 67) {
            ctx.strokeStyle = `rgba(174, 194, 224, 0.6)`;
            ctx.lineWidth = 1;
            env.rain.forEach(r => {
                ctx.globalAlpha = r.a;
                ctx.beginPath();
                ctx.moveTo(r.x, r.y);
                ctx.lineTo(r.x + 2, r.y + r.length);
                ctx.stroke();
                
                r.y += r.speed;
                if (r.y > canvas.height) {
                    r.y = -r.length;
                    r.x = Math.random()*canvas.width;
                }
            });
            ctx.globalAlpha = 1;
        }
        
        requestAnimationFrame(animate);
    }

    function drawSunCanvas(id, data) {
        const c = document.getElementById(id);
        if(!c) return;
        const cx = c.getContext('2d');
        const w = c.width, h = c.height;
        
        cx.clearRect(0,0,w,h);
        
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç –Ω–µ–±–∞
        const skyGrad = cx.createLinearGradient(0,0,0,h);
        skyGrad.addColorStop(0, '#1a2980');
        skyGrad.addColorStop(0.5, '#26d0ce');
        skyGrad.addColorStop(1, '#1a2980');
        cx.fillStyle = skyGrad;
        cx.fillRect(0,0,w,h);
        
        // –ì–æ—Ä–∏–∑–æ–Ω—Ç
        cx.beginPath();
        cx.strokeStyle = 'rgba(255,255,255,0.4)';
        cx.lineWidth = 2;
        cx.moveTo(0, h/2);
        cx.lineTo(w, h/2);
        cx.stroke();
        
        // –°–∏–Ω—É—Å–æ–∏–¥–∞ —Å–æ–ª–Ω—Ü–∞
        cx.beginPath();
        cx.strokeStyle = '#FFD60A';
        cx.lineWidth = 4;
        cx.shadowColor = '#FFD60A';
        cx.shadowBlur = 10;
        for(let x=0; x<=w; x++) {
            let y = Math.sin((x/w)*Math.PI) * (h/2 - 20);
            cx.lineTo(x, h/2 - y);
        }
        cx.stroke();
        cx.shadowBlur = 0;
        
        // –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è —Å–æ–ª–Ω—Ü–∞
        const now = new Date();
        const riseTime = new Date(data.daily.sunrise[0]);
        const setTime = new Date(data.daily.sunset[0]);
        
        if (now >= riseTime && now <= setTime) {
            const dayDuration = setTime - riseTime;
            const currentProgress = (now - riseTime) / dayDuration;
            const xPos = currentProgress * w;
            const yPos = Math.sin(currentProgress * Math.PI) * (h/2 - 20);
            
            // –°–æ–ª–Ω—Ü–µ
            cx.beginPath();
            cx.fillStyle = '#fff';
            cx.shadowColor = '#FFD60A';
            cx.shadowBlur = 20;
            cx.arc(xPos, h/2 - yPos, 8, 0, Math.PI*2);
            cx.fill();
            cx.shadowBlur = 0;
        }
    }

    // --- –î–µ—Ç–∞–ª—å–Ω–æ–µ –º–µ–Ω—é –°–æ–ª–Ω—Ü–∞ ---
    function openSunDetail(json) {
        const d = JSON.parse(decodeURIComponent(json));
        const modal = document.getElementById('sun-modal');
        const content = document.getElementById('sun-details-content');
        
        const rise = new Date(d.rise);
        const set = new Date(d.set);
        const riseStr = `${rise.getHours().toString().padStart(2,'0')}:${rise.getMinutes().toString().padStart(2,'0')}`;
        const setStr = `${set.getHours().toString().padStart(2,'0')}:${set.getMinutes().toString().padStart(2,'0')}`;
        const durH = Math.floor(d.dur / 3600);
        const durM = Math.round((d.dur % 3600) / 60);
        
        const firstLight = new Date(rise);
        firstLight.setMinutes(firstLight.getMinutes() - 30);
        const lastLight = new Date(set);
        lastLight.setMinutes(lastLight.getMinutes() + 30);

        content.innerHTML = `
            <div style="text-align:center; padding: 20px 0; background: rgba(255,215,10,0.1); border-radius: 15px; margin-bottom: 30px;">
                <span style="font-size:14px; opacity:0.7">–°–≤–µ—Ç–æ–≤–æ–π –¥–µ–Ω—å</span>
                <div style="font-size:32px; font-weight:600; color:#FFD60A">${durH} —á ${durM} –º–∏–Ω</div>
            </div>
            
            <div class="sun-graph-lg">
                <canvas id="sun-detailed-graph" width="600" height="200" style="width:100%; height:100%"></canvas>
            </div>
            
            <div class="sun-detail-row">
                <span>–ü–µ—Ä–≤—ã–µ –ª—É—á–∏</span>
                <span style="color:#FFD60A">${firstLight.getHours().toString().padStart(2,'0')}:${firstLight.getMinutes().toString().padStart(2,'0')}</span>
            </div>
            <div class="sun-detail-row">
                <span style="font-weight:500">–í–æ—Å—Ö–æ–¥</span>
                <span style="color:#FF9F0A; font-weight:600">${riseStr}</span>
            </div>
            <div class="sun-detail-row">
                <span style="font-weight:500">–ó–∞–∫–∞—Ç</span>
                <span style="color:#FF6B35; font-weight:600">${setStr}</span>
            </div>
            <div class="sun-detail-row">
                <span>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª—É—á–∏</span>
                <span>${lastLight.getHours().toString().padStart(2,'0')}:${lastLight.getMinutes().toString().padStart(2,'0')}</span>
            </div>
        `;
        
        modal.classList.add('open');
        
        setTimeout(() => {
            const canvas = document.getElementById('sun-detailed-graph');
            if (canvas) drawDetailedSunGraph(canvas, rise, set);
        }, 50);
    }

    function drawDetailedSunGraph(canvas, rise, set) {
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        
        ctx.clearRect(0,0,w,h);
        
        // –§–æ–Ω
        const grad = ctx.createLinearGradient(0,0,0,h);
        grad.addColorStop(0, '#1a2980');
        grad.addColorStop(0.5, '#26d0ce');
        grad.addColorStop(1, '#1a2980');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,w,h);
        
        // –®–∫–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–∏
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 1;
        for(let i=0; i<=24; i+=3) {
            const x = (i/24)*w;
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, h);
            ctx.stroke();
            
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.font = '12px -apple-system';
            ctx.fillText(`${i}:00`, x-15, h-10);
        }
        
        // –ö—Ä–∏–≤–∞—è —Å–æ–ª–Ω—Ü–∞
        const riseHour = rise.getHours() + rise.getMinutes()/60;
        const setHour = set.getHours() + set.getMinutes()/60;
        const dayLength = setHour - riseHour;
        
        ctx.beginPath();
        ctx.strokeStyle = '#FFD60A';
        ctx.lineWidth = 3;
        ctx.shadowColor = '#FFD60A';
        ctx.shadowBlur = 10;
        
        for(let x=0; x<=w; x++) {
            const hour = (x/w)*24;
            if (hour >= riseHour && hour <= setHour) {
                const progress = (hour - riseHour) / dayLength;
                const y = Math.sin(progress * Math.PI) * (h-50) + 25;
                ctx.lineTo(x, h - y);
            } else {
                const y = 10;
                ctx.lineTo(x, h - y);
            }
        }
        ctx.stroke();
        ctx.shadowBlur = 0;
        
        // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes()/60;
        const xPos = (currentHour/24)*w;
        
        if (currentHour >= riseHour && currentHour <= setHour) {
            const progress = (currentHour - riseHour) / dayLength;
            const yPos = Math.sin(progress * Math.PI) * (h-50) + 25;
            
            ctx.beginPath();
            ctx.fillStyle = '#fff';
            ctx.arc(xPos, h - yPos, 8, 0, Math.PI*2);
            ctx.fill();
            
            // –¢–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
            ctx.fillStyle = '#fff';
            ctx.font = '14px -apple-system';
            ctx.fillText('–°–µ–π—á–∞—Å', xPos-20, h - yPos - 15);
        }
    }

    // --- –£—Ç–∏–ª–∏—Ç—ã ---
    
    function updatePagination() {
        const p = document.getElementById('pagination');
        if (cities.length < 2) { p.style.display = 'none'; return; }
        p.style.display = 'flex';
        p.innerHTML = cities.map((_, i) => `<div class="dot ${i===currentIndex?'active':''}" onclick="changePage(${i})"></div>`).join('');
    }

    function toggleSettings(open) {
        const lay = document.getElementById('settings-layer');
        if (open) {
            lay.style.display = 'block';
            setTimeout(() => lay.classList.add('show'), 10);
            renderFavList();
        } else {
            lay.classList.remove('show');
            setTimeout(() => lay.style.display = 'none', 400);
        }
    }

    function renderFavList() {
        const l = document.getElementById('fav-list');
        l.innerHTML = cities.map((c, i) => `
            <div class="list-item" onclick="changePage(${i}); toggleSettings(false)">
                <div>
                    <div style="font-size:18px; font-weight:600">${c.name}</div>
                    <div style="font-size:12px; opacity:0.6">${c.country}</div>
                </div>
                ${!c.isHome ? `<div class="btn-circle" onclick="event.stopPropagation(); removeCity(${i})" style="width:30px; height:30px; background:rgba(255,69,58,0.2); border-color:transparent; color:#ff453a">‚úï</div>` : '<span style="opacity:0.5; font-size:12px">–ì–µ–æ</span>'}
            </div>
        `).join('');
    }

    function removeCity(i) {
        if(cities[i].isHome) return;
        cities.splice(i, 1);
        saveCities();
        renderFavList();
        if (currentIndex >= cities.length) currentIndex = Math.max(0, cities.length - 1);
        loadWeather(currentIndex);
    }

    function toggleUnit(type, value) {
        if (type === 'temp') {
            unit = unit === 'C' ? 'F' : 'C';
            localStorage.setItem('unit', unit);
            document.getElementById('unit-disp').innerText = '¬∞' + unit;
        } else if (type === 'wind') {
            windUnit = value;
            localStorage.setItem('windUnit', windUnit);
            document.querySelectorAll('.unit-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        loadWeather(currentIndex);
    }

    function getAIText(temp, code, wind, pressure) {
        const tempC = temp; // —É–∂–µ –≤ ¬∞C
        const windKmh = wind;
        const pressureMm = pressure * 0.75;
        
        let messages = [];
        
        // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
        if (tempC < -15) {
            messages.push("‚ùÑÔ∏è –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π –º–æ—Ä–æ–∑! –û–¥–µ–≤–∞–π—Ç–µ—Å—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–µ–ø–ª–æ: —Ç–µ—Ä–º–æ–±–µ–ª—å–µ, –ø—É—Ö–æ–≤–∏–∫, —à–∞–ø–∫–∞, —à–∞—Ä—Ñ, –≤–∞—Ä–µ–∂–∫–∏. –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –≤—Ä–µ–º—è –Ω–∞ —É–ª–∏—Ü–µ.");
        } else if (tempC < 0) {
            messages.push("ü•∂ –ú–æ—Ä–æ–∑–Ω–æ. –ù–∞–¥–µ–Ω—å—Ç–µ —Ç–µ–ø–ª—É—é –∫—É—Ä—Ç–∫—É, —à–∞–ø–∫—É –∏ –ø–µ—Ä—á–∞—Ç–∫–∏. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –Ω–∞ –ª—å–¥—É.");
        } else if (tempC < 10) {
            messages.push("üß• –ü—Ä–æ—Ö–ª–∞–¥–Ω–æ. –õ–µ–≥–∫–∞—è –∫—É—Ä—Ç–∫–∞ –∏–ª–∏ –≤–µ—Ç—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç –∫—Å—Ç–∞—Ç–∏.");
        } else if (tempC < 20) {
            messages.push("üëï –ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞. –õ–µ–≥–∫–∞—è –∫–æ—Ñ—Ç–∞ –∏–ª–∏ —Ñ—É—Ç–±–æ–ª–∫–∞ —Å –≤–µ—Ç—Ä–æ–≤–∫–æ–π.");
        } else if (tempC < 30) {
            messages.push("üòé –¢–µ–ø–ª–æ. –õ–µ–≥–∫–∞—è –æ–¥–µ–∂–¥–∞, –≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä –æ—Ç —Å–æ–ª–Ω—Ü–∞.");
        } else {
            messages.push("üî• –ñ–∞—Ä–∫–æ! –õ–µ–≥–∫–∞—è —Å–≤–µ—Ç–ª–∞—è –æ–¥–µ–∂–¥–∞, –≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä, —Å–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–Ω—ã–π –∫—Ä–µ–º. –ü–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã.");
        }
        
        // –ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
        if (code === 0) {
            messages.push("‚òÄÔ∏è –Ø—Å–Ω–æ–µ –Ω–µ–±–æ. –û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫!");
        } else if (code <= 3) {
            messages.push("‚õÖ –ù–µ–±–æ–ª—å—à–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å. –£–§-–∏–Ω–¥–µ–∫—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã—Å–æ–∫–∏–º –≤ –ø–æ–ª–¥–µ–Ω—å.");
        } else if (code === 45 || code === 48) {
            messages.push("üå´Ô∏è –¢—É–º–∞–Ω. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö, –≤–∫–ª—é—á–∏—Ç–µ —Ñ–∞—Ä—ã.");
        } else if (code >= 51 && code <= 55) {
            messages.push("üåßÔ∏è –õ–µ–≥–∫–∞—è –º–æ—Ä–æ—Å—å. –í–æ–∑—å–º–∏—Ç–µ –∑–æ–Ω—Ç –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π.");
        } else if (code >= 61 && code <= 65) {
            messages.push("üåßÔ∏è –î–æ–∂–¥—å. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–æ–Ω—Ç –∏ –Ω–µ–ø—Ä–æ–º–æ–∫–∞–µ–º—É—é –æ–±—É–≤—å.");
        } else if (code >= 71 && code <= 77) {
            messages.push("‚ùÑÔ∏è –°–Ω–µ–≥. –î–æ—Ä–æ–≥–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–∫–æ–ª—å–∑–∫–∏–º–∏. –û–¥–µ–≤–∞–π—Ç–µ—Å—å —Ç–µ–ø–ª–µ–µ.");
        } else if (code >= 95 && code <= 99) {
            messages.push("‚õàÔ∏è –ì—Ä–æ–∑–∞! –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏, –∏–∑–±–µ–≥–∞–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤ –∏ –≤–æ–¥—ã.");
        }
        
        // –í–µ—Ç–µ—Ä
        if (windKmh > 50) {
            messages.push("üí® –û—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä! –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã, –≤–æ–∑–º–æ–∂–Ω—ã –ø–∞–¥–µ–Ω–∏—è –¥–µ—Ä–µ–≤—å–µ–≤ –∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤.");
        } else if (windKmh > 30) {
            messages.push("üí® –°–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä. –ó–∞–∫—Ä–µ–ø–∏—Ç–µ –ª–µ–≥–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–∞ —É–ª–∏—Ü–µ.");
        } else if (windKmh > 15) {
            messages.push("üí® –£–º–µ—Ä–µ–Ω–Ω—ã–π –≤–µ—Ç–µ—Ä. –ú–æ–∂–µ—Ç –æ—â—É—â–∞—Ç—å—Å—è –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ.");
        }
        
        // –î–∞–≤–ª–µ–Ω–∏–µ
        if (pressureMm < 730) {
            messages.push("üìâ –ù–∏–∑–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ. –ú–µ—Ç–µ–æ–∑–∞–≤–∏—Å–∏–º—ã–µ –ª—é–¥–∏ –º–æ–≥—É—Ç —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–µ–¥–æ–º–æ–≥–∞–Ω–∏–µ.");
        } else if (pressureMm > 770) {
            messages.push("üìà –í—ã—Å–æ–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ. –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ª—é–¥–µ–π.");
        }
        
        // –û–±—â–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
        messages.push("\nüéØ –ò—Ç–æ–≥: " + (tempC > 25 && code === 0 ? "–û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –æ—Ç–¥—ã—Ö–∞ –Ω–∞ –ø—Ä–∏—Ä–æ–¥–µ!" : 
                        tempC < 5 && (code >= 61 || code >= 71) ? "–õ—É—á—à–µ –æ—Å—Ç–∞—Ç—å—Å—è –≤ —Ç–µ–ø–ª–µ –¥–æ–º–∞." :
                        "–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å –¥–ª—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ–ª."));
        
        return messages.join('\n\n');
    }

    function getWDesc(code, isDay = 1) {
        const map = {
            0: isDay ? '–Ø—Å–Ω–æ' : '–Ø—Å–Ω–∞—è –Ω–æ—á—å',
            1: isDay ? '–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —è—Å–Ω–æ' : '–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —è—Å–Ω–æ',
            2: '–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å',
            3: '–ü–∞—Å–º—É—Ä–Ω–æ',
            45: '–¢—É–º–∞–Ω',
            48: '–¢—É–º–∞–Ω —Å –∏–∑–º–æ—Ä–æ–∑—å—é',
            51: '–õ–µ–≥–∫–∞—è –º–æ—Ä–æ—Å—å',
            53: '–£–º–µ—Ä–µ–Ω–Ω–∞—è –º–æ—Ä–æ—Å—å',
            55: '–°–∏–ª—å–Ω–∞—è –º–æ—Ä–æ—Å—å',
            61: '–ù–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å',
            63: '–£–º–µ—Ä–µ–Ω–Ω—ã–π –¥–æ–∂–¥—å',
            65: '–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å',
            71: '–ù–µ–±–æ–ª—å—à–æ–π —Å–Ω–µ–≥',
            73: '–£–º–µ—Ä–µ–Ω–Ω—ã–π —Å–Ω–µ–≥',
            75: '–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥',
            77: '–°–Ω–µ–∂–Ω—ã–µ –∑–µ—Ä–Ω–∞',
            80: '–ù–µ–±–æ–ª—å—à–∏–µ –ª–∏–≤–Ω–∏',
            81: '–£–º–µ—Ä–µ–Ω–Ω—ã–µ –ª–∏–≤–Ω–∏',
            82: '–°–∏–ª—å–Ω—ã–µ –ª–∏–≤–Ω–∏',
            85: '–ù–µ–±–æ–ª—å—à–∏–µ —Å–Ω–µ–≥–æ–ø–∞–¥—ã',
            86: '–°–∏–ª—å–Ω—ã–µ —Å–Ω–µ–≥–æ–ø–∞–¥—ã',
            95: '–ì—Ä–æ–∑–∞',
            96: '–ì—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º',
            99: '–°–∏–ª—å–Ω–∞—è –≥—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º'
        };
        return map[code] || '–û–±–ª–∞—á–Ω–æ';
    }
    
    function getWIcon(code, hour = 12) {
        const isNight = hour < 6 || hour > 20;
        
        if (code === 0) return isNight ? 'üåï' : '‚òÄÔ∏è';
        if (code === 1 || code === 2) return isNight ? '‚òÅÔ∏è' : '‚õÖ';
        if (code === 3) return '‚òÅÔ∏è';
        if (code >= 45 && code <= 48) return 'üå´Ô∏è';
        if (code >= 51 && code <= 67) return 'üåßÔ∏è';
        if (code >= 71 && code <= 77) return '‚ùÑÔ∏è';
        if (code >= 80 && code <= 86) return 'üå¶Ô∏è';
        if (code >= 95 && code <= 99) return '‚õàÔ∏è';
        return 'üå§Ô∏è';
    }

    function resize() { 
        canvas.width = window.innerWidth; 
        canvas.height = window.innerHeight; 
    }

    // –ó–∞–ø—É—Å–∫
    init();

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather AI Pro OS</title>
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.1); 
            --blur: blur(35px); 
            --spring: cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; outline: none; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; touch-action: pan-y; }
        
        canvas#bg { position: fixed; inset: 0; z-index: -1; }

        header { padding: 15px; max-width: 900px; margin: 0 auto; display: flex; align-items: center; gap: 10px; z-index: 100; position: relative; }
        .search-box { 
            flex: 1; display: flex; align-items: center; background: var(--glass); backdrop-filter: var(--blur); 
            border-radius: 20px; padding: 8px 15px; border: 0.5px solid rgba(255,255,255,0.2); gap: 10px;
        }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; }
        
        .settings-btn { background: var(--glass); border: 0.5px solid rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: var(--blur); }

        /* –ü–æ–∏—Å–∫ –∏ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ */
        .suggestions { position: absolute; top: 70px; left: 15px; right: 65px; background: rgba(20,20,20,0.9); backdrop-filter: blur(20px); border-radius: 20px; overflow: hidden; z-index: 1000; border: 0.5px solid var(--glass); }
        .sugg-item { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid rgba(255,255,255,0.1); }
        .star-btn { font-size: 20px; cursor: pointer; filter: grayscale(1); transition: 0.3s; }
        .star-btn.active { filter: grayscale(0); color: #FFD700; }

        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        main { height: calc(100vh - 80px); overflow-y: auto; padding: 0 20px 40px; scrollbar-width: none; }
        main::-webkit-scrollbar { display: none; }
        .content-wrap { max-width: 800px; margin: 0 auto; transition: transform 0.5s var(--spring); }

        .now { text-align: center; padding: 40px 0; }
        .temp-val { font-size: 100px; font-weight: 100; letter-spacing: -5px; margin: 10px 0; }

        /* –°–µ—Ç–∫–∞ –∏–Ω—Ñ–æ-–±–ª–æ–∫–æ–≤ */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 24px; padding: 18px; border: 0.5px solid rgba(255,255,255,0.15); }
        .card-label { font-size: 11px; opacity: 0.5; text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
        .card-val { font-size: 24px; font-weight: 500; }

        /* AI –°–æ–≤–µ—Ç */
        .ai-box { grid-column: span 2; background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.3); }
        .ai-text { font-size: 15px; line-height: 1.4; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∏ */
        .nav-arrow { position: fixed; top: 50%; transform: translateY(-50%); font-size: 40px; color: rgba(255,255,255,0.3); cursor: pointer; padding: 20px; z-index: 50; transition: 0.3s; }
        .nav-arrow:hover { color: #fff; }
        .arrow-l { left: 0; } .arrow-r { right: 0; }

        @media (max-width: 768px) { .nav-arrow { display: none; } }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<div class="nav-arrow arrow-l" onclick="prevCity()">‚Äπ</div>
<div class="nav-arrow arrow-r" onclick="nextCity()">‚Ä∫</div>

<header>
    <div class="search-box">
        <span>üîç</span>
        <input id="q" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." oninput="handleSearch(this.value)" />
    </div>
    <button class="settings-btn" onclick="toggleUnit()">‚öôÔ∏è</button>
    <div id="suggestions" class="suggestions" style="display:none"></div>
</header>

<main id="mainView" ontouchstart="handleTs(event)" ontouchend="handleTe(event)">
    <div class="content-wrap" id="app">
        <section class="now">
            <div id="place" style="font-size:28px; font-weight:600;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="temp-val" id="mainTemp">--</div>
            <div id="mainDesc" style="font-size:18px; opacity:0.7;">–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...</div>
        </section>

        <section class="card" style="margin-bottom:15px;">
            <div class="card-label">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—è</div>
            <div id="dList"></div>
        </section>

        <div class="info-grid">
            <div class="card">
                <div class="card-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
                <div class="card-val" id="humVal">--%</div>
                <div style="font-size:12px; opacity:0.6; margin-top:5px;" id="dewVal">–¢–æ—á–∫–∞ —Ä–æ—Å—ã: --¬∞</div>
            </div>
            <div class="card">
                <div class="card-label">–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫</div>
                <div class="card-val" id="feelVal">--¬∞</div>
            </div>
            <div class="card ai-box">
                <div class="card-label">ü§ñ AI –°–û–í–ï–¢</div>
                <div class="ai-text" id="aiAdvice">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø–æ–≥–æ–¥—É...</div>
            </div>
        </div>
    </div>
</main>

<script>
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let unit = localStorage.getItem('unit') || 'celsius';
    let favorites = JSON.parse(localStorage.getItem('favCities')) || [];
    let currentIdx = 0; // 0 - –¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ, –¥–∞–ª–µ–µ - –∏–∑–±—Ä–∞–Ω–Ω—ã–µ
    let weatherList = []; 
    let tStart = 0;

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    window.onload = () => {
        resize();
        navigator.geolocation.getCurrentPosition(
            p => { initWeather(p.coords.latitude, p.coords.longitude, '–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'); },
            e => { initWeather(55.75, 37.62, '–ú–æ—Å–∫–≤–∞'); }
        );
        draw();
    };

    async function initWeather(lat, lon, name) {
        const myLoc = { lat, lon, name, isBase: true };
        weatherList = [myLoc, ...favorites];
        loadWeatherData(0);
    }

    async function loadWeatherData(idx) {
        currentIdx = idx;
        const city = weatherList[idx];
        const d = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&temperature_unit=${unit}`).then(r=>r.json());
        
        render(d, city.name);
        initEnvironment(d.current.is_day, d.current.weather_code);
    }

    function render(d, name) {
        const u = unit === 'celsius' ? '¬∞' : '¬∞F';
        document.getElementById('place').innerText = name;
        document.getElementById('mainTemp').innerText = Math.round(d.current.temperature_2m) + u;
        document.getElementById('humVal').innerText = d.current.relative_humidity_2m + '%';
        document.getElementById('feelVal').innerText = Math.round(d.current.apparent_temperature) + u;
        
        // –¢–æ—á–∫–∞ —Ä–æ—Å—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –õ–∞–π–Ω—Ö–∞—Ä–¥—Ç–∞)
        const T = d.current.temperature_2m;
        const Rh = d.current.relative_humidity_2m;
        const dewPoint = T - ((100 - Rh) / 5);
        document.getElementById('dewVal').innerText = `–¢–æ—á–∫–∞ —Ä–æ—Å—ã: ${Math.round(dewPoint)}¬∞`;

        // AI –°–æ–≤–µ—Ç
        document.getElementById('aiAdvice').innerText = getAISuggestion(T, d.current.weather_code, Rh);

        // –°–ø–∏—Å–æ–∫ 3 –¥–Ω—è
        document.getElementById('dList').innerHTML = d.daily.time.slice(0,3).map((t, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:0.5px solid rgba(255,255,255,0.1)">
                <span>${i===0?'–°–µ–≥–æ–¥–Ω—è':new Date(t).toLocaleDateString('ru',{weekday:'short'})}</span>
                <span>${Math.round(d.daily.temperature_2m_max[i])}${u}</span>
            </div>
        `).join('');
    }

    function getAISuggestion(t, code, hum) {
        let advice = "";
        if (t > 25) advice = "–ù–∞ —É–ª–∏—Ü–µ –∂–∞—Ä–∫–æ. –í—ã–±–∏—Ä–∞–π—Ç–µ –ª–µ–≥–∫—É—é –æ–¥–µ–∂–¥—É –∏–∑ —Ö–ª–æ–ø–∫–∞.";
        else if (t > 15) advice = "–ü—Ä–∏—è—Ç–Ω–∞—è –ø–æ–≥–æ–¥–∞. –ü–æ–¥–æ–π–¥–µ—Ç –ª–µ–≥–∫–∞—è –∫–æ—Ñ—Ç–∞ –∏–ª–∏ —Ö—É–¥–∏.";
        else if (t > 5) advice = "–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ. –°—Ç–æ–∏—Ç –Ω–∞–¥–µ—Ç—å –∫—É—Ä—Ç–∫—É –∏–ª–∏ –ø–∞–ª—å—Ç–æ.";
        else advice = "–•–æ–ª–æ–¥–Ω–æ! –ù–∞–¥–µ–Ω—å—Ç–µ —Ç–µ–ø–ª—É—é –∫—É—Ä—Ç–∫—É, —à–∞—Ä—Ñ –∏ –ø–µ—Ä—á–∞—Ç–∫–∏.";

        if (code >= 61) advice += " –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–æ–∑—å–º–∏—Ç–µ –∑–æ–Ω—Ç ‚Äî –æ–∂–∏–¥–∞–µ—Ç—Å—è –¥–æ–∂–¥—å. ‚òÇÔ∏è";
        if (hum > 80 && t > 20) advice += " –í—ã—Å–æ–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å, –º–æ–∂–µ—Ç –±—ã—Ç—å –¥—É—à–Ω–æ.";
        return advice;
    }

    // --- –ü–û–ò–°–ö –ò –ò–ó–ë–†–ê–ù–ù–û–ï ---
    async function handleSearch(v) {
        if(v.length < 2) return document.getElementById('suggestions').style.display='none';
        const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${v}&count=3&language=ru`).then(r=>r.json());
        if(res.results) {
            const sugg = document.getElementById('suggestions');
            sugg.innerHTML = res.results.map(g => {
                const isFav = favorites.some(f => f.name === g.name);
                return `
                <div class="sugg-item">
                    <div onclick="addAndLoad('${g.latitude}','${g.longitude}','${g.name}')" style="flex:1">${g.name}</div>
                    <div class="star-btn ${isFav?'active':''}" onclick="toggleFav(event, '${g.latitude}','${g.longitude}','${g.name}')">‚òÖ</div>
                </div>`;
            }).join('');
            sugg.style.display = 'block';
        }
    }

    function toggleFav(e, lat, lon, name) {
        e.stopPropagation();
        const idx = favorites.findIndex(f => f.name === name);
        if(idx === -1) {
            if(favorites.length >= 3) favorites.shift();
            favorites.push({lat, lon, name});
        } else {
            favorites.splice(idx, 1);
        }
        localStorage.setItem('favCities', JSON.stringify(favorites));
        handleSearch(document.getElementById('q').value); // –û–±–Ω–æ–≤–∏—Ç—å –∑–≤–µ–∑–¥—ã
        initWeather(weatherList[0].lat, weatherList[0].lon, weatherList[0].name); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
    }

    function addAndLoad(lat, lon, name) {
        document.getElementById('suggestions').style.display = 'none';
        initWeather(weatherList[0].lat, weatherList[0].lon, weatherList[0].name); // –°–±—Ä–æ—Å –∫ –±–∞–∑–µ
        loadWeatherData(0); // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ (–≤—Ä–µ–º–µ–Ω–Ω–æ)
    }

    // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
    function nextCity() { if(currentIdx < weatherList.length - 1) loadWeatherData(currentIdx + 1); }
    function prevCity() { if(currentIdx > 0) loadWeatherData(currentIdx - 1); }

    function handleTs(e) { tStart = e.touches[0].clientX; }
    function handleTe(e) {
        let tEnd = e.changedTouches[0].clientX;
        if(tStart - tEnd > 100) nextCity();
        if(tEnd - tStart > 100) prevCity();
    }

    function toggleUnit() {
        unit = unit === 'celsius' ? 'fahrenheit' : 'celsius';
        localStorage.setItem('unit', unit);
        loadWeatherData(currentIdx);
    }

    // --- –ì–†–ê–§–ò–ö–ê ---
    let blobs = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    function initEnvironment(isDay, code) {
        blobs = [];
        const pal = isDay ? ['#007AFF', '#00C6FF', '#74ebd5'] : ['#0F0C29', '#302B63', '#24243E'];
        for(let i=0; i<3; i++) blobs.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:canvas.width, c:pal[i], vx:Math.random()-0.5, vy:Math.random()-0.5});
    }

    function draw() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        blobs.forEach(b => {
            b.x += b.vx; b.y += b.vy;
            if(b.x<0 || b.x>canvas.width) b.vx*=-1; if(b.y<0 || b.y>canvas.height) b.vy*=-1;
            let g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r);
            g.addColorStop(0, b.c); g.addColorStop(1, 'transparent');
            ctx.globalCompositeOperation = 'screen';
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
        });
        requestAnimationFrame(draw);
    }
</script>
</body>
</html>

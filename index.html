<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather iOS Ultimate</title>
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.1); 
            --blur: blur(40px); 
            --spring: cubic-bezier(0.23, 1, 0.32, 1);
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        canvas#bg { position: fixed; inset: 0; z-index: -1; transform: scale(1.1); }

        /* UI –≠–ª–µ–º–µ–Ω—Ç—ã */
        header { padding: 15px; max-width: 600px; margin: 0 auto; display: flex; gap: 10px; position: relative; z-index: 100; }
        .search-box { flex: 1; display: flex; align-items: center; background: var(--glass); backdrop-filter: var(--blur); border-radius: 20px; padding: 10px 15px; border: 0.5px solid rgba(255,255,255,0.2); gap: 10px; }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; }
        .icon-btn { background: var(--glass); border: 0.5px solid rgba(255,255,255,0.2); border-radius: 15px; color: #fff; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: var(--blur); }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–∏—Å–∫–∞ */
        .suggestions { position: absolute; top: 75px; left: 15px; right: 15px; background: rgba(20,20,20,0.8); backdrop-filter: blur(30px); border-radius: 22px; overflow: hidden; border: 0.5px solid var(--glass); z-index: 1000; }
        .s-item { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid rgba(255,255,255,0.1); }
        .s-info { flex: 1; cursor: pointer; }
        .s-name { font-weight: 500; font-size: 17px; display: block; }
        .s-sub { font-size: 12px; opacity: 0.5; }
        .s-star { font-size: 24px; cursor: pointer; color: rgba(255,255,255,0.2); transition: 0.3s; }
        .s-star.active { color: #FFD700; }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (iOS Like) */
        #settingsModal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: flex-end; }
        .modal-content { width: 100%; background: rgba(30,30,30,0.8); backdrop-filter: blur(50px); border-top-left-radius: 30px; border-top-right-radius: 30px; padding: 25px; border-top: 0.5px solid rgba(255,255,255,0.2); animation: slideUp 0.4s var(--spring); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .setting-row { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .setting-row.active { border: 1px solid #007AFF; }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        main { height: 100vh; overflow-y: auto; padding: 80px 20px 120px; scrollbar-width: none; }
        main::-webkit-scrollbar { display: none; }
        .now-section { text-align: center; margin-bottom: 40px; animation: fadeIn 1s var(--spring); }
        .temp-big { font-size: 110px; font-weight: 100; letter-spacing: -5px; margin: 5px 0; }
        
        /* –ü—Ä–æ–≥–Ω–æ–∑ 3 –¥–Ω—è –≤ —Å—Ç–æ–ª–±–∏–∫ */
        .forecast-list { background: var(--glass); backdrop-filter: var(--blur); border-radius: 25px; padding: 15px; border: 0.5px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .day-row { display: grid; grid-template-columns: 80px 1fr 100px; align-items: center; padding: 12px 0; border-bottom: 0.5px solid rgba(255,255,255,0.1); }
        .day-row:last-child { border: none; }

        /* –ò–Ω—Ñ–æ-–∫–∞—Ä—Ç–æ—á–∫–∏ */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 22px; padding: 18px; border: 0.5px solid rgba(255,255,255,0.1); }
        .card-label { font-size: 11px; opacity: 0.5; text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
        .ai-box { grid-column: span 2; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); }

        /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
        .pagination { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); padding: 8px 16px; border-radius: 25px; display: flex; align-items: center; gap: 12px; z-index: 500; }
        .dot { width: 7px; height: 7px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #fff; transform: scale(1.3); }
        .dot-loc { width: 14px; height: 14px; fill: rgba(255,255,255,0.3); }
        .dot-loc.active { fill: #fff; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<header>
    <div class="search-box">
        <span>üîç</span>
        <input id="q" placeholder="–ü–æ–∏—Å–∫..." oninput="search(this.value)" />
    </div>
    <div class="icon-btn" onclick="toggleSettings(true)">‚öôÔ∏è</div>
    <div id="results" class="suggestions" style="display:none"></div>
</header>

<main id="mainContent" ontouchstart="ts(event)" ontouchend="te(event)">
    <div class="now-section">
        <div id="place" style="font-size:32px; font-weight:500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="temp-big" id="temp">--</div>
        <div id="desc" style="font-size:20px; opacity:0.7">–û–ø—Ä–µ–¥–µ–ª—è–µ–º...</div>
    </div>

    <div class="forecast-list" id="dList"></div>

    <div class="info-grid">
        <div class="card"><div class="card-label">–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫</div><div id="feel" style="font-size:26px">--</div></div>
        <div class="card"><div class="card-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div><div id="hum" style="font-size:26px">--</div></div>
        <div class="card ai-box"><div class="card-label">ü§ñ AI –°–æ–≤–µ—Ç</div><div id="aiAdvice" style="font-size:15px; line-height:1.4">...</div></div>
    </div>
</main>

<div id="settingsModal" onclick="toggleSettings(false)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 style="margin:0">–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è</h2>
            <div class="icon-btn" style="width:30px; height:30px" onclick="toggleSettings(false)">‚úï</div>
        </div>
        <div class="setting-row" id="unitC" onclick="setUnit('celsius')"><span>–ì—Ä–∞–¥—É—Å—ã –¶–µ–ª—å—Å–∏—è (¬∞C)</span><span class="check"></span></div>
        <div class="setting-row" id="unitF" onclick="setUnit('fahrenheit')"><span>–ì—Ä–∞–¥—É—Å—ã –§–∞—Ä–µ–Ω–≥–µ–π—Ç–∞ (¬∞F)</span><span class="check"></span></div>
    </div>
</div>

<div class="pagination" id="pag"></div>

<script>
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let favorites = JSON.parse(localStorage.getItem('favs')) || [];
    let pages = [];
    let curIdx = 0;
    let unit = localStorage.getItem('unit') || 'celsius';
    let startX = 0;
    let sunRot = 0;
    let blobs = [];

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        resize();
        navigator.geolocation.getCurrentPosition(p => {
            initApp(p.coords.latitude, p.coords.longitude);
        }, () => {
            initApp(55.75, 37.62); // –ú–æ—Å–∫–≤–∞ –ø–æ –¥–µ—Ñ–æ–ª—Ç—É
        });
        draw();
    };

    function initApp(lat, lon) {
        const home = { lat, lon, name: '–ú–æ—è –ª–æ–∫–∞—Ü–∏—è', isHome: true };
        pages = [home, ...favorites];
        renderPag();
        loadWeather(0);
    }

    async function loadWeather(idx) {
        const city = pages[idx];
        const u = unit === 'celsius' ? '¬∞' : '¬∞F';
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&temperature_unit=${unit}`).then(r=>r.json());
        
        document.getElementById('place').innerText = city.name;
        document.getElementById('temp').innerText = Math.round(res.current.temperature_2m) + u;
        document.getElementById('feel').innerText = Math.round(res.current.apparent_temperature) + '¬∞';
        document.getElementById('hum').innerText = res.current.relative_humidity_2m + '%';
        
        // –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—è
        document.getElementById('dList').innerHTML = res.daily.time.slice(0,3).map((t, i) => `
            <div class="day-row">
                <span>${i===0?'–°–µ–≥–æ–¥–Ω—è':new Date(t).toLocaleDateString('ru',{weekday:'short'})}</span>
                <span style="font-size:24px; text-align:center">${res.daily.weather_code[i] < 3 ? '‚òÄÔ∏è' : '‚òÅÔ∏è'}</span>
                <div style="text-align:right">
                    <span style="opacity:0.4; margin-right:10px">${Math.round(res.daily.temperature_2m_min[i])}¬∞</span>
                    <span style="font-weight:600">${Math.round(res.daily.temperature_2m_max[i])}¬∞</span>
                </div>
            </div>
        `).join('');

        document.getElementById('aiAdvice').innerText = res.current.temperature_2m < 5 ? "–•–æ–ª–æ–¥–Ω–æ, –æ–¥–µ–≤–∞–π—Ç–µ—Å—å —Ç–µ–ø–ª–µ–µ." : "–ü–æ–≥–æ–¥–∞ –æ—Ç–ª–∏—á–Ω–∞—è, –ø—Ä–∏—è—Ç–Ω–æ–π –ø—Ä–æ–≥—É–ª–∫–∏!";
        
        initEnvironment(res.current.is_day, res.current.weather_code);
    }

    // --- –ü–æ–∏—Å–∫ ---
    async function search(v) {
        if(v.length < 2) return document.getElementById('results').style.display='none';
        const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${v}&count=5&language=ru`).then(r=>r.json());
        if(res.results) {
            const box = document.getElementById('results');
            box.innerHTML = res.results.map(g => {
                const isFav = favorites.some(f => f.name === g.name);
                const sub = [g.admin1, g.country].filter(Boolean).join(', ');
                return `
                <div class="s-item">
                    <div class="s-info" onclick="selectCity(${g.latitude},${g.longitude},'${g.name}')">
                        <span class="s-name">${g.name}</span>
                        <span class="s-sub">${sub}</span>
                    </div>
                    <div class="s-star ${isFav?'active':''}" onclick="toggleFav(event, ${g.latitude},${g.longitude},'${g.name}')">‚òÖ</div>
                </div>`;
            }).join('');
            box.style.display = 'block';
        }
    }

    function toggleFav(e, lat, lon, name) {
        e.stopPropagation();
        const idx = favorites.findIndex(f => f.name === name);
        if(idx === -1) {
            if(favorites.length < 3) favorites.push({lat, lon, name});
        } else {
            favorites.splice(idx, 1);
        }
        localStorage.setItem('favs', JSON.stringify(favorites));
        search(document.getElementById('q').value);
        initApp(pages[0].lat, pages[0].lon);
    }

    function selectCity(lat, lon, name) {
        document.getElementById('results').style.display = 'none';
        document.getElementById('q').value = name;
        pages[curIdx] = {lat, lon, name};
        loadWeather(curIdx);
    }

    // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è ---
    function renderPag() {
        const pag = document.getElementById('pag');
        pag.innerHTML = pages.map((p, i) => {
            if(p.isHome) return `<svg class="dot-loc ${curIdx===i?'active':''}" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>`;
            return `<div class="dot ${curIdx===i?'active':''}"></div>`;
        }).join('');
    }
    function ts(e) { startX = e.touches[0].clientX; }
    function te(e) {
        let x = e.changedTouches[0].clientX;
        if(startX - x > 80 && curIdx < pages.length-1) { curIdx++; setPage(); }
        if(x - startX > 80 && curIdx > 0) { curIdx--; setPage(); }
    }
    function setPage() { loadWeather(curIdx); renderPag(); }

    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
    function toggleSettings(show) {
        document.getElementById('settingsModal').style.display = show ? 'flex' : 'none';
        document.getElementById('unitC').classList.toggle('active', unit === 'celsius');
        document.getElementById('unitF').classList.toggle('active', unit === 'fahrenheit');
    }
    function setUnit(u) {
        unit = u;
        localStorage.setItem('unit', u);
        toggleSettings(false);
        loadWeather(curIdx);
    }

    // --- –ì—Ä–∞—Ñ–∏–∫–∞ (–ê–Ω–∏–º–∞—Ü–∏–∏) ---
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    function initEnvironment(isDay) {
        blobs = [];
        const pal = isDay ? ['#007AFF', '#00C6FF', '#74ebd5'] : ['#0F0C29', '#302B63', '#24243E'];
        for(let i=0; i<3; i++) blobs.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:canvas.width, c:pal[i], vx:Math.random()-0.5, vy:Math.random()-0.5});
    }

    function draw() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        blobs.forEach(b => {
            b.x += b.vx; b.y += b.vy;
            if(b.x<0 || b.x>canvas.width) b.vx*=-1; if(b.y<0 || b.y>canvas.height) b.vy*=-1;
            let g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r);
            g.addColorStop(0, b.c); g.addColorStop(1, 'transparent');
            ctx.globalCompositeOperation = 'screen'; ctx.fillStyle = g;
            ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
        });

        // –°–æ–ª–Ω–µ—á–Ω—ã–µ –ª—É—á–∏ (–µ—Å–ª–∏ –¥–µ–Ω—å)
        sunRot += 0.002;
        ctx.save();
        ctx.translate(canvas.width*0.8, 150);
        ctx.rotate(sunRot);
        for(let i=0; i<10; i++) {
            ctx.rotate(Math.PI/5);
            let rg = ctx.createLinearGradient(0,0,0,400);
            rg.addColorStop(0, 'rgba(255,255,255,0.05)'); rg.addColorStop(1, 'transparent');
            ctx.fillStyle = rg;
            ctx.beginPath(); ctx.moveTo(-20,0); ctx.lineTo(20,0); ctx.lineTo(0, 800); ctx.fill();
        }
        ctx.restore();

        requestAnimationFrame(draw);
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather iOS Ultimate</title>
    <style>
        :root { --glass: rgba(255, 255, 255, 0.1); --blur: blur(50px); --spring: cubic-bezier(0.165, 0.84, 0.44, 1); }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        canvas#bg { position: fixed; inset: 0; z-index: -1; }

        header { padding: 15px; max-width: 600px; margin: 0 auto; display: flex; gap: 10px; position: relative; z-index: 2000; }
        .search-box { flex: 1; display: flex; align-items: center; background: var(--glass); backdrop-filter: var(--blur); border-radius: 20px; padding: 10px 15px; border: 0.5px solid rgba(255,255,255,0.2); position: relative; }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; margin-left: 10px; }
        .icon-btn { background: var(--glass); border: 0.5px solid rgba(255,255,255,0.2); border-radius: 15px; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: var(--blur); }

        #stage { 
            height: 100vh; 
            overflow: hidden; 
            position: relative; 
        }
        .page-container {
            position: absolute;
            inset: 0;
            padding: 20px 20px 180px;
            transition: transform 0.6s var(--spring), opacity 0.6s var(--spring);
            will-change: transform, opacity;
        }
        .page-container.next { transform: translateX(100%); opacity: 0; }
        .page-container.prev { transform: translateX(-100%); opacity: 0; }
        .page-container.active { transform: translateX(0); opacity: 1; }

        .city-header { text-align: center; margin: 40px 0; }
        .temp-big { font-size: 110px; font-weight: 100; letter-spacing: -5px; margin: 5px 0; }
        
        .card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 28px; padding: 20px; border: 0.5px solid rgba(255,255,255,0.15); margin-bottom: 20px; }
        .card-label { font-size: 11px; opacity: 0.5; text-transform: uppercase; font-weight: 700; margin-bottom: 15px; }

        .extra-cards { display: flex; gap: 20px; }
        .extra-card { flex: 1; }

        .h-scroll { display: flex; gap: 20px; overflow-x: auto; scrollbar-width: none; align-items: flex-start; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-item { text-align: center; min-width: 60px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .wind-icon { font-size: 12px; transition: transform 0.3s; }

        .day-row { display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; padding: 12px 0; border-bottom: 0.5px solid rgba(255,255,255,0.1); font-size: 14px; }
        .day-row:last-child { border: none; }

        #settings { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); z-index: 3000; display: none; padding: 40px 20px; overflow-y: auto; }
        .close-settings { position: absolute; top: 20px; right: 20px; font-size: 30px; cursor: pointer; }

        .nav-dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); backdrop-filter: blur(20px); padding: 10px 20px; border-radius: 25px; display: flex; align-items: center; gap: 12px; border: 0.5px solid rgba(255,255,255,0.1); z-index: 2500; }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 50%; }
        .dot.active { background: #fff; }

        .fav-star { font-size: 22px; cursor: pointer; position: absolute; right: 15px; top: 12px; color: #FFD700; opacity: 0.4; transition: opacity 0.2s; }
        .fav-star.active { opacity: 1; }

        .settings-section { margin: 30px 0; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 0.5px solid rgba(255,255,255,0.15); }
        .fav-list-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 0.5px solid rgba(255,255,255,0.15); }
        .delete-btn { color: #ff3b30; font-size: 18px; cursor: pointer; }

        @keyframes flakeFall { 0% { transform: translateY(-10px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<header>
    <div class="search-box">
        üîç <input id="q" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." oninput="search(this.value)">
        <span id="addFavStar" class="fav-star" onclick="toggleFavorite()">‚òÜ</span>
    </div>
    <div class="icon-btn" onclick="toggleSet(true)">‚öôÔ∏è</div>
    <div id="results" style="position:absolute; top:75px; left:15px; right:15px; background:rgba(30,30,30,0.9); border-radius:20px; overflow:hidden; display:none; z-index:2500;"></div>
</header>

<div id="stage">
    <!-- —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
</div>

<div id="settings">
    <div class="close-settings" onclick="toggleSet(false)">‚úï</div>
    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

    <div class="settings-section">
        <div class="settings-item">
            <span>–ï–¥–∏–Ω–∏—Ü—ã —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</span>
            <select id="unitSelect" onchange="changeUnit(this.value)">
                <option value="C">¬∞C</option>
                <option value="F">¬∞F</option>
            </select>
        </div>
    </div>

    <div class="settings-section">
        <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞</h3>
        <div id="favList"></div>
    </div>

    <p>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: <span id="locStatus">–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...</span></p>
    <button onclick="requestLocation()">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
</div>

<div class="nav-dock" id="pag"></div>

<script>
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let pages = [], curIdx = 0, startX = 0;
    let env = { isDay: true, code: 0, wind: 0, wSpeed: 0, stars: [], clouds: [], particles: [] };
    let unit = localStorage.getItem('unit') || 'C';

    document.getElementById('unitSelect').value = unit;

    function toDisplayTemp(c) {
        return unit === 'F' ? Math.round(c * 9/5 + 32) : Math.round(c);
    }

    function changeUnit(u) {
        unit = u;
        localStorage.setItem('unit', u);
        if (pages.length > 0) loadWeather(curIdx);
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    async function init() {
        resize();
        requestLocation();
        loop();
    }

    function requestLocation() {
        if (navigator.geolocation) {
            document.getElementById('locStatus').innerText = '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è...';
            navigator.geolocation.getCurrentPosition(
                p => fetchMain(p.coords.latitude, p.coords.longitude, '–ú–æ—è –ª–æ–∫–∞—Ü–∏—è', true),
                () => fetchMain(52.518, 5.471, 'Lelystad', true)
            );
        } else {
            fetchMain(52.518, 5.471, 'Lelystad', true);
        }
    }

    async function fetchMain(lat, lon, name, isHome = false) {
        const existing = pages.find(p => p.home);
        if (existing && isHome) {
            existing.lat = lat; existing.lon = lon; existing.name = name;
            loadWeather(curIdx);
        } else {
            pages = [{lat, lon, name, home: true}];
            const favs = JSON.parse(localStorage.getItem('favs') || '[]');
            pages.push(...favs.map(f => ({...f, home: false})));
            renderPag();
            loadWeather(0);
        }
        updateStarIcon();
    }

    async function loadWeather(idx, direction = 0) {
        curIdx = idx;
        const city = pages[idx];

        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,apparent_temperature,weather_code,is_day,wind_direction_10m,wind_speed_10m,relative_humidity_2m,dewpoint_2m&hourly=temperature_2m,weather_code,wind_direction_10m,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,relative_humidity_2m_max,wind_speed_10m_max,wind_direction_10m_dominant&timezone=auto`).then(r=>r.json());

        env.isDay = !!res.current.is_day;
        env.code = res.current.weather_code;
        env.wind = res.current.wind_direction_10m;
        env.wSpeed = res.current.wind_speed_10m;

        renderPageContent(idx, res, city);

        initGraphics();
        renderPag();
        updateStarIcon();

        // –∞–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
        const containers = document.querySelectorAll('.page-container');
        containers.forEach((c, i) => {
            if (i === idx) {
                c.classList.remove('next', 'prev');
                c.classList.add('active');
            } else if (i === curIdx - direction) {
                c.classList.remove('active');
                c.classList.add(direction > 0 ? 'prev' : 'next');
            }
        });
    }

    function renderPageContent(idx, res, city) {
        let html = `
            <div class="city-header">
                <div style="font-size:32px;">${city.name}</div>
                <div class="temp-big" id="curTemp-${idx}">${toDisplayTemp(res.current.temperature_2m)}¬∞</div>
                <div style="font-size:18px; opacity:0.8">–ú–∏–Ω: ${toDisplayTemp(res.daily.temperature_2m_min[0])}¬∞ / –ú–∞–∫—Å: ${toDisplayTemp(res.daily.temperature_2m_max[0])}¬∞</div>
            </div>

            <div class="extra-cards">
                <div class="card extra-card">
                    <div class="card-label">–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫</div>
                    <div style="font-size: 24px; text-align: center;">${toDisplayTemp(res.current.apparent_temperature)}¬∞</div>
                </div>
                <div class="card extra-card">
                    <div class="card-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å –∏ —Ç–æ—á–∫–∞ —Ä–æ—Å—ã</div>
                    <div style="font-size: 18px; text-align: center;">${res.current.relative_humidity_2m}%</div>
                    <div style="font-size: 18px; text-align: center; opacity: 0.8;">–¢–æ—á–∫–∞ —Ä–æ—Å—ã: ${toDisplayTemp(res.current.dewpoint_2m)}¬∞</div>
                </div>
            </div>

            <div class="card">
                <div class="card-label">–ü–æ—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑, –≤–µ—Ç–µ—Ä</div>
                <div class="h-scroll">${res.hourly.time.slice(0,24).map((t,i)=>`
                    <div class="h-item">
                        <span style="font-size:12px; opacity:0.6">${new Date(t).getHours()}:00</span>
                        <span style="font-size:20px">${res.hourly.weather_code[i] < 3 ? '‚òÄÔ∏è' : '‚òÅÔ∏è'}</span>
                        <span style="font-weight:600">${toDisplayTemp(res.hourly.temperature_2m[i])}¬∞</span>
                        <div class="wind-icon" style="transform:rotate(${res.hourly.wind_direction_10m[i]}deg)">‚Üë</div>
                        <span style="font-size:10px">${Math.round(res.hourly.wind_speed_10m[i])} –º/—Å</span>
                    </div>
                `).join('')}</div>
            </div>

            <div class="card">
                <div class="card-label">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—è</div>
                ${res.daily.time.slice(0,3).map((t,i)=>`
                    <div class="day-row">
                        <div class="day-details">
                            <b>${i===0?'–°–µ–≥–æ–¥–Ω—è':new Date(t).toLocaleDateString('ru',{weekday:'short'})}</b>
                            <span>${new Date(t).toLocaleDateString('ru',{day:'numeric', month:'short'})}</span>
                        </div>
                        <div style="text-align:center">
                            <span style="font-weight:600">${toDisplayTemp(res.daily.temperature_2m_max[i])}¬∞</span>
                            <span style="opacity:0.5; margin-left:5px">${toDisplayTemp(res.daily.temperature_2m_min[i])}¬∞</span>
                        </div>
                        <div class="day-details" style="text-align:right">
                            <span>üíß ${res.daily.relative_humidity_2m_max[i]}%</span>
                            <span>üí® ${Math.round(res.daily.wind_speed_10m_max[i])} –º/—Å</span>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="card" style="background:rgba(255,255,255,0.05)">
                <div class="card-label">ü§ñ AI –°–û–í–ï–¢</div>
                <div style="line-height:1.4; font-size:15px">
                    ${env.code >= 71 ? "–ò–¥–µ—Ç —Å–Ω–µ–≥! –ù–∞–¥–µ–Ω—å—Ç–µ —Ç–µ–ø–ª—É—é –∫—É—Ä—Ç–∫—É –∏ —Å–∞–ø–æ–≥–∏." :
                      env.code >= 51 ? "–ò–¥–µ—Ç –¥–æ–∂–¥—å, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –∑–æ–Ω—Ç." :
                      res.current.temperature_2m < -15 ? "–û—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–æ, –±–µ—Ä–µ–≥–∏—Ç–µ –ª–∏—Ü–æ!" : "–ü–æ–≥–æ–¥–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è."}
                </div>
            </div>
        `;

        let container = document.getElementById(`page-${idx}`);
        if (!container) {
            container = document.createElement('div');
            container.id = `page-${idx}`;
            container.className = 'page-container';
            if (idx === curIdx) container.classList.add('active');
            else container.classList.add(idx > curIdx ? 'next' : 'prev');
            document.getElementById('stage').appendChild(container);
        }
        container.innerHTML = html;
    }

    function updateStarIcon() {
        const star = document.getElementById('addFavStar');
        const current = pages[curIdx];
        const isFav = !current.home && pages.some((p,i) => i !== curIdx && !p.home && p.name === current.name);
        star.innerText = isFav ? '‚òÖ' : '‚òÜ';
        star.className = `fav-star ${isFav ? 'active' : ''}`;
    }

    function toggleFavorite() {
        const current = pages[curIdx];
        if (current.home) return; // –¥–æ–º–∞—à–Ω—é—é –ª–æ–∫–∞—Ü–∏—é –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ

        const favs = JSON.parse(localStorage.getItem('favs') || '[]');
        const exists = favs.some(f => f.name === current.name);

        if (exists) {
            // —É–¥–∞–ª—è–µ–º
            const newFavs = favs.filter(f => f.name !== current.name);
            localStorage.setItem('favs', JSON.stringify(newFavs));
            pages = [pages[0], ...newFavs.map(f => ({...f, home: false}))];
        } else {
            // –¥–æ–±–∞–≤–ª—è–µ–º
            favs.push({lat: current.lat, lon: current.lon, name: current.name});
            localStorage.setItem('favs', JSON.stringify(favs));
            pages.push({lat: current.lat, lon: current.lon, name: current.name, home: false});
        }

        renderPag();
        updateStarIcon();
        renderFavoritesList();
    }

    function renderFavoritesList() {
        const list = document.getElementById('favList');
        const favs = pages.filter(p => !p.home);
        list.innerHTML = favs.map((f, i) => `
            <div class="fav-list-item">
                <span>${f.name}</span>
                <span class="delete-btn" onclick="removeFavorite(${i})">–£–¥–∞–ª–∏—Ç—å</span>
            </div>
        `).join('');
    }

    function removeFavorite(arrayIdx) {
        const realIdx = arrayIdx + 1; // —Å–º–µ—â–µ–Ω–∏–µ –∏–∑-–∑–∞ home
        pages.splice(realIdx, 1);
        const favs = pages.filter(p => !p.home);
        localStorage.setItem('favs', JSON.stringify(favs.map(f => ({lat:f.lat, lon:f.lon, name:f.name}))));
        renderPag();
        renderFavoritesList();
        if (curIdx >= pages.length) {
            loadWeather(pages.length - 1);
        } else {
            loadWeather(curIdx);
        }
    }

    // –ì—Ä–∞—Ñ–∏–∫–∞ (–æ—Å—Ç–∞–≤–∏–ª —Ç–æ–ª—å–∫–æ —Å–∞–º—É—é –≤–∞–∂–Ω—É—é —á–∞—Å—Ç—å –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏)
    function initGraphics() { /* ... —Ç–æ—Ç –∂–µ –∫–æ–¥ —Å–æ —Å–Ω–µ–≥–æ–º, –¥–æ–∂–¥—ë–º, —Å–æ–ª–Ω—Ü–µ–º ... */ }
    function loop() { /* ... —Ç–æ—Ç –∂–µ –∫–æ–¥ –∞–Ω–∏–º–∞—Ü–∏–∏ ... */ }

    // –ü–æ–∏—Å–∫
    async function search(v) {
        if(v.length < 2) return document.getElementById('results').style.display='none';
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${v}&count=5&language=ru`).then(res=>res.json());
        if(r.results) {
            const box = document.getElementById('results');
            box.innerHTML = r.results.map(g => `
                <div style="padding:15px; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;" 
                     onclick="addCity(${g.latitude},${g.longitude},'${g.name.replace(/'/g,"\\'")}')">
                    ${g.name}, ${g.country}
                    <span style="font-size:22px; color:#FFD700;">‚òÜ</span>
                </div>
            `).join('');
            box.style.display = 'block';
        }
    }

    function addCity(lat, lon, name) {
        document.getElementById('results').style.display = 'none';
        const exists = pages.some(p => p.name === name);
        if (exists) {
            const idx = pages.findIndex(p => p.name === name);
            loadWeather(idx);
            return;
        }
        pages.push({lat, lon, name, home: false});
        const favs = pages.filter(p => !p.home).map(p => ({lat:p.lat, lon:p.lon, name:p.name}));
        localStorage.setItem('favs', JSON.stringify(favs));
        loadWeather(pages.length-1);
        renderFavoritesList();
    }

    // –°–≤–∞–π–ø—ã
    function ts(e) { startX = e.touches[0].clientX; }
    function te(e) {
        const diff = startX - e.changedTouches[0].clientX;
        if(Math.abs(diff) > 80) {
            if(diff > 0 && curIdx < pages.length-1) loadWeather(curIdx+1, 1);
            else if(diff < 0 && curIdx > 0) loadWeather(curIdx-1, -1);
        }
    }

    function toggleSet(show) {
        document.getElementById('settings').style.display = show ? 'block' : 'none';
        if (show) renderFavoritesList();
    }

    function renderPag() {
        document.getElementById('pag').innerHTML = pages.map((_, i) => 
            `<div class="dot ${curIdx===i?'active':''}"></div>`
        ).join('');
    }

    function resize() { 
        canvas.width = window.innerWidth; 
        canvas.height = window.innerHeight; 
    }

    window.onresize = resize;
    document.getElementById('stage').ontouchstart = ts;
    document.getElementById('stage').ontouchend = te;

    init();
</script>
</body>
</html>
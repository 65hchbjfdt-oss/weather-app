<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Weather iOS Pro</title>
    <style>
        :root { 
            --glass-bg: rgba(25, 25, 25, 0.75); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --blur-val: blur(35px) saturate(160%);
            --ios-spring: cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; background: #000; color: #fff; overflow: hidden; 
            height: 100vh; width: 100vw; position: fixed;
        }
        
        canvas#bg { position: fixed; inset: 0; z-index: -1; pointer-events: none; transition: opacity 1s; }

        /* HEADER */
        header { 
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000; 
            padding: calc(env(safe-area-inset-top) + 10px) 16px 10px;
            display: flex; gap: 12px; align-items: center;
        }
        .search-wrapper { flex: 1; position: relative; }
        .search-box { 
            display: flex; align-items: center; 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 12px; padding: 8px 12px; 
            border: 1px solid var(--glass-border);
        }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; margin-left: 8px; outline: none; }
        
        #results { 
            position: absolute; top: 50px; left: 0; right: 0; 
            background: rgba(30,30,30,0.95); backdrop-filter: blur(30px);
            border-radius: 14px; overflow: hidden; display: none; 
            border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .res-item { padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }

        /* STAGE & PAGES */
        #stage { height: 100vh; width: 100vw; position: relative; overflow: hidden; }
        
        .page-container {
            position: absolute; inset: 0;
            padding: 130px 16px 100px; 
            overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            display: none; 
            opacity: 0;
            transition: transform 0.5s var(--ios-spring), opacity 0.4s ease;
        }
        .page-container::-webkit-scrollbar { display: none; }
        
        .page-container.active { display: block; opacity: 1; transform: translateX(0); z-index: 10; }
        .page-container.prev { display: block; transform: translateX(-100%); opacity: 0; }
        .page-container.next { display: block; transform: translateX(100%); opacity: 0; }

        /* CONTENT */
        .city-info { text-align: center; margin-bottom: 40px; }
        .city-name { font-size: 34px; font-weight: 500; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .temp-main { font-size: 96px; font-weight: 200; margin: 5px 0; letter-spacing: -3px; }
        .condition { font-size: 20px; opacity: 0.9; font-weight: 500; }

        .card { 
            background: var(--glass-bg); backdrop-filter: var(--blur-val); -webkit-backdrop-filter: var(--blur-val);
            border-radius: 22px; padding: 18px; border: 1px solid var(--glass-border); margin-bottom: 14px;
        }
        .card-label { font-size: 12px; opacity: 0.6; font-weight: 700; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; }

        .h-scroll { display: flex; gap: 24px; overflow-x: auto; padding-bottom: 10px; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-item { text-align: center; min-width: 55px; display: flex; flex-direction: column; align-items: center; }

        .day-row { display: grid; grid-template-columns: 1fr 50px 1fr; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .day-row:last-child { border: none; }

        /* SUN GRAPH */
        .sun-container { height: 110px; width: 100%; margin-top: 10px; }

        /* DOTS */
        .dots-nav { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 8px; z-index: 1000; pointer-events: none;
            background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 20px;
        }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #fff; transform: scale(1.3); }

        .btn-circle { 
            width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);
            cursor: pointer;
        }

        /* SETTINGS */
        #settings-layer { 
            position: fixed; inset: 0; background: #111; z-index: 2000; 
            transform: translateY(100%); transition: transform 0.4s var(--ios-spring);
            padding: calc(env(safe-area-inset-top) + 20px) 20px;
            overflow-y: auto;
        }
        #settings-layer.open { transform: translateY(0); }
        .fav-item { 
            background: rgba(255,255,255,0.05); padding: 16px; border-radius: 16px; 
            margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    </style>
</head>
<body>

    <canvas id="bg"></canvas>

    <header>
        <div class="btn-circle" onclick="toggleSettings(true)">‚ò∞</div>
        <div class="search-wrapper">
            <div class="search-box">
                <span style="opacity: 0.5;">üîç</span>
                <input id="q" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞" oninput="doSearch(this.value)" autocomplete="off">
            </div>
            <div id="results"></div>
        </div>
    </header>

    <div id="stage"></div>
    <div class="dots-nav" id="dots"></div>

    <div id="settings-layer">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h1 style="margin:0; font-size: 32px;">–ü–æ–≥–æ–¥–∞</h1>
            <div class="btn-circle" onclick="toggleSettings(false)">‚úï</div>
        </div>
        <div id="fav-list"></div>
    </div>

<script>
    // --- STATE ---
    let cities = JSON.parse(localStorage.getItem('savedCities')) || [
        {lat: 55.75, lon: 37.62, name: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è'}
    ];
    let currentIndex = 0;
    
    // --- CANVAS ENGINE ---
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let env = { particles: [], clouds: [], stars: [], isDay: true, code: 0 };

    function initCanvas() {
        resize();
        window.addEventListener('resize', resize);
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–≤–µ–∑–¥—ã –æ–¥–∏–Ω —Ä–∞–∑
        for(let i=0; i<80; i++) env.stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2, a: Math.random() });
        animate();
    }

    function updateWeatherEnv(code, isDay) {
        env.code = code;
        env.isDay = !!isDay;
        env.particles = [];
        env.clouds = [];
        
        // –û–±–ª–∞–∫–∞ –¥–ª—è –ø–∞—Å–º—É—Ä–Ω–æ–π –ø–æ–≥–æ–¥—ã
        if(code >= 1 && code <= 3) {
            for(let i=0; i<5; i++) env.clouds.push({ x: Math.random()*canvas.width, y: Math.random()*200, r: Math.random()*100+50, v: Math.random()*0.2+0.1 });
        }
        // –û—Å–∞–¥–∫–∏
        if(code >= 51) {
            let count = code >= 65 ? 150 : 60;
            for(let i=0; i<count; i++) env.particles.push({ 
                x: Math.random()*canvas.width, y: Math.random()*canvas.height, 
                v: code >= 71 && code <= 77 ? Math.random()*2+1 : Math.random()*10+10, 
                l: code >= 71 && code <= 77 ? 2 : 15,
                type: code >= 71 && code <= 77 ? 'snow' : 'rain'
            });
        }
    }

    function animate() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        
        // –§–æ–Ω
        let grad = ctx.createLinearGradient(0,0,0,canvas.height);
        if(env.isDay) {
            grad.addColorStop(0, env.code >= 51 ? '#5D6D7E' : '#4facfe');
            grad.addColorStop(1, env.code >= 51 ? '#2C3E50' : '#00f2fe');
        } else {
            grad.addColorStop(0, '#0f2027');
            grad.addColorStop(1, '#2c5364');
        }
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,canvas.width, canvas.height);

        // –ó–≤–µ–∑–¥—ã –Ω–æ—á—å—é
        if(!env.isDay) {
            ctx.fillStyle = '#fff';
            env.stars.forEach(s => {
                ctx.globalAlpha = s.a;
                ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        // –û–±–ª–∞–∫–∞
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        env.clouds.forEach(c => {
            c.x += c.v; if(c.x > canvas.width + c.r) c.x = -c.r;
            ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.fill();
        });

        // –ß–∞—Å—Ç–∏—Ü—ã
        ctx.strokeStyle = '#fff';
        ctx.fillStyle = '#fff';
        env.particles.forEach(p => {
            p.y += p.v; if(p.y > canvas.height) p.y = -20;
            if(p.type === 'rain') {
                ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x, p.y+p.l); ctx.stroke();
            } else {
                ctx.beginPath(); ctx.arc(p.x, p.y, p.l, 0, Math.PI*2); ctx.fill();
            }
        });

        requestAnimationFrame(animate);
    }

    // --- CORE LOGIC ---
    async function init() {
        initCanvas();
        renderStructure();
        await loadCityData(currentIndex);
        initGestures();
    }

    function renderStructure() {
        const stage = document.getElementById('stage');
        const dots = document.getElementById('dots');
        stage.innerHTML = ''; dots.innerHTML = '';
        
        cities.forEach((_, i) => {
            const page = document.createElement('div');
            page.className = `page-container ${i === currentIndex ? 'active' : (i < currentIndex ? 'prev' : 'next')}`;
            page.id = `page-${i}`;
            stage.appendChild(page);

            const dot = document.createElement('div');
            dot.className = `dot ${i === currentIndex ? 'active' : ''}`;
            dots.appendChild(dot);
        });
    }

    async function loadCityData(idx) {
        const page = document.getElementById(`page-${idx}`);
        if (!page) return;

        const c = cities[idx];
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&current=temperature_2m,weather_code,is_day,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`);
            const data = await res.json();
            
            page.innerHTML = generateHTML(data, c, idx);
            if (idx === currentIndex) updateWeatherEnv(data.current.weather_code, data.current.is_day);
            
            setTimeout(() => drawSun(`sun-${idx}`, data.daily.sunrise[0], data.daily.sunset[0]), 50);
        } catch (e) {
            page.innerHTML = `<div style="padding-top:100px; text-align:center;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>`;
        }
    }

    function generateHTML(data, c, idx) {
        const cur = data.current;
        const daily = data.daily;
        
        let hourly = '';
        const nowH = new Date().getHours();
        for(let i = nowH; i < nowH + 24; i++) {
            hourly += `
                <div class="h-item">
                    <span style="font-size:13px; opacity:0.7; margin-bottom:8px;">${i % 24}:00</span>
                    <span style="font-size:22px; margin-bottom:8px;">${getIcon(data.hourly.weather_code[i])}</span>
                    <span style="font-weight:600;">${Math.round(data.hourly.temperature_2m[i])}¬∞</span>
                </div>`;
        }

        let week = '';
        for(let i = 0; i < 7; i++) {
            const day = new Date(daily.time[i]).toLocaleDateString('ru-RU', {weekday: 'short'});
            week += `
                <div class="day-row">
                    <div style="text-transform: capitalize; font-weight:500;">${i === 0 ? '–°–µ–≥–æ–¥–Ω—è' : day}</div>
                    <div style="font-size:20px; text-align:center;">${getIcon(daily.weather_code[i])}</div>
                    <div style="text-align:right;">
                        <span style="opacity:0.5; margin-right:10px;">${Math.round(daily.temperature_2m_min[i])}¬∞</span>
                        <span style="font-weight:600;">${Math.round(daily.temperature_2m_max[i])}¬∞</span>
                    </div>
                </div>`;
        }

        return `
            <div class="city-info">
                <div class="city-name">${c.name}</div>
                <div class="temp-main">${Math.round(cur.temperature_2m)}¬∞</div>
                <div class="condition">${getDesc(cur.weather_code)}</div>
                <div style="margin-top:10px; font-weight:500;">–ú–∞–∫—Å: ${Math.round(daily.temperature_2m_max[0])}¬∞, –º–∏–Ω: ${Math.round(daily.temperature_2m_min[0])}¬∞</div>
            </div>
            <div class="card">
                <div class="card-label">üïì –ü–æ—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑</div>
                <div class="h-scroll">${hourly}</div>
            </div>
            <div class="card">
                <div class="card-label">üìÖ 7 –¥–Ω–µ–π</div>
                ${week}
            </div>
            <div class="grid-2">
                <div class="card">
                    <div class="card-label">üåÖ –°–æ–ª–Ω—Ü–µ</div>
                    <div class="sun-container"><canvas id="sun-${idx}" width="200" height="110" style="width:100%; height:100%"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-label">üí® –í–µ—Ç–µ—Ä</div>
                    <div style="font-size:28px; font-weight:600; margin-top:10px;">${cur.wind_speed_10m} <span style="font-size:16px; opacity:0.6;">–∫–º/—á</span></div>
                </div>
            </div>
        `;
    }

    // --- SUN GRAPH ---
    function drawSun(id, riseStr, setStr) {
        const c = document.getElementById(id);
        if(!c) return;
        const sctx = c.getContext('2d');
        const w = c.width, h = c.height;
        const now = new Date(), rise = new Date(riseStr), set = new Date(setStr);
        
        sctx.clearRect(0,0,w,h);
        sctx.strokeStyle = 'rgba(255,255,255,0.2)';
        sctx.lineWidth = 2;
        
        // –ì–æ—Ä–∏–∑–æ–Ω—Ç
        sctx.beginPath(); sctx.moveTo(0, h-20); sctx.lineTo(w, h-20); sctx.stroke();

        // –î—É–≥–∞
        const r = w/2 - 10;
        const cx = w/2, cy = h - 20;
        sctx.beginPath(); sctx.setLineDash([5,5]);
        sctx.arc(cx, cy, r, Math.PI, 0); sctx.stroke();
        sctx.setLineDash([]);

        // –ü–æ–ª–æ–∂–µ–Ω–∏–µ —Å–æ–ª–Ω—Ü–∞
        const total = set - rise;
        const current = now - rise;
        const pct = Math.max(0, Math.min(1, current / total));

        if(now >= rise && now <= set) {
            const angle = Math.PI + (Math.PI * pct);
            const sx = cx + r * Math.cos(angle);
            const sy = cy + r * Math.sin(angle);
            
            sctx.strokeStyle = '#FFD700'; sctx.lineWidth = 3;
            sctx.beginPath(); sctx.arc(cx, cy, r, Math.PI, angle); sctx.stroke();
            
            sctx.fillStyle = '#FFD700'; sctx.shadowBlur = 10; sctx.shadowColor = '#FFD700';
            sctx.beginPath(); sctx.arc(sx, sy, 6, 0, Math.PI*2); sctx.fill();
        }
    }

    // --- GESTURES ---
    function initGestures() {
        let startX = 0, startY = 0, isHorizontal = false;
        
        document.addEventListener('touchstart', e => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isHorizontal = false;
        }, {passive: true});

        document.addEventListener('touchmove', e => {
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            if(!isHorizontal && Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) isHorizontal = true;
        }, {passive: true});

        document.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - startX;
            if(isHorizontal && Math.abs(dx) > 70) {
                if(dx > 0 && currentIndex > 0) switchCity(currentIndex - 1);
                else if(dx < 0 && currentIndex < cities.length - 1) switchCity(currentIndex + 1);
            }
        });
    }

    function switchCity(idx) {
        currentIndex = idx;
        const pages = document.querySelectorAll('.page-container');
        const dots = document.querySelectorAll('.dot');
        
        pages.forEach((p, i) => {
            p.className = `page-container ${i === idx ? 'active' : (i < idx ? 'prev' : 'next')}`;
        });
        dots.forEach((d, i) => d.classList.toggle('active', i === idx));
        loadCityData(idx);
    }

    // --- UTILS ---
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

    function toggleSettings(open) {
        document.getElementById('settings-layer').classList.toggle('open', open);
        if(open) renderFavList();
    }

    function renderFavList() {
        const list = document.getElementById('fav-list');
        list.innerHTML = cities.map((c, i) => `
            <div class="fav-item" onclick="switchCity(${i}); toggleSettings(false);">
                <div>
                    <div style="font-size:18px; font-weight:600;">${c.name}</div>
                    <div style="font-size:12px; opacity:0.6;">${c.country}</div>
                </div>
                <div style="font-size:20px; opacity:0.5;">${i === currentIndex ? 'üìç' : '‚Üí'}</div>
            </div>`).join('');
    }

    async function doSearch(q) {
        const resBox = document.getElementById('results');
        if (q.length < 2) { resBox.style.display = 'none'; return; }
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=ru`).then(x => x.json());
        if (!r.results) return;
        resBox.innerHTML = r.results.map(i => `<div class="res-item" onclick="addCity(${i.latitude}, ${i.longitude}, '${i.name}', '${i.country}')"><b>${i.name}</b>, ${i.country}</div>`).join('');
        resBox.style.display = 'block';
    }

    function addCity(lat, lon, name, country) {
        cities.push({lat, lon, name, country});
        localStorage.setItem('savedCities', JSON.stringify(cities));
        document.getElementById('results').style.display = 'none';
        document.getElementById('q').value = '';
        renderStructure();
        switchCity(cities.length - 1);
    }

    function getIcon(code) {
        if(code === 0) return '‚òÄÔ∏è';
        if(code <= 3) return '‚òÅÔ∏è';
        if(code <= 67) return 'üåßÔ∏è';
        if(code <= 77) return '‚ùÑÔ∏è';
        return '‚õàÔ∏è';
    }

    function getDesc(code) {
        const d = {0:'–Ø—Å–Ω–æ', 1:'–í –æ—Å–Ω. —è—Å–Ω–æ', 2:'–û–±–ª–∞—á–Ω–æ', 3:'–ü–∞—Å–º—É—Ä–Ω–æ', 45:'–¢—É–º–∞–Ω', 51:'–ú–æ—Ä–æ—Å—å', 61:'–î–æ–∂–¥—å', 71:'–°–Ω–µ–≥', 95:'–ì—Ä–æ–∑–∞'};
        return d[code] || '–û—Å–∞–¥–∫–∏';
    }

    init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather AI Pro</title>
    <style>
        :root { --glass: rgba(255, 255, 255, 0.12); --blur: blur(25px); --radius: 24px; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; }
        body { margin: 0; background: #000; color: #fff; overflow-x: hidden; min-height: 100vh; }
        canvas#bg { position: fixed; inset: 0; z-index: -1; }

        header { padding: 15px; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
        
        /* Поиск и подсказки */
        .search-container { position: relative; flex: 1; display: flex; gap: 8px; }
        .search-box { flex: 1; display: flex; background: var(--glass); backdrop-filter: var(--blur); border-radius: 18px; padding: 10px 15px; border: 0.5px solid rgba(255,255,255,0.2); }
        input { flex: 1; background: transparent; border: none; color: #fff; outline: none; font-size: 16px; }
        
        .suggestions { position: absolute; top: 110%; left: 0; right: 0; background: rgba(0,0,0,0.8); backdrop-filter: var(--blur); border-radius: 15px; z-index: 100; overflow: hidden; border: 0.5px solid var(--glass); }
        .suggestion-item { padding: 12px 15px; cursor: pointer; border-bottom: 0.5px solid rgba(255,255,255,0.1); font-size: 14px; }
        .suggestion-item:hover { background: var(--glass); }

        /* Избранное */
        .fav-bar { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; scrollbar-width: none; }
        .fav-item { background: var(--glass); backdrop-filter: var(--blur); padding: 8px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; border: 0.5px solid rgba(255,255,255,0.1); transition: 0.3s; }
        .fav-item.active { background: #fff; color: #000; }

        main { padding: 10px; display: flex; flex-direction: column; gap: 15px; max-width: 900px; margin: 0 auto; }
        .card { background: var(--glass); backdrop-filter: var(--blur); border-radius: var(--radius); border: 0.5px solid rgba(255,255,255,0.15); padding: 20px; }

        .now { text-align: center; padding: 30px 10px; background: transparent; }
        .temp-big { font-size: 90px; font-weight: 100; margin: 0; letter-spacing: -3px; position: relative; display: inline-block;}
        .temp-big::after { content: '°'; position: absolute; top: 10px; right: -25px; font-size: 40px; }
        
        .day-row { display: grid; grid-template-columns: 60px 40px 1fr 100px; align-items: center; gap: 10px; padding: 12px 0; border-bottom: 0.5px solid rgba(255,255,255,0.1); }
        .day-temps { text-align: right; }
        .t-min { opacity: 0.5; margin-right: 8px; font-size: 0.9em; }

        @media (min-width: 768px) {
            main { display: grid; grid-template-columns: 1fr 1fr; }
            .now { grid-column: span 2; }
        }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<header>
    <div class="search-container">
        <div class="search-box">
            <input id="q" placeholder="Поиск города..." oninput="handleInput(this.value)" />
            <button onclick="toggleFavorite()" id="favBtn">♡</button>
        </div>
        <div id="suggestions" class="suggestions" style="display:none"></div>
    </div>
    <div class="fav-bar" id="favBar"></div>
</header>

<main id="app" style="display:none">
    <section class="now">
        <div style="font-size:28px; font-weight:600" id="place">---</div>
        <div class="temp-big" id="mainTemp">0</div>
        <div style="font-size:20px; opacity:0.8" id="mainDesc">---</div>
    </section>

    <section class="card">
        <div style="font-size:12px; opacity:0.5; margin-bottom:15px">ПРОГНОЗ НА 3 ДНЯ</div>
        <div id="dList"></div>
    </section>
</main>

<script>
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let favorites = JSON.parse(localStorage.getItem('favs')) || [];
    let currentCity = null, isDay = true, weatherCode = 0;
    let blobs = [], stars = [], clouds = [], sunRays = 0;

    // --- ЛОГИКА ПОИСКА ---
    async function handleInput(val) {
        if (val.length < 2) { document.getElementById('suggestions').style.display = 'none'; return; }
        const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${val}&count=3&language=ru`).then(r => r.json());
        const container = document.getElementById('suggestions');
        if (res.results) {
            container.innerHTML = res.results.map(g => `
                <div class="suggestion-item" onclick="selectCity('${g.latitude}', '${g.longitude}', '${g.name}')">
                    ${g.name}, <span style="opacity:0.5">${g.country}</span>
                </div>
            `).join('');
            container.style.display = 'block';
        }
    }

    function selectCity(lat, lon, name) {
        document.getElementById('suggestions').style.display = 'none';
        document.getElementById('q').value = name;
        load(lat, lon, name);
    }

    // --- ИЗБРАННОЕ ---
    function toggleFavorite() {
        if (!currentCity) return;
        const idx = favorites.findIndex(f => f.name === currentCity.name);
        if (idx === -1) {
            if (favorites.length >= 3) favorites.shift();
            favorites.push(currentCity);
        } else {
            favorites.splice(idx, 1);
        }
        localStorage.setItem('favs', JSON.stringify(favorites));
        renderFavs();
    }

    function renderFavs() {
        const bar = document.getElementById('favBar');
        bar.innerHTML = favorites.map(f => `
            <div class="fav-item ${currentCity?.name === f.name ? 'active' : ''}" onclick="load(${f.lat}, ${f.lon}, '${f.name}')">
                ${f.name}
            </div>
        `).join('');
        document.getElementById('favBtn').innerText = favorites.some(f => f.name === currentCity?.name) ? '❤️' : '♡';
    }

    // --- ПОГОДА ---
    async function load(lat, lon, name) {
        currentCity = {lat, lon, name};
        const d = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,is_day,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`).then(r=>r.json());
        isDay = !!d.current.is_day;
        weatherCode = d.current.weather_code;
        
        document.getElementById('place').innerText = name;
        document.getElementById('mainTemp').innerText = Math.round(d.current.temperature_2m);
        document.getElementById('mainDesc').innerText = weatherCode === 0 ? 'Ясно' : 'Облачно';
        
        const dList = document.getElementById('dList');
        dList.innerHTML = d.daily.time.slice(0,3).map((time, i) => `
            <div class="day-row">
                <span>${i===0?'Сегодня':new Date(time).toLocaleDateString('ru',{weekday:'short'})}</span>
                <span style="font-size:20px">☁️</span>
                <span style="opacity:0.6; font-size:13px">Переменная обл.</span>
                <div class="day-temps">
                    <span class="t-min">${Math.round(d.daily.temperature_2m_min[i])}°</span>
                    <span>${Math.round(d.daily.temperature_2m_max[i])}°</span>
                </div>
            </div>
        `).join('');

        document.getElementById('app').style.display = 'grid';
        initScene();
        renderFavs();
    }

    // --- ГРАФИКА (AI LOOK) ---
    function initScene() {
        blobs = [];
        const pal = isDay ? ['#007AFF', '#00C6FF', '#0052D4'] : ['#0F0C29', '#302B63', '#24243E'];
        for(let i=0; i<3; i++) blobs.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:canvas.width*0.8, c:pal[i], vx:Math.random()-0.5, vy:Math.random()-0.5});
        
        clouds = [];
        for(let i=0; i<8; i++) clouds.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*150+100, o:Math.random()*0.1+0.02, v:Math.random()*0.2+0.1});
        
        stars = isDay ? [] : Array(80).fill().map(() => ({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*1.5}));
    }

    function draw() {
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
        
        // Жидкий фон
        blobs.forEach(b => {
            b.x += b.vx; b.y += b.vy;
            if(b.x<0 || b.x>canvas.width) b.vx*=-1; if(b.y<0 || b.y>canvas.height) b.vy*=-1;
            let g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r);
            g.addColorStop(0, b.c); g.addColorStop(1, 'transparent');
            ctx.globalCompositeOperation = 'screen'; ctx.fillStyle = g;
            ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
        });

        ctx.globalCompositeOperation = 'source-over';

        // Реалистичное Солнце
        if (isDay && weatherCode < 2) {
            const sunX = canvas.width * 0.8, sunY = 150;
            sunRays += 0.005;
            
            // Корона
            let pulse = Math.sin(Date.now()/1000)*10;
            let g2 = ctx.createRadialGradient(sunX, sunY, 0, sunX, sunY, 150 + pulse);
            g2.addColorStop(0, 'rgba(255, 230, 100, 0.4)'); g2.addColorStop(1, 'transparent');
            ctx.fillStyle = g2;
            ctx.beginPath(); ctx.arc(sunX, sunY, 150+pulse, 0, Math.PI*2); ctx.fill();

            // Лучи
            for(let i=0; i<8; i++) {
                ctx.save();
                ctx.translate(sunX, sunY);
                ctx.rotate(sunRays + i * Math.PI/4);
                let rg = ctx.createLinearGradient(0,0, 0, 400);
                rg.addColorStop(0, 'rgba(255,255,255,0.15)'); rg.addColorStop(1, 'transparent');
                ctx.fillStyle = rg;
                ctx.beginPath(); ctx.moveTo(-20,0); ctx.lineTo(20,0); ctx.lineTo(0, 400); ctx.fill();
                ctx.restore();
            }
        }

        // Звезды
        stars.forEach(s => {
            ctx.fillStyle = `rgba(255,255,255,${Math.abs(Math.sin(Date.now()/1000 + s.x))})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
        });

        // Еле видимые облака
        clouds.forEach(c => {
            c.x += c.v; if(c.x > canvas.width + c.r) c.x = -c.r;
            let g = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, c.r);
            g.addColorStop(0, `rgba(255,255,255,${c.o})`); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.fill();
        });

        requestAnimationFrame(draw);
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initScene(); }
    window.onresize = resize;
    window.onload = () => { resize(); load(55.75, 37.62, 'Москва'); draw(); };
</script>
</body>
</html>

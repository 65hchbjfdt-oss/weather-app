<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Weather iOS Enhanced</title>
<style>
:root {
--glass: rgba(50, 50, 50, 0.35);
--glass-border: rgba(255, 255, 255, 0.18);
--blur: blur(40px);
--spring: cubic-bezier(0.25, 0.8, 0.25, 1);
}
* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; touch-action: pan-y; }

/* –§–æ–Ω-–∞–Ω–∏–º–∞—Ü–∏—è */
canvas#bg { position: fixed; inset: 0; z-index: -1; transition: filter 1s ease; }

/* –ü–æ–∏—Å–∫ */
header { padding: 40px 20px 10px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; gap: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); pointer-events: none; }
.search-wrapper { flex: 1; pointer-events: auto; position: relative; }
.search-box { display: flex; align-items: center; background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); border-radius: 14px; padding: 8px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid var(--glass-border); }
input { flex: 1; background: transparent; border: none; color: #fff; font-size: 17px; outline: none; margin-left: 8px; }

/* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ */
#results { position: absolute; top: 50px; left: 0; right: 0; background: var(--glass); border-radius: 14px; overflow: hidden; display: none; z-index: 2500; border: 1px solid var(--glass-border); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); max-height: 300px; overflow-y: auto; }
.res-item { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: background 0.2s ease; }
.res-item:hover { background: rgba(255,255,255,0.1); }
.res-item:last-child { border: none; }
.res-main { font-size: 16px; color: #fff; }
.res-sub { font-size: 13px; color: #aaa; margin-top: 2px; }

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü */
#stage { height: 100vh; width: 100vw; position: relative; overflow: hidden; touch-action: pan-y; }

/* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–æ—Ä–æ–¥–∞ */
.page-container {
position: absolute; inset: 0;
padding: 100px 20px 140px;
transition: transform 0.6s var(--spring), opacity 0.5s ease;
overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth;
-webkit-overflow-scrolling: touch;
display: none;
touch-action: pan-y;
}
.page-container.active { display: block; transform: translateX(0); opacity: 1; z-index: 5; }
.page-container.prev { display: block; transform: translateX(-40%); opacity: 0; z-index: 1; }
.page-container.next { display: block; transform: translateX(100%); opacity: 1; z-index: 6; }

/* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
.city-header { text-align: center; margin-bottom: 40px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
.city-name { font-size: 32px; font-weight: 600; }
.temp-big { font-size: 90px; font-weight: 200; letter-spacing: -2px; line-height: 1.1; }
.condition-text { font-size: 18px; font-weight: 500; opacity: 0.9; text-transform: capitalize; }
.hl-temp { font-size: 18px; font-weight: 500; margin-top: 5px; }

/* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –∂–∏–¥–∫–∏–º —Å—Ç–µ–∫–ª–æ–º */
.card {
background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
border-radius: 20px; padding: 15px; border: 1px solid var(--glass-border); margin-bottom: 12px;
box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}
.card-label { font-size: 13px; opacity: 0.6; text-transform: uppercase; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }

/* –°–µ—Ç–∫–∞ –ø–ª–∏—Ç–æ–∫ 2x2 */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
.tile { aspect-ratio: 1; display: flex; flex-direction: column; justify-content: space-between; }
.tile-val { font-size: 26px; font-weight: 500; }
.tile-sub { font-size: 13px; opacity: 0.7; }

/* –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Å–∫—Ä–æ–ª–ª—ã */
.h-scroll { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
.h-scroll::-webkit-scrollbar { display: none; }
.h-item { text-align: center; min-width: 50px; display: flex; flex-direction: column; align-items: center; gap: 6px; }
.h-item.current { background: rgba(255,255,255,0.15); border-radius: 12px; padding: 8px; }

.day-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 16px; font-weight: 500; }
.day-row:last-child { border: none; }

/* –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–æ—á–∫–∏) */
.nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); padding: 8px 16px; border-radius: 20px; display: flex; gap: 8px; z-index: 2000; border: 1px solid var(--glass-border); pointer-events: none; }
.dot { width: 8px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s var(--spring); }
.dot.active { background: #fff; transform: scale(1.2); }

/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
.btn-circle { width: 40px; height: 40px; border-radius: 50%; background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); display: flex; align-items: center; justify-content: center; border: 1px solid var(--glass-border); cursor: pointer; pointer-events: auto; transition: transform 0.2s var(--spring); }
.btn-circle:active { transform: scale(0.9); }

/* –ü–†–ï–î–ü–†–û–°–ú–û–¢–† (–ú–æ–¥–∞–ª–∫–∞) —Å –∂–∏–¥–∫–∏–º —Å—Ç–µ–∫–ª–æ–º */
#preview-modal { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: none; flex-direction: column; }
.preview-header { padding: 50px 20px 10px; display: flex; justify-content: space-between; align-items: center; }
.preview-content { flex: 1; overflow-y: auto; padding: 0 20px 40px; }
.preview-actions { padding: 20px; display: flex; justify-content: center; gap: 20px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
.add-btn { background: #fff; color: #000; padding: 12px 30px; border-radius: 25px; font-weight: 600; border: none; font-size: 16px; transition: transform 0.2s var(--spring); }
.add-btn:active { transform: scale(0.95); }

/* –°–û–õ–ù–¶–ï (–ú–æ–¥–∞–ª–∫–∞) */
#sun-modal { position: fixed; inset: 0; z-index: 3500; background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); transform: translateY(100%); transition: transform 0.4s var(--spring); display: flex; flex-direction: column; }
#sun-modal.open { transform: translateY(0); }
.sun-modal-head { display: flex; justify-content: space-between; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }
.sun-modal-body { padding: 20px; flex: 1; overflow-y: auto; }
.sun-detail-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 17px; }
.sun-graph-lg { width: 100%; height: 200px; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.2); }

/* AI Text */
.ai-box { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 15px; margin-top: 20px; }
.ai-title { font-size: 14px; font-weight: 700; color: #FFD60A; margin-bottom: 8px; }
.ai-text { font-size: 15px; line-height: 1.4; opacity: 0.9; }

/* List Menu (Settings/Favorites) —Å –∂–∏–¥–∫–∏–º —Å—Ç–µ–∫–ª–æ–º */
#settings-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); z-index: 2900; transform: translateX(-100%); transition: 0.4s var(--spring); padding: 50px 20px; overflow-y: auto; }
#settings-layer.show { transform: translateX(0); }
.list-item { background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--glass-border); }

</style>
</head>
<body>

<canvas id="bg"></canvas>

<header>
<div class="btn-circle" onclick="toggleSettings(true)" style="margin-right: 10px;">‚ò∞</div>
<div class="search-wrapper">
<div class="search-box">
<span style="opacity:0.6">üîç</span>
<input id="q" placeholder="–ü–æ–∏—Å–∫ (–ì–æ—Ä–æ–¥, –°—Ç—Ä–∞–Ω–∞)" oninput="doSearch(this.value)">
</div>
<div id="results"></div>
</div>
</header>

<div id="stage"></div>

<div class="nav-dock" id="pagination"></div>

<div id="settings-layer">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
<h1 style="margin:0; font-size:28px;">–ú–æ–∏ –≥–æ—Ä–æ–¥–∞</h1>
<div class="btn-circle" onclick="toggleSettings(false)">‚úï</div>
</div>
<div id="fav-list"></div>
<div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
<h3 style="opacity:0.5">–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è</h3>
<div class="list-item" onclick="toggleUnit('temp')">
<span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span>
<span id="unit-disp" style="color:#0a84ff">¬∞C</span>
</div>
<div class="list-item" onclick="toggleUnit('wind')">
<span>–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞</span>
<span id="wind-unit-disp" style="color:#0a84ff">–∫–º/—á</span>
</div>
</div>
</div>

<div id="preview-modal">
<div class="preview-header">
<div class="btn-circle" onclick="closePreview()">‚úï</div>
<span style="font-weight:600; opacity:0.8">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
<div style="width:40px"></div>
</div>
<div class="preview-content" id="preview-inner"></div>
<div class="preview-actions">
<button class="add-btn" onclick="confirmAddCity()">–î–æ–±–∞–≤–∏—Ç—å</button>
</div>
</div>

<div id="sun-modal">
<div class="sun-modal-head">
<span style="font-size:18px; font-weight:600">–°–æ–ª–Ω—Ü–µ</span>
<div class="btn-circle" style="width:30px; height:30px; font-size:14px;" onclick="document.getElementById('sun-modal').classList.remove('open')">‚úï</div>
</div>
<div class="sun-modal-body" id="sun-details-content">
</div>
</div>

<script>
// --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
let cities = [];
let currentIndex = 0;
let unit = localStorage.getItem('unit') || 'C';
let windUnit = localStorage.getItem('windUnit') || 'kmh';
let tempCity = null;

// –ì—Ä–∞—Ñ–∏–∫–∞
const canvas = document.getElementById('bg');
const ctx = canvas.getContext('2d');
let env = { wCode: 0, isDay: 1, stars: [], rain: [], snow: [], clouds: [] };

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
async function init() {
resize();
window.addEventListener('resize', resize);

const saved = JSON.parse(localStorage.getItem('savedCities') || '[]');
if (saved.length > 0) {
cities = saved;
loadWeather(0);
} else {
navigator.geolocation.getCurrentPosition(
async pos => {
const data = await getGeoName(pos.coords.latitude, pos.coords.longitude);
cities = [{...data, isHome: true}];
saveCities();
loadWeather(0);
},
() => {
cities = [{lat: 55.75, lon: 37.62, name: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è', isHome: true}];
saveCities();
loadWeather(0);
}
);
}

document.getElementById('unit-disp').innerText = unit === 'C' ? '¬∞C' : '¬∞F';
document.getElementById('wind-unit-disp').innerText = windUnit === 'kmh' ? '–∫–º/—á' : (windUnit === 'ms' ? '–º/—Å' : '–º–∏–ª—å/—á');
startAnimLoop();

// –°–≤–∞–π–ø—ã —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π iOS –∞–Ω–∏–º–∞—Ü–∏–µ–π
let sx = 0, sy = 0;
const stage = document.getElementById('stage');
stage.addEventListener('touchstart', e => {
sx = e.touches[0].clientX;
sy = e.touches[0].clientY;
});
stage.addEventListener('touchmove', e => {
const dy = Math.abs(e.touches[0].clientY - sy);
const dx = Math.abs(e.touches[0].clientX - sx);
if (dx > dy) {
e.preventDefault();
}
}, { passive: false });
stage.addEventListener('touchend', e => {
const diff = sx - e.changedTouches[0].clientX;
const diffY = Math.abs(sy - e.changedTouches[0].clientY);
if (Math.abs(diff) > 50 && diffY < 100) {
if (diff > 0 && currentIndex < cities.length - 1) changePage(currentIndex + 1);
else if (diff < 0 && currentIndex > 0) changePage(currentIndex - 1);
}
});
}

// --- API & –õ–æ–≥–∏–∫–∞ ---

async function getGeoName(lat, lon) {
try {
const r = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}`);
const d = await r.json();
if(!d.results || !d.results[0]) return {lat, lon, name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', country: ''};
const loc = d.results[0];
return {lat, lon, name: loc.name, region: loc.admin1 || '', country: loc.country || ''};
} catch(e) { return {lat, lon, name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', country: ''}; }
}

async function doSearch(q) {
const res = document.getElementById('results');
if(!q.trim()) { res.style.display = 'none'; return; }
try {
const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=5&language=ru`);
const d = await r.json();
if(!d.results || d.results.length === 0) { res.style.display = 'none'; return; }
res.innerHTML = d.results.map(loc => `
<div class="res-item" onclick='selectCity(${JSON.stringify(loc)})'>
<div class="res-main">${loc.name}</div>
<div class="res-sub">${[loc.admin1, loc.country].filter(x=>x).join(', ')}</div>
</div>
`).join('');
res.style.display = 'block';
} catch(e) { res.style.display = 'none'; }
}

async function selectCity(loc) {
document.getElementById('results').style.display = 'none';
document.getElementById('q').value = '';
tempCity = {lat: loc.latitude, lon: loc.longitude, name: loc.name, region: loc.admin1 || '', country: loc.country || ''};
await showPreview(tempCity);
}

async function showPreview(city) {
const modal = document.getElementById('preview-modal');
const inner = document.getElementById('preview-inner');
inner.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.5">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
modal.style.display = 'flex';

try {
const tempU = unit === 'C' ? 'celsius' : 'fahrenheit';
const windU = windUnit === 'kmh' ? 'kmh' : (windUnit === 'ms' ? 'ms' : 'mph');
const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,weather_code,wind_speed_10m,wind_direction_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&temperature_unit=${tempU}&wind_speed_unit=${windU}&timezone=auto`);
const data = await r.json();
updateEnv(data);
inner.innerHTML = buildPageHTML(city, data, true);
} catch(e) {
inner.innerHTML = '<div style="text-align:center; padding:40px; color:#ff453a">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
}
}

function closePreview() {
document.getElementById('preview-modal').style.display = 'none';
tempCity = null;
}

function confirmAddCity() {
if(!tempCity) return;
const exists = cities.some(c => c.lat === tempCity.lat && c.lon === tempCity.lon);
if(exists) { alert('–ì–æ—Ä–æ–¥ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω'); return; }
cities.push(tempCity);
saveCities();
loadWeather(cities.length - 1);
closePreview();
}

function saveCities() {
localStorage.setItem('savedCities', JSON.stringify(cities));
}

async function loadWeather(index) {
if(index < 0 || index >= cities.length) return;
currentIndex = index;
updatePagination();

const city = cities[index];
const tempU = unit === 'C' ? 'celsius' : 'fahrenheit';
const windU = windUnit === 'kmh' ? 'kmh' : (windUnit === 'ms' ? 'ms' : 'mph');
try {
const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,weather_code,wind_speed_10m,wind_direction_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&temperature_unit=${tempU}&wind_speed_unit=${windU}&timezone=auto`);
const data = await r.json();
updateEnv(data);
renderPage(city, data, index);
} catch(e) {
console.error(e);
}
}

function renderPage(city, data, index) {
const stage = document.getElementById('stage');
let page = stage.querySelector(`[data-index="${index}"]`);
if(!page) {
page = document.createElement('div');
page.className = 'page-container';
page.dataset.index = index;
stage.appendChild(page);
}
page.innerHTML = buildPageHTML(city, data, false);

document.querySelectorAll('.page-container').forEach(p => {
const i = parseInt(p.dataset.index);
p.classList.remove('active', 'prev', 'next');
if(i === index) p.classList.add('active');
else if(i < index) p.classList.add('prev');
else p.classList.add('next');
});
}

function buildPageHTML(city, data, isPreview) {
const c = data.current;
const d = data.daily;
const h = data.hourly;

const tempSymbol = unit === 'C' ? '¬∞C' : '¬∞F';
const windSymbol = windUnit === 'kmh' ? '–∫–º/—á' : (windUnit === 'ms' ? '–º/—Å' : '–º–∏–ª—å/—á');

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
const now = new Date();
const currentHour = now.getHours();

// –ü–æ—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
const hourlyHTML = h.time.slice(0, 24).map((t, i) => {
const hour = new Date(t).getHours();
const temp = Math.round(h.temperature_2m[i]);
const icon = getWIcon(h.weather_code[i]);
const isCurrent = hour === currentHour;
const label = isCurrent ? '–°–µ–π—á–∞—Å' : `${hour}:00`;
return `<div class="h-item ${isCurrent ? 'current' : ''}">
<div style="font-size:13px; opacity:0.7">${label}</div>
<div style="font-size:24px">${icon}</div>
<div style="font-weight:600">${temp}${tempSymbol}</div>
</div>`;
}).join('');

// 7-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑
const weekHTML = d.time.slice(0, 7).map((t, i) => {
const date = new Date(t);
const day = i === 0 ? '–°–µ–≥–æ–¥–Ω—è' : date.toLocaleDateString('ru', {weekday: 'short'});
const icon = getWIcon(d.weather_code[i]);
const tmax = Math.round(d.temperature_2m_max[i]);
const tmin = Math.round(d.temperature_2m_min[i]);
return `<div class="day-row">
<div>${day}</div>
<div style="text-align:center">${icon}</div>
<div style="text-align:right">${tmin}¬∞ / ${tmax}¬∞</div>
</div>`;
}).join('');

// –°–æ–ª–Ω—Ü–µ
const sunrise = d.sunrise[0];
const sunset = d.sunset[0];
const sunData = {rise: sunrise, set: sunset, dur: (new Date(sunset) - new Date(sunrise)) / 1000};
const sunJSON = encodeURIComponent(JSON.stringify(sunData));

// AI —Ç–µ–∫—Å—Ç —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
const aiText = getAIText(c.temperature_2m, c.weather_code, c.wind_speed_10m, c.apparent_temperature);

return `
<div class="city-header">
<div class="city-name">${city.name}</div>
<div class="temp-big">${Math.round(c.temperature_2m)}¬∞</div>
<div class="condition-text">${getWDesc(c.weather_code)}</div>
<div class="hl-temp">–ú–∞–∫—Å.: ${Math.round(d.temperature_2m_max[0])}¬∞ –ú–∏–Ω.: ${Math.round(d.temperature_2m_min[0])}¬∞</div>
</div>

<div class="card">
<div class="card-label">‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ</div>
<div style="display:flex; justify-content:space-around; margin-bottom:15px">
<div><div style="opacity:0.6; font-size:13px">–í–æ—Å—Ö–æ–¥</div><div style="font-size:18px; font-weight:600">${sunrise.split('T')[1]}</div></div>
<div><div style="opacity:0.6; font-size:13px">–ó–∞–∫–∞—Ç</div><div style="font-size:18px; font-weight:600">${sunset.split('T')[1]}</div></div>
</div>
<canvas class="sun-graph-lg" id="sun-${isPreview?'preview':''+currentIndex}" width="300" height="100"></canvas>
<div style="text-align:center; margin-top:10px; opacity:0.7; font-size:14px; cursor:pointer" onclick='openSunDetail("${sunJSON}")'>–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí</div>
</div>

<div class="card">
<div class="card-label">üïê –ü–æ—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑</div>
<div class="h-scroll">${hourlyHTML}</div>
</div>

<div class="grid-2">
<div class="card tile">
<div class="card-label">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
<div class="tile-val">${c.relative_humidity_2m}%</div>
</div>
<div class="card tile">
<div class="card-label">üå°Ô∏è –û—â—É—â–∞–µ—Ç—Å—è</div>
<div class="tile-val">${Math.round(c.apparent_temperature)}¬∞</div>
</div>
<div class="card tile">
<div class="card-label">üí® –í–µ—Ç–µ—Ä</div>
<div class="tile-val">${Math.round(c.wind_speed_10m)}</div>
<div class="tile-sub">${windSymbol}</div>
</div>
<div class="card tile">
<div class="card-label">üß≠ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
<div class="tile-val">${getWindDir(c.wind_direction_10m)}</div>
</div>
</div>

<div class="card">
<div class="card-label">üìÖ 7-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑</div>
${weekHTML}
</div>

<div class="ai-box">
<div class="ai-title">ü§ñ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ò–ò</div>
<div class="ai-text">${aiText}</div>
</div>
`;
}

function changePage(index) {
if(index < 0 || index >= cities.length) return;
loadWeather(index);
}

function drawSunGraph(canvasId, rise, set) {
setTimeout(() => {
const c = document.getElementById(canvasId);
if(!c) return;
const cx = c.getContext('2d');
const w = c.width, h = c.height;
cx.clearRect(0, 0, w, h);

cx.beginPath();
cx.strokeStyle = '#FFD60A';
cx.lineWidth = 4;
for(let x=0; x<=w; x++) {
let y = Math.sin((x/w)*Math.PI) * (h/2 - 10);
cx.lineTo(x, h/2 - y);
}
cx.stroke();

const now = new Date();
const riseTime = new Date(rise);
const setTime = new Date(set);
const totalDur = setTime - riseTime;
const elapsed = now - riseTime;
const progress = Math.max(0, Math.min(1, elapsed / totalDur));

const xPos = progress * w;
const yPos = Math.sin(progress * Math.PI) * (h/2 - 10);

cx.beginPath();
cx.fillStyle = '#fff';
cx.shadowBlur = 10; cx.shadowColor = '#FFD60A';
cx.arc(xPos, h/2 - yPos, 6, 0, Math.PI*2);
cx.fill();
cx.shadowBlur = 0;
}, 100);
}

function openSunDetail(json) {
const d = JSON.parse(decodeURIComponent(json));
const modal = document.getElementById('sun-modal');
const content = document.getElementById('sun-details-content');

const rise = d.rise.split('T')[1];
const set = d.set.split('T')[1];
const durH = Math.floor(d.dur / 3600);
const durM = Math.round((d.dur % 3600) / 60);

content.innerHTML = `
<div style="text-align:center; padding: 20px 0;">
<span style="font-size:14px; opacity:0.7">–°–≤–µ—Ç–æ–≤–æ–π –¥–µ–Ω—å</span>
<div style="font-size:32px; font-weight:500">${durH} —á ${durM} –º–∏–Ω</div>
</div>

<div class="sun-detail-row">
<span>–ü–µ—Ä–≤—ã–µ –ª—É—á–∏</span>
<span>${parseInt(rise.split(':')[0])}:10</span>
</div>
<div class="sun-detail-row">
<span style="color:#FFD60A">–í–æ—Å—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è</span>
<span>${rise}</span>
</div>
<div class="sun-detail-row">
<span style="color:#FF9F0A">–ó–∞–∫–∞—Ç —Å–µ–≥–æ–¥–Ω—è</span>
<span>${set}</span>
</div>
<div class="sun-detail-row">
<span>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª—É—á–∏</span>
<span>${parseInt(set.split(':')[0])}:45</span>
</div>
`;

modal.classList.add('open');
}

// --- –£—Ç–∏–ª–∏—Ç—ã ---

function updatePagination() {
const p = document.getElementById('pagination');
if (cities.length < 2) { p.style.display = 'none'; return; }
p.style.display = 'flex';
p.innerHTML = cities.map((_, i) => `<div class="dot ${i===currentIndex?'active':''}"></div>`).join('');
}

function toggleSettings(open) {
const lay = document.getElementById('settings-layer');
lay.className = open ? 'show' : '';
if(open) renderFavList();
}

function renderFavList() {
const l = document.getElementById('fav-list');
l.innerHTML = cities.map((c, i) => `
<div class="list-item">
<div>
<div style="font-size:18px; font-weight:600">${c.name}</div>
<div style="font-size:12px; opacity:0.6">${c.country}</div>
</div>
${!c.isHome ? `<div class="btn-circle" style="width:30px; height:30px; background:rgba(255,69,58,0.2); border-color:transparent; color:#ff453a" onclick="removeCity(${i})">‚úï</div>` : '<span style="opacity:0.5; font-size:12px">–ì–µ–æ</span>'}
</div>
`).join('');
}

function removeCity(i) {
if(cities[i].isHome) return;
cities.splice(i, 1);
saveCities();
renderFavList();
loadWeather(0);
}

function toggleUnit(type) {
if (type === 'temp') {
unit = unit === 'C' ? 'F' : 'C';
localStorage.setItem('unit', unit);
document.getElementById('unit-disp').innerText = '¬∞' + unit;
} else if (type === 'wind') {
const options = ['kmh', 'ms', 'mph'];
const idx = options.indexOf(windUnit);
windUnit = options[(idx + 1) % options.length];
localStorage.setItem('windUnit', windUnit);
const labels = { kmh: '–∫–º/—á', ms: '–º/—Å', mph: '–º–∏–ª—å/—á' };
document.getElementById('wind-unit-disp').innerText = labels[windUnit];
}
loadWeather(currentIndex);
}

function getAIText(temp, wcode, wind, feels) {
// –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å —É—á–µ—Ç–æ–º –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤
if(wcode >= 95) return "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –ì—Ä–æ–∑–∞ —Å –≥—Ä–æ–∑–æ–≤—ã–º–∏ —Ä–∞–∑—Ä—è–¥–∞–º–∏. –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏, –∏–∑–±–µ–≥–∞–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤ –∏ –¥–µ—Ä–∂–∏—Ç–µ—Å—å –ø–æ–¥–∞–ª—å—à–µ –æ—Ç –æ–∫–æ–Ω –∏ —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–±–æ—Ä–æ–≤.";
if(wcode >= 85) return "‚ùÑÔ∏è –°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥–æ–ø–∞–¥. –í–∏–¥–∏–º–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞. –î–æ—Ä–æ–≥–∏ —Å–∫–æ–ª—å–∑–∫–∏–µ –∏ –æ–ø–∞—Å–Ω—ã–µ. –ï—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–π—Ç–∏, –æ–¥–µ–≤–∞–π—Ç–µ—Å—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–µ–ø–ª–æ: —Ç–µ—Ä–º–æ–±–µ–ª—å–µ, –ø—É—Ö–æ–≤–∏–∫, —à–∞–ø–∫–∞, —à–∞—Ä—Ñ –∏ –ø–µ—Ä—á–∞—Ç–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.";
if(wcode >= 71) return "üå®Ô∏è –ò–¥–µ—Ç —Å–Ω–µ–≥. –î–æ—Ä–æ–≥–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–∫–æ–ª—å–∑–∫–∏–º–∏, –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –ø—Ä–∏ –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ç–µ–ø–ª–∞—è –æ–¥–µ–∂–¥–∞: –ø—É—Ö–æ–≤–∏–∫, —à–∞–ø–∫–∞, —à–∞—Ä—Ñ –∏ –Ω–µ–ø—Ä–æ–º–æ–∫–∞–µ–º–∞—è –æ–±—É–≤—å.";
if(wcode >= 63) return "üåßÔ∏è –°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å. –í–æ–∑–º–æ–∂–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–æ–∑—å–º–∏—Ç–µ –∑–æ–Ω—Ç, –Ω–∞–¥–µ–Ω—å—Ç–µ –Ω–µ–ø—Ä–æ–º–æ–∫–∞–µ–º—É—é –∫—É—Ä—Ç–∫—É –∏ –≤–æ–¥–æ–Ω–µ–ø—Ä–æ–Ω–∏—Ü–∞–µ–º—É—é –æ–±—É–≤—å.";
if(wcode >= 51) return "‚òî –ò–¥–µ—Ç –¥–æ–∂–¥—å –∏–ª–∏ –º–æ—Ä–æ—Å—å. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–æ–Ω—Ç –∏ –Ω–µ–ø—Ä–æ–º–æ–∫–∞–µ–º—É—é –æ–±—É–≤—å. –î–æ—Ä–æ–≥–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–∫–æ–ª—å–∑–∫–∏–º–∏.";
if(wcode >= 45) return "üå´Ô∏è –¢—É–º–∞–Ω. –í–∏–¥–∏–º–æ—Å—Ç—å —Å–Ω–∏–∂–µ–Ω–∞. –ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã –Ω–∞ –¥–æ—Ä–æ–≥–µ, –≤–∫–ª—é—á–∏—Ç–µ —Ñ–∞—Ä—ã –∞–≤—Ç–æ–º–æ–±–∏–ª—è.";
if(wind > 50) return "üí® –û—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä! –ò–∑–±–µ–≥–∞–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤, –Ω–µ –ø–∞—Ä–∫—É–π—Ç–µ—Å—å –ø–æ–¥ –¥–µ—Ä–µ–≤—å—è–º–∏. –í–æ–∑–º–æ–∂–Ω—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.";
if(wind > 30) return "üå¨Ô∏è –°–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –Ω–∞ —É–ª–∏—Ü–µ, –∑–∞–∫—Ä–µ–ø–∏—Ç–µ –ª–µ–≥–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–µ—Ç—Ä–æ–∑–∞—â–∏—Ç–Ω–∞—è –æ–¥–µ–∂–¥–∞.";
if(temp < -20) return "ü•∂ –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π –º–æ—Ä–æ–∑! –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –≤—Ä–µ–º—è –Ω–∞ —É–ª–∏—Ü–µ. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: —Ç–µ—Ä–º–æ–±–µ–ª—å–µ, –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è –æ–¥–µ–∂–¥–∞, —Ç–µ–ø–ª—ã–π –ø—É—Ö–æ–≤–∏–∫, —à–∞–ø–∫–∞-—É—à–∞–Ω–∫–∞, —à–∞—Ä—Ñ, –ø–µ—Ä—á–∞—Ç–∫–∏ –∏–ª–∏ –≤–∞—Ä–µ–∂–∫–∏.";
if(temp < -10) return "‚ùÑÔ∏è –°–∏–ª—å–Ω—ã–π –º–æ—Ä–æ–∑. –û–¥–µ–Ω—å—Ç–µ—Å—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–µ–ø–ª–æ: —Ç–µ—Ä–º–æ–±–µ–ª—å–µ, –ø—É—Ö–æ–≤–∏–∫, —à–∞–ø–∫–∞, —à–∞—Ä—Ñ –∏ —Ç–µ–ø–ª—ã–µ –ø–µ—Ä—á–∞—Ç–∫–∏. –ó–∞—â–∏—Ç–∏—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —É—á–∞—Å—Ç–∫–∏ –∫–æ–∂–∏.";
if(temp < 0) return "üßä –ú–æ—Ä–æ–∑ –Ω–∞ —É–ª–∏—Ü–µ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ç–µ–ø–ª–∞—è –∑–∏–º–Ω—è—è –æ–¥–µ–∂–¥–∞: –ø—É—Ö–æ–≤–∏–∫ –∏–ª–∏ —Ç–µ–ø–ª–∞—è –∫—É—Ä—Ç–∫–∞, —à–∞–ø–∫–∞, —à–∞—Ä—Ñ –∏ –ø–µ—Ä—á–∞—Ç–∫–∏.";
if(temp > 35) return "üî• –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è –∂–∞—Ä–∞! –ò–∑–±–µ–≥–∞–π—Ç–µ –ø—Ä—è–º—ã—Ö —Å–æ–ª–Ω–µ—á–Ω—ã—Ö –ª—É—á–µ–π, –æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –≤ —Ç–µ–Ω–∏ –∏–ª–∏ –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏ —Å –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–æ–º. –ü–µ–π—Ç–µ –º–Ω–æ–≥–æ –≤–æ–¥—ã (–º–∏–Ω–∏–º—É–º 2-3 –ª–∏—Ç—Ä–∞), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–Ω—ã–π –∫—Ä–µ–º SPF 50+, –Ω–æ—Å–∏—Ç–µ –≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä –∏ –ª–µ–≥–∫—É—é —Å–≤–µ—Ç–ª—É—é –æ–¥–µ–∂–¥—É.";
if(temp > 30) return "‚òÄÔ∏è –û—á–µ–Ω—å –∂–∞—Ä–∫–æ! –ü–µ–π—Ç–µ –º–Ω–æ–≥–æ –≤–æ–¥—ã (–Ω–µ –º–µ–Ω–µ–µ 2 –ª–∏—Ç—Ä–æ–≤), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–Ω—ã–π –∫—Ä–µ–º SPF 30+, –Ω–æ—Å–∏—Ç–µ –≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä –∏ —Å–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–Ω—ã–µ –æ—á–∫–∏. –ò–∑–±–µ–≥–∞–π—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ –≤ –ø–æ–ª–¥–µ–Ω—å.";
if(temp > 25) return "üå§Ô∏è –¢–µ–ø–ª–æ –∏ —Å–æ–ª–Ω–µ—á–Ω–æ. –û—Ç–ª–∏—á–Ω–∞—è –ø–æ–≥–æ–¥–∞ –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫! –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–Ω—ã–π –∫—Ä–µ–º –∏ –≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –ø—Ä–µ–±—ã–≤–∞–Ω–∏–∏ –Ω–∞ —Å–æ–ª–Ω—Ü–µ.";
if(feels < temp - 5) return "üå¨Ô∏è –ò–∑-–∑–∞ –≤–µ—Ç—Ä–∞ –æ—â—É—â–∞–µ—Ç—Å—è —Ö–æ–ª–æ–¥–Ω–µ–µ, —á–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ—Ä–º–æ–º–µ—Ç—Ä. –û–¥–µ–Ω—å—Ç–µ—Å—å —Ç–µ–ø–ª–µ–µ –∏ –∑–∞—â–∏—Ç–∏—Ç–µ –ª–∏—Ü–æ –æ—Ç –≤–µ—Ç—Ä–∞.";
if(feels > temp + 5) return "üí¶ –ò–∑-–∑–∞ –≤—ã—Å–æ–∫–æ–π –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –æ—â—É—â–∞–µ—Ç—Å—è –∂–∞—Ä—á–µ. –ü–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã –∏ –∏–∑–±–µ–≥–∞–π—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫.";
return "‚úÖ –ü–æ–≥–æ–¥–∞ —Å–ø–æ–∫–æ–π–Ω–∞—è –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è. –û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏, –∑–∞–Ω—è—Ç–∏–π —Å–ø–æ—Ä—Ç–æ–º –∏–ª–∏ –¥–µ–ª –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ!";
}

function getWDesc(c) {
const m = {
0:'–Ø—Å–Ω–æ', 1:'–ú–∞–ª–æ–æ–±–ª–∞—á–Ω–æ', 2:'–û–±–ª–∞—á–Ω–æ', 3:'–ü–∞—Å–º—É—Ä–Ω–æ',
45:'–¢—É–º–∞–Ω', 48:'–ò–∑–º–æ—Ä–æ–∑—å',
51:'–õ–µ–≥–∫–∞—è –º–æ—Ä–æ—Å—å', 53:'–ú–æ—Ä–æ—Å—å', 55:'–°–∏–ª—å–Ω–∞—è –º–æ—Ä–æ—Å—å',
61:'–ù–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å', 63:'–î–æ–∂–¥—å', 65:'–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å',
71:'–ù–µ–±–æ–ª—å—à–æ–π —Å–Ω–µ–≥', 73:'–°–Ω–µ–≥', 75:'–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥',
77:'–°–Ω–µ–∂–Ω–∞—è –∫—Ä—É–ø–∞', 80:'–õ–∏–≤–µ–Ω—å', 81:'–°–∏–ª—å–Ω—ã–π –ª–∏–≤–µ–Ω—å',
85:'–°–Ω–µ–≥–æ–ø–∞–¥', 86:'–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥–æ–ø–∞–¥',
95:'–ì—Ä–æ–∑–∞', 96:'–ì—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º', 99:'–°–∏–ª—å–Ω–∞—è –≥—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º'
};
return m[c] || '–û—Å–∞–¥–∫–∏';
}

function getWIcon(c) {
if(c===0) return '‚òÄÔ∏è';
if(c<=3) return '‚õÖ';
if(c<=48) return 'üå´Ô∏è';
if(c<=55) return 'üå¶Ô∏è';
if(c<=67) return 'üåßÔ∏è';
if(c<=77) return '‚ùÑÔ∏è';
if(c<=86) return 'üå®Ô∏è';
if(c>=95) return '‚õàÔ∏è';
return 'üåßÔ∏è';
}

function getWindDir(deg) {
const dirs = ['–°', '–°–í', '–í', '–Æ–í', '–Æ', '–Æ–ó', '–ó', '–°–ó'];
return dirs[Math.round(deg / 45) % 8];
}

// --- –ê–Ω–∏–º–∞—Ü–∏—è (Canvas) ---
function startAnimLoop() {
const count = 100;
for(let i=0; i<count; i++) {
env.stars.push({
x: Math.random() * canvas.width,
y: Math.random() * canvas.height,
s: Math.random() * 2,
a: Math.random()
});
}
for(let i=0; i<50; i++) {
env.rain.push({
x: Math.random() * canvas.width,
y: Math.random() * canvas.height,
speed: 5 + Math.random() * 5
});
}
for(let i=0; i<50; i++) {
env.snow.push({
x: Math.random() * canvas.width,
y: Math.random() * canvas.height,
speed: 1 + Math.random() * 2,
drift: Math.random() * 2 - 1
});
}
loop();
}

function loop() {
ctx.clearRect(0, 0, canvas.width, canvas.height);

// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–≥–æ–¥—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
if (env.isDay === 1) {
if (env.wCode === 0) {
grad.addColorStop(0, '#87CEEB');
grad.addColorStop(1, '#E0F6FF');
} else if (env.wCode >= 95) {
grad.addColorStop(0, '#2C3E50');
grad.addColorStop(1, '#4A5568');
} else if (env.wCode >= 51) {
grad.addColorStop(0, '#607D8B');
grad.addColorStop(1, '#90A4AE');
} else {
grad.addColorStop(0, '#5DADE2');
grad.addColorStop(1, '#AED6F1');
}
} else {
if (env.wCode >= 95) {
grad.addColorStop(0, '#1A1A2E');
grad.addColorStop(1, '#16213E');
} else {
grad.addColorStop(0, '#0f2027');
grad.addColorStop(1, '#2c5364');
}
}
ctx.fillStyle = grad;
ctx.fillRect(0, 0, canvas.width, canvas.height);

// –ó–≤–µ–∑–¥—ã (—Ç–æ–ª—å–∫–æ –Ω–æ—á—å—é)
if (env.isDay === 0) {
ctx.fillStyle = '#fff';
env.stars.forEach(s => {
s.a += (Math.random() - 0.5) * 0.05;
if(s.a < 0) s.a = 0;
if(s.a > 1) s.a = 1;
ctx.globalAlpha = s.a;
ctx.beginPath();
ctx.arc(s.x, s.y, s.s, 0, Math.PI * 2);
ctx.fill();
});
ctx.globalAlpha = 1;
}

// –î–æ–∂–¥—å
if (env.wCode >= 51 && env.wCode < 71) {
ctx.strokeStyle = 'rgba(174, 214, 241, 0.6)';
ctx.lineWidth = 2;
env.rain.forEach(r => {
ctx.beginPath();
ctx.moveTo(r.x, r.y);
ctx.lineTo(r.x, r.y + 10);
ctx.stroke();
r.y += r.speed;
if (r.y > canvas.height) {
r.y = 0;
r.x = Math.random() * canvas.width;
}
});
}

// –°–Ω–µ–≥
if (env.wCode >= 71 && env.wCode < 80) {
ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
env.snow.forEach(s => {
ctx.beginPath();
ctx.arc(s.x, s.y, 3, 0, Math.PI * 2);
ctx.fill();
s.y += s.speed;
s.x += s.drift;
if (s.y > canvas.height) {
s.y = 0;
s.x = Math.random() * canvas.width;
}
if (s.x < 0) s.x = canvas.width;
if (s.x > canvas.width) s.x = 0;
});
}

// –ú–æ–ª–Ω–∏–∏ (–≥—Ä–æ–∑–∞)
if (env.wCode >= 95 && Math.random() < 0.01) {
ctx.strokeStyle = '#FFD700';
ctx.lineWidth = 3;
ctx.beginPath();
const startX = Math.random() * canvas.width;
let x = startX, y = 0;
ctx.moveTo(x, y);
while (y < canvas.height) {
x += (Math.random() - 0.5) * 50;
y += Math.random() * 50 + 20;
ctx.lineTo(x, y);
}
ctx.stroke();
}

requestAnimationFrame(loop);
}

function updateEnv(data) {
env.wCode = data.current.weather_code;
env.isDay = data.current.is_day;
// –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å–æ–ª–Ω—Ü–∞
const canvasId = `sun-${currentIndex}`;
drawSunGraph(canvasId, data.daily.sunrise[0], data.daily.sunset[0]);
}

function resize() {
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
}

// –ó–∞–ø—É—Å–∫
init();

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather iOS Masterpiece</title>
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.1); 
            --blur: blur(45px); 
            --spring: cubic-bezier(0.25, 1, 0.35, 1);
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        
        canvas#bg { position: fixed; inset: 0; z-index: -1; transition: filter 1s; }

        /* Header & Search */
        header { padding: 15px; max-width: 600px; margin: 0 auto; display: flex; gap: 10px; position: relative; z-index: 2000; }
        .search-box { flex: 1; display: flex; align-items: center; background: var(--glass); backdrop-filter: var(--blur); border-radius: 20px; padding: 10px 15px; border: 0.5px solid rgba(255,255,255,0.2); gap: 10px; }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; }
        .icon-btn { background: var(--glass); border: 0.5px solid rgba(255,255,255,0.2); border-radius: 15px; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: var(--blur); transition: transform 0.2s; }
        .icon-btn:active { transform: scale(0.9); }

        /* Main Scroll Area with iOS Animation */
        #stage { height: 100vh; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; }
        .app-container { 
            padding: 20px 20px 150px; 
            max-width: 600px; 
            margin: 0 auto; 
            transition: transform 0.6s var(--spring), opacity 0.5s; 
        }

        .now-section { text-align: center; margin-bottom: 40px; margin-top: 40px; }
        .temp-big { font-size: 115px; font-weight: 100; letter-spacing: -6px; margin: 5px 0; }

        /* Cards */
        .card { background: var(--glass); backdrop-filter: var(--blur); border-radius: 28px; padding: 20px; border: 0.5px solid rgba(255,255,255,0.15); margin-bottom: 20px; }
        .card-label { font-size: 11px; opacity: 0.5; text-transform: uppercase; font-weight: 700; margin-bottom: 12px; letter-spacing: 0.5px; }

        /* Hourly with Sunrise/Sunset */
        .hourly-scroll { display: flex; gap: 20px; overflow-x: auto; scrollbar-width: none; align-items: flex-end; }
        .h-item { text-align: center; min-width: 50px; display: flex; flex-direction: column; gap: 8px; font-size: 15px; }
        .h-sun { color: #ffcc00; font-weight: 600; min-width: 70px; }

        /* Daily Row */
        .day-row { display: grid; grid-template-columns: 85px 1fr 105px; align-items: center; padding: 14px 0; border-bottom: 0.5px solid rgba(255,255,255,0.08); }
        .day-row:last-child { border: none; }

        /* Pagination & Nav */
        .pagination-bar { position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); padding: 10px 18px; border-radius: 25px; display: flex; align-items: center; gap: 12px; z-index: 3000; border: 0.5px solid rgba(255,255,255,0.1); }
        .dot { width: 7px; height: 7px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.4s var(--spring); }
        .dot.active { background: #fff; transform: scale(1.3); }
        .dot-loc { width: 14px; height: 14px; fill: rgba(255,255,255,0.3); }
        .dot-loc.active { fill: #fff; }

        /* Transitions */
        .slide-left { transform: translateX(-100%) scale(0.9); opacity: 0; }
        .slide-right { transform: translateX(100%) scale(0.9); opacity: 0; }
    </style>
</head>
<body>

<canvas id="bg"></canvas>

<header>
    <div class="search-box">
        <span>üîç</span>
        <input id="q" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." oninput="handleSearch(this.value)" />
    </div>
    <div class="icon-btn" onclick="alert('–ï–¥–∏–Ω–∏—Ü—ã: ¬∞C')">‚öôÔ∏è</div>
</header>

<div id="stage" ontouchstart="handleTS(event)" ontouchend="handleTE(event)">
    <div class="app-container" id="app">
        <div class="now-section">
            <div id="city" style="font-size:34px; font-weight:500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="temp-big" id="mainTemp">--</div>
            <div id="mainDesc" style="font-size:22px; opacity:0.8">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è GPS...</div>
        </div>

        <div class="card">
            <div class="card-label">–ü–æ—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –∏ —Å–æ–ª–Ω—Ü–µ</div>
            <div class="hourly-scroll" id="hourly"></div>
        </div>

        <div class="card">
            <div class="card-label">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—è</div>
            <div id="daily"></div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
            <div class="card"><div class="card-label">–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫</div><div id="feel" style="font-size:28px">--</div></div>
            <div class="card"><div class="card-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div><div id="hum" style="font-size:28px">--</div></div>
        </div>

        <div class="card" style="background:rgba(255,255,255,0.05)">
            <div class="card-label">ü§ñ AI –°–û–í–ï–¢</div>
            <div id="ai" style="line-height:1.5">...</div>
        </div>
    </div>
</div>

<div class="pagination-bar" id="pag"></div>

<script>
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let pages = [], curIdx = 0, startX = 0;
    let isDay = true, t = 0, weatherCode = 0;

    async function init() {
        resize();
        navigator.geolocation.getCurrentPosition(
            p => fetchMain(p.coords.latitude, p.coords.longitude, '–ú–æ—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏—è'),
            () => fetchMain(55.75, 37.62, '–ú–æ—Å–∫–≤–∞')
        );
        animate();
    }

    async function fetchMain(lat, lon, name) {
        pages = [{lat, lon, name, isHome: true}];
        const favs = JSON.parse(localStorage.getItem('favs') || '[]');
        pages.push(...favs);
        updatePag();
        loadWeather(0);
    }

    async function loadWeather(idx, direction = '') {
        const app = document.getElementById('app');
        if(direction) app.className = 'app-container ' + (direction === 'next' ? 'slide-left' : 'slide-right');
        
        setTimeout(async () => {
            curIdx = idx;
            const city = pages[idx];
            const data = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,is_day&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`).then(r=>r.json());
            
            isDay = !!data.current.is_day;
            t = data.current.temperature_2m;
            weatherCode = data.current.weather_code;

            document.getElementById('city').innerText = city.name;
            document.getElementById('mainTemp').innerText = Math.round(t) + '¬∞';
            document.getElementById('feel').innerText = Math.round(data.current.apparent_temperature) + '¬∞';
            document.getElementById('hum').innerText = data.current.relative_humidity_2m + '%';
            document.getElementById('mainDesc').innerText = weatherCode < 3 ? '–Ø—Å–Ω–æ' : '–ü–∞—Å–º—É—Ä–Ω–æ';

            // –ü–æ—á–∞—Å–æ–≤–∞—è —Å –≤–æ—Å—Ö–æ–¥–æ–º/–∑–∞–∫–∞—Ç–æ–º
            const hourlyUI = [];
            const suns = [
                {t: new Date(data.daily.sunrise[0]), type: '–í–æ—Å—Ö–æ–¥', icon: 'üåÖ'},
                {t: new Date(data.daily.sunset[0]), type: '–ó–∞–∫–∞—Ç', icon: 'üåá'}
            ];

            for(let i=0; i<24; i++) {
                const hourTime = new Date(data.hourly.time[i]);
                suns.forEach(s => {
                    if(s.t.getHours() === hourTime.getHours() && !s.done) {
                        hourlyUI.push(`<div class="h-item h-sun"><span>${s.t.getHours()}:${s.t.getMinutes()}</span><span>${s.icon}</span><span>${s.type}</span></div>`);
                        s.done = true;
                    }
                });
                hourlyUI.push(`<div class="h-item"><span>${hourTime.getHours()}:00</span><span>${data.hourly.weather_code[i] < 3 ? '‚òÄÔ∏è' : '‚òÅÔ∏è'}</span><span>${Math.round(data.hourly.temperature_2m[i])}¬∞</span></div>`);
            }
            document.getElementById('hourly').innerHTML = hourlyUI.join('');

            // AI –°–æ–≤–µ—Ç
            document.getElementById('ai').innerText = t < -30 ? "–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π —Ö–æ–ª–æ–¥! –í–∫–ª—é—á–µ–Ω–æ —Å–µ–≤–µ—Ä–Ω–æ–µ —Å–∏—è–Ω–∏–µ. üåå" : "–û–¥–µ–Ω—å—Ç–µ—Å—å –ø–æ –ø–æ–≥–æ–¥–µ, —Ö–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!";

            app.className = 'app-container';
            updatePag();
        }, direction ? 300 : 0);
    }

    // --- –ì—Ä–∞—Ñ–∏–∫–∞ –∏ –ê–Ω–∏–º–∞—Ü–∏–∏ ---
    let blobs = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    
    function animate() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        
        // –ñ–∏–¥–∫–∏–π —Ñ–æ–Ω (iOS Fluid)
        const colors = isDay ? ['#007AFF', '#00C6FF', '#74ebd5'] : (t < -30 ? ['#0F0C29', '#00F260', '#0575E6'] : ['#0F0C29', '#302B63', '#24243E']);
        if(blobs.length === 0) {
            for(let i=0; i<4; i++) blobs.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:canvas.width, c:colors[i%3], vx:Math.random()-0.5, vy:Math.random()-0.5});
        }

        blobs.forEach((b, i) => {
            b.x += b.vx; b.y += b.vy;
            if(b.x<0 || b.x>canvas.width) b.vx*=-1; if(b.y<0 || b.y>canvas.height) b.vy*=-1;
            let g = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r);
            g.addColorStop(0, b.c); g.addColorStop(1, 'transparent');
            ctx.globalCompositeOperation = 'screen';
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
        });

        // –°–æ–ª–Ω—Ü–µ / –ó–≤–µ–∑–¥—ã
        if(isDay) {
            const time = Date.now()*0.001;
            ctx.save(); ctx.translate(canvas.width*0.8, 150); ctx.rotate(time*0.1);
            for(let i=0; i<8; i++) {
                ctx.rotate(Math.PI/4);
                let rg = ctx.createLinearGradient(0,0,0,500);
                rg.addColorStop(0, 'rgba(255,255,255,0.1)'); rg.addColorStop(1, 'transparent');
                ctx.fillStyle = rg; ctx.beginPath(); ctx.moveTo(-30,0); ctx.lineTo(30,0); ctx.lineTo(0,800); ctx.fill();
            }
            ctx.restore();
        }

        requestAnimationFrame(animate);
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    function handleTS(e) { startX = e.touches[0].clientX; }
    function handleTE(e) {
        const diff = startX - e.changedTouches[0].clientX;
        if(Math.abs(diff) > 100) {
            if(diff > 0 && curIdx < pages.length-1) loadWeather(curIdx+1, 'next');
            else if(diff < 0 && curIdx > 0) loadWeather(curIdx-1, 'prev');
        }
    }

    function updatePag() {
        document.getElementById('pag').innerHTML = pages.map((p, i) => {
            if(p.isHome) return `<svg class="dot-loc ${curIdx===i?'active':''}" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>`;
            return `<div class="dot ${curIdx===i?'active':''}"></div>`;
        }).join('');
    }

    window.onresize = resize;
    init();
</script>
</body>
</html>

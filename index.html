<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather iOS Ultimate AI</title>
    <style>
        :root { 
            --glass: rgba(30, 30, 30, 0.65); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --blur: blur(40px); 
            --spring: cubic-bezier(0.25, 0.8, 0.25, 1);
            --accent: #4cd964;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        
        /* –§–æ–Ω-–∞–Ω–∏–º–∞—Ü–∏—è (–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω) */
        canvas#bg { position: fixed; inset: 0; z-index: -1; }

        /* –û–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ü–ö */
        .content-wrapper {
            max-width: 500px;
            margin: 0 auto;
            height: 100vh;
            position: relative;
        }

        /* –ü–æ–∏—Å–∫ */
        header { 
            padding: 40px 20px 10px; position: absolute; top: 0; left: 0; right: 0; z-index: 1000; 
            display: flex; gap: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); 
            pointer-events: none; 
        }
        .search-wrapper { flex: 1; pointer-events: auto; position: relative; }
        .search-box { display: flex; align-items: center; background: rgba(40,40,40,0.7); backdrop-filter: var(--blur); border-radius: 14px; padding: 8px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid var(--glass-border); }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 17px; outline: none; margin-left: 8px; }
        
        #results { position: absolute; top: 50px; left: 0; right: 0; background: rgba(30,30,30,0.95); border-radius: 14px; overflow: hidden; display: none; z-index: 2500; border: 1px solid var(--glass-border); backdrop-filter: blur(50px); max-height: 300px; overflow-y: auto; }
        .res-item { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        
        /* –°—Ü–µ–Ω–∞ */
        #stage { height: 100%; width: 100%; position: relative; overflow: hidden; }
        .page-container {
            position: absolute; inset: 0; padding: 110px 20px 140px;
            transition: opacity 0.4s ease; overflow-y: auto; scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; display: none; opacity: 0;
            /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
            scrollbar-width: none; 
        }
        .page-container::-webkit-scrollbar { display: none; }
        .page-container.active { display: block; opacity: 1; z-index: 5; }

        /* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
        .city-header { text-align: center; margin-bottom: 30px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .city-name { font-size: 32px; font-weight: 600; }
        .temp-big { font-size: 90px; font-weight: 200; letter-spacing: -2px; line-height: 1.1; }
        .condition-text { font-size: 18px; font-weight: 500; opacity: 0.9; text-transform: capitalize; }
        .hl-temp { font-size: 18px; font-weight: 500; margin-top: 5px; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { 
            background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border-radius: 20px; padding: 15px; border: 1px solid var(--glass-border); margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .card-label { font-size: 13px; opacity: 0.6; text-transform: uppercase; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        .h-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-item { text-align: center; min-width: 60px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .wind-sm { font-size: 11px; opacity: 0.7; display: flex; align-items: center; gap: 2px; margin-top: 2px; }

        .day-row { display: grid; grid-template-columns: 1.5fr 0.5fr 1fr 1fr; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 16px; font-weight: 500; }
        .day-row:last-child { border: none; }
        .day-date { display: flex; flex-direction: column; }
        .day-sub { font-size: 12px; opacity: 0.5; font-weight: 400; }
        .temp-range { display: flex; gap: 8px; justify-content: flex-end; }
        .temp-night { opacity: 0.5; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .tile { aspect-ratio: 1; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: transform 0.2s; }
        .tile:active { transform: scale(0.97); }
        .tile-val { font-size: 24px; font-weight: 500; margin-top: 5px; }
        .tile-sub { font-size: 13px; opacity: 0.7; }

        /* --- AI GRAPH UPGRADE --- */
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .vote-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; transition: opacity 0.5s; }
        .vote-btn { 
            background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 5px; 
            text-align: center; font-size: 12px; cursor: pointer; border: 1px solid transparent;
            transition: 0.3s var(--spring);
        }
        .vote-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .vote-btn.disabled { opacity: 0.3; pointer-events: none; } /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è */

        #ai-thank-you { font-size: 16px; color: #4cd964; text-align: center; margin-bottom: 10px; display: none; }

        .ai-chart-wrapper { display: flex; height: 120px; margin-top: 15px; position: relative; }
        .y-axis { 
            width: 30px; display: flex; flex-direction: column; justify-content: space-between; 
            font-size: 10px; opacity: 0.5; text-align: right; padding-right: 5px; padding-bottom: 20px;
        }
        .graph-area { flex: 1; position: relative; }
        
        /* SVG –∏ –¢–æ—á–∫–∏ */
        svg.ai-svg { width: 100%; height: 100%; overflow: visible; }
        path.graph-line { fill: none; stroke: var(--accent); stroke-width: 2.5; stroke-linecap: round; transition: d 0.5s ease; }
        path.graph-fill { fill: rgba(76, 217, 100, 0.15); stroke: none; transition: d 0.5s ease; }
        
        .graph-dot { 
            r: 4; fill: #000; stroke: var(--accent); stroke-width: 2; cursor: pointer; transition: cy 0.5s ease; 
        }
        .graph-dot:hover { r: 6; stroke-width: 3; }
        
        /* –¢—É–ª—Ç–∏–ø */
        .chart-tooltip {
            position: absolute; background: rgba(255,255,255,0.9); color: #000;
            padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
            transform: translate(-50%, -100%); margin-top: -10px; white-space: nowrap; z-index: 10;
        }

        /* --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –°–ª–æ–∏ --- */
        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.7); backdrop-filter: blur(20px); padding: 8px 16px; border-radius: 20px; display: flex; gap: 8px; z-index: 2000; border: 1px solid rgba(255,255,255,0.1); }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; cursor: pointer; }
        .dot.active { background: #fff; transform: scale(1.2); }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; background: rgba(60,60,60,0.6); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; pointer-events: auto; }

        /* –°—Ç—Ä–µ–ª–∫–∏ –¥–ª—è –ü–ö */
        .desktop-arrow {
            position: fixed; top: 50%; transform: translateY(-50%);
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            display: none; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; z-index: 1500;
            transition: 0.3s;
        }
        .desktop-arrow:hover { background: rgba(255,255,255,0.25); }
        .arrow-left { left: 20px; }
        .arrow-right { right: 20px; }
        @media (min-width: 768px) { .desktop-arrow { display: flex; } }

        /* –°–ª–æ–∏ (Settings, Preview, Modal) */
        .layer { 
            position: fixed; inset: 0; background: #000; z-index: 3000; 
            transform: translateX(100%); transition: transform 0.4s var(--spring); 
            display: flex; flex-direction: column;
        }
        .layer.show { transform: translateX(0); }
        .layer.modal { background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); transform: translateY(100%); }
        .layer.modal.show { transform: translateY(0); }

        .layer-header { padding: 50px 20px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .layer-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* AI Text */
        .ai-box { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 15px; margin-top: 20px; }
        .ai-title { font-size: 14px; font-weight: 700; color: #FFD60A; margin-bottom: 8px; }
        .ai-text { font-size: 15px; line-height: 1.4; opacity: 0.9; }

        /* Settings List */
        .list-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    </style>
</head>
<body>

    <canvas id="bg"></canvas>

    <div class="content-wrapper">
        <header id="main-header">
            <div class="btn-circle" onclick="toggleSettings(true)" style="margin-right: 10px;">‚ò∞</div>
            <div class="search-wrapper">
                <div class="search-box">
                    <span style="opacity:0.6">üîç</span>
                    <input id="q" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..." oninput="doSearch(this.value)">
                </div>
                <div id="results"></div>
            </div>
        </header>

        <div id="stage"></div>
        <div class="nav-dock" id="pagination"></div>
    </div>

    <!-- –°—Ç—Ä–µ–ª–∫–∏ –ü–ö -->
    <div class="desktop-arrow arrow-left" onclick="movePage(-1)">‚Äπ</div>
    <div class="desktop-arrow arrow-right" onclick="movePage(1)">‚Ä∫</div>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div id="settings-layer" class="layer">
        <div class="layer-header">
            <h1 style="margin:0; font-size:28px;">–ú–æ–∏ –≥–æ—Ä–æ–¥–∞</h1>
            <div class="btn-circle" onclick="toggleSettings(false)">‚úï</div>
        </div>
        <div class="layer-content">
            <div id="fav-list"></div>
            <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                <h3 style="opacity:0.5">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <div class="list-item" onclick="toggleUnit()">
                    <span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span>
                    <span id="unit-disp" style="color:#0a84ff">¬∞C</span>
                </div>
                <div class="list-item" onclick="toggleWindUnit()">
                    <span>–í–µ—Ç–µ—Ä</span>
                    <span id="wind-disp" style="color:#0a84ff">–∫–º/—á</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–†–ï–î–ü–†–û–°–ú–û–¢–† -->
    <div id="preview-layer" class="layer" style="background:rgba(20,20,20,0.95); backdrop-filter:blur(50px);">
        <div class="layer-header">
            <div class="btn-circle" onclick="closePreview()">‚úï</div>
            <span style="font-weight:600">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
            <div style="width:40px"></div>
        </div>
        <div class="layer-content" id="preview-inner"></div>
        <div style="padding:20px; text-align:center;">
            <button onclick="confirmAddCity()" style="background:#fff; color:#000; padding:14px 40px; border-radius:30px; border:none; font-weight:600; font-size:16px; cursor:pointer">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –°–û–õ–ù–¶–ê -->
    <div id="sun-modal" class="layer modal">
        <div class="layer-header" style="padding-top:20px">
            <span style="font-size:18px; font-weight:600">–°–æ–ª–Ω—Ü–µ –∏ –õ—É–Ω–∞</span>
            <div class="btn-circle" onclick="document.getElementById('sun-modal').classList.remove('show')">‚úï</div>
        </div>
        <div class="layer-content" id="sun-modal-content"></div>
    </div>

<script>
    // --- State ---
    let cities = []; 
    let currentIndex = 0;
    let unit = localStorage.getItem('unit') || 'C';
    let windUnit = localStorage.getItem('windUnit') || 'kmh'; // kmh, ms, mph
    let tempCity = null;
    let userGeo = null; // {lat, lon}

    // --- Init ---
    async function init() {
        resize(); window.addEventListener('resize', resize);
        
        // –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ
        navigator.geolocation.getCurrentPosition(pos => {
            userGeo = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        }, err => console.log('Geo error'));

        const saved = JSON.parse(localStorage.getItem('savedCities') || '[]');
        if (saved.length > 0) cities = saved;
        else cities = [{lat: 55.75, lon: 37.62, name: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è', isHome: true}];

        initStageDOM();
        loadWeather(0);
        updateSettingsUI();
        
        initParticles();
        requestAnimationFrame(loop);
    }

    function initStageDOM() {
        const stage = document.getElementById('stage');
        stage.innerHTML = '';
        cities.forEach((c, i) => {
            const div = document.createElement('div');
            div.className = 'page-container';
            div.id = `page-${i}`;
            stage.appendChild(div);
        });
        updatePagination();
    }

    // --- Navigation & Actions ---
    function movePage(dir) {
        let next = currentIndex + dir;
        if(next >= 0 && next < cities.length) loadWeather(next);
    }
    
    function toggleSettings(v) { 
        document.getElementById('settings-layer').className = v ? 'layer show' : 'layer'; 
        if(v) renderFav(); 
    }

    async function doSearch(q) {
        if(q.length < 2) { document.getElementById('results').style.display='none'; return; }
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=ru`).then(x=>x.json());
        if(!r.results) return;
        const resBox = document.getElementById('results');
        resBox.innerHTML = r.results.map(i => `
            <div class="res-item" onclick="openPreview(${i.latitude}, ${i.longitude}, '${i.name}', '${i.country||''}')">
                <div class="res-main">${i.name}</div>
                <div class="res-sub">${i.country}</div>
            </div>
        `).join('');
        resBox.style.display = 'block';
    }

    async function fetchWeather(lat, lon) {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day,wind_speed_10m,wind_direction_10m,pressure_msl&hourly=temperature_2m,weather_code,wind_speed_10m,wind_direction_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,daylight_duration&timezone=auto`;
        return await fetch(url).then(r=>r.json());
    }

    // --- Preview & Management ---
    async function openPreview(lat, lon, name, country) {
        document.getElementById('results').style.display = 'none';
        document.getElementById('q').value = '';
        const layer = document.getElementById('preview-layer');
        const content = document.getElementById('preview-inner');
        
        content.innerHTML = '<div style="text-align:center; padding-top:50px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        layer.classList.add('show');
        tempCity = {lat, lon, name, country};
        const data = await fetchWeather(lat, lon);
        content.innerHTML = generateHTML(data, tempCity, true);
        updateEnv(data); // Show preview weather background
    }

    function closePreview() {
        document.getElementById('preview-layer').classList.remove('show');
        tempCity = null;
        loadWeather(currentIndex); // Restore current city bg
    }

    function confirmAddCity() {
        if(!tempCity) return;
        cities.push(tempCity);
        localStorage.setItem('savedCities', JSON.stringify(cities));
        initStageDOM();
        closePreview();
        loadWeather(cities.length-1);
    }

    function removeCity(i) {
        cities.splice(i,1);
        localStorage.setItem('savedCities', JSON.stringify(cities));
        renderFav();
        initStageDOM();
        let next = Math.min(i, cities.length-1);
        if(cities.length === 0) next = 0; // Should not happen with home city logic but safe
        loadWeather(next);
    }

    // --- Rendering ---
    async function loadWeather(idx) {
        currentIndex = idx;
        const city = cities[idx];
        const el = document.getElementById(`page-${idx}`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã —Å—Ç—Ä–∞–Ω–∏—Ü
        document.querySelectorAll('.page-container').forEach((p, i) => {
            p.classList.remove('active');
            if(i === idx) p.classList.add('active');
        });
        updatePagination();

        if(el.innerHTML.length < 50 || el.dataset.unit !== unit || el.dataset.wunit !== windUnit) {
            el.innerHTML = '<div style="text-align:center; padding-top:100px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            const data = await fetchWeather(city.lat, city.lon);
            el.dataset.unit = unit;
            el.dataset.wunit = windUnit;
            el.innerHTML = generateHTML(data, city, false);
            if(idx === currentIndex) updateEnv(data);
        } else {
             // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–º —Ñ–æ–Ω
             // (–í –∏–¥–µ–∞–ª–µ –Ω–∞–¥–æ —Ö—Ä–∞–Ω–∏—Ç—å data –≤ –ø–∞–º—è—Ç–∏, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–∏–º –µ—â–µ —Ä–∞–∑ –¥–ª—è —Ñ–æ–Ω–∞)
             const data = await fetchWeather(city.lat, city.lon); 
             if(idx === currentIndex) updateEnv(data);
        }
    }

    function generateHTML(data, city, isPreview) {
        const cur = data.current;
        const d = data.daily;
        const h = data.hourly;
        
        // Conversions
        const temp = unit==='F' ? Math.round(cur.temperature_2m*9/5+32) : Math.round(cur.temperature_2m);
        const min = unit==='F' ? Math.round(d.temperature_2m_min[0]*9/5+32) : Math.round(d.temperature_2m_min[0]);
        const max = unit==='F' ? Math.round(d.temperature_2m_max[0]*9/5+32) : Math.round(d.temperature_2m_max[0]);
        
        let ws = cur.wind_speed_10m;
        let wLabel = '–∫–º/—á';
        if(windUnit === 'ms') { ws /= 3.6; wLabel='–º/—Å'; }
        else if(windUnit === 'mph') { ws /= 1.609; wLabel='–º–∏–ª—å/—á'; }
        ws = Math.round(ws);

        // Hourly
        const nowStr = cur.time.substring(0, 13);
        let startIdx = h.time.findIndex(t => t.startsWith(nowStr));
        if(startIdx === -1) startIdx = 0;
        
        let hourlyHTML = '';
        for(let i=0; i<12; i++) {
            const idx = startIdx + i;
            if(idx >= h.time.length) break;
            const hour = h.time[idx].split('T')[1].split(':')[0];
            const dispT = i===0 ? '–°–µ–π—á–∞—Å' : hour;
            const hTemp = unit==='F' ? Math.round(h.temperature_2m[idx]*9/5+32) : Math.round(h.temperature_2m[idx]);
            const wDeg = h.wind_direction_10m[idx];
            
            hourlyHTML += `
                <div class="h-item">
                    <span style="font-weight:600; font-size:14px">${dispT}</span>
                    <span style="font-size:22px">${getWIcon(h.weather_code[idx])}</span>
                    <span style="font-size:16px; font-weight:500">${hTemp}¬∞</span>
                    <div class="wind-sm">
                        <span style="transform:rotate(${wDeg}deg); display:inline-block">‚Üì</span> ${Math.round(h.wind_speed_10m[idx])}
                    </div>
                </div>`;
        }

        // Daily
        let dailyHTML = '';
        for(let i=0; i<5; i++) {
            const date = new Date(d.time[i]);
            const dayName = i===0 ? '–°–µ–≥–æ–¥–Ω—è' : date.toLocaleDateString('ru-RU', {weekday:'short'});
            const dateNum = date.toLocaleDateString('ru-RU', {day:'numeric', month:'short'});
            const dMin = unit==='F' ? Math.round(d.temperature_2m_min[i]*9/5+32) : Math.round(d.temperature_2m_min[i]);
            const dMax = unit==='F' ? Math.round(d.temperature_2m_max[i]*9/5+32) : Math.round(d.temperature_2m_max[i]);
            dailyHTML += `
                <div class="day-row">
                    <div class="day-date"><span>${dayName}</span><span class="day-sub">${dateNum}</span></div>
                    <div style="font-size:20px; text-align:center">${getWIcon(d.weather_code[i])}</div>
                    <div class="temp-range"><span>${dMax}¬∞</span><span class="temp-night">${dMin}¬∞</span></div>
                </div>`;
        }

        const sunJson = encodeURIComponent(JSON.stringify({rise:d.sunrise[0], set:d.sunset[0], dur:d.daylight_duration[0]}));
        const aiId = isPreview ? 'preview' : cities.indexOf(city);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
        const canVote = checkLocation(city.lat, city.lon);
        const voteClass = canVote ? '' : 'disabled';
        const voteMsg = canVote ? '–£—Ç–æ—á–Ω–∏—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑:' : '–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏';

        return `
            <div class="city-header">
                <div class="city-name">${city.name}</div>
                <div class="condition-text">${getWDesc(cur.weather_code)}</div>
                <div class="temp-big">${temp}¬∞</div>
                <div class="hl-temp">–ú–∞–∫—Å.: ${max}¬∞ –ú–∏–Ω.: ${min}¬∞</div>
            </div>

            <!-- AI FORECAST BLOCK -->
            <div class="card">
                <div class="ai-header">
                    <div class="card-label" style="margin:0">ü§ñ AI-–ü–†–û–ì–ù–û–ó –û–°–ê–î–ö–û–í</div>
                    <div style="font-size:10px; opacity:0.5; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px">LIVE</div>
                </div>
                <div style="font-size:12px; opacity:0.7; margin-bottom:10px">${voteMsg}</div>
                
                <div class="vote-grid" id="vote-box-${aiId}">
                    <div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 0)">‚òÄÔ∏è –Ø—Å–Ω–æ</div>
                    <div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 1)">‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ</div>
                    <div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 2)">üåß –î–æ–∂–¥—å</div>
                    <div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 3)">‚ùÑÔ∏è –°–Ω–µ–≥</div>
                </div>
                <div id="ai-thank-you">–°–ø–∞—Å–∏–±–æ! –í–∞—à –≥–æ–ª–æ—Å —É—á—Ç–µ–Ω.</div>

                <div class="ai-chart-wrapper">
                    <div class="y-axis">
                        <span>100%</span><span>50%</span><span>0%</span>
                    </div>
                    <div class="graph-area" id="graph-area-${aiId}">
                        <div class="chart-tooltip" id="tooltip-${aiId}"></div>
                        <svg class="ai-svg" viewBox="0 0 300 100" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="grad-${aiId}" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="#4cd964" stop-opacity="0.3"/>
                                    <stop offset="100%" stop-color="#4cd964" stop-opacity="0"/>
                                </linearGradient>
                            </defs>
                            <path id="path-fill-${aiId}" class="graph-fill"></path>
                            <path id="path-line-${aiId}" class="graph-line"></path>
                            
                            <!-- Dots (Group) -->
                            <g id="dots-group-${aiId}"></g>
                        </svg>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:10px; opacity:0.5; margin-left:35px">
                    <span>–°–µ–π—á–∞—Å</span><span>15–º</span><span>30–º</span><span>45–º</span><span>60–º</span>
                </div>
            </div>

            <div class="card"><div class="card-label">üïì –ü–û–ß–ê–°–û–í–û–ô</div><div class="h-scroll">${hourlyHTML}</div></div>
            <div class="card"><div class="card-label">üìÖ 5 –î–ù–ï–ô</div>${dailyHTML}</div>
            
            <div class="grid-2">
                <div class="card tile" onclick="openSunDetail('${sunJson}')">
                    <div class="card-label">‚òÄÔ∏è –°–û–õ–ù–¶–ï</div>
                    <div class="tile-val">${d.sunset[0].split('T')[1]}</div>
                    <div class="tile-sub">–ó–∞–∫–∞—Ç</div>
                </div>
                <div class="card tile">
                    <div class="card-label">üí® –í–ï–¢–ï–†</div>
                    <div class="tile-val">${ws} <span style="font-size:16px">${wLabel}</span></div>
                    <div class="tile-sub">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${cur.wind_direction_10m}¬∞</div>
                </div>
            </div>
            
            <div class="ai-box">
                <div class="ai-title">AI –°–û–í–ï–¢</div>
                <div class="ai-text">${getAIText(temp, cur.weather_code)}</div>
            </div>

            <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
            <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" 
                 onload="initAIGraph('${aiId}')" style="display:none"/>
        `;
    }

    // --- AI GRAPH SYSTEM ---
    const aiData = {};

    function checkLocation(lat, lon) {
        if(!userGeo) return false;
        // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤ —Ä–∞–¥–∏—É—Å–µ ~10–∫–º)
        return Math.abs(userGeo.lat - lat) < 0.1 && Math.abs(userGeo.lon - lon) < 0.1;
    }

    function initAIGraph(id) {
        // –°–∏–º—É–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (5 —Ç–æ—á–µ–∫: 0, 15, 30, 45, 60 –º–∏–Ω)
        let pts = [];
        let v = Math.random()*40;
        for(let i=0; i<5; i++) {
            v += (Math.random()-0.5)*30;
            v = Math.max(0, Math.min(100, v));
            pts.push(v);
        }
        aiData[id] = { points: pts, voted: false };
        renderGraph(id);
        
        // –ñ–∏–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è (–¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ—á–µ–∫)
        if(id !== 'preview') {
            setInterval(() => {
                if(!document.getElementById(`page-${id}`).classList.contains('active')) return;
                // –õ–µ–≥–∫–æ–µ "–¥—ã—Ö–∞–Ω–∏–µ" –≥—Ä–∞—Ñ–∏–∫–∞
                aiData[id].points = aiData[id].points.map(p => {
                    let np = p + (Math.random()-0.5)*2;
                    return Math.max(0, Math.min(100, np));
                });
                renderGraph(id);
            }, 2000);
        }
    }

    function renderGraph(id) {
        const d = aiData[id].points;
        const svgW = 300, svgH = 100;
        const stepX = svgW / 4; // 4 –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø–æ 15 –º–∏–Ω
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É—Ç–∏
        let path = `M0,${svgH - (d[0]/100)*svgH}`;
        for(let i=1; i<d.length; i++) {
            path += ` L${i*stepX},${svgH - (d[i]/100)*svgH}`;
        }

        const line = document.getElementById(`path-line-${id}`);
        const fill = document.getElementById(`path-fill-${id}`);
        const dotsG = document.getElementById(`dots-group-${id}`);
        const tooltip = document.getElementById(`tooltip-${id}`);
        
        if(line && fill) {
            line.setAttribute('d', path);
            fill.setAttribute('d', path + ` L${svgW},${svgH} L0,${svgH} Z`);
            
            // –¢–æ—á–∫–∏
            dotsG.innerHTML = '';
            d.forEach((val, i) => {
                const cx = i * stepX;
                const cy = svgH - (val/100)*svgH;
                const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                dot.setAttribute("class", "graph-dot");
                dot.setAttribute("cx", cx);
                dot.setAttribute("cy", cy);
                
                // Hover Events
                dot.addEventListener('mouseenter', () => {
                    tooltip.style.opacity = 1;
                    tooltip.style.left = (cx / 300 * 100) + '%';
                    tooltip.style.top = (cy / 100 * 100) + '%';
                    let icon = val > 50 ? 'üåß' : (val > 20 ? '‚òÅÔ∏è' : '‚òÄÔ∏è');
                    tooltip.innerHTML = `${icon} ${Math.round(val)}%`;
                });
                dot.addEventListener('mouseleave', () => {
                    tooltip.style.opacity = 0;
                });
                
                dotsG.appendChild(dot);
            });
        }
    }

    function submitVote(id, type) {
        if(aiData[id].voted) return;
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞—Ü–∏–∏ —É–∂–µ –±—ã–ª–∞ –≤ generateHTML (–∫–ª–∞—Å—Å disabled), –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º –µ—â–µ —Ä–∞–∑
        if(document.querySelector(`#vote-box-${id} .vote-btn`).classList.contains('disabled')) return;

        aiData[id].voted = true;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è UI
        const box = document.getElementById(`vote-box-${id}`);
        const thx = document.querySelector(`#page-${id} #ai-thank-you`) || document.getElementById('ai-thank-you');
        
        box.style.opacity = 0;
        setTimeout(() => {
            box.style.display = 'none';
            thx.style.display = 'block';
            
            // –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            let factor = (type >= 2) ? 20 : -20;
            aiData[id].points = aiData[id].points.map(v => Math.max(0, Math.min(100, v + factor)));
            renderGraph(id);
        }, 500);
    }

    // --- Helpers ---
    function getWDesc(c) { const m={0:'–Ø—Å–Ω–æ',1:'–ú–∞–ª–æ–æ–±–ª.',2:'–û–±–ª–∞—á–Ω–æ',3:'–ü–∞—Å–º—É—Ä–Ω–æ',45:'–¢—É–º–∞–Ω',61:'–î–æ–∂–¥—å',71:'–°–Ω–µ–≥',95:'–ì—Ä–æ–∑–∞'}; return m[c]||'–û—Å–∞–¥–∫–∏'; }
    function getWIcon(c) { if(c===0)return'‚òÄÔ∏è'; if(c<=3)return'‚òÅÔ∏è'; if(c<=48)return'üå´'; if(c<=69)return'üåß'; if(c<=79)return'‚ùÑÔ∏è'; if(c>=95)return'‚ö°Ô∏è'; return'üåß'; }
    function getAIText(t,c) { if(c>=95)return "–ì—Ä–æ–∑–∞! –ù–µ —Å—Ç–æ–π—Ç–µ –ø–æ–¥ –¥–µ—Ä–µ–≤—å—è–º–∏."; if(c>=60)return "–ë–µ—Ä–∏—Ç–µ –∑–æ–Ω—Ç, —Å–∫–æ—Ä–æ –ø–æ–ª—å–µ—Ç."; if(t<0)return "–û–¥–µ–≤–∞–π—Ç–µ—Å—å —Ç–µ–ø–ª–µ–µ."; return "–û—Ç–ª–∏—á–Ω–∞—è –ø–æ–≥–æ–¥–∞ –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏."; }

    // --- Settings UI ---
    function renderFav() {
        document.getElementById('fav-list').innerHTML = cities.map((c,i)=>`
            <div class="list-item" onclick="loadWeather(${i}); toggleSettings(false)">
                <div><b>${c.name}</b><div style="font-size:12px;opacity:0.6">${c.country}</div></div>
                ${!c.isHome ? `<div class="btn-circle" style="color:#ff453a;border-color:rgba(255,69,58,0.3)" onclick="event.stopPropagation(); removeCity(${i})">‚úï</div>` : ''}
            </div>`).join('');
    }
    function toggleUnit() { unit = unit==='C'?'F':'C'; localStorage.setItem('unit', unit); updateSettingsUI(); loadWeather(currentIndex); }
    function toggleWindUnit() { 
        const next = { 'kmh':'ms', 'ms':'mph', 'mph':'kmh' };
        windUnit = next[windUnit]; localStorage.setItem('windUnit', windUnit); updateSettingsUI(); loadWeather(currentIndex); 
    }
    function updateSettingsUI() {
        document.getElementById('unit-disp').innerText = '¬∞'+unit;
        const wLabels = {'kmh':'–∫–º/—á', 'ms':'–º/—Å', 'mph':'–º–∏–ª—å/—á'};
        document.getElementById('wind-disp').innerText = wLabels[windUnit];
    }
    function updatePagination() {
        const p = document.getElementById('pagination');
        if(cities.length < 2) p.style.display='none';
        else {
            p.style.display='flex';
            p.innerHTML = cities.map((_,i)=>`<div class="dot ${i===currentIndex?'active':''}" onclick="loadWeather(${i})"></div>`).join('');
        }
    }
    function openSunDetail(j) {
        const d = JSON.parse(decodeURIComponent(j));
        document.getElementById('sun-modal-content').innerHTML = `
            <div style="text-align:center;padding:40px 0">
                <div style="font-size:50px">${Math.floor(d.dur/3600)}—á ${Math.round((d.dur%3600)/60)}–º</div>
                <div style="opacity:0.6">–°–≤–µ—Ç–æ–≤–æ–π –¥–µ–Ω—å</div>
            </div>
            <div style="background:rgba(255,255,255,0.1); border-radius:15px; padding:20px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:15px"><span>–í–æ—Å—Ö–æ–¥</span><b>${d.rise.split('T')[1]}</b></div>
                <div style="display:flex;justify-content:space-between"><span>–ó–∞–∫–∞—Ç</span><b>${d.set.split('T')[1]}</b></div>
            </div>`;
        document.getElementById('sun-modal').classList.add('show');
    }

    // --- ANIMATION ENGINE (Full iOS Style) ---
    const ctx = document.getElementById('bg').getContext('2d');
    let env = { w:0, h:0, code:0, day:1, items:[], clouds:[], stars:[] };

    function initParticles() {
        env.stars = [];
        for(let i=0; i<100; i++) env.stars.push({x:Math.random(), y:Math.random(), a:Math.random()});
    }

    function updateEnv(data) {
        env.code = data.current.weather_code;
        env.day = data.current.is_day;
        env.items = []; // Reset rain/snow
        env.clouds = [];
        // Add clouds if cloudy
        if(env.code >= 1 && env.code <= 3 || env.code >= 45) {
            for(let i=0; i<6; i++) env.clouds.push({x:Math.random()*window.innerWidth, y:Math.random()*300, s:Math.random()*0.5+0.2});
        }
    }

    function resize() { env.w = window.innerWidth; env.h = window.innerHeight; ctx.canvas.width = env.w; ctx.canvas.height = env.h; }

    function loop() {
        ctx.clearRect(0,0,env.w,env.h);
        
        // 1. Background Gradient
        let g = ctx.createLinearGradient(0,0,0,env.h);
        const c = env.code;
        if(c >= 95) { g.addColorStop(0,'#232526'); g.addColorStop(1,'#414345'); } // Storm
        else if(c >= 51 || c===45) { // Rain/Fog
             if(env.day) { g.addColorStop(0,'#5C6575'); g.addColorStop(1,'#8E9CAB'); }
             else { g.addColorStop(0,'#1e2329'); g.addColorStop(1,'#2c3e50'); }
        } else if(c <= 2) { // Clear/Partly
             if(env.day) { g.addColorStop(0,'#2980b9'); g.addColorStop(1,'#6dd5fa'); }
             else { g.addColorStop(0,'#0f2027'); g.addColorStop(1,'#203a43'); }
        } else { // Cloudy
             if(env.day) { g.addColorStop(0,'#757F9A'); g.addColorStop(1,'#D7DDE8'); }
             else { g.addColorStop(0,'#2c3e50'); g.addColorStop(1,'#4ca1af'); }
        }
        ctx.fillStyle = g; ctx.fillRect(0,0,env.w,env.h);

        // 2. Stars (Night)
        if(!env.day && c <= 2) {
            ctx.fillStyle = '#fff';
            env.stars.forEach(s => {
                ctx.globalAlpha = Math.abs(Math.sin(Date.now()/1000 + s.x*10)) * s.a;
                ctx.beginPath(); ctx.arc(s.x*env.w, s.y*env.h, 1.5, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        // 3. Sun / Moon
        if(c <= 2) {
            let sx = env.day ? env.w*0.8 : env.w*0.8;
            let sy = env.h*0.15;
            if(env.day) { // Sun
                let rg = ctx.createRadialGradient(sx,sy,10,sx,sy,60);
                rg.addColorStop(0,'rgba(255,255,200,0.9)'); rg.addColorStop(1,'rgba(255,255,255,0)');
                ctx.fillStyle=rg; ctx.beginPath(); ctx.arc(sx,sy,80,0,Math.PI*2); ctx.fill();
                ctx.fillStyle='#FFD700'; ctx.beginPath(); ctx.arc(sx,sy,20,0,Math.PI*2); ctx.fill();
            } else { // Moon
                ctx.fillStyle='rgba(255,255,230,0.9)'; ctx.beginPath(); ctx.arc(sx,sy,25,0,Math.PI*2); ctx.fill();
            }
        }

        // 4. Clouds
        ctx.fillStyle = env.day ? 'rgba(255,255,255,0.3)' : 'rgba(200,200,200,0.1)';
        env.clouds.forEach(cl => {
            cl.x += cl.s; if(cl.x > env.w + 100) cl.x = -100;
            ctx.beginPath(); ctx.arc(cl.x, cl.y, 60, 0, Math.PI*2); ctx.arc(cl.x+50, cl.y+20, 70, 0, Math.PI*2); ctx.fill();
        });

        // 5. Precip (Rain/Snow)
        const isRain = (c>=50 && c<=69) || c>=95;
        const isSnow = c>=70 && c<=79;
        if(isRain || isSnow) {
            if(env.items.length < 150) env.items.push({x:Math.random()*env.w, y:-20, v:Math.random()*5+5, s:Math.random()*2});
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.fillStyle = '#fff';
            ctx.lineWidth = isSnow ? 0 : 1.5;
            env.items.forEach((p,i) => {
                p.y += p.v;
                if(p.y > env.h) env.items[i] = {x:Math.random()*env.w, y:-20, v:p.v, s:p.s};
                if(isSnow) {
                    p.x += Math.sin(p.y/50); // Snow drift
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                } else {
                    ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x, p.y+15); ctx.stroke();
                }
            });
        }
        
        // 6. Lightning
        if(c >= 95 && Math.random() < 0.005) {
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillRect(0,0,env.w,env.h);
        }

        requestAnimationFrame(loop);
    }

    init();
</script>
</body>
</html>
        /* –°–µ—Ç–∫–∞ –ø–ª–∏—Ç–æ–∫ 2x2 */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .tile { aspect-ratio: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .tile-val { font-size: 26px; font-weight: 500; }
        .tile-sub { font-size: 13px; opacity: 0.7; }

        /* –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Å–∫—Ä–æ–ª–ª—ã */
        .h-scroll { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-item { text-align: center; min-width: 50px; display: flex; flex-direction: column; align-items: center; gap: 6px; }

        .day-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 16px; font-weight: 500; }
        .day-row:last-child { border: none; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–æ—á–∫–∏) */
        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.7); backdrop-filter: blur(20px); padding: 8px 16px; border-radius: 20px; display: flex; gap: 8px; z-index: 2000; border: 1px solid rgba(255,255,255,0.1); pointer-events: none; }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #fff; transform: scale(1.2); }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; background: rgba(60,60,60,0.6); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; pointer-events: auto; }
        
        /* –ü–†–ï–î–ü–†–û–°–ú–û–¢–† (–ú–æ–¥–∞–ª–∫–∞) */
        #preview-modal { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); display: none; flex-direction: column; }
        .preview-header { padding: 50px 20px 10px; display: flex; justify-content: space-between; align-items: center; }
        .preview-content { flex: 1; overflow-y: auto; padding: 0 20px 40px; }
        .preview-actions { padding: 20px; display: flex; justify-content: center; gap: 20px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
        .add-btn { background: #fff; color: #000; padding: 12px 30px; border-radius: 25px; font-weight: 600; border: none; font-size: 16px; }

        /* –°–û–õ–ù–¶–ï (–ú–æ–¥–∞–ª–∫–∞) */
        #sun-modal { position: fixed; inset: 0; z-index: 3500; background: rgba(20,20,20,0.95); backdrop-filter: blur(40px); transform: translateY(100%); transition: transform 0.4s var(--spring); display: flex; flex-direction: column; }
        #sun-modal.open { transform: translateY(0); }
        .sun-modal-head { display: flex; justify-content: space-between; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }
        .sun-modal-body { padding: 20px; flex: 1; overflow-y: auto; }
        .sun-detail-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 17px; }
        .sun-graph-lg { width: 100%; height: 200px; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.2); }

        /* AI Text */
        .ai-box { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 15px; margin-top: 20px; }
        .ai-title { font-size: 14px; font-weight: 700; color: #FFD60A; margin-bottom: 8px; }
        .ai-text { font-size: 15px; line-height: 1.4; opacity: 0.9; }

        /* List Menu (Settings/Favorites) */
        #settings-layer { position: fixed; inset: 0; background: #000; z-index: 2900; transform: translateX(-100%); transition: 0.4s var(--spring); padding: 50px 20px; overflow-y: auto; }
        #settings-layer.show { transform: translateX(0); }
        .list-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
    </style>
</head>
<body>

    <canvas id="bg"></canvas>

    <header>
        <div class="btn-circle" onclick="toggleSettings(true)" style="margin-right: 10px;">‚ò∞</div>
        <div class="search-wrapper">
            <div class="search-box">
                <span style="opacity:0.6">üîç</span>
                <input id="q" placeholder="–ü–æ–∏—Å–∫ (–ì–æ—Ä–æ–¥, –°—Ç—Ä–∞–Ω–∞)" oninput="doSearch(this.value)">
            </div>
            <div id="results"></div>
        </div>
    </header>

    <div id="stage"></div>

    <div class="nav-dock" id="pagination"></div>

    <div id="settings-layer">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h1 style="margin:0; font-size:28px;">–ú–æ–∏ –≥–æ—Ä–æ–¥–∞</h1>
            <div class="btn-circle" onclick="toggleSettings(false)">‚úï</div>
        </div>
        <div id="fav-list"></div>
        <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
            <h3 style="opacity:0.5">–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è</h3>
            <div class="list-item" onclick="toggleUnit()">
                <span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span>
                <span id="unit-disp" style="color:#0a84ff">¬∞C</span>
            </div>
        </div>
    </div>

    <div id="preview-modal">
        <div class="preview-header">
            <div class="btn-circle" onclick="closePreview()">‚úï</div>
            <span style="font-weight:600; opacity:0.8">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
            <div style="width:40px"></div>
        </div>
        <div class="preview-content" id="preview-inner"></div>
        <div class="preview-actions">
            <button class="add-btn" onclick="confirmAddCity()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="sun-modal">
        <div class="sun-modal-head">
            <span style="font-size:18px; font-weight:600">–°–æ–ª–Ω—Ü–µ</span>
            <div class="btn-circle" style="width:30px; height:30px; font-size:14px;" onclick="document.getElementById('sun-modal').classList.remove('open')">‚úï</div>
        </div>
        <div class="sun-modal-body" id="sun-details-content">
            </div>
    </div>

<script>
    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    let cities = []; // {lat, lon, name, region, country, isHome}
    let currentIndex = 0;
    let unit = localStorage.getItem('unit') || 'C';
    let tempCity = null; // –î–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    
    // –ì—Ä–∞—Ñ–∏–∫–∞
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let env = { wCode: 0, isDay: 1, stars: [], rain: [], clouds: [] };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    async function init() {
        resize();
        window.addEventListener('resize', resize);
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö
        const saved = JSON.parse(localStorage.getItem('savedCities') || '[]');
        if (saved.length > 0) {
            cities = saved;
            loadWeather(0);
        } else {
            // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
            navigator.geolocation.getCurrentPosition(
                async pos => {
                    const data = await getGeoName(pos.coords.latitude, pos.coords.longitude);
                    cities = [{...data, isHome: true}];
                    saveCities();
                    loadWeather(0);
                },
                () => {
                    cities = [{lat: 55.75, lon: 37.62, name: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è', isHome: true}];
                    saveCities();
                    loadWeather(0);
                }
            );
        }
        
        document.getElementById('unit-disp').innerText = unit === 'C' ? '¬∞C' : '¬∞F';
        startAnimLoop();
        
        // –°–≤–∞–π–ø—ã
        let sx = 0;
        document.getElementById('stage').addEventListener('touchstart', e => sx = e.touches[0].clientX);
        document.getElementById('stage').addEventListener('touchend', e => {
            const diff = sx - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
                if (diff > 0 && currentIndex < cities.length - 1) changePage(currentIndex + 1);
                else if (diff < 0 && currentIndex > 0) changePage(currentIndex - 1);
            }
        });
    }

    // --- API & –õ–æ–≥–∏–∫–∞ ---
    
    async function getGeoName(lat, lon) {
        try {
            const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ru`);
            const d = await r.json();
            return {
                lat, lon,
                name: d.address.city || d.address.town || d.address.village || '–ú–æ–µ –º–µ—Å—Ç–æ',
                region: d.address.state || '',
                country: d.address.country || ''
            };
        } catch { return {lat, lon, name:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', region:'', country:''}; }
    }

    async function doSearch(q) {
        const resBox = document.getElementById('results');
        if (q.length < 2) { resBox.style.display = 'none'; return; }
        
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=ru`).then(x => x.json());
        if (!r.results) return;

        resBox.innerHTML = r.results.map(i => `
            <div class="res-item" onclick="openPreview(${i.latitude}, ${i.longitude}, '${i.name}', '${i.admin1 || ''}', '${i.country || ''}')">
                <div class="res-main">${i.name}</div>
                <div class="res-sub">${i.admin1 ? i.admin1 + ', ' : ''}${i.country}</div>
            </div>
        `).join('');
        resBox.style.display = 'block';
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ (Preview vs Main) ---

    // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–Ω–µ –¥–æ–±–∞–≤–ª—è—è –≤ –º–∞—Å—Å–∏–≤)
    async function openPreview(lat, lon, name, region, country) {
        document.getElementById('results').style.display = 'none';
        document.getElementById('q').value = '';
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
        const exists = cities.findIndex(c => Math.abs(c.lat - lat) < 0.01 && Math.abs(c.lon - lon) < 0.01);
        if (exists !== -1) {
            changePage(exists); // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º
            return;
        }

        tempCity = { lat, lon, name, region, country };
        const modal = document.getElementById('preview-modal');
        modal.style.display = 'flex';
        document.getElementById('preview-inner').innerHTML = '<div style="text-align:center; margin-top:50px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        const data = await fetchWeatherData(lat, lon);
        document.getElementById('preview-inner').innerHTML = generateHTML(data, tempCity, false);
        
        // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –ø—Ä–µ–≤—å—é
        setTimeout(() => drawSunCanvas(`sun-canvas-preview`, data), 100);
    }

    function closePreview() {
        document.getElementById('preview-modal').style.display = 'none';
        tempCity = null;
    }

    function confirmAddCity() {
        if (tempCity) {
            cities.push(tempCity);
            saveCities();
            closePreview();
            changePage(cities.length - 1);
        }
    }

    function saveCities() {
        localStorage.setItem('savedCities', JSON.stringify(cities));
        renderFavList();
    }

    // --- –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥—ã ---

    async function loadWeather(idx) {
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        const stage = document.getElementById('stage');
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞)
        if (stage.children.length !== cities.length) {
            stage.innerHTML = '';
            cities.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'page-container';
                div.id = `page-${i}`;
                stage.appendChild(div);
            });
        }
        
        updatePagination();
        changePage(idx); // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
        
        const city = cities[idx];
        const container = document.getElementById(`page-${idx}`);
        
        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç, –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º (–∫—ç—à –≤ DOM), –Ω–æ –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å
        if (container.innerHTML.length > 100) return; 

        container.innerHTML = '<div style="text-align:center; padding-top:100px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        const data = await fetchWeatherData(city.lat, city.lon);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)
        if (idx === currentIndex) updateEnv(data);
        
        container.innerHTML = generateHTML(data, city, true);
        
        // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å–æ–ª–Ω—Ü–∞
        setTimeout(() => drawSunCanvas(`sun-graph-${idx}`, data), 50);
    }
    
    function changePage(idx) {
        currentIndex = idx;
        const pages = document.querySelectorAll('.page-container');
        pages.forEach((p, i) => {
            p.className = 'page-container';
            if (i === idx) {
                p.classList.add('active');
                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ—Ç, –ø–æ–¥–≥—Ä—É–∂–∞–µ–º
                if (p.innerHTML === '') loadWeather(i);
                else {
                    // –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é —Ñ–æ–Ω–∞, –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—É—é
                     // (—É–ø—Ä–æ—â–µ–Ω–∏–µ: –±–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ DOM –∞—Ç—Ç—Ä–∏–±—É—Ç–æ–≤ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ –º–µ–Ω—è–µ–º)
                }
            }
            else if (i < idx) p.classList.add('prev');
            else p.classList.add('next');
        });
        updatePagination();
    }

    async function fetchWeatherData(lat, lon) {
        const uParams = `&current=temperature_2m,weather_code,is_day,wind_speed_10m,wind_direction_10m,pressure_msl,relative_humidity_2m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,daylight_duration&timezone=auto`;
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}${uParams}`;
        return await fetch(url).then(r => r.json());
    }

    // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML (–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ) ---
    
    function generateHTML(data, cityInfo, isMain) {
        const cur = data.current;
        const daily = data.daily;
        const idx = isMain ? cities.indexOf(cityInfo) : 'preview';
        
        const desc = getWDesc(cur.weather_code);
        const temp = unit === 'F' ? Math.round(cur.temperature_2m * 9/5 + 32) : Math.round(cur.temperature_2m);
        const min = unit === 'F' ? Math.round(daily.temperature_2m_min[0] * 9/5 + 32) : Math.round(daily.temperature_2m_min[0]);
        const max = unit === 'F' ? Math.round(daily.temperature_2m_max[0] * 9/5 + 32) : Math.round(daily.temperature_2m_max[0]);
        
        // –ü–æ—á–∞—Å–æ–≤–∞—è (24—á) - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è
        let hourlyHTML = '';
        const nowHour = new Date().getHours(); 
        for(let i=0; i<24; i++) {
            // –ë–µ—Ä–µ–º –≤—Ä–µ–º—è –∏–∑ —Å—Ç—Ä–æ–∫–∏ API (2023-01-01T14:00) -> 14
            const tStr = data.hourly.time[i]; 
            const h = parseInt(tStr.split('T')[1].split(':')[0]); 
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ —á–∞—Å—ã (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
            // –ù–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å 00:00, –ø–æ—ç—Ç–æ–º—É —Å–¥–≤–∏–≥:
            // –£ OpenMeteo current time match - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å
             
            const hTemp = unit === 'F' ? Math.round(data.hourly.temperature_2m[i] * 9/5 + 32) : Math.round(data.hourly.temperature_2m[i]);
            
            // –ï—Å–ª–∏ —á–∞—Å —É–∂–µ –ø—Ä–æ—à–µ–ª –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–∏—Ö —Å—É—Ç–æ–∫, –º–æ–∂–Ω–æ –µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, 
            // –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞–∂–µ–º —Å—É—Ç–∫–∏ –Ω–∞—á–∏–Ω–∞—è —Å —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞ API (–æ–±—ã—á–Ω–æ –æ–Ω–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç)
            // –õ—É—á—à–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å.
            
            hourlyHTML += `
                <div class="h-item">
                    <span style="font-size:14px; font-weight:600">${h}:00</span>
                    <span style="font-size:20px; margin:4px 0">${getWIcon(data.hourly.weather_code[i])}</span>
                    <span style="font-size:16px">${hTemp}¬∞</span>
                </div>
            `;
        }

        // Daily
        let dailyHTML = '';
        for(let i=0; i<5; i++) {
            const date = new Date(daily.time[i]);
            const dayName = i===0 ? '–°–µ–≥–æ–¥–Ω—è' : date.toLocaleDateString('ru-RU', {weekday:'short'});
            const dMin = unit === 'F' ? Math.round(daily.temperature_2m_min[i]*9/5+32) : Math.round(daily.temperature_2m_min[i]);
            const dMax = unit === 'F' ? Math.round(daily.temperature_2m_max[i]*9/5+32) : Math.round(daily.temperature_2m_max[i]);
            
            dailyHTML += `
                <div class="day-row">
                    <div style="text-transform:capitalize">${dayName}</div>
                    <div style="text-align:center">${getWIcon(daily.weather_code[i])}</div>
                    <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end">
                        <span style="opacity:0.5">${dMin}¬∞</span>
                        <span>${dMax}¬∞</span>
                    </div>
                </div>
            `;
        }

        // JSON –¥–ª—è —Å–æ–ª–Ω—Ü–∞ (–ø–µ—Ä–µ–¥–∞–¥–∏–º –≤ –∫–ª–∏–∫)
        const sunData = encodeURIComponent(JSON.stringify({
            rise: daily.sunrise[0],
            set: daily.sunset[0],
            dur: daily.daylight_duration[0]
        }));
        
        // AI Text
        const aiText = getAIText(cur.temperature_2m, cur.weather_code, cur.wind_speed_10m);

        return `
            <div class="city-header">
                <div class="city-name">${cityInfo.name}</div>
                <div class="condition-text">${desc}</div>
                <div class="temp-big">${temp}¬∞</div>
                <div class="hl-temp">–ú–∞–∫—Å.: ${max}¬∞ –ú–∏–Ω.: ${min}¬∞</div>
            </div>

            <div class="card">
                <div class="card-label">üïì –ü–û–ß–ê–°–û–í–û–ô –ü–†–û–ì–ù–û–ó</div>
                <div class="h-scroll">
                    ${hourlyHTML}
                </div>
            </div>

            <div class="card">
                <div class="card-label">üìÖ –ü–†–û–ì–ù–û–ó –ù–ê 5 –î–ù–ï–ô</div>
                ${dailyHTML}
            </div>

            <div class="grid-2">
                <div class="card tile" onclick="openSunDetail('${sunData}')" style="cursor:pointer">
                    <div class="card-label">üåÖ –í–û–°–•–û–î –ò –ó–ê–ö–ê–¢</div>
                    <div style="position:relative; width:100%; height:60px; margin-top:10px;">
                        <canvas id="sun-graph-${idx}" width="300" height="120" style="width:100%; height:100%"></canvas>
                    </div>
                    <div class="tile-sub">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</div>
                </div>

                <div class="card tile">
                    <div class="card-label">üåô –õ–£–ù–ê</div>
                    <div style="font-size:15px; font-weight:500">–†–∞—Å—Ç—É—â–∞—è –ª—É–Ω–∞</div>
                    <div style="font-size:30px; text-align:center; margin:5px 0">üåñ</div>
                    <div class="tile-sub">–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å: 78%</div>
                </div>

                <div class="card tile">
                    <div class="card-label">üí® –í–ï–¢–ï–†</div>
                    <div class="tile-val">${Math.round(cur.wind_speed_10m)} <span style="font-size:16px">–∫–º/—á</span></div>
                    <div class="tile-sub">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${cur.wind_direction_10m}¬∞</div>
                </div>

                <div class="card tile">
                    <div class="card-label">üìâ –î–ê–í–õ–ï–ù–ò–ï</div>
                    <div class="tile-val">${Math.round(cur.pressure_msl * 0.75)} <span style="font-size:16px">–º–º</span></div>
                    <div class="tile-sub">—Ä—Ç. —Å—Ç.</div>
                </div>
            </div>

            <div class="ai-box">
                <div class="ai-title">ü§ñ AI –ü–û–ú–û–©–ù–ò–ö</div>
                <div class="ai-text">${aiText}</div>
            </div>
        `;
    }

    // --- –†–∏—Å–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å–æ–ª–Ω—Ü–∞ (–°–∏–Ω—É—Å–æ–∏–¥–∞) ---
    function drawSunCanvas(id, data) {
        const c = document.getElementById(id);
        if(!c) return;
        const cx = c.getContext('2d');
        const w = c.width, h = c.height;
        
        cx.clearRect(0,0,w,h);
        
        // –†–∏—Å—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç
        cx.beginPath();
        cx.strokeStyle = 'rgba(255,255,255,0.3)';
        cx.lineWidth = 2;
        cx.moveTo(0, h/2); cx.lineTo(w, h/2);
        cx.stroke();

        // –°–∏–Ω—É—Å–æ–∏–¥–∞
        cx.beginPath();
        cx.strokeStyle = '#FFD60A';
        cx.lineWidth = 4;
        for(let x=0; x<=w; x++) {
            // y = sin(x)
            let y = Math.sin((x/w)*Math.PI) * (h/2 - 10);
            cx.lineTo(x, h/2 - y);
        }
        cx.stroke();

        // –¢–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ (—Ñ–µ–π–∫–æ–≤–æ–µ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã, —Ç–∞–∫ –∫–∞–∫ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å–ª–æ–∂–µ–Ω)
        // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Å –∏ –º–∞–ø–∏–º –Ω–∞ —à–∏—Ä–∏–Ω—É
        const now = new Date();
        const mins = now.getHours() * 60 + now.getMinutes();
        const totalMins = 24 * 60;
        const xPos = (mins / totalMins) * w;
        // –ù–æ –Ω–∞–º –Ω—É–∂–Ω–∞ –¥—É–≥–∞ —Ç–æ–ª—å–∫–æ –¥–Ω–µ–º, —É–ø—Ä–æ—Å—Ç–∏–º: –ø—Ä–æ—Å—Ç–æ —Ç–æ—á–∫—É –Ω–∞ –¥—É–≥–µ –ø–æ—Å—Ç–∞–≤–∏–º
        // –î–æ–ø—É—Å—Ç–∏–º, –º—ã –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥—É–≥–∏
        const yPos = Math.sin((0.5)*Math.PI) * (h/2 - 10); // –ü–∏–∫

        cx.beginPath();
        cx.fillStyle = '#fff';
        cx.shadowBlur = 10; cx.shadowColor = '#FFD60A';
        cx.arc(w/2, h/2 - yPos, 6, 0, Math.PI*2);
        cx.fill();
        cx.shadowBlur = 0;
    }

    // --- –î–µ—Ç–∞–ª—å–Ω–æ–µ –º–µ–Ω—é –°–æ–ª–Ω—Ü–∞ ---
    function openSunDetail(json) {
        const d = JSON.parse(decodeURIComponent(json));
        const modal = document.getElementById('sun-modal');
        const content = document.getElementById('sun-details-content');
        
        const rise = d.rise.split('T')[1];
        const set = d.set.split('T')[1];
        const durH = Math.floor(d.dur / 3600);
        const durM = Math.round((d.dur % 3600) / 60);

        // –†–∞—Å—á–µ—Ç –ø–µ—Ä–≤—ã—Ö –ª—É—á–µ–π (—É—Å–ª–æ–≤–Ω–æ -30 –º–∏–Ω)
        content.innerHTML = `
            <div style="text-align:center; padding: 20px 0;">
                <span style="font-size:14px; opacity:0.7">–°–≤–µ—Ç–æ–≤–æ–π –¥–µ–Ω—å</span>
                <div style="font-size:32px; font-weight:500">${durH} —á ${durM} –º–∏–Ω</div>
            </div>
            
            <div class="sun-detail-row">
                <span>–ü–µ—Ä–≤—ã–µ –ª—É—á–∏</span>
                <span>${parseInt(rise.split(':')[0])}:10</span> 
            </div>
            <div class="sun-detail-row">
                <span style="color:#FFD60A">–í–æ—Å—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è</span>
                <span>${rise}</span>
            </div>
            <div class="sun-detail-row">
                <span style="color:#FF9F0A">–ó–∞–∫–∞—Ç —Å–µ–≥–æ–¥–Ω—è</span>
                <span>${set}</span>
            </div>
            <div class="sun-detail-row">
                <span>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª—É—á–∏</span>
                <span>${parseInt(set.split(':')[0])}:45</span>
            </div>
        `;
        
        modal.classList.add('open');
    }

    // --- –£—Ç–∏–ª–∏—Ç—ã ---
    
    function updatePagination() {
        const p = document.getElementById('pagination');
        if (cities.length < 2) { p.style.display = 'none'; return; }
        p.style.display = 'flex';
        p.innerHTML = cities.map((_, i) => `<div class="dot ${i===currentIndex?'active':''}"></div>`).join('');
    }

    function toggleSettings(open) {
        const lay = document.getElementById('settings-layer');
        lay.className = open ? 'show' : '';
        if(open) renderFavList();
    }

    function renderFavList() {
        const l = document.getElementById('fav-list');
        l.innerHTML = cities.map((c, i) => `
            <div class="list-item">
                <div>
                    <div style="font-size:18px; font-weight:600">${c.name}</div>
                    <div style="font-size:12px; opacity:0.6">${c.country}</div>
                </div>
                ${!c.isHome ? `<div class="btn-circle" style="width:30px; height:30px; background:rgba(255,69,58,0.2); border-color:transparent; color:#ff453a" onclick="removeCity(${i})">‚úï</div>` : '<span style="opacity:0.5; font-size:12px">–ì–µ–æ</span>'}
            </div>
        `).join('');
    }

    function removeCity(i) {
        if(cities[i].isHome) return;
        cities.splice(i, 1);
        saveCities();
        renderFavList();
        loadWeather(0);
    }

    function toggleUnit() {
        unit = unit === 'C' ? 'F' : 'C';
        localStorage.setItem('unit', unit);
        document.getElementById('unit-disp').innerText = '¬∞' + unit;
        loadWeather(currentIndex);
    }

    function getAIText(t, c, w) {
        if(c >= 95) return "–í–Ω–∏–º–∞–Ω–∏–µ! –ì—Ä–æ–∑–∞. –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏ –∏ –¥–µ—Ä–∂–∏—Ç–µ—Å—å –ø–æ–¥–∞–ª—å—à–µ –æ—Ç –æ–∫–æ–Ω.";
        if(c >= 71) return "–°–Ω–µ–≥–æ–ø–∞–¥. –î–æ—Ä–æ–≥–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–∫–æ–ª—å–∑–∫–∏–º–∏. –û–¥–µ–≤–∞–π—Ç–µ—Å—å —Ç–µ–ø–ª–æ, —à–∞–ø–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞.";
        if(c >= 51) return "–ò–¥–µ—Ç –¥–æ–∂–¥—å. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–æ–Ω—Ç –∏ –Ω–µ–ø—Ä–æ–º–æ–∫–∞–µ–º—É—é –æ–±—É–≤—å.";
        if(t < 0) return "–ù–∞ —É–ª–∏—Ü–µ –º–æ—Ä–æ–∑. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ç–µ—Ä–º–æ–±–µ–ª—å–µ –∏ —Ç–µ–ø–ª—ã–π –ø—É—Ö–æ–≤–∏–∫.";
        if(t > 30) return "–ñ–∞—Ä–∫–æ! –ü–µ–π—Ç–µ –º–Ω–æ–≥–æ –≤–æ–¥—ã, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–Ω—ã–π –∫—Ä–µ–º –∏ –Ω–æ—Å–∏—Ç–µ –≥–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä.";
        return "–ü–æ–≥–æ–¥–∞ —Å–ø–æ–∫–æ–π–Ω–∞—è. –û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏ –∏–ª–∏ –¥–µ–ª –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ.";
    }

    function getWDesc(c) {
        const m = {0:'–Ø—Å–Ω–æ',1:'–ú–∞–ª–æ–æ–±–ª–∞—á–Ω–æ',2:'–û–±–ª–∞—á–Ω–æ',3:'–ü–∞—Å–º—É—Ä–Ω–æ',45:'–¢—É–º–∞–Ω',51:'–ú–æ—Ä–æ—Å—å',61:'–î–æ–∂–¥—å',63:'–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å',71:'–°–Ω–µ–≥',73:'–°–Ω–µ–≥–æ–ø–∞–¥',95:'–ì—Ä–æ–∑–∞'};
        return m[c] || '–û—Å–∞–¥–∫–∏';
    }
    
    function getWIcon(c) {
        if(c===0) return '‚òÄÔ∏è';
        if(c<=3) return '‚õÖ';
        if(c<=48) return 'üå´Ô∏è';
        if(c<=67) return 'üåßÔ∏è';
        if(c<=77) return '‚ùÑÔ∏è';
        if(c>=95) return '‚õàÔ∏è';
        return 'üåßÔ∏è';
    }

    // --- –ê–Ω–∏–º–∞—Ü–∏—è (Canvas) ---
    function startAnimLoop() {
        const count = 100;
        for(let i=0; i<count; i++) env.stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*2, a:Math.random()});
        loop();
    }
    
    function loop() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        
        // –§–æ–Ω –≥—Ä–∞–¥–∏–µ–Ω—Ç
        const grad = ctx.createLinearGradient(0,0,0,canvas.height);
        // –ü—Ä–æ—Å—Ç–æ–π –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ (–º–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å)
        grad.addColorStop(0, '#0f2027'); 
        grad.addColorStop(1, '#2c5364');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,canvas.width, canvas.height);

        // –ó–≤–µ–∑–¥—ã
        ctx.fillStyle = '#fff';
        env.stars.forEach(s => {
            s.a += (Math.random()-0.5)*0.05;
            if(s.a<0) s.a=0; if(s.a>1) s.a=1;
            ctx.globalAlpha = s.a;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
        });
        ctx.globalAlpha = 1;

        requestAnimationFrame(loop);
    }
    
    function updateEnv(data) {
        env.wCode = data.current.weather_code;
        env.isDay = data.current.is_day;
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

    // –ó–∞–ø—É—Å–∫
    init();

</script>
</body>
</html>

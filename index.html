<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>iOS Weather Pro</title>
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.1); 
            --blur: blur(30px); 
            --ios-font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", sans-serif;
        }
        * { box-sizing: border-box; font-family: var(--ios-font); -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        
        canvas#weather-bg { position: fixed; inset: 0; z-index: -1; transition: filter 1s; }

        .app-wrapper { height: 100vh; display: flex; flex-direction: column; }

        header { padding: 15px; z-index: 1000; display: flex; gap: 10px; align-items: center; }
        .search-container { flex: 1; position: relative; }
        .search-box { 
            background: rgba(255,255,255,0.15); backdrop-filter: var(--blur);
            border-radius: 12px; padding: 8px 12px; display: flex; align-items: center;
        }
        .search-box input { 
            background: transparent; border: none; color: #fff; font-size: 17px; 
            width: 100%; outline: none; margin-left: 8px;
        }

        #search-results {
            position: absolute; top: 50px; left: 0; right: 0;
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(40px);
            border-radius: 14px; overflow: hidden; z-index: 2000; display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .search-item { 
            padding: 12px 15px; border-bottom: 0.5px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .search-item .geo-info { font-size: 12px; opacity: 0.6; display: block; }

        .main-scroll { 
            flex: 1; overflow-y: auto; scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; padding: 0 15px 120px;
        }
        .main-scroll::-webkit-scrollbar { width: 0; }

        .hero { text-align: center; padding: 40px 0; }
        .hero h1 { font-size: 34px; font-weight: 400; margin: 0; }
        .hero .temp { font-size: 96px; font-weight: 100; margin: -5px 0; }
        .hero .condition { font-size: 20px; font-weight: 500; opacity: 0.8; }

        .card { 
            background: var(--glass); backdrop-filter: var(--blur); 
            border-radius: 20px; padding: 15px; margin-bottom: 15px;
            border: 0.5px solid rgba(255,255,255,0.1);
        }
        .card-title { 
            font-size: 13px; font-weight: 600; opacity: 0.5; 
            text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 5px;
        }

        /* –ü–æ—á–∞—Å–æ–≤–∞—è */
        .hourly-box { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 5px; }
        .hourly-box::-webkit-scrollbar { display: none; }
        .hour-item { text-align: center; min-width: 50px; }
        .hour-item .time { font-size: 13px; font-weight: 600; margin-bottom: 8px; }
        .hour-item .icon { font-size: 22px; margin-bottom: 8px; }

        /* –ü—Ä–æ–≥–Ω–æ–∑ 3 –¥–Ω—è */
        .day-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 0.5px solid rgba(255,255,255,0.1); 
        }
        .day-row:last-child { border: none; }

        /* –°–µ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ */
        .params-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .param-val { font-size: 28px; font-weight: 400; }

        /* AI –ü–æ–º–æ—â–Ω–∏–∫ */
        .ai-card { background: linear-gradient(135deg, rgba(120, 80, 255, 0.2), rgba(0, 200, 255, 0.2)); border: 0.5px solid rgba(255,255,255,0.3); }

        .nav-dots { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 20px;
        }
        .dot { width: 7px; height: 7px; background: rgba(255,255,255,0.4); border-radius: 50%; }
        .dot.active { background: #fff; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

<canvas id="weather-bg"></canvas>

<div class="app-wrapper">
    <header>
        <div class="search-container">
            <div class="search-box">
                <span>üîç</span>
                <input type="text" id="citySearch" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞" oninput="handleSearch(this.value)">
            </div>
            <div id="search-results"></div>
        </div>
        <div style="font-size: 24px; cursor: pointer;" onclick="refreshLocation()">üìç</div>
    </header>

    <div class="main-scroll" id="content">
        <div style="text-align: center; margin-top: 100px;">
            <p style="animation: pulse 1.5s infinite">–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...</p>
        </div>
    </div>
</div>

<div class="nav-dots" id="dots">
    <div class="dot active"></div>
</div>

<script>
    const canvas = document.getElementById('weather-bg');
    const ctx = canvas.getContext('2d');
    let W, H;
    let particles = [];
    let currentWeather = { code: 0, isDay: 1 };
    
    const WEATHER_MAP = {
        0: { label: "–Ø—Å–Ω–æ", icon: "‚òÄÔ∏è" },
        1: { label: "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —è—Å–Ω–æ", icon: "üå§Ô∏è" },
        2: { label: "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å", icon: "‚õÖ" },
        3: { label: "–ü–∞—Å–º—É—Ä–Ω–æ", icon: "‚òÅÔ∏è" },
        45: { label: "–¢—É–º–∞–Ω", icon: "üå´Ô∏è" },
        51: { label: "–ú–æ—Ä–æ—Å—å", icon: "üå¶Ô∏è" },
        61: { label: "–ù–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å", icon: "üåßÔ∏è" },
        63: { label: "–î–æ–∂–¥—å", icon: "üåßÔ∏è" },
        71: { label: "–°–Ω–µ–≥", icon: "‚ùÑÔ∏è" },
        80: { label: "–õ–∏–≤–µ–Ω—å", icon: "üå¶Ô∏è" },
        95: { label: "–ì—Ä–æ–∑–∞", icon: "‚õàÔ∏è" }
    };

    // --- –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã –∏ –µ–¥–∏–Ω–∏—Ü ---
    function getUnitByLocation(countryCode) {
        const fCountries = ['US', 'BS', 'KY', 'LR', 'PW', 'MH', 'FM'];
        return fCountries.includes(countryCode) ? 'fahrenheit' : 'celsius';
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        resize();
        refreshLocation();
        animate();
    };

    function resize() {
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
    }

    async function refreshLocation() {
        navigator.geolocation.getCurrentPosition(
            async (p) => {
                const { latitude, longitude } = p.coords;
                // –†–µ–≤–µ—Ä—Å–∏–≤–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞
                const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`).then(r => r.json());
                const cityName = geo.address.city || geo.address.town || geo.address.village || "–í–∞—à –≥–æ—Ä–æ–¥";
                const countryCode = geo.address.country_code.toUpperCase();
                loadWeatherData(latitude, longitude, cityName, countryCode);
            },
            () => loadWeatherData(55.75, 37.61, "–ú–æ—Å–∫–≤–∞", "RU")
        );
    }

    async function loadWeatherData(lat, lon, name, countryCode) {
        const unit = getUnitByLocation(countryCode);
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto&temperature_unit=${unit}`;
        
        const data = await fetch(url).then(r => r.json());
        currentWeather = { code: data.current.weather_code, isDay: data.current.is_day };
        renderWeather(data, name, unit === 'celsius' ? '¬∞C' : '¬∞F');
        initBackgroundEffect();
    }

    function renderWeather(data, name, unit) {
        const cur = data.current;
        const daily = data.daily;
        const hourly = data.hourly;

        const aiAdvice = getAIAdvice(cur.weather_code, cur.temperature_2m);

        let html = `
            <div class="hero">
                <h1>${name}</h1>
                <div class="temp">${Math.round(cur.temperature_2m)}${unit}</div>
                <div class="condition">${WEATHER_MAP[cur.weather_code]?.label || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
                <div style="font-weight:500; margin-top:5px">–ú–∞–∫—Å: ${Math.round(daily.temperature_2m_max[0])}¬∞, –º–∏–Ω: ${Math.round(daily.temperature_2m_min[0])}¬∞</div>
            </div>

            <div class="card">
                <div class="card-title">üïí –ü–æ—á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑</div>
                <div class="hourly-box">
                    ${hourly.time.slice(0, 24).map((t, i) => {
                        const date = new Date(t);
                        const isSunset = date.getHours() === new Date(daily.sunset[0]).getHours();
                        const isSunrise = date.getHours() === new Date(daily.sunrise[0]).getHours();
                        return `
                            <div class="hour-item">
                                <div class="time">${date.getHours()}:00</div>
                                <div class="icon">${isSunrise ? 'üåÖ' : (isSunset ? 'üåá' : (WEATHER_MAP[hourly.weather_code[i]]?.icon || '‚òÄÔ∏è'))}</div>
                                <div style="font-weight:600">${Math.round(hourly.temperature_2m[i])}¬∞</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìÖ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –¥–Ω—è</div>
                ${daily.time.slice(0, 3).map((t, i) => `
                    <div class="day-row">
                        <span style="width: 80px; font-weight: 500;">${i === 0 ? '–°–µ–≥–æ–¥–Ω—è' : new Date(t).toLocaleDateString('ru', {weekday: 'short'})}</span>
                        <span style="font-size: 20px;">${WEATHER_MAP[daily.weather_code[i]].icon}</span>
                        <span style="width: 100px; text-align: right; font-weight: 500;">
                            ${Math.round(daily.temperature_2m_max[i])}¬∞ <span style="opacity:0.4; margin-left:8px">${Math.round(daily.temperature_2m_min[i])}¬∞</span>
                        </span>
                    </div>
                `).join('')}
            </div>

            <div class="params-grid">
                <div class="card">
                    <div class="card-title">üå°Ô∏è –û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫</div>
                    <div class="param-val">${Math.round(cur.apparent_temperature)}¬∞</div>
                </div>
                <div class="card">
                    <div class="card-title">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
                    <div class="param-val">${cur.relative_humidity_2m}%</div>
                </div>
                <div class="card">
                    <div class="card-title">üí® –í–µ—Ç–µ—Ä</div>
                    <div class="param-val">${Math.round(cur.wind_speed_10m)} <span style="font-size:14px">–∫–º/—á</span></div>
                </div>
                <div class="card">
                    <div class="card-title">‚òÄÔ∏è –í–æ—Å—Ö–æ–¥</div>
                    <div class="param-val" style="font-size:20px">${daily.sunrise[0].split('T')[1]}</div>
                </div>
            </div>

            <div class="card ai-card">
                <div class="card-title">ü§ñ –ü–æ–º–æ—â–Ω–∏–∫</div>
                <div style="font-size: 15px; line-height: 1.4;">${aiAdvice}</div>
            </div>
        `;
        document.getElementById('content').innerHTML = html;
    }

    function getAIAdvice(code, temp) {
        if (code >= 95) return "–û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –¥–æ–º–∞! –°–∏–ª—å–Ω–∞—è –≥—Ä–æ–∑–∞. –û—Ç–∫–ª—é—á–∏—Ç–µ —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–±–æ—Ä—ã.";
        if (code >= 71) return "–ù–∞ —É–ª–∏—Ü–µ —Å–Ω–µ–≥. –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –≥–æ—Ä—è—á–µ–≥–æ –∫–∞–∫–∞–æ –∏ —Ç–µ–ø–ª—ã—Ö –±–æ—Ç–∏–Ω–æ–∫.";
        if (code >= 51) return "–í–æ–∑—å–º–∏—Ç–µ –∑–æ–Ω—Ç–∏–∫ ‚Äî –æ–∂–∏–¥–∞—é—Ç—Å—è –æ—Å–∞–¥–∫–∏. –ü–æ–≥–æ–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç –∫ –ø—Ä–æ–≥—É–ª–∫–∞–º.";
        if (temp > 25) return "–°–µ–≥–æ–¥–Ω—è –∂–∞—Ä–∫–æ! –ù–µ –∑–∞–±—É–¥—å—Ç–µ SPF –∏ –ø–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã.";
        if (temp < 0) return "–û–¥–µ–≤–∞–π—Ç–µ—Å—å –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ, –º–æ—Ä–æ–∑ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ–≤–∞—Ä–Ω—ã–º.";
        return "–û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏ –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ. –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å!";
    }

    // --- –ü–æ–∏—Å–∫ ---
    async function handleSearch(query) {
        const resultsBox = document.getElementById('search-results');
        if (query.length < 2) { resultsBox.style.display = 'none'; return; }

        const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=ru`).then(r => r.json());
        
        if (res.results) {
            resultsBox.innerHTML = res.results.map(g => `
                <div class="search-item" onclick="selectCity(${g.latitude}, ${g.longitude}, '${g.name}', '${g.country_code}')">
                    <div>
                        <b>${g.name}</b>
                        <span class="geo-info">${g.country}, ${g.admin1 || ''} ${g.admin2 || ''}</span>
                    </div>
                    <span style="color: #FFD700">‚òÜ</span>
                </div>
            `).join('');
            resultsBox.style.display = 'block';
        }
    }

    function selectCity(lat, lon, name, countryCode) {
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('citySearch').value = '';
        loadWeatherData(lat, lon, name, countryCode);
    }

    // --- –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (Background Engine) ---
    function initBackgroundEffect() {
        particles = [];
        let count = 0;
        if (currentWeather.code >= 71) count = 100; // –°–Ω–µ–≥
        else if (currentWeather.code >= 51) count = 150; // –î–æ–∂–¥—å
        
        for (let i = 0; i < count; i++) {
            particles.push({
                x: Math.random() * W,
                y: Math.random() * H,
                v: (currentWeather.code >= 71 ? 1 : 10) + Math.random() * 5,
                s: Math.random() * 2 + 1
            });
        }
    }

    function animate() {
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–µ–±–∞ (–ì—Ä–∞–¥–∏–µ–Ω—Ç)
        let grad = ctx.createLinearGradient(0, 0, 0, H);
        if (currentWeather.isDay) {
            if (currentWeather.code >= 3) { // –ü–∞—Å–º—É—Ä–Ω–æ
                grad.addColorStop(0, '#57606f'); grad.addColorStop(1, '#2f3542');
            } else { // –Ø—Å–Ω–æ/–†–∞—Å—Å–≤–µ—Ç
                grad.addColorStop(0, '#1e90ff'); grad.addColorStop(1, '#70a1ff');
            }
        } else { // –ù–æ—á—å
            grad.addColorStop(0, '#000000'); grad.addColorStop(1, '#2f3542');
        }
        
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —á–∞—Å—Ç–∏—Ü
        ctx.fillStyle = "rgba(255,255,255,0.8)";
        particles.forEach(p => {
            if (currentWeather.code >= 71) { // –°–Ω–µ–≥
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.s, 0, Math.PI * 2);
                ctx.fill();
            } else { // –î–æ–∂–¥—å
                ctx.fillRect(p.x, p.y, 1, 15);
            }
            p.y += p.v;
            if (p.y > H) p.y = -20;
        });

        requestAnimationFrame(animate);
    }

    window.onresize = resize;
</script>
</body>
</html>

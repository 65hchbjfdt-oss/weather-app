<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Weather iOS Pro</title>
    <style>
        :root { 
            --glass-bg: rgba(25, 25, 25, 0.7); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --blur-val: blur(30px) saturate(160%);
            --ios-spring: cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; background: #000; color: #fff; overflow: hidden; 
            height: 100vh; width: 100vw; position: fixed;
        }
        
        canvas#bg { position: fixed; inset: 0; z-index: -1; pointer-events: none; }

        /* HEADER */
        header { 
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000; 
            padding: calc(env(safe-area-inset-top) + 10px) 20px 10px;
            display: flex; gap: 12px; align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
        }
        .search-wrapper { flex: 1; position: relative; }
        .search-box { 
            display: flex; align-items: center; 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: 12px; padding: 8px 12px; 
            border: 1px solid var(--glass-border);
        }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 16px; margin-left: 8px; }
        
        #results { 
            position: absolute; top: 50px; left: 0; right: 0; 
            background: rgba(30,30,30,0.95); backdrop-filter: blur(30px);
            border-radius: 14px; overflow: hidden; display: none; 
            border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .res-item { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }

        /* STAGE & PAGES */
        #stage { height: 100vh; width: 100vw; position: relative; }
        
        .page-container {
            position: absolute; inset: 0;
            padding: 130px 16px 100px; 
            overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            display: none; 
            opacity: 0;
            transition: transform 0.6s var(--ios-spring), opacity 0.4s ease;
        }
        /* –¢–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page-container::-webkit-scrollbar { display: none; }
        
        .page-container.active { display: block; opacity: 1; transform: translateX(0); z-index: 10; }
        .page-container.prev { display: block; transform: translateX(-100%); opacity: 0; }
        .page-container.next { display: block; transform: translateX(100%); opacity: 0; }

        /* CONTENT STYLING */
        .city-info { text-align: center; margin-bottom: 30px; }
        .city-name { font-size: 34px; font-weight: 500; }
        .temp-main { font-size: 90px; font-weight: 200; margin: 0; }
        .condition { font-size: 20px; opacity: 0.8; font-weight: 500; }

        .card { 
            background: var(--glass-bg); backdrop-filter: var(--blur-val); -webkit-backdrop-filter: var(--blur-val);
            border-radius: 20px; padding: 16px; border: 1px solid var(--glass-border); margin-bottom: 12px;
        }
        .card-label { font-size: 12px; opacity: 0.5; font-weight: 600; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px; }

        .h-scroll { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 8px; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-item { text-align: center; min-width: 50px; }

        .day-row { display: grid; grid-template-columns: 1fr 40px 1fr; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* SUN GRAPH */
        .sun-container { height: 100px; position: relative; width: 100%; margin-top: 10px;}

        /* DOTS NAVIGATION */
        .dots-nav { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 8px; z-index: 1000; pointer-events: none;
        }
        .dot { width: 7px; height: 7px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #fff; transform: scale(1.2); }

        .btn-circle { 
            width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }

        /* SETTINGS */
        #settings-layer { 
            position: fixed; inset: 0; background: #000; z-index: 2000; 
            transform: translateY(100%); transition: transform 0.5s var(--ios-spring);
            padding: 60px 20px;
        }
        #settings-layer.open { transform: translateY(0); }

    </style>
</head>
<body>

    <canvas id="bg"></canvas>

    <header>
        <div class="btn-circle" onclick="toggleSettings(true)">‚ò∞</div>
        <div class="search-wrapper">
            <div class="search-box">
                <span>üîç</span>
                <input id="q" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞" oninput="doSearch(this.value)">
            </div>
            <div id="results"></div>
        </div>
    </header>

    <div id="stage"></div>
    <div class="dots-nav" id="dots"></div>

    <div id="settings-layer">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h1 style="margin:0;">–ì–æ—Ä–æ–¥–∞</h1>
            <div class="btn-circle" onclick="toggleSettings(false)">‚úï</div>
        </div>
        <div id="fav-list"></div>
    </div>

<script>
    let cities = JSON.parse(localStorage.getItem('savedCities')) || [
        {lat: 55.75, lon: 37.62, name: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è'}
    ];
    let currentIndex = 0;
    
    // Canvas Background
    const canvas = document.getElementById('bg');
    const ctx = canvas.getContext('2d');
    let particles = [];

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    async function init() {
        resize();
        window.addEventListener('resize', resize);
        renderStructure();
        loadCityData(currentIndex);
        initGestures();
        animateBackground();
    }

    function renderStructure() {
        const stage = document.getElementById('stage');
        const dots = document.getElementById('dots');
        stage.innerHTML = '';
        dots.innerHTML = '';
        
        cities.forEach((_, i) => {
            const page = document.createElement('div');
            page.className = `page-container ${i === currentIndex ? 'active' : (i < currentIndex ? 'prev' : 'next')}`;
            page.id = `page-${i}`;
            stage.appendChild(page);

            const dot = document.createElement('div');
            dot.className = `dot ${i === currentIndex ? 'active' : ''}`;
            dots.appendChild(dot);
        });
    }

    async function loadCityData(idx) {
        const page = document.getElementById(`page-${idx}`);
        if (!page || (page.dataset.loaded === "true" && idx !== currentIndex)) return;

        const c = cities[idx];
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&current=temperature_2m,weather_code,is_day,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`);
            const data = await res.json();
            
            page.innerHTML = renderCityHTML(data, c, idx);
            page.dataset.loaded = "true";
            
            if (idx === currentIndex) {
                updateBackgroundEffects(data.current.weather_code, data.current.is_day);
            }
            
            // –†–∏—Å—É–µ–º —Å–æ–ª–Ω—Ü–µ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
            setTimeout(() => drawSun(`sun-${idx}`, data.daily.sunrise[0], data.daily.sunset[0]), 100);
            
        } catch (e) {
            page.innerHTML = `<div style="padding:50px; text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>`;
        }
    }

    function renderCityHTML(data, c, idx) {
        const cur = data.current;
        const hours = data.hourly;
        
        let hourlyHTML = '';
        const nowH = new Date().getHours();
        for(let i = nowH; i < nowH + 24; i++) {
            hourlyHTML += `
                <div class="h-item">
                    <div style="font-size:13px; margin-bottom:8px;">${i % 24}:00</div>
                    <div style="font-size:20px; margin-bottom:8px;">${getIcon(hours.weather_code[i])}</div>
                    <div style="font-weight:600;">${Math.round(hours.temperature_2m[i])}¬∞</div>
                </div>
            `;
        }

        let dailyHTML = '';
        for(let i = 0; i < 7; i++) {
            const date = new Date(data.daily.time[i]).toLocaleDateString('ru-RU', {weekday: 'short'});
            dailyHTML += `
                <div class="day-row">
                    <div style="text-transform: capitalize;">${i === 0 ? '–°–µ–≥–æ–¥–Ω—è' : date}</div>
                    <div>${getIcon(data.daily.weather_code[i])}</div>
                    <div style="text-align:right;">
                        <span style="opacity:0.5; margin-right:8px;">${Math.round(data.daily.temperature_2m_min[i])}¬∞</span>
                        <span>${Math.round(data.daily.temperature_2m_max[i])}¬∞</span>
                    </div>
                </div>
            `;
        }

        return `
            <div class="city-info">
                <div class="city-name">${c.name}</div>
                <h1 class="temp-main">${Math.round(cur.temperature_2m)}¬∞</h1>
                <div class="condition">${getDesc(cur.weather_code)}</div>
                <div style="font-weight:500; margin-top:5px;">–ú–∞–∫—Å: ${Math.round(data.daily.temperature_2m_max[0])}¬∞, –º–∏–Ω: ${Math.round(data.daily.temperature_2m_min[0])}¬∞</div>
            </div>

            <div class="card">
                <div class="card-label">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 24 —á–∞—Å–∞</div>
                <div class="h-scroll">${hourlyHTML}</div>
            </div>

            <div class="card">
                <div class="card-label">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 7 –¥–Ω–µ–π</div>
                ${dailyHTML}
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-label">–í–æ—Å—Ö–æ–¥ –∏ –∑–∞–∫–∞—Ç</div>
                    <div class="sun-container">
                        <canvas id="sun-${idx}" width="200" height="100" style="width:100%; height:100%;"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-label">–í–µ—Ç–µ—Ä</div>
                    <div style="font-size:24px; font-weight:600;">${cur.wind_speed_10m} <span style="font-size:14px;">–∫–º/—á</span></div>
                </div>
            </div>
        `;
    }

    // --- –ì—Ä–∞—Ñ–∏–∫ –°–æ–ª–Ω—Ü–∞ ---
    function drawSun(canvasId, sunriseStr, sunsetStr) {
        const c = document.getElementById(canvasId);
        if (!c) return;
        const ctxS = c.getContext('2d');
        const w = c.width;
        const h = c.height;
        
        const now = new Date();
        const sunrise = new Date(sunriseStr);
        const sunset = new Date(sunsetStr);
        
        // –õ–∏–Ω–∏—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞
        ctxS.strokeStyle = 'rgba(255,255,255,0.2)';
        ctxS.lineWidth = 2;
        ctxS.beginPath();
        ctxS.moveTo(0, h - 20);
        ctxS.lineTo(w, h - 20);
        ctxS.stroke();

        // –î—É–≥–∞ (–ø—É—Ç—å —Å–æ–ª–Ω—Ü–∞)
        ctxS.strokeStyle = 'rgba(255,215,0,0.3)';
        ctxS.setLineDash([5, 5]);
        ctxS.beginPath();
        ctxS.arc(w/2, h + 10, w/2, Math.PI, 0);
        ctxS.stroke();
        ctxS.setLineDash([]);

        // –ü–æ–ª–æ–∂–µ–Ω–∏–µ —Å–æ–ª–Ω—Ü–∞
        const totalDaylight = sunset - sunrise;
        const currentProgress = now - sunrise;
        const pct = currentProgress / totalDaylight;

        if (pct >= 0 && pct <= 1) {
            const angle = Math.PI + (Math.PI * pct);
            const r = w/2;
            const sx = w/2 + r * Math.cos(angle);
            const sy = (h + 10) + r * Math.sin(angle);

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏ –¥—É–≥–∏
            ctxS.strokeStyle = '#FFD700';
            ctxS.lineWidth = 3;
            ctxS.beginPath();
            ctxS.arc(w/2, h + 10, r, Math.PI, angle);
            ctxS.stroke();

            // –¢–æ—á–∫–∞ —Å–æ–ª–Ω—Ü–∞
            ctxS.fillStyle = '#FFD700';
            ctxS.shadowBlur = 10;
            ctxS.shadowColor = '#FFD700';
            ctxS.beginPath();
            ctxS.arc(sx, sy, 5, 0, Math.PI*2);
            ctxS.fill();
        }
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–µ—Å—Ç–∞–º–∏ ---
    function initGestures() {
        let startX = 0;
        let startY = 0;
        let isHorizontalMove = false;

        document.addEventListener('touchstart', e => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isHorizontalMove = false;
        }, {passive: true});

        document.addEventListener('touchmove', e => {
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            
            if (!isHorizontalMove && Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {
                isHorizontalMove = true;
            }
        }, {passive: true});

        document.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - startX;
            if (isHorizontalMove && Math.abs(dx) > 80) {
                if (dx > 0 && currentIndex > 0) switchPage(currentIndex - 1);
                else if (dx < 0 && currentIndex < cities.length - 1) switchPage(currentIndex + 1);
            }
        });
    }

    function switchPage(idx) {
        currentIndex = idx;
        const pages = document.querySelectorAll('.page-container');
        const dots = document.querySelectorAll('.dot');
        
        pages.forEach((p, i) => {
            p.className = 'page-container';
            if (i === idx) p.classList.add('active');
            else if (i < idx) p.classList.add('prev');
            else p.classList.add('next');
        });

        dots.forEach((d, i) => d.classList.toggle('active', i === idx));
        loadCityData(idx);
    }

    // --- –§–æ–Ω–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã ---
    function updateBackgroundEffects(code, isDay) {
        particles = [];
        let color1 = isDay ? '#4a90e2' : '#1a2a6c';
        let color2 = isDay ? '#87ceeb' : '#000000';
        
        if (code >= 51) { // –î–æ–∂–¥—å/–°–Ω–µ–≥
            for(let i=0; i<100; i++) particles.push({
                x: Math.random()*canvas.width, 
                y: Math.random()*canvas.height, 
                v: Math.random()*10+5,
                l: Math.random()*20+10
            });
        }
        canvas.style.background = `linear-gradient(to bottom, ${color1}, ${color2})`;
    }

    function animateBackground() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 1;
        particles.forEach(p => {
            p.y += p.v;
            if (p.y > canvas.height) p.y = -20;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x, p.y + p.l);
            ctx.stroke();
        });
        requestAnimationFrame(animateBackground);
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    function toggleSettings(open) {
        const layer = document.getElementById('settings-layer');
        if (open) {
            layer.classList.add('open');
            renderFavList();
        } else {
            layer.classList.remove('open');
        }
    }

    function renderFavList() {
        const list = document.getElementById('fav-list');
        list.innerHTML = cities.map((c, i) => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;" onclick="switchPage(${i}); toggleSettings(false);">
                <div>
                    <div style="font-size:18px; font-weight:600;">${c.name}</div>
                    <div style="font-size:12px; opacity:0.6;">${c.country}</div>
                </div>
                <div style="font-size:24px;">‚Üí</div>
            </div>
        `).join('');
    }

    async function doSearch(q) {
        const resBox = document.getElementById('results');
        if (q.length < 2) { resBox.style.display = 'none'; return; }
        
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=ru`).then(x => x.json());
        if (!r.results) return;

        resBox.innerHTML = r.results.map(i => `
            <div class="res-item" onclick="addCity(${i.latitude}, ${i.longitude}, '${i.name}', '${i.country}')">
                <b>${i.name}</b>, <span style="opacity:0.6">${i.country}</span>
            </div>
        `).join('');
        resBox.style.display = 'block';
    }

    function addCity(lat, lon, name, country) {
        cities.push({lat, lon, name, country});
        localStorage.setItem('savedCities', JSON.stringify(cities));
        document.getElementById('results').style.display = 'none';
        document.getElementById('q').value = '';
        renderStructure();
        switchPage(cities.length - 1);
    }

    function getIcon(code) {
        if (code === 0) return '‚òÄÔ∏è';
        if (code <= 3) return '‚òÅÔ∏è';
        if (code <= 67) return 'üåßÔ∏è';
        if (code <= 77) return '‚ùÑÔ∏è';
        return '‚õàÔ∏è';
    }

    function getDesc(code) {
        const d = {0:'–Ø—Å–Ω–æ', 1:'–Ø—Å–Ω–æ', 2:'–û–±–ª–∞—á–Ω–æ', 3:'–ü–∞—Å–º—É—Ä–Ω–æ', 45:'–¢—É–º–∞–Ω', 51:'–ú–æ—Ä–æ—Å—å', 61:'–î–æ–∂–¥—å', 71:'–°–Ω–µ–≥', 95:'–ì—Ä–æ–∑–∞'};
        return d[code] || '–û—Å–∞–¥–∫–∏';
    }

    init();
</script>
</body>
</html>

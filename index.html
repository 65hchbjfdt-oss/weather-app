<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather iOS Ultimate AI</title>
    <style>
        :root { 
            --glass: rgba(30, 30, 30, 0.65); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --blur: blur(40px); 
            --spring: cubic-bezier(0.25, 0.8, 0.25, 1);
            --accent: #4cd964;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        html, body {
            margin: 0; padding: 0; background: #000; color: #fff;
            width: 100%; height: 100%; overflow: hidden; position: fixed;
        }
        
        canvas#bg { position: fixed; inset: 0; z-index: -1; }

        .content-wrapper {
            max-width: 500px; width: 100%; margin: 0 auto; height: 100%;
            position: relative; background: transparent; overflow: hidden;
        }

        /* HEADER */
        header { 
            padding: 40px 20px 10px; position: absolute; top: 0; left: 0; right: 0; 
            z-index: 1000; display: flex; gap: 10px; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); 
            pointer-events: none; width: 100%; max-width: 500px; margin: 0 auto;
        }
        .search-wrapper { flex: 1; pointer-events: auto; position: relative; }
        .search-box { display: flex; align-items: center; background: rgba(40,40,40,0.7); backdrop-filter: var(--blur); border-radius: 14px; padding: 8px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid var(--glass-border); }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 17px; outline: none; margin-left: 8px; width: 100%; min-width: 0; }
        
        #results { position: absolute; top: 50px; left: 0; right: 0; background: rgba(30,30,30,0.95); border-radius: 14px; overflow: hidden; display: none; z-index: 2500; border: 1px solid var(--glass-border); backdrop-filter: blur(50px); max-height: 300px; overflow-y: auto; }
        .res-item { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .res-sub { font-size: 12px; opacity: 0.6; margin-top: 2px; line-height: 1.3; }
        
        #stage { height: 100%; width: 100%; position: relative; overflow: hidden; }
        
        .page-container {
            position: absolute; inset: 0; padding: 110px 20px 140px;
            transition: opacity 0.4s ease; 
            overflow-y: auto; overflow-x: hidden;
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch; 
            display: none; opacity: 0; width: 100%;
            scrollbar-width: none; touch-action: pan-y; overscroll-behavior-x: none;
        }
        .page-container::-webkit-scrollbar { display: none; }
        .page-container.active { display: block; opacity: 1; z-index: 5; }

        .city-header { text-align: center; margin-bottom: 30px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .city-name { font-size: 32px; font-weight: 600; }
        .temp-big { font-size: 90px; font-weight: 200; letter-spacing: -2px; line-height: 1.1; }
        .condition-text { font-size: 18px; font-weight: 500; opacity: 0.9; text-transform: capitalize; }
        .hl-temp { font-size: 18px; font-weight: 500; margin-top: 5px; }

        .card { 
            background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border-radius: 20px; padding: 15px; border: 1px solid var(--glass-border); margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 100%; box-sizing: border-box;
        }
        .card-label { font-size: 13px; opacity: 0.6; text-transform: uppercase; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }

        .h-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-item { text-align: center; min-width: 60px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .wind-sm { font-size: 11px; opacity: 0.7; display: flex; align-items: center; gap: 2px; margin-top: 2px; }

        .day-row { display: grid; grid-template-columns: 1.2fr 0.3fr 0.8fr 1fr; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 16px; font-weight: 500; }
        .day-row:last-child { border: none; }
        .day-date { display: flex; flex-direction: column; }
        .day-sub { font-size: 12px; opacity: 0.5; font-weight: 400; }
        .day-wind { font-size: 12px; opacity: 0.7; display: flex; align-items: center; gap: 4px; justify-content: flex-start; }
        .temp-range { display: flex; gap: 8px; justify-content: flex-end; }
        .temp-night { opacity: 0.5; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; width: 100%; box-sizing: border-box; }
        .tile { 
            aspect-ratio: 1; display: flex; flex-direction: column; justify-content: space-between; 
            cursor: pointer; transition: transform 0.2s; min-width: 0; overflow: hidden;
        }
        .tile:active { transform: scale(0.97); }
        .tile-val { font-size: 24px; font-weight: 500; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tile-sub { font-size: 13px; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* AI GRAPH */
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .vote-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; transition: opacity 0.5s; width: 100%; }
        .vote-btn { 
            background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 2px; 
            text-align: center; font-size: 11px; cursor: pointer; border: 1px solid transparent;
            transition: 0.3s var(--spring); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .vote-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .vote-btn.disabled { opacity: 0.3; pointer-events: none; }
        #ai-thank-you { font-size: 16px; color: #4cd964; text-align: center; margin-bottom: 10px; display: none; transition: opacity 0.5s; }

        .ai-graph-container { display: flex; height: 180px; margin-top: 15px; position: relative; width: 100%; }
        .y-axis { 
            width: 30px; display: flex; flex-direction: column; justify-content: space-between; 
            font-size: 10px; opacity: 0.5; text-align: right; 
            padding-right: 5px; padding-bottom: 25px; padding-top: 15px;
        }
        .y-axis-label { position: absolute; left: 0; top: -10px; font-size: 9px; opacity: 0.6; width: 100%; text-align: left; }
        .graph-area { flex: 1; position: relative; height: 140px; top: 10px; margin-bottom: 0; width: 100%; }
        
        svg.ai-svg { width: 100%; height: 100%; overflow: visible; }
        path.graph-line { fill: none; stroke: var(--accent); stroke-width: 2.5; stroke-linecap: round; transition: d 2s ease-in-out; }
        path.graph-fill { fill: rgba(76, 217, 100, 0.15); stroke: none; transition: d 2s ease-in-out; }
        
        .html-dot {
            position: absolute; width: 10px; height: 10px;
            background: #000; border: 2px solid var(--accent); border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 5; pointer-events: none; 
            transition: top 2s ease-in-out; 
        }
        .click-zone { 
            position: absolute; width: 40px; height: 40px;
            background: transparent; transform: translate(-50%, -50%);
            z-index: 10; cursor: pointer;
        }

        /* FIXED TOOLTIPS - –°—Ç—Ä–æ–≥–∏–π —Ä–∞–∑–º–µ—Ä –∏ –ø–æ–∑–∏—Ü–∏—è */
        .chart-tooltip {
            position: absolute; 
            background: rgba(255,255,255,0.95); color: #000;
            padding: 6px 0; 
            border-radius: 10px; font-size: 13px; font-weight: 600;
            pointer-events: none; opacity: 0; 
            transition: opacity 0.2s; 
            width: 70px; /* –°–¢–†–û–ì–ê–Ø –®–ò–†–ò–ù–ê */
            text-align: center;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .chart-tooltip.pos-top::after { content: ''; position: absolute; left: 50%; bottom: -5px; transform: translateX(-50%); border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid rgba(255,255,255,0.95); }
        .chart-tooltip.pos-bottom::after { content: ''; position: absolute; left: 50%; top: -5px; transform: translateX(-50%); border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 5px solid rgba(255,255,255,0.95); }
        
        .chart-tooltip.align-left::after { left: 15px; transform: none; }
        .chart-tooltip.align-right::after { left: auto; right: 15px; transform: none; }

        .x-labels { position: absolute; bottom: -5px; left: 30px; right: 0; height: 20px; display: flex; justify-content: space-between; }
        .x-label { font-size: 10px; opacity: 0.5; text-align: center; width: 40px; transform: translateX(0); }
        .x-label:first-child { text-align: left; transform: translateX(-10px); }
        .x-label:last-child { text-align: right; transform: translateX(10px); }

        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.7); backdrop-filter: blur(20px); padding: 8px 16px; border-radius: 20px; display: flex; gap: 8px; z-index: 2000; border: 1px solid rgba(255,255,255,0.1); }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; cursor: pointer; }
        .dot.active { background: #fff; transform: scale(1.2); }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; background: rgba(60,60,60,0.6); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; pointer-events: auto; }

        .nav-arrow {
            position: fixed; top: 50%; transform: translateY(-50%);
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; z-index: 1500; transition: 0.3s;
        }
        .nav-arrow:active { background: rgba(255,255,255,0.3); transform: translateY(-50%) scale(0.9); }
        .arrow-left { left: 10px; } .arrow-right { right: 10px; }
        @media (min-width: 768px) {
            .nav-arrow { width: 50px; height: 50px; font-size: 24px; background: rgba(255,255,255,0.15); }
            .nav-arrow:hover { background: rgba(255,255,255,0.25); }
            .arrow-left { left: 30px; } .arrow-right { right: 30px; }
        }

        .layer { position: fixed; inset: 0; z-index: 3000; transform: translateX(100%); transition: transform 0.4s var(--spring); display: flex; justify-content: center; background: #000; }
        @media (min-width: 768px) { .layer { background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); } }
        .layer.show { transform: translateX(0); }
        .layer-inner { width: 100%; max-width: 500px; height: 100%; background: #000; position: relative; display: flex; flex-direction: column; border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1); }
        
        .layer.modal { background: transparent; align-items: flex-end; transform: translateY(100%); }
        .layer.modal .layer-inner {
            max-width: 500px; height: auto; max-height: 80vh;
            background: rgba(20,20,20,0.95); backdrop-filter: blur(30px);
            border-top-left-radius: 25px; border-top-right-radius: 25px;
            margin: 0 auto; border: 1px solid rgba(255,255,255,0.15);
        }
        .layer.modal.show { transform: translateY(0); }

        .layer-header { padding: 50px 20px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .layer-content { flex: 1; overflow-y: auto; padding: 20px; }
        .ai-box { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 15px; margin-top: 20px; }
        .ai-title { font-size: 14px; font-weight: 700; color: #FFD60A; margin-bottom: 8px; }
        .ai-text { font-size: 15px; line-height: 1.4; opacity: 0.9; }
        .list-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    </style>
</head>
<body>

    <canvas id="bg"></canvas>

    <div class="content-wrapper">
        <header id="main-header">
            <div class="btn-circle" onclick="toggleSettings(true)" style="margin-right: 10px;">‚ò∞</div>
            <div class="search-wrapper">
                <div class="search-box">
                    <span style="opacity:0.6">üîç</span>
                    <input id="q" placeholder="–ü–æ–∏—Å–∫..." oninput="doSearch(this.value)">
                </div>
                <div id="results"></div>
            </div>
        </header>

        <div id="stage"></div>
        <div class="nav-dock" id="pagination"></div>
    </div>

    <div class="nav-arrow arrow-left" onclick="movePage(-1)">‚Äπ</div>
    <div class="nav-arrow arrow-right" onclick="movePage(1)">‚Ä∫</div>

    <!-- SETTINGS -->
    <div id="settings-layer" class="layer">
        <div class="layer-inner">
            <div class="layer-header">
                <h1 style="margin:0; font-size:28px;">–ú–æ–∏ –≥–æ—Ä–æ–¥–∞</h1>
                <div class="btn-circle" onclick="toggleSettings(false)">‚úï</div>
            </div>
            <div class="layer-content">
                <div class="list-item" onclick="detectLocation()" style="background:rgba(76, 217, 100, 0.2); border:1px solid rgba(76, 217, 100, 0.4);">
                    <div style="display:flex; align-items:center; gap:10px"><span>üìç</span><b>–ù–∞–π—Ç–∏ –º–µ–Ω—è</b></div>
                </div>
                <div id="fav-list"></div>
                <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                    <h3 style="opacity:0.5">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="list-item" onclick="toggleUnit()"><span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span><span id="unit-disp" style="color:#0a84ff">¬∞C</span></div>
                    <div class="list-item" onclick="toggleWindUnit()"><span>–í–µ—Ç–µ—Ä</span><span id="wind-disp" style="color:#0a84ff">–∫–º/—á</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PREVIEW -->
    <div id="preview-layer" class="layer">
        <div class="layer-inner" style="background:rgba(20,20,20,0.95); backdrop-filter:blur(50px);">
            <div class="layer-header">
                <div class="btn-circle" onclick="closePreview()">‚úï</div>
                <span style="font-weight:600">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span><div style="width:40px"></div>
            </div>
            <div class="layer-content" id="preview-inner"></div>
            <div style="padding:20px; text-align:center;">
                <button onclick="confirmAddCity()" style="background:#fff; color:#000; padding:14px 40px; border-radius:30px; border:none; font-weight:600; font-size:16px; cursor:pointer">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- SUN MODAL -->
    <div id="sun-modal" class="layer modal">
        <div class="layer-inner">
            <div class="layer-header" style="padding-top:20px">
                <span style="font-size:18px; font-weight:600">–°–æ–ª–Ω—Ü–µ –∏ –õ—É–Ω–∞</span>
                <div class="btn-circle" onclick="document.getElementById('sun-modal').classList.remove('show')">‚úï</div>
            </div>
            <div class="layer-content" id="sun-modal-content"></div>
        </div>
    </div>

<script>
    let cities = []; let currentIndex = 0;
    let unit = localStorage.getItem('unit') || 'C';
    let windUnit = localStorage.getItem('windUnit') || 'kmh'; 
    let tempCity = null; let userGeo = null; 

    async function init() {
        resize(); window.addEventListener('resize', resize);
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userGeo = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            }, () => {});
        }
        const saved = JSON.parse(localStorage.getItem('savedCities') || '[]');
        if (saved.length > 0) cities = saved;
        else cities = [{lat: 55.75, lon: 37.62, name: '–ú–æ—Å–∫–≤–∞', country: '–†–æ—Å—Å–∏—è', isHome: true}];
        initStageDOM(); loadWeather(0); updateSettingsUI(); initParticles(); requestAnimationFrame(loop);
    }

    function initStageDOM() {
        const stage = document.getElementById('stage'); stage.innerHTML = '';
        cities.forEach((c, i) => {
            const div = document.createElement('div'); div.className = 'page-container'; div.id = `page-${i}`;
            stage.appendChild(div);
        });
        updatePagination(); updateArrows();
    }

    function movePage(dir) {
        let next = currentIndex + dir;
        if(next >= 0 && next < cities.length) loadWeather(next);
    }

    function updateArrows() {
        const l = document.querySelector('.arrow-left'); const r = document.querySelector('.arrow-right');
        if(l) l.style.display = currentIndex === 0 ? 'none' : 'flex';
        if(r) r.style.display = currentIndex === cities.length - 1 ? 'none' : 'flex';
    }
    
    function toggleSettings(v) { document.getElementById('settings-layer').className = v ? 'layer show' : 'layer'; if(v) renderFav(); }

    async function doSearch(q) {
        if(q.length < 2) { document.getElementById('results').style.display='none'; return; }
        try {
            const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=ru`).then(x=>x.json());
            if(!r.results) return;
            document.getElementById('results').innerHTML = r.results.map(i => {
                const details = [i.country, i.admin1].filter(Boolean).join(', ');
                return `<div class="res-item" onclick="openPreview(${i.latitude}, ${i.longitude}, '${i.name}', '${i.country||''}')">
                    <div class="res-main">${i.name}</div><div class="res-sub">${details}</div></div>`;
            }).join('');
            document.getElementById('results').style.display = 'block';
        } catch(e) {}
    }

    function detectLocation() {
        toggleSettings(false);
        if(!navigator.geolocation) { alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude; const lon = pos.coords.longitude;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ru`);
                const data = await res.json();
                const name = data.address.city || data.address.town || '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                const newCity = {lat, lon, name, country: data.address.country || '', isHome: true};
                const exists = cities.find(c => (Math.abs(c.lat - lat) < 0.01 && Math.abs(c.lon - lon) < 0.01));
                if(!exists) { cities.unshift(newCity); localStorage.setItem('savedCities', JSON.stringify(cities)); initStageDOM(); loadWeather(0); }
                else { loadWeather(cities.indexOf(exists)); }
            } catch(e) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥'); }
        });
    }

    async function fetchWeather(lat, lon) {
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 5000);
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day,wind_speed_10m,wind_direction_10m&hourly=temperature_2m,weather_code,wind_speed_10m,wind_direction_10m,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,daylight_duration,wind_speed_10m_max,wind_direction_10m_dominant&timezone=auto`, { signal: controller.signal });
            clearTimeout(id);
            return await response.json();
        } catch(e) { return null; }
    }

    async function openPreview(lat, lon, name, country) {
        document.getElementById('results').style.display = 'none'; document.getElementById('q').value = '';
        const content = document.getElementById('preview-inner'); content.innerHTML = '<div style="text-align:center; padding-top:50px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        document.getElementById('preview-layer').classList.add('show');
        tempCity = {lat, lon, name, country};
        const data = await fetchWeather(lat, lon);
        if(data) {
            content.innerHTML = generateHTML(data, tempCity, true); updateEnv(data);
            const p1 = data.hourly.precipitation_probability[0] || 0; const p2 = data.hourly.precipitation_probability[1] || p1;
            const c0 = data.current.weather_code; const c1 = data.hourly.weather_code[1] || c0;
            setTimeout(() => initAIGraph('preview', [p1, p2], [c0, c1], {lat, lon}), 50);
        } else content.innerHTML = '<div style="text-align:center; padding-top:50px">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</div>';
    }

    function closePreview() { document.getElementById('preview-layer').classList.remove('show'); tempCity = null; loadWeather(currentIndex); }

    function confirmAddCity() {
        if(!tempCity) return;
        const exists = cities.some(c => (Math.abs(c.lat - tempCity.lat) < 0.01 && Math.abs(c.lon - tempCity.lon) < 0.01));
        if (exists) { alert('–≠—Ç–æ—Ç –≥–æ—Ä–æ–¥ —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ!'); return; }
        cities.push(tempCity); localStorage.setItem('savedCities', JSON.stringify(cities));
        initStageDOM(); closePreview(); loadWeather(cities.length-1);
    }

    function removeCity(i) {
        cities.splice(i,1); localStorage.setItem('savedCities', JSON.stringify(cities));
        renderFav(); initStageDOM(); loadWeather(Math.min(i, cities.length-1));
    }

    function getWindDir(deg) { return ["–°", "–°–í", "–í", "–Æ–í", "–Æ", "–Æ–ó", "–ó", "–°–ó"][Math.round(((deg %= 360) < 0 ? deg + 360 : deg) / 45) % 8]; }
    function convertWind(val, unit) {
        if(unit === 'ms') return { v: Math.round(val/3.6), l: '–º/—Å' };
        if(unit === 'mph') return { v: Math.round(val/1.609), l: '–º–∏–ª—å/—á' };
        return { v: Math.round(val), l: '–∫–º/—á' };
    }

    async function loadWeather(idx) {
        currentIndex = idx; const city = cities[idx];
        const el = document.getElementById(`page-${idx}`);
        document.querySelectorAll('.page-container').forEach((p, i) => { p.classList.remove('active'); if(i === idx) p.classList.add('active'); });
        updatePagination(); updateArrows();

        if(el.innerHTML.length < 50 || el.dataset.unit !== unit || el.dataset.wunit !== windUnit) {
            el.innerHTML = '<div style="text-align:center; padding-top:100px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            const data = await fetchWeather(city.lat, city.lon);
            if (!data) { el.innerHTML = '<div style="text-align:center; padding-top:100px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.<br><button onclick="loadWeather('+idx+')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button></div>'; return; }
            el.dataset.unit = unit; el.dataset.wunit = windUnit;
            el.innerHTML = generateHTML(data, city, false);
            if(idx === currentIndex) updateEnv(data);
            
            const h = data.hourly; const nowStr = data.current.time.substring(0, 13);
            let startIdx = h.time.findIndex(t => t.startsWith(nowStr)); if(startIdx === -1) startIdx = 0;
            const p1 = h.precipitation_probability[startIdx] || 0; const p2 = h.precipitation_probability[startIdx+1] || p1;
            const c0 = h.weather_code[startIdx] !== undefined ? h.weather_code[startIdx] : data.current.weather_code;
            const c1 = h.weather_code[startIdx+1] !== undefined ? h.weather_code[startIdx+1] : c0;
            setTimeout(() => initAIGraph(cities.indexOf(city), [p1, p2], [c0, c1], {lat: city.lat, lon: city.lon}), 50);
        } else { if(idx === currentIndex) { const data = await fetchWeather(city.lat, city.lon); if(data) updateEnv(data); } }
    }

    function generateHTML(data, city, isPreview) {
        const cur = data.current; const d = data.daily; const h = data.hourly;
        const temp = unit==='F' ? Math.round(cur.temperature_2m*9/5+32) : Math.round(cur.temperature_2m);
        const min = unit==='F' ? Math.round(d.temperature_2m_min[0]*9/5+32) : Math.round(d.temperature_2m_min[0]);
        const max = unit==='F' ? Math.round(d.temperature_2m_max[0]*9/5+32) : Math.round(d.temperature_2m_max[0]);
        const wInfo = convertWind(cur.wind_speed_10m, windUnit);

        let hourlyHTML = '';
        const nowStr = cur.time.substring(0, 13);
        let startIdx = h.time.findIndex(t => t.startsWith(nowStr)); if(startIdx === -1) startIdx = 0;
        
        for(let i=0; i<12; i++) {
            const idx = startIdx + i; if(idx >= h.time.length) break;
            const hour = h.time[idx].split('T')[1].split(':')[0];
            const hTemp = unit==='F' ? Math.round(h.temperature_2m[idx]*9/5+32) : Math.round(h.temperature_2m[idx]);
            const hWInfo = convertWind(h.wind_speed_10m[idx], windUnit);
            hourlyHTML += `<div class="h-item"><span style="font-weight:600; font-size:14px">${i===0?'–°–µ–π—á–∞—Å':hour}</span><span style="font-size:22px">${getWIcon(h.weather_code[idx])}</span><span style="font-size:16px; font-weight:500">${hTemp}¬∞</span><div class="wind-sm"><span style="transform:rotate(${h.wind_direction_10m[idx]}deg); display:inline-block">‚Üì</span> ${hWInfo.v}</div></div>`;
        }

        let dailyHTML = '';
        for(let i=0; i<5; i++) {
            const date = new Date(d.time[i]);
            const dMin = unit==='F' ? Math.round(d.temperature_2m_min[i]*9/5+32) : Math.round(d.temperature_2m_min[i]);
            const dMax = unit==='F' ? Math.round(d.temperature_2m_max[i]*9/5+32) : Math.round(d.temperature_2m_max[i]);
            const dWInfo = convertWind(d.wind_speed_10m_max[i], windUnit);
            dailyHTML += `<div class="day-row"><div class="day-date"><span>${i===0?'–°–µ–≥–æ–¥–Ω—è':date.toLocaleDateString('ru-RU', {weekday:'short'})}</span><span class="day-sub">${date.toLocaleDateString('ru-RU', {day:'numeric', month:'short'})}</span></div><div style="font-size:20px; text-align:center">${getWIcon(d.weather_code[i])}</div><div class="day-wind"><span style="transform:rotate(${d.wind_direction_10m_dominant[i]}deg); display:inline-block">‚Üì</span><span>${dWInfo.v} ${dWInfo.l}</span></div><div class="temp-range"><span>${dMax}¬∞</span><span class="temp-night">${dMin}¬∞</span></div></div>`;
        }

        const aiId = isPreview ? 'preview' : cities.indexOf(city);
        const voteMsg = checkLocation(city.lat, city.lon) ? '–£—Ç–æ—á–Ω–∏—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑:' : '–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏';
        const voteClass = checkLocation(city.lat, city.lon) ? '' : 'disabled';

        return `<div class="city-header"><div class="city-name">${city.name}</div><div class="condition-text">${getWDesc(cur.weather_code)}</div><div class="temp-big">${temp}¬∞</div><div class="hl-temp">–ú–∞–∫—Å.: ${max}¬∞ –ú–∏–Ω.: ${min}¬∞</div></div>
            <div class="card">
                <div class="ai-header"><div class="card-label" style="margin:0">ü§ñ AI-–ü–†–û–ì–ù–û–ó</div><div style="font-size:10px; opacity:0.5; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px">LIVE</div></div>
                <div style="font-size:12px; opacity:0.7; margin-bottom:10px">${voteMsg}</div>
                <div class="vote-grid" id="vote-box-${aiId}">
                    <div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 0)">‚òÄÔ∏è –Ø—Å–Ω–æ</div><div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 1)">‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ</div>
                    <div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 2)">üåß –î–æ–∂–¥—å</div><div class="vote-btn ${voteClass}" onclick="submitVote('${aiId}', 3)">‚ùÑÔ∏è –°–Ω–µ–≥</div>
                </div>
                <div id="ai-thank-you-${aiId}" style="display:none; text-align:center; color:#4cd964; margin-bottom:10px">–°–ø–∞—Å–∏–±–æ! –í–∞—à –≥–æ–ª–æ—Å —É—á—Ç–µ–Ω.</div>
                <div class="ai-graph-container">
                    <div class="y-axis-label">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤</div>
                    <div class="y-axis"><span>100%</span><span>50%</span><span>0%</span></div>
                    <div class="graph-area" id="graph-area-${aiId}">
                        <div class="chart-tooltip" id="tooltip-${aiId}"></div>
                        <svg class="ai-svg" viewBox="0 0 300 100" preserveAspectRatio="none">
                            <defs><linearGradient id="grad-${aiId}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#4cd964" stop-opacity="0.3"/><stop offset="100%" stop-color="#4cd964" stop-opacity="0"/></linearGradient></defs>
                            <path id="path-fill-${aiId}" class="graph-fill"></path><path id="path-line-${aiId}" class="graph-line"></path>
                        </svg>
                        <div id="dots-container-${aiId}" style="position:absolute; inset:0;"></div>
                    </div>
                    <div class="x-labels"><div class="x-label">–°–µ–π—á–∞—Å</div><div class="x-label">15–º</div><div class="x-label">30–º</div><div class="x-label">45–º</div><div class="x-label">60–º</div></div>
                </div>
            </div>
            <div class="card"><div class="card-label">üïì –ü–û–ß–ê–°–û–í–û–ô</div><div class="h-scroll">${hourlyHTML}</div></div>
            <div class="card"><div class="card-label">üìÖ 5 –î–ù–ï–ô</div>${dailyHTML}</div>
            <div class="grid-2">
                <div class="card tile" onclick="openSunDetail(this)" data-rise="${d.sunrise[0]}" data-set="${d.sunset[0]}" data-dur="${d.daylight_duration[0]}">
                    <div class="card-label">‚òÄÔ∏è –°–û–õ–ù–¶–ï</div><div class="tile-val">${d.sunset[0].split('T')[1]}</div><div class="tile-sub">–ó–∞–∫–∞—Ç</div>
                </div>
                <div class="card tile"><div class="card-label">üí® –í–ï–¢–ï–†</div><div class="tile-val">${wInfo.v} <span style="font-size:16px">${wInfo.l}</span></div><div class="tile-sub">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${getWindDir(cur.wind_direction_10m)}</div></div>
            </div>
            <div class="ai-box"><div class="ai-title">AI –°–û–í–ï–¢</div><div class="ai-text">${getAIText(temp, cur.weather_code)}</div></div>`;
    }

    // --- STATIC GRAPH LOGIC (NO RANDOM NOISE) ---
    const aiData = {};
    function checkLocation(lat, lon) { return userGeo && Math.abs(userGeo.lat - lat) < 0.1 && Math.abs(userGeo.lon - lon) < 0.1; }
    
    // –í–∑–≤–µ—à–µ–Ω–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ–≥–æ–¥—ã —Å —É—á–µ—Ç–æ–º —Å–Ω–µ–≥–∞
    function getWeatherVolatility(code) {
        if (code >= 95) return 0.4; // –ì—Ä–æ–∑–∞: –≤—ã—Å–æ–∫–∞—è
        if (code >= 70 && code <= 79) return 0.25; // –°–Ω–µ–≥
        if (code >= 85 && code <= 86) return 0.25; // –°–Ω–µ–∂–Ω—ã–µ –ª–∏–≤–Ω–∏
        if (code >= 50) return 0.25; // –î–æ–∂–¥—å
        if (code <= 3) return 0.05; // –Ø—Å–Ω–æ: –Ω–∏–∑–∫–∞—è
        return 0.15;
    }

    function initAIGraph(id, baseProbs, codes, geo) {
        let pts = []; 
        const start = baseProbs[0]; 
        const end = baseProbs[1];
        
        // –°–ª–æ–∂–Ω—ã–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç (–∫—Ä–∏–≤—ã–µ –ë–µ–∑—å–µ + —Å–∏–Ω—É—Å)
        for(let i=0; i<5; i++) {
            let t = i / 4; 
            // –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
            let linear = start + (end - start) * t;
            
            // –ü–æ–ª—É—á–∞–µ–º –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
            let volatility = getWeatherVolatility(i <= 2 ? codes[0] : codes[1]);
            
            // "–î—ã—Ö–∞–Ω–∏–µ" –ø–æ–≥–æ–¥—ã: —Å–∏–Ω—É—Å–æ–∏–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Math.floor –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ (–º–µ–Ω—è–µ—Ç—Å—è —Ä–∞–∑ –≤ 10 —Å–µ–∫—É–Ω–¥)
            const timeSeed = Math.floor(Date.now() / 10000); 
            const seed = geo.lat + geo.lon + timeSeed + i;
            const wave = Math.sin(seed) * 20 * volatility; 
            
            let val = linear + wave;
            pts.push(Math.max(0, Math.min(100, val)));
        }
        
        aiData[id] = { points: pts, voted: false, codes: codes, activeDot: -1, timer: null };
        renderGraph(id);
        
        // –ñ–∏–≤–æ–π —Ü–∏–∫–ª (–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑ –≤ 2 —Å–µ–∫—É–Ω–¥—ã)
        if(aiData[id].liveTimer) clearInterval(aiData[id].liveTimer);
        
        aiData[id].liveTimer = setInterval(() => {
            aiData[id].points = aiData[id].points.map((val, idx) => {
                let t = idx / 4; let baseVal = start + (end - start) * t;
                let volatility = getWeatherVolatility(idx <= 2 ? codes[0] : codes[1]);
                
                // –í—Ä–µ–º–µ–Ω–Ω–æ–π —Å–¥–≤–∏–≥ (Time Seed)
                const timeSeed = Date.now() / 2000; // –ü–ª–∞–≤–Ω–∞—è –≤–æ–ª–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏
                const wave = Math.sin(timeSeed + idx + geo.lat) * 15 * volatility;
                
                let newVal = baseVal + wave;
                return Math.max(0, Math.min(100, newVal));
            });
            renderGraph(id, true);
        }, 2000);
    }

    function getGraphIcon(val, hourlyCode) {
        // –õ–æ–≥–∏–∫–∞ –∏–∫–æ–Ω–æ–∫
        if(val <= 10) return getWIcon(hourlyCode);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–Ω–µ–≥–∞
        if ((hourlyCode >= 70 && hourlyCode <= 79) || (hourlyCode >= 85 && hourlyCode <= 86)) return '‚ùÑÔ∏è';
        
        if(val <= 24) return (hourlyCode >= 95) ? 'üå©' : (hourlyCode <= 1 ? '‚õÖ' : '‚òÅÔ∏è');
        if(val <= 59) return (hourlyCode <= 3) ? 'üå¶' : 'üåß';
        
        // –ï—Å–ª–∏ –Ω–µ –ø–æ–ø–∞–ª–∏ –≤ —Å–Ω–µ–≥ –≤—ã—à–µ, –∑–Ω–∞—á–∏—Ç –¥–æ–∂–¥—å
        return 'üåß';
    }

    function renderGraph(id, isUpdate = false) {
        if(!aiData[id]) return;
        const d = aiData[id].points; const codes = aiData[id].codes;
        const svgW = 300, svgH = 100; const stepX = svgW / 4;
        let path = `M0,${svgH - (d[0]/100)*svgH}`;
        for(let i=1; i<d.length; i++) path += ` L${i*stepX},${svgH - (d[i]/100)*svgH}`;

        const line = document.getElementById(`path-line-${id}`);
        const fill = document.getElementById(`path-fill-${id}`);
        const dotsContainer = document.getElementById(`dots-container-${id}`);
        const tooltip = document.getElementById(`tooltip-${id}`);
        
        if(line && fill) {
            line.setAttribute('d', path); fill.setAttribute('d', path + ` L${svgW},${svgH} L0,${svgH} Z`);
            
            if (isUpdate && dotsContainer.children.length === 5) {
                 Array.from(dotsContainer.children).forEach((group, i) => {
                     const val = d[i]; const cyPercent = 100 - val;
                     group.style.top = cyPercent + '%';
                     const zone = group.querySelector('.click-zone');
                     if(zone) zone.dataset.val = val; 
                 });
                 return;
            }
            
            dotsContainer.innerHTML = '';
            d.forEach((val, i) => {
                const cxPercent = i * 25; const cyPercent = 100 - val;
                const icon = getGraphIcon(val, i <= 2 ? codes[0] : codes[1]);
                const group = document.createElement('div');
                group.style.position = 'absolute'; group.style.left = cxPercent + '%'; group.style.top = cyPercent + '%'; 
                group.style.width = '0'; group.style.height = '0'; 
                group.style.transition = 'top 2s ease-in-out'; // –°–∏–Ω—Ö—Ä–æ–Ω —Å –ª–∏–Ω–∏–µ–π
                
                const dot = document.createElement('div'); dot.className = 'html-dot'; group.appendChild(dot);
                const zone = document.createElement('div'); z
